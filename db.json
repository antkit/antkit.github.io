{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/README","path":"README","modified":0,"renderable":0},{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.jpg","path":"images/avatar.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/algolia-search.js","path":"js/src/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/exturl.js","path":"js/src/exturl.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/js.cookie.js","path":"js/src/js.cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scroll-cookie.js","path":"js/src/scroll-cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","path":"lib/algolia-instant-search/instantsearch.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","path":"lib/canvas-nest/canvas-nest.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","path":"lib/canvas-ribbon/canvas-ribbon.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/LICENSE","path":"lib/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/README.md","path":"lib/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/bower.json","path":"lib/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","path":"lib/jquery_lazyload/CONTRIBUTING.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","path":"lib/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","path":"lib/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","path":"lib/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","path":"lib/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","path":"lib/three/canvas_lines.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","path":"lib/three/canvas_sphere.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three-waves.min.js","path":"lib/three/three-waves.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/bower.json","path":"lib/velocity/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.css","path":"lib/Han/dist/han.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.min.js","path":"lib/Han/dist/han.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","path":"lib/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","path":"lib/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","path":"lib/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","path":"lib/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","path":"lib/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","path":"lib/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","path":"lib/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","path":"lib/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","path":"lib/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","path":"lib/ua-parser-js/dist/ua-parser.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","path":"lib/ua-parser-js/dist/ua-parser.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.css","path":"lib/Han/dist/han.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/han.js","path":"lib/Han/dist/han.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","path":"lib/Han/dist/font/han-space.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","path":"lib/Han/dist/font/han-space.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","path":"lib/Han/dist/font/han.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","path":"lib/Han/dist/font/han.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","path":"lib/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","path":"lib/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","path":"lib/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","path":"lib/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","path":"lib/algolia-instant-search/instantsearch.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/three/three.min.js","path":"lib/three/three.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","path":"lib/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"e4e4e2a982f79e23f8f60b207196f1b5bb816b85","modified":1502499216942},{"_id":"source/README","hash":"9cbf5f3b46cca842c0eb84d925e0c4d03a05fb55","modified":1502499216942},{"_id":"themes/next/.bowerrc","hash":"3228a58ed0ece9f85e1e3136352094080b8dece1","modified":1502499216954},{"_id":"themes/next/.editorconfig","hash":"792fd2bd8174ece1a75d5fd24ab16594886f3a7f","modified":1502499216954},{"_id":"themes/next/.gitattributes","hash":"44bd4729c74ccb88110804f41746fec07bf487d4","modified":1502499216954},{"_id":"themes/next/.gitignore","hash":"32ea93f21d8693d5d8fa4eef1c51a21ad0670047","modified":1502499216954},{"_id":"themes/next/.hound.yml","hash":"b76daa84c9ca3ad292c78412603370a367cc2bc3","modified":1502499216954},{"_id":"themes/next/.javascript_ignore","hash":"f9ea3c5395f8feb225a24e2c32baa79afda30c16","modified":1502499216954},{"_id":"themes/next/.jshintrc","hash":"9928f81bd822f6a8d67fdbc909b517178533bca9","modified":1502499216954},{"_id":"themes/next/.stylintrc","hash":"b28e24704a5d8de08346c45286574c8e76cc109f","modified":1502499216954},{"_id":"themes/next/.travis.yml","hash":"c42d9608c8c7fe90de7b1581a8dc3886e90c179e","modified":1502499216954},{"_id":"themes/next/LICENSE","hash":"f293bcfcdc06c0b77ba13570bb8af55eb5c059fd","modified":1502499216954},{"_id":"themes/next/README.en.md","hash":"4ece25ee5f64447cd522e54cb0fffd9a375f0bd4","modified":1502499216954},{"_id":"themes/next/README.md","hash":"500b5606eb6a09c979d16128f8b00f4bf9bc95ac","modified":1502499216954},{"_id":"themes/next/_config.yml","hash":"9ec2200c25d8a8082cc47c681c9062ac5a67943c","modified":1502499216954},{"_id":"themes/next/bower.json","hash":"be0a430362cb73a7e3cf9ecf51a67edf8214b637","modified":1502499216954},{"_id":"themes/next/gulpfile.coffee","hash":"031bffc483e417b20e90eceb6cf358e7596d2e69","modified":1502499216954},{"_id":"themes/next/package.json","hash":"7e87b2621104b39a30488654c2a8a0c6a563574b","modified":1502499216958},{"_id":"source/_posts/Celery.md","hash":"0328f9271e85b36f13d438c42caffd250f018eef","modified":1502499216942},{"_id":"source/_posts/Docker.md","hash":"a677700e316795e9170cdc0946ce107882de45d1","modified":1502499216942},{"_id":"source/_posts/Gerrit-集锦.md","hash":"f7f5e7fe60b4e7f40c3a75b8085cfd4bd4b018eb","modified":1502509447719},{"_id":"source/_posts/PyPI.md","hash":"d52b09083ec2d87a763b649552123db616f2a7d6","modified":1502499216942},{"_id":"source/_posts/ROS.md","hash":"17c3ba9ce921ddfafae3c36cd0ccc20839866730","modified":1502499216942},{"_id":"source/_posts/Pyramid-Startup.md","hash":"9405864c34d3a1190579bf4abe02083701743520","modified":1502499216942},{"_id":"source/_posts/Robot.md","hash":"812f1017b5097f44c5e4511a5767a4d6d28725ed","modified":1502499216942},{"_id":"source/_posts/Tango-Example-Hello-Video.md","hash":"b137eacf897d9e7f6d4fe2f9adbd3ac4d076d683","modified":1502499216942},{"_id":"source/_posts/Tango-Example-hello-area-description.md","hash":"f4b7cb71c548853ae3b3637e5dbaf834abf2d52b","modified":1502499216942},{"_id":"source/_posts/Tango-Example-hello-depth-perception.md","hash":"db067dbd5d500ba00020bacca64104fd753f3fb5","modified":1502499216942},{"_id":"source/_posts/Ubuntu-apt-mirror.md","hash":"b947a576e777854a86fa043b68fb0a8108abbcbc","modified":1502499216942},{"_id":"source/_posts/Ubuntu-用户与权限.md","hash":"40d0a094efe4d48933937badb5c9c4b193c6ef18","modified":1502499216942},{"_id":"source/_posts/Ubuntu-配置-Gerrit-与-Apache.md","hash":"cf6097818862d7570aa05ac02c731adbf3c885d1","modified":1502499216942},{"_id":"source/_posts/WebKit渲染流程.md","hash":"1a97533c6ae1b4a8f19494a325312dd85308bac7","modified":1502499216942},{"_id":"source/_posts/hello-world.md","hash":"e5b7607243f6f90ec99fdd237a6355bf55dacd90","modified":1502499216942},{"_id":"source/categories/index.md","hash":"95cb039a0939be693ad100a57d9ddff933b930ce","modified":1502499216942},{"_id":"source/tags/index.md","hash":"6514979b508db706262b374a9a50307252fbc65e","modified":1502499216942},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"3b5eafd32abb718e56ccf8d1cee0607ad8ce611d","modified":1502499216954},{"_id":"themes/next/.github/ISSUE_TEMPLATE.md","hash":"fdd63b77472612337309eb93ec415a059b90756b","modified":1502499216954},{"_id":"themes/next/languages/de.yml","hash":"306db8c865630f32c6b6260ade9d3209fbec8011","modified":1502499216954},{"_id":"themes/next/languages/default.yml","hash":"4cc6aeb1ac09a58330e494c8771773758ab354af","modified":1502499216954},{"_id":"themes/next/languages/en.yml","hash":"e7def07a709ef55684490b700a06998c67f35f39","modified":1502499216954},{"_id":"themes/next/languages/fr-FR.yml","hash":"24180322c83587a153cea110e74e96eacc3355ad","modified":1502499216954},{"_id":"themes/next/languages/id.yml","hash":"2835ea80dadf093fcf47edd957680973f1fb6b85","modified":1502499216954},{"_id":"themes/next/languages/ja.yml","hash":"1c3a05ab80a6f8be63268b66da6f19da7aa2c638","modified":1502499216954},{"_id":"themes/next/languages/ko.yml","hash":"be150543379150f78329815af427bf152c0e9431","modified":1502499216954},{"_id":"themes/next/languages/pt-BR.yml","hash":"958e49571818a34fdf4af3232a07a024050f8f4e","modified":1502499216954},{"_id":"themes/next/languages/pt.yml","hash":"36c8f60dacbe5d27d84d0e0d6974d7679f928da0","modified":1502499216954},{"_id":"themes/next/languages/ru.yml","hash":"1549a7c2fe23caa7cbedcd0aa2b77c46e57caf27","modified":1502499216954},{"_id":"themes/next/languages/zh-Hans.yml","hash":"3c0c7dfd0256457ee24df9e9879226c58cb084b5","modified":1502499216954},{"_id":"themes/next/languages/zh-hk.yml","hash":"1c917997413bf566cb79e0975789f3c9c9128ccd","modified":1502499216954},{"_id":"themes/next/languages/zh-tw.yml","hash":"0b2c18aa76570364003c8d1cd429fa158ae89022","modified":1502499216954},{"_id":"themes/next/layout/_layout.swig","hash":"9d1a23a6add6f3d0f88c2d17979956f14aaa37a4","modified":1502499216954},{"_id":"themes/next/layout/archive.swig","hash":"5de4dca06b05d99e4f6bad617a4b8f4f3592fb01","modified":1502499216958},{"_id":"themes/next/layout/category.swig","hash":"82e7bc278559b4335ad974659104eaaf04863032","modified":1502499216958},{"_id":"themes/next/layout/index.swig","hash":"03e8a2cda03bad42ac0cb827025eb81f95d496a2","modified":1502499216958},{"_id":"themes/next/layout/page.swig","hash":"2c6a78999133b991d9221f484aee2eacae894251","modified":1502499216958},{"_id":"themes/next/layout/post.swig","hash":"2d5f8d7f0a96b611e2d5a5e4d111fc17726a990f","modified":1502499216958},{"_id":"themes/next/layout/schedule.swig","hash":"f93c53f6fd5c712584f6efba6f770c30fa8a3e80","modified":1502499216958},{"_id":"themes/next/layout/tag.swig","hash":"2e73ee478e981092ea9a5d10dd472a9461db395b","modified":1502499216958},{"_id":"themes/next/scripts/merge-configs.js","hash":"13c8b3a2d9fce06c2488820d9248d190c8100e0a","modified":1502499216958},{"_id":"themes/next/scripts/merge.js","hash":"9130dabe6a674c54b535f322b17d75fe6081472f","modified":1502499216958},{"_id":"themes/next/test/.jshintrc","hash":"19f93d13d1689fe033c82eb2d5f3ce30b6543cc0","modified":1502499216974},{"_id":"themes/next/test/helpers.js","hash":"a1f5de25154c3724ffc24a91ddc576cdbd60864f","modified":1502499216974},{"_id":"themes/next/test/intern.js","hash":"11fa8a4f5c3b4119a179ae0a2584c8187f907a73","modified":1502499216974},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1502499216958},{"_id":"themes/next/layout/_custom/header.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1502499216954},{"_id":"themes/next/layout/_custom/sidebar.swig","hash":"adc83b19e793491b1c6ea0fd8b46cd9f32e592fc","modified":1502499216954},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"31322a7f57936cf2dc62e824af5490da5354cf02","modified":1502499216954},{"_id":"themes/next/layout/_macro/post-copyright.swig","hash":"b16fcbf0efd20c018d7545257a8533c497ea7647","modified":1502499216954},{"_id":"themes/next/layout/_macro/post.swig","hash":"c00261ee0dca8ef7d3f7753e8f8cd444f51118c4","modified":1502499216954},{"_id":"themes/next/layout/_macro/reward.swig","hash":"37e5b7c42ec17b9b6b786c5512bcc481a21c974e","modified":1502499216954},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"911b99ba0445b2c07373128d87a4ef2eb7de341a","modified":1502499216954},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"14e785adeb0e671ba0ff9a553e6f0d8def6c670c","modified":1502499216954},{"_id":"themes/next/layout/_partials/comments.swig","hash":"1c7d3c975e499b9aa3119d6724b030b7b00fc87e","modified":1502499216954},{"_id":"themes/next/layout/_partials/footer.swig","hash":"7172c6053118b7c291a56a7860128a652ae66b83","modified":1502499216954},{"_id":"themes/next/layout/_partials/head.swig","hash":"d4a05c51aac02f1f6248baccf2ddb8ee12b9122f","modified":1502499216954},{"_id":"themes/next/layout/_partials/header.swig","hash":"a1ffbb691dfad3eaf2832a11766e58a179003b8b","modified":1502499216954},{"_id":"themes/next/layout/_partials/page-header.swig","hash":"1efd925d34a5d4ba2dc0838d9c86ba911e705fc9","modified":1502499216954},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9e8e21d194ef44d271b1cca0bc1448c14d7edf4f","modified":1502499216954},{"_id":"themes/next/layout/_partials/search.swig","hash":"9dbd378e94abfcb3f864a5b8dbbf18d212ca2ee0","modified":1502499216954},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"03aaebe9d50f6acb007ec38cc04acd1cfceb404d","modified":1502499216954},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"766b2bdda29523ed6cd8d7aa197f996022f8fd94","modified":1502499216954},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"9baf90f7c40b3b10f288e9268c3191e895890cea","modified":1502499216954},{"_id":"themes/next/layout/_third-party/duoshuo-hot-articles.swig","hash":"5d4638c46aef65bf32a01681495b62416ccc98db","modified":1502499216954},{"_id":"themes/next/layout/_third-party/exturl.swig","hash":"7c04a42319d728be356746363aff8ea247791d24","modified":1502499216954},{"_id":"themes/next/layout/_third-party/mathjax.swig","hash":"6d25596d6a7c57700d37b607f8d9a62d89708683","modified":1502499216954},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"22369026c87fc23893c35a7f250b42f3bb1b60f1","modified":1502499216954},{"_id":"themes/next/layout/_third-party/scroll-cookie.swig","hash":"1ddb2336a1a19b47af3017047012c01ec5f54529","modified":1502499216954},{"_id":"themes/next/scripts/tags/button.js","hash":"62e6dbeb53d07627a048132c79630b45d9a8f2cc","modified":1502499216958},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"535fc542781021c4326dec24d8495cbb1387634a","modified":1502499216958},{"_id":"themes/next/scripts/tags/exturl.js","hash":"8d7e60f60779bde050d20fd76f6fdc36fc85e06d","modified":1502499216958},{"_id":"themes/next/scripts/tags/full-image.js","hash":"8eeb3fb89540299bdbb799edfdfdac3743b50596","modified":1502499216958},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"49252824cd53184dc9b97b2f2d87ff28e1b3ef27","modified":1502499216958},{"_id":"themes/next/scripts/tags/note.js","hash":"6752925eedbdb939d8ec4d11bdfb75199f18dd70","modified":1502499216958},{"_id":"themes/next/source/css/main.styl","hash":"20702c48d6053c92c5bcdbc68e8d0ef1369848a0","modified":1502499216958},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"90035272fa31a3f65b3c0e2cb8a633876ef457dc","modified":1502499216958},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1502499216958},{"_id":"themes/next/source/images/avatar.jpg","hash":"de436c380f4c2e8cd9bee98b495db3250ef15b54","modified":1502499216958},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1502499216958},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1502499216958},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1502499216958},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1502499216958},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1502499216958},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1502499216958},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1502499216958},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1502499216958},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1502499216958},{"_id":"themes/next/source/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1502499216962},{"_id":"themes/next/source/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1502499216962},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1502499216962},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1502499216954},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1502499216954},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1502499216958},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1502499216958},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1502499216958},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1502499216958},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1502499216958},{"_id":"themes/next/layout/_partials/head/custom-head.swig","hash":"4efa1f3d64e2038960dcaea8a74df34b43255f44","modified":1502499216954},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"7ce76358411184482bb0934e70037949dd0da8ca","modified":1502499216954},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"957701729b85fb0c5bfcf2fb99c19d54582f91ed","modified":1502499216954},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"959b7e04a96a5596056e4009b73b6489c117597e","modified":1502499216954},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"eefe2388ff3d424694045eda21346989b123977c","modified":1502499216954},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"23e23dc0f76ef3c631f24c65277adf7ea517b383","modified":1502499216954},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"1f1107468aaf03f7d0dcd7eb2b653e2813a675b4","modified":1502499216954},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"89c5a5240ecb223acfe1d12377df5562a943fd5d","modified":1502499216954},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"63315fcf210799f894208c9f512737096df84962","modified":1502499216954},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"069d1357c717572256e5cdee09574ebce529cbae","modified":1502499216954},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"60426bf73f8a89ba61fb1be2df3ad5398e32c4ef","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"deda6a814ed48debc694c4e0c466f06c127163d0","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"18e7bef8923d83ea42df6c97405e515a876cede4","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"8160b27bee0aa372c7dc7c8476c05bae57f58d0f","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"394d008e5e94575280407ad8a1607a028026cbc3","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"5d9943d74cc2e0a91badcf4f755c6de77eab193a","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"3358d11b9a26185a2d36c96049e4340e701646e4","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"92dc60821307fc9769bea9b2d60adaeb798342af","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"3658414379e0e8a34c45c40feadc3edc8dc55f88","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"a652f202bd5b30c648c228ab8f0e997eb4928e44","modified":1502499216954},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"c3971fd154d781088e1cc665035f8561a4098f4c","modified":1502499216954},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"0e3378f7c39b2b0f69638290873ede6b6b6825c0","modified":1502499216954},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"c316758546dc9ba6c60cb4d852c17ca6bb6d6724","modified":1502499216954},{"_id":"themes/next/layout/_third-party/comments/duoshuo.swig","hash":"a356b2185d40914447fde817eb3d358ab6b3e4c3","modified":1502499216954},{"_id":"themes/next/layout/_third-party/comments/gentie.swig","hash":"03592d1d731592103a41ebb87437fe4b0a4c78ca","modified":1502499216954},{"_id":"themes/next/layout/_third-party/comments/hypercomments.swig","hash":"3e8dc5c6c912628a37e3b5f886bec7b2e5ed14ea","modified":1502499216954},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"abb92620197a16ed2c0775edf18a0f044a82256e","modified":1502499216954},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"1d0d01aaeb7bcde3671263d736718f8837c20182","modified":1502499216954},{"_id":"themes/next/layout/_third-party/comments/youyan.swig","hash":"af9dd8a4aed7d06cf47b363eebff48850888566c","modified":1502499216954},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"c747fb5c6b1f500e8f0c583e44195878b66e4e29","modified":1502499216958},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"1f349aa30dd1f7022f7d07a1f085eea5ace3f26d","modified":1502499216958},{"_id":"themes/next/layout/_third-party/search/tinysou.swig","hash":"cb3a5d36dbe1630bab84e03a52733a46df7c219b","modified":1502499216958},{"_id":"themes/next/layout/_third-party/seo/baidu-push.swig","hash":"c057b17f79e8261680fbae8dc4e81317a127c799","modified":1502499216958},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"328d9a9696cc2ccf59c67d3c26000d569f46344c","modified":1502499216958},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"715d5b40dc52f319fe4bff0325beb874774d9bd9","modified":1502499216958},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"78a83c38f69a8747bb74e420e6c9eeef1ea76525","modified":1502499216958},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"c8d35a6b9e3bff6d8fdb66de853065af9d37562d","modified":1502499216958},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"06f432f328a5b8a9ef0dbd5301b002aba600b4ce","modified":1502499216958},{"_id":"themes/next/source/css/_variables/base.styl","hash":"d6a793bcada68d4b6c58392546bc48a482e4a7d3","modified":1502499216958},{"_id":"themes/next/source/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1502499216962},{"_id":"themes/next/source/js/src/algolia-search.js","hash":"b172f697ed339a24b1e80261075232978d164c35","modified":1502499216962},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"aab7be0a6e2724b3faa9338db93c19556c559625","modified":1502499216962},{"_id":"themes/next/source/js/src/exturl.js","hash":"e42e2aaab7bf4c19a0c8e779140e079c6aa5c0b1","modified":1502499216962},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1502499216962},{"_id":"themes/next/source/js/src/js.cookie.js","hash":"9b37973a90fd50e71ea91682265715e45ae82c75","modified":1502499216962},{"_id":"themes/next/source/js/src/motion.js","hash":"269414e84df544a4ccb88519f6abae4943db3c67","modified":1502499216962},{"_id":"themes/next/source/js/src/post-details.js","hash":"af7a417dd1cb02465a7b98211653e7c6192e6d55","modified":1502499216962},{"_id":"themes/next/source/js/src/scroll-cookie.js","hash":"09dc828cbf5f31158ff6250d2bf7c3cde6365c67","modified":1502499216962},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1502499216962},{"_id":"themes/next/source/js/src/utils.js","hash":"803f684fa7d0e729115a48851023a31f6fb6d0a7","modified":1502499216962},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.css","hash":"90ef19edc982645b118b095615838d9c5eaba0de","modified":1502499216962},{"_id":"themes/next/source/lib/canvas-nest/canvas-nest.min.js","hash":"0387e75e23b1db108a755073fe52a0d03eb391a7","modified":1502499216966},{"_id":"themes/next/source/lib/canvas-ribbon/canvas-ribbon.js","hash":"3587602ad777b031628bb5944864d1a4fcfea4ac","modified":1502499216966},{"_id":"themes/next/source/lib/fastclick/.bower.json","hash":"93ebd5b35e632f714dcf1753e1f6db77ec74449b","modified":1502499216966},{"_id":"themes/next/source/lib/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1502499216966},{"_id":"themes/next/source/lib/fastclick/README.md","hash":"1decd8e1adad2cd6db0ab50cf56de6035156f4ea","modified":1502499216966},{"_id":"themes/next/source/lib/fastclick/bower.json","hash":"13379463c7463b4b96d13556b46faa4cc38d81e6","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"a2aaaf12378db56bd10596ba3daae30950eac051","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"69d152fa46b517141ec3b1114dd6134724494d83","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"dcf470ab3a358103bb896a539cc03caeda10fa8b","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"279a8a718ab6c930a67c41237f0aac166c1b9440","modified":1502499216966},{"_id":"themes/next/source/lib/jquery/.bower.json","hash":"91745c2cc6c946c7275f952b2b0760b880cea69e","modified":1502499216970},{"_id":"themes/next/source/lib/jquery_lazyload/.bower.json","hash":"b7638afc93e9cd350d0783565ee9a7da6805ad8e","modified":1502499216970},{"_id":"themes/next/source/lib/jquery_lazyload/CONTRIBUTING.md","hash":"4891864c24c28efecd81a6a8d3f261145190f901","modified":1502499216970},{"_id":"themes/next/source/lib/jquery_lazyload/README.md","hash":"895d50fa29759af7835256522e9dd7dac597765c","modified":1502499216970},{"_id":"themes/next/source/lib/jquery_lazyload/bower.json","hash":"65bc85d12197e71c40a55c0cd7f6823995a05222","modified":1502499216970},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1502499216970},{"_id":"themes/next/source/lib/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1502499216970},{"_id":"themes/next/source/lib/three/canvas_lines.min.js","hash":"dce4a3b65f8bf958f973690caa7ec4952f353b0c","modified":1502499216970},{"_id":"themes/next/source/lib/three/canvas_sphere.min.js","hash":"d8ea241a53c135a650f7335d2b6982b899fd58a9","modified":1502499216970},{"_id":"themes/next/source/lib/three/three-waves.min.js","hash":"d968cba6b3a50b3626a02d67b544f349d83b147c","modified":1502499216970},{"_id":"themes/next/source/lib/velocity/.bower.json","hash":"05f960846f1c7a93dab1d3f9a1121e86812e8c88","modified":1502499216974},{"_id":"themes/next/source/lib/velocity/bower.json","hash":"2ec99573e84c7117368beccb9e94b6bf35d2db03","modified":1502499216974},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1502499216974},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1502499216974},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1502499216974},{"_id":"themes/next/source/lib/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1502499216970},{"_id":"themes/next/layout/_third-party/search/algolia-search/assets.swig","hash":"28ff4ed6714c59124569ffcbd10f1173d53ca923","modified":1502499216954},{"_id":"themes/next/layout/_third-party/search/algolia-search/dom.swig","hash":"ba698f49dd3a868c95b240d802f5b1b24ff287e4","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"59ad08bcc6fe9793594869ac2b4c525021453e78","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"ef089a407c90e58eca10c49bc47ec978f96e03ba","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"0dfb4b3ba3180d7285e66f270e1d3fa0f132c3d2","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"471f1627891aca5c0e1973e09fbcb01e1510d193","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"a6bb5256be6195e76addbda12f4ed7c662d65e7a","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"711c8830886619d4f4a0598b0cde5499dce50c62","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"dd8a3b22fc2f222ac6e6c05bd8a773fb039169c0","modified":1502499216958},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"2186be20e317505cd31886f1291429cc21f76703","modified":1502499216958},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"7804e31c44717c9a9ddf0f8482b9b9c1a0f74538","modified":1502499216958},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"9c25c75311e1bd4d68df031d3f2ae6d141a90766","modified":1502499216958},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"ece571f38180febaf02ace8187ead8318a300ea7","modified":1502499216958},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"013619c472c7e4b08311c464fcbe9fcf5edde603","modified":1502499216958},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"64f5d56c08d74a338813df1265580ca0cbf0190b","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"c2d079788d6fc2e9a191ccdae94e50d55bf849dc","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"5ae7906dc7c1d9468c7f4b4a6feddddc555797a1","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"38e5df90c8689a71c978fd83ba74af3d4e4e5386","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"b0dcca862cd0cc6e732e33d975b476d744911742","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"fda14bc35be2e1b332809b55b3d07155a833dbf4","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9a5581a770af8964064fef7afd3e16963e45547f","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"0efa036a15c18f5abb058b7c0fad1dd9ac5eed4c","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"8829bc556ca38bfec4add4f15a2f028092ac6d46","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"82bbaa6322764779a1ac2e2c8390ce901c7972e2","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"a0e2030a606c934fb2c5c7373aaae04a1caac4c5","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"c4ed249798296f60bda02351fe6404fb3ef2126f","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"5b93958239d3d2bf9aeaede44eced2434d784462","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"215de948be49bcf14f06d500cef9f7035e406a43","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"2f878213cb24c5ddc18877f6d15ec5c5f57745ac","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"e3e23751d4ad24e8714b425d768cf68e37de7ded","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"69ecd6c97e7cdfd822ac8102b45ad0ede85050db","modified":1502499216958},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"79da92119bc246fe05d1626ac98426a83ec90a94","modified":1502499216962},{"_id":"themes/next/source/lib/Han/dist/han.min.css","hash":"d9c0b3dc9158e717fde36f554709e6c3a22b5f85","modified":1502499216962},{"_id":"themes/next/source/lib/Han/dist/han.min.js","hash":"f559c68a25065a14f47da954a7617d87263e409d","modified":1502499216962},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1502499216966},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1502499216966},{"_id":"themes/next/source/lib/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1502499216966},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1502499216974},{"_id":"themes/next/source/lib/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1502499216974},{"_id":"themes/next/source/lib/Han/dist/han.css","hash":"38e48f275ad00daa9dcdcb8d9b44e576acda4707","modified":1502499216962},{"_id":"themes/next/source/lib/Han/dist/han.js","hash":"e345397e0585c9fed1449e614ec13e0224acf2ab","modified":1502499216962},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1502499216970},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1502499216970},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1502499216974},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"8994ffcce84deac0471532f270f97c44fea54dc0","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"ae1ca14e51de67b07dba8f61ec79ee0e2e344574","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d27448f199fc2f9980b601bc22b87f08b5d64dd1","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"8a2421cb9005352905fae9d41a847ae56957247e","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"6c00f6e0978f4d8f9a846a15579963728aaa6a17","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"49c2b2c14a1e7fcc810c6be4b632975d0204c281","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"96f32ea6c3265a3889e6abe57587f6e2a2a40dfb","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"740d37f428b8f4574a76fc95cc25e50e0565f45e","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"b76387934fb6bb75212b23c1a194486892cc495e","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"7778920dd105fa4de3a7ab206eeba30b1a7bac45","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"4eff5b252d7b614e500fc7d52c97ce325e57d3ab","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"2039590632bba3943c39319d80ef630af7928185","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"9bf4362a4d0ae151ada84b219d39fbe5bb8c790e","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"a82afbb72d83ee394aedc7b37ac0008a9823b4f4","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"beccb53dcd658136fb91a0c5678dea8f37d6e0b6","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"dbc07ec641a537df5918b41ce40a6466712a44f6","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"f54367c0feda6986c030cc4d15a0ca6ceea14bcb","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"2cdc094ecf907a02fce25ad4a607cd5c40da0f2b","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"88c7d75646b66b168213190ee4cd874609afd5e3","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"387ce23bba52b22a586b2dfb4ec618fe1ffd3926","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"c089419916988d0f51d89b225460fe11b631e0a3","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"a5d8617a24d7cb6c5ad91ea621183ca2c0917331","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"e792c8dc41561c96d128e9b421187f1c3dc978a0","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"a352ae5b1f8857393bf770d2e638bf15f0c9585d","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"963105a531403d7aad6d9e5e23e3bfabb8ec065a","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"10251257aceecb117233c9554dcf8ecfef8e2104","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"8c0276883398651336853d5ec0e9da267a00dd86","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"2e7ec9aaa3293941106b1bdd09055246aa3c3dc6","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"920343e41c124221a17f050bbb989494d44f7a24","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"5f6ea57aabfa30a437059bf8352f1ad829dbd4ff","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"9486ddd2cb255227db102d09a7df4cae0fabad72","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"45fa7193435a8eae9960267438750b4c9fa9587f","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"7690b9596ec3a49befbe529a5a2649abec0faf76","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"a2ec22ef4a6817bbb2abe8660fcd99fe4ca0cc5e","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"234facd038f144bd0fe09a31ed1357c5d74c517f","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"3623e7fa4324ec1307370f33d8f287a9e20a5578","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"c2abe4d87148e23e15d49ee225bc650de60baf46","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/tags/exturl.styl","hash":"1b3cc9f4e5a7f6e05b4100e9990b37b20d4a2005","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"b8969e1654eec89a0fd10d88b337fee9cb03cd44","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"4851b981020c5cbc354a1af9b831a2dcb3cf9d39","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"74d0ba86f698165d13402670382a822c8736a556","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"dd310c2d999185e881db007360176ee2f811df10","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"fd42777b9125fd8969dc39d4f15473e2b91b4142","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"93b08815c4d17e2b96fef8530ec1f1064dede6ef","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"d4e6d8d7b34dc69994593c208f875ae8f7e8a3ae","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"2340dd9b3202c61d73cc708b790fac5adddbfc7f","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/third-party/gentie.styl","hash":"586a3ec0f1015e7207cd6a2474362e068c341744","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/third-party/han.styl","hash":"cce6772e2cdb4db85d35486ae4c6c59367fbdd40","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"327b5f63d55ec26f7663185c1a778440588d9803","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"d89c4b562b528e4746696b2ad8935764d133bdae","modified":1502499216958},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"bb3be8374c31c372ed0995bd8030d2b920d581de","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"5dc4859c66305f871e56cba78f64bfe3bf1b5f01","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1502499216958},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1502499216958},{"_id":"themes/next/source/lib/Han/dist/font/han-space.otf","hash":"07436f011b44051f61b8329c99de4bec64e86f4b","modified":1502499216962},{"_id":"themes/next/source/lib/Han/dist/font/han-space.woff","hash":"7a635062b10bf5662ae1d218ba0980171005d060","modified":1502499216962},{"_id":"themes/next/source/lib/Han/dist/font/han.otf","hash":"f1f6bb8f461f5672e000380195d3d2358a28494c","modified":1502499216962},{"_id":"themes/next/source/lib/Han/dist/font/han.woff","hash":"f38ff9b2eecaa17b50b66aa2dae87e9e7436d195","modified":1502499216962},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1502499216966},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/fonts/FontAwesome.otf","hash":"048707bc52ac4b6563aaa383bfe8660a0ddc908c","modified":1502499216966},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1502499216970},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.ttf","hash":"13b1eab65a983c7a73bc7997c479d66943f7c6cb","modified":1502499216970},{"_id":"themes/next/source/lib/algolia-instant-search/instantsearch.min.js","hash":"9ccc6f8144f54e86df9a3fd33a18368d81cf3a4f","modified":1502499216966},{"_id":"themes/next/source/lib/three/three.min.js","hash":"73f4cdc17e51a72b9bf5b9291f65386d615c483b","modified":1502499216974},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.svg","hash":"98a8aa5cf7d62c2eff5f07ede8d844b874ef06ed","modified":1502499216970},{"_id":"source/_posts/HTTP-Status-Codes.md","hash":"9f5e8489a1b9354adf14f1c38bf2d6ce021ac148","modified":1505821207601},{"_id":"source/_posts/硬件加速.md","hash":"63f34330d2191e3ce439840677096000f67a0415","modified":1505054175902}],"Category":[{"name":"Python","_id":"cj68r48dp0003nki34bpxjago"},{"name":"Docker","_id":"cj68r48e10008nki3ssnhfjkv"},{"name":"Gerrit","_id":"cj68r48e8000dnki3f0tmw7bn"},{"name":"ROS","_id":"cj68r48ef000lnki3jwqia8la"},{"name":"Robot","_id":"cj68r48el000snki30sntc6pv"},{"name":"Tango","_id":"cj68r48er000ynki3nma4hjtj"},{"name":"Ubuntu","_id":"cj68r48ey001cnki3gquf1vsn"},{"name":"WebKit","_id":"cj68r48ez001lnki3tasteoyq"},{"name":"Hexo","_id":"cj68r48f1001qnki3utooi4ns"},{"name":"HTTP","_id":"cj7rj4rpj0001pri3cylf2tt1"},{"name":"高性能计算","_id":"cj7rj4rrx0006pri3be8rzn8f"}],"Data":[],"Page":[{"title":"categories","type":"categories","date":"2017-07-17T08:53:26.000Z","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ntype: categories\ndate: 2017-07-17 16:53:26\n---\n","updated":"2017-08-12T00:53:36.942Z","path":"categories/index.html","comments":1,"layout":"page","_id":"cj68r48dj0001nki38gyoj2sw","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"tags","type":"tags","date":"2017-07-17T08:49:35.000Z","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ntype: tags\ndate: 2017-07-17 16:49:35\n---\n","updated":"2017-08-12T00:53:36.942Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cj68r48kf002inki3e3j1ysyn","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"Celery","date":"2017-07-10T08:11:29.000Z","_content":"\n## 终止进程\n终止 Celery 相关进程：\n``` bash\nps auxww | grep 'celery worker' | awk '{print $2}' | xargs kill -9\n```\n\n如果使用的是 celeryd：\n``` bash\nps auxww | grep celeryd | awk '{print $2}' | xargs kill -9\n```","source":"_posts/Celery.md","raw":"---\ntitle: Celery\ndate: 2017-07-10 16:11:29\ncategories: Python\ntags: [Python, Celery]\n---\n\n## 终止进程\n终止 Celery 相关进程：\n``` bash\nps auxww | grep 'celery worker' | awk '{print $2}' | xargs kill -9\n```\n\n如果使用的是 celeryd：\n``` bash\nps auxww | grep celeryd | awk '{print $2}' | xargs kill -9\n```","slug":"Celery","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48dd0000nki3mo9egksv","content":"<h2 id=\"终止进程\"><a href=\"#终止进程\" class=\"headerlink\" title=\"终止进程\"></a>终止进程</h2><p>终止 Celery 相关进程：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps auxww | grep <span class=\"string\">'celery worker'</span> | awk <span class=\"string\">'&#123;print $2&#125;'</span> | xargs <span class=\"built_in\">kill</span> -9</div></pre></td></tr></table></figure></p>\n<p>如果使用的是 celeryd：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps auxww | grep celeryd | awk <span class=\"string\">'&#123;print $2&#125;'</span> | xargs <span class=\"built_in\">kill</span> -9</div></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"终止进程\"><a href=\"#终止进程\" class=\"headerlink\" title=\"终止进程\"></a>终止进程</h2><p>终止 Celery 相关进程：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps auxww | grep <span class=\"string\">'celery worker'</span> | awk <span class=\"string\">'&#123;print $2&#125;'</span> | xargs <span class=\"built_in\">kill</span> -9</div></pre></td></tr></table></figure></p>\n<p>如果使用的是 celeryd：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps auxww | grep celeryd | awk <span class=\"string\">'&#123;print $2&#125;'</span> | xargs <span class=\"built_in\">kill</span> -9</div></pre></td></tr></table></figure></p>\n"},{"title":"Docker","date":"2017-07-10T08:13:19.000Z","_content":"\n## 退出容器\n退出容器有两种方式：\n  * ctrl+d 退出容器且关闭, docker ps 查看无\n  * ctrl+p+q 退出容器但不关闭, docker ps 查看有\n\n## 关于 GUI\n参考 stackoverflow 上的 [Can you run GUI apps in a docker container?](https://stackoverflow.com/questions/16296753/can-you-run-gui-apps-in-a-docker-container)。\n``` bash\n# Dockerfile partial\n\n# Access xserver on the host\nRUN apt-get install -qqy x11-apps\nENV DISPLAY :0\n```\n``` bash\n$ XSOCK=/tmp/.X11-unix\n$ XAUTH=/tmp/.docker.xauth\n$ xauth nlist :0 | sed -e 's/^..../ffff/' | xauth -f $XAUTH nmerge -\n$ docker run --rm -v $XSOCK:$XSOCK -v $XAUTH:$XAUTH -e XAUTHORITY=$XAUTH -t -i mytest xeyes\n```\n\n## Docker 加速\n在阿里云申请加速服务，记下加速器 URL。新建 /etc/docker/daemon.json 并加入如下内容（里面的 URL 就是你加速器的 URL）：\n``` json\n{\n  \"registry-mirrors\": [\"https://1inmm0s4.mirror.aliyuncs.com\"]\n}\n```\n上面的加速器如果不能用可以自己在阿里云申请一个，保存后重启 docker 服务以加载配置：\n``` bash\n$ sudo systemctl daemon-reload\n$ sudo systemctl restart docker\n```\n\n## Container自启动\n参考 [How do I auto start docker containers at system boot](https://serverfault.com/questions/633067/how-do-i-auto-start-docker-containers-at-system-boot)。\n``` bash\n$ docker run --restart=always -d redis\n```\n\n## Docker Compose\n\n### nvidia-docker\n参考 [Use nvidia-docker-compose](https://stackoverflow.com/questions/41346401/use-nvidia-docker-compose-launch-a-container-but-exited-soon)。\n如果你运行过 nvidia-docker，该参考中的第二步就不需要了，nvidia-docker 会自动创建 volume nvidia_driver_<version>。\n``` yaml\nversion: '3'\n\nvolumes:\n  nvidia_driver_375.66:  # 使用 docker volume ls 查看，与之匹配\n    external: true  # this will use the volume we created above\n\nservices:\n  cuda:\n    command: nvidia-smi\n    devices:  # this is required\n      - /dev/nvidiactl\n      - /dev/nvidia-uvm\n      - /dev/nvidia0  # in general: /dev/nvidia# where # depends on which gpu card is wanted to be used\n    image: nvidia/cuda:8.0-runtime-ubuntu16.04\n    volumes:\n      - nvidia_driver_375.66:/usr/local/nvidia/:ro\n```\n\n### Variables & Template\n\n有两种简单的方式实现变量功能。\n\n** Environment file **\n\nDocker compose 是支持 environment file 的，详细可参考官方文档 [Declare default environment variables in file](https://docs.docker.com/compose/env-file/)。\n\n如果没有特别指定，默认的 environment file 就是与 compose file 同一目录的 .env 文件。Environment file 的内容是一些键值对，compose 将他们应用到 compose file 所声明的变量。这种方式有不足：无法作为 compose file 内容的 key，如果有这种需求，请看接下来的另一种方式。\n\n** envsubst **\n\n参考 [How to use environment variables in docker compose](https://stackoverflow.com/questions/29377853/how-to-use-environment-variables-in-docker-compose)。","source":"_posts/Docker.md","raw":"---\ntitle: Docker\ndate: 2017-07-10 16:13:19\ncategories: Docker\ntags: Docker\n---\n\n## 退出容器\n退出容器有两种方式：\n  * ctrl+d 退出容器且关闭, docker ps 查看无\n  * ctrl+p+q 退出容器但不关闭, docker ps 查看有\n\n## 关于 GUI\n参考 stackoverflow 上的 [Can you run GUI apps in a docker container?](https://stackoverflow.com/questions/16296753/can-you-run-gui-apps-in-a-docker-container)。\n``` bash\n# Dockerfile partial\n\n# Access xserver on the host\nRUN apt-get install -qqy x11-apps\nENV DISPLAY :0\n```\n``` bash\n$ XSOCK=/tmp/.X11-unix\n$ XAUTH=/tmp/.docker.xauth\n$ xauth nlist :0 | sed -e 's/^..../ffff/' | xauth -f $XAUTH nmerge -\n$ docker run --rm -v $XSOCK:$XSOCK -v $XAUTH:$XAUTH -e XAUTHORITY=$XAUTH -t -i mytest xeyes\n```\n\n## Docker 加速\n在阿里云申请加速服务，记下加速器 URL。新建 /etc/docker/daemon.json 并加入如下内容（里面的 URL 就是你加速器的 URL）：\n``` json\n{\n  \"registry-mirrors\": [\"https://1inmm0s4.mirror.aliyuncs.com\"]\n}\n```\n上面的加速器如果不能用可以自己在阿里云申请一个，保存后重启 docker 服务以加载配置：\n``` bash\n$ sudo systemctl daemon-reload\n$ sudo systemctl restart docker\n```\n\n## Container自启动\n参考 [How do I auto start docker containers at system boot](https://serverfault.com/questions/633067/how-do-i-auto-start-docker-containers-at-system-boot)。\n``` bash\n$ docker run --restart=always -d redis\n```\n\n## Docker Compose\n\n### nvidia-docker\n参考 [Use nvidia-docker-compose](https://stackoverflow.com/questions/41346401/use-nvidia-docker-compose-launch-a-container-but-exited-soon)。\n如果你运行过 nvidia-docker，该参考中的第二步就不需要了，nvidia-docker 会自动创建 volume nvidia_driver_<version>。\n``` yaml\nversion: '3'\n\nvolumes:\n  nvidia_driver_375.66:  # 使用 docker volume ls 查看，与之匹配\n    external: true  # this will use the volume we created above\n\nservices:\n  cuda:\n    command: nvidia-smi\n    devices:  # this is required\n      - /dev/nvidiactl\n      - /dev/nvidia-uvm\n      - /dev/nvidia0  # in general: /dev/nvidia# where # depends on which gpu card is wanted to be used\n    image: nvidia/cuda:8.0-runtime-ubuntu16.04\n    volumes:\n      - nvidia_driver_375.66:/usr/local/nvidia/:ro\n```\n\n### Variables & Template\n\n有两种简单的方式实现变量功能。\n\n** Environment file **\n\nDocker compose 是支持 environment file 的，详细可参考官方文档 [Declare default environment variables in file](https://docs.docker.com/compose/env-file/)。\n\n如果没有特别指定，默认的 environment file 就是与 compose file 同一目录的 .env 文件。Environment file 的内容是一些键值对，compose 将他们应用到 compose file 所声明的变量。这种方式有不足：无法作为 compose file 内容的 key，如果有这种需求，请看接下来的另一种方式。\n\n** envsubst **\n\n参考 [How to use environment variables in docker compose](https://stackoverflow.com/questions/29377853/how-to-use-environment-variables-in-docker-compose)。","slug":"Docker","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48dl0002nki3g55eo9z6","content":"<h2 id=\"退出容器\"><a href=\"#退出容器\" class=\"headerlink\" title=\"退出容器\"></a>退出容器</h2><p>退出容器有两种方式：</p>\n<ul>\n<li>ctrl+d 退出容器且关闭, docker ps 查看无</li>\n<li>ctrl+p+q 退出容器但不关闭, docker ps 查看有</li>\n</ul>\n<h2 id=\"关于-GUI\"><a href=\"#关于-GUI\" class=\"headerlink\" title=\"关于 GUI\"></a>关于 GUI</h2><p>参考 stackoverflow 上的 <a href=\"https://stackoverflow.com/questions/16296753/can-you-run-gui-apps-in-a-docker-container\" target=\"_blank\" rel=\"external\">Can you run GUI apps in a docker container?</a>。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># Dockerfile partial</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Access xserver on the host</span></div><div class=\"line\">RUN apt-get install -qqy x11-apps</div><div class=\"line\">ENV DISPLAY :0</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ XSOCK=/tmp/.X11-unix</div><div class=\"line\">$ XAUTH=/tmp/.docker.xauth</div><div class=\"line\">$ xauth nlist :0 | sed -e <span class=\"string\">'s/^..../ffff/'</span> | xauth -f <span class=\"variable\">$XAUTH</span> nmerge -</div><div class=\"line\">$ docker run --rm -v <span class=\"variable\">$XSOCK</span>:<span class=\"variable\">$XSOCK</span> -v <span class=\"variable\">$XAUTH</span>:<span class=\"variable\">$XAUTH</span> -e XAUTHORITY=<span class=\"variable\">$XAUTH</span> -t -i mytest xeyes</div></pre></td></tr></table></figure>\n<h2 id=\"Docker-加速\"><a href=\"#Docker-加速\" class=\"headerlink\" title=\"Docker 加速\"></a>Docker 加速</h2><p>在阿里云申请加速服务，记下加速器 URL。新建 /etc/docker/daemon.json 并加入如下内容（里面的 URL 就是你加速器的 URL）：<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"registry-mirrors\"</span>: [<span class=\"string\">\"https://1inmm0s4.mirror.aliyuncs.com\"</span>]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>上面的加速器如果不能用可以自己在阿里云申请一个，保存后重启 docker 服务以加载配置：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo systemctl daemon-reload</div><div class=\"line\">$ sudo systemctl restart docker</div></pre></td></tr></table></figure></p>\n<h2 id=\"Container自启动\"><a href=\"#Container自启动\" class=\"headerlink\" title=\"Container自启动\"></a>Container自启动</h2><p>参考 <a href=\"https://serverfault.com/questions/633067/how-do-i-auto-start-docker-containers-at-system-boot\" target=\"_blank\" rel=\"external\">How do I auto start docker containers at system boot</a>。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ docker run --restart=always -d redis</div></pre></td></tr></table></figure></p>\n<h2 id=\"Docker-Compose\"><a href=\"#Docker-Compose\" class=\"headerlink\" title=\"Docker Compose\"></a>Docker Compose</h2><h3 id=\"nvidia-docker\"><a href=\"#nvidia-docker\" class=\"headerlink\" title=\"nvidia-docker\"></a>nvidia-docker</h3><p>参考 <a href=\"https://stackoverflow.com/questions/41346401/use-nvidia-docker-compose-launch-a-container-but-exited-soon\" target=\"_blank\" rel=\"external\">Use nvidia-docker-compose</a>。<br>如果你运行过 nvidia-docker，该参考中的第二步就不需要了，nvidia-docker 会自动创建 volume nvidia<em>driver</em><version>。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"attr\">volumes:</span></div><div class=\"line\">  <span class=\"string\">nvidia_driver_375.66:</span>  <span class=\"comment\"># 使用 docker volume ls 查看，与之匹配</span></div><div class=\"line\"><span class=\"attr\">    external:</span> <span class=\"literal\">true</span>  <span class=\"comment\"># this will use the volume we created above</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"attr\">services:</span></div><div class=\"line\"><span class=\"attr\">  cuda:</span></div><div class=\"line\"><span class=\"attr\">    command:</span> <span class=\"string\">nvidia-smi</span></div><div class=\"line\"><span class=\"attr\">    devices:</span>  <span class=\"comment\"># this is required</span></div><div class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/dev/nvidiactl</span></div><div class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/dev/nvidia-uvm</span></div><div class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/dev/nvidia0</span>  <span class=\"comment\"># in general: /dev/nvidia# where # depends on which gpu card is wanted to be used</span></div><div class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">nvidia/cuda:8.0-runtime-ubuntu16.04</span></div><div class=\"line\"><span class=\"attr\">    volumes:</span></div><div class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">nvidia_driver_375.66:/usr/local/nvidia/:ro</span></div></pre></td></tr></table></figure></version></p>\n<h3 id=\"Variables-amp-Template\"><a href=\"#Variables-amp-Template\" class=\"headerlink\" title=\"Variables &amp; Template\"></a>Variables &amp; Template</h3><p>有两种简单的方式实现变量功能。</p>\n<p><strong> Environment file </strong></p>\n<p>Docker compose 是支持 environment file 的，详细可参考官方文档 <a href=\"https://docs.docker.com/compose/env-file/\" target=\"_blank\" rel=\"external\">Declare default environment variables in file</a>。</p>\n<p>如果没有特别指定，默认的 environment file 就是与 compose file 同一目录的 .env 文件。Environment file 的内容是一些键值对，compose 将他们应用到 compose file 所声明的变量。这种方式有不足：无法作为 compose file 内容的 key，如果有这种需求，请看接下来的另一种方式。</p>\n<p><strong> envsubst </strong></p>\n<p>参考 <a href=\"https://stackoverflow.com/questions/29377853/how-to-use-environment-variables-in-docker-compose\" target=\"_blank\" rel=\"external\">How to use environment variables in docker compose</a>。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"退出容器\"><a href=\"#退出容器\" class=\"headerlink\" title=\"退出容器\"></a>退出容器</h2><p>退出容器有两种方式：</p>\n<ul>\n<li>ctrl+d 退出容器且关闭, docker ps 查看无</li>\n<li>ctrl+p+q 退出容器但不关闭, docker ps 查看有</li>\n</ul>\n<h2 id=\"关于-GUI\"><a href=\"#关于-GUI\" class=\"headerlink\" title=\"关于 GUI\"></a>关于 GUI</h2><p>参考 stackoverflow 上的 <a href=\"https://stackoverflow.com/questions/16296753/can-you-run-gui-apps-in-a-docker-container\" target=\"_blank\" rel=\"external\">Can you run GUI apps in a docker container?</a>。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># Dockerfile partial</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Access xserver on the host</span></div><div class=\"line\">RUN apt-get install -qqy x11-apps</div><div class=\"line\">ENV DISPLAY :0</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ XSOCK=/tmp/.X11-unix</div><div class=\"line\">$ XAUTH=/tmp/.docker.xauth</div><div class=\"line\">$ xauth nlist :0 | sed -e <span class=\"string\">'s/^..../ffff/'</span> | xauth -f <span class=\"variable\">$XAUTH</span> nmerge -</div><div class=\"line\">$ docker run --rm -v <span class=\"variable\">$XSOCK</span>:<span class=\"variable\">$XSOCK</span> -v <span class=\"variable\">$XAUTH</span>:<span class=\"variable\">$XAUTH</span> -e XAUTHORITY=<span class=\"variable\">$XAUTH</span> -t -i mytest xeyes</div></pre></td></tr></table></figure>\n<h2 id=\"Docker-加速\"><a href=\"#Docker-加速\" class=\"headerlink\" title=\"Docker 加速\"></a>Docker 加速</h2><p>在阿里云申请加速服务，记下加速器 URL。新建 /etc/docker/daemon.json 并加入如下内容（里面的 URL 就是你加速器的 URL）：<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">\"registry-mirrors\"</span>: [<span class=\"string\">\"https://1inmm0s4.mirror.aliyuncs.com\"</span>]</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>上面的加速器如果不能用可以自己在阿里云申请一个，保存后重启 docker 服务以加载配置：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo systemctl daemon-reload</div><div class=\"line\">$ sudo systemctl restart docker</div></pre></td></tr></table></figure></p>\n<h2 id=\"Container自启动\"><a href=\"#Container自启动\" class=\"headerlink\" title=\"Container自启动\"></a>Container自启动</h2><p>参考 <a href=\"https://serverfault.com/questions/633067/how-do-i-auto-start-docker-containers-at-system-boot\" target=\"_blank\" rel=\"external\">How do I auto start docker containers at system boot</a>。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ docker run --restart=always -d redis</div></pre></td></tr></table></figure></p>\n<h2 id=\"Docker-Compose\"><a href=\"#Docker-Compose\" class=\"headerlink\" title=\"Docker Compose\"></a>Docker Compose</h2><h3 id=\"nvidia-docker\"><a href=\"#nvidia-docker\" class=\"headerlink\" title=\"nvidia-docker\"></a>nvidia-docker</h3><p>参考 <a href=\"https://stackoverflow.com/questions/41346401/use-nvidia-docker-compose-launch-a-container-but-exited-soon\" target=\"_blank\" rel=\"external\">Use nvidia-docker-compose</a>。<br>如果你运行过 nvidia-docker，该参考中的第二步就不需要了，nvidia-docker 会自动创建 volume nvidia<em>driver</em><version>。<br><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">'3'</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"attr\">volumes:</span></div><div class=\"line\">  <span class=\"string\">nvidia_driver_375.66:</span>  <span class=\"comment\"># 使用 docker volume ls 查看，与之匹配</span></div><div class=\"line\"><span class=\"attr\">    external:</span> <span class=\"literal\">true</span>  <span class=\"comment\"># this will use the volume we created above</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"attr\">services:</span></div><div class=\"line\"><span class=\"attr\">  cuda:</span></div><div class=\"line\"><span class=\"attr\">    command:</span> <span class=\"string\">nvidia-smi</span></div><div class=\"line\"><span class=\"attr\">    devices:</span>  <span class=\"comment\"># this is required</span></div><div class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/dev/nvidiactl</span></div><div class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/dev/nvidia-uvm</span></div><div class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">/dev/nvidia0</span>  <span class=\"comment\"># in general: /dev/nvidia# where # depends on which gpu card is wanted to be used</span></div><div class=\"line\"><span class=\"attr\">    image:</span> <span class=\"string\">nvidia/cuda:8.0-runtime-ubuntu16.04</span></div><div class=\"line\"><span class=\"attr\">    volumes:</span></div><div class=\"line\"><span class=\"bullet\">      -</span> <span class=\"string\">nvidia_driver_375.66:/usr/local/nvidia/:ro</span></div></pre></td></tr></table></figure></version></p>\n<h3 id=\"Variables-amp-Template\"><a href=\"#Variables-amp-Template\" class=\"headerlink\" title=\"Variables &amp; Template\"></a>Variables &amp; Template</h3><p>有两种简单的方式实现变量功能。</p>\n<p><strong> Environment file </strong></p>\n<p>Docker compose 是支持 environment file 的，详细可参考官方文档 <a href=\"https://docs.docker.com/compose/env-file/\" target=\"_blank\" rel=\"external\">Declare default environment variables in file</a>。</p>\n<p>如果没有特别指定，默认的 environment file 就是与 compose file 同一目录的 .env 文件。Environment file 的内容是一些键值对，compose 将他们应用到 compose file 所声明的变量。这种方式有不足：无法作为 compose file 内容的 key，如果有这种需求，请看接下来的另一种方式。</p>\n<p><strong> envsubst </strong></p>\n<p>参考 <a href=\"https://stackoverflow.com/questions/29377853/how-to-use-environment-variables-in-docker-compose\" target=\"_blank\" rel=\"external\">How to use environment variables in docker compose</a>。</p>\n"},{"title":"Gerrit 集锦","date":"2017-08-11T05:50:04.000Z","_content":"\n## Tag\n\n### Tag 的创建和删除\n\n``` bash\n# Create a tag 'v2.1' and push it to remote server\n$ git tag -m'release v2.1' v2.1\n$ git push origin v2.1\n\n# Remove the created tag 'v2.1'\n$ git tag -d v2.1\n$ git push origin :v2.1\n```","source":"_posts/Gerrit-集锦.md","raw":"---\ntitle: Gerrit 集锦\ndate: 2017-08-11 13:50:04\ncategories: Gerrit\ntags: [Gerrit, Git]\n---\n\n## Tag\n\n### Tag 的创建和删除\n\n``` bash\n# Create a tag 'v2.1' and push it to remote server\n$ git tag -m'release v2.1' v2.1\n$ git push origin v2.1\n\n# Remove the created tag 'v2.1'\n$ git tag -d v2.1\n$ git push origin :v2.1\n```","slug":"Gerrit-集锦","published":1,"updated":"2017-08-12T03:44:07.719Z","_id":"cj68r48dt0005nki3ge775adz","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"Tag\"><a href=\"#Tag\" class=\"headerlink\" title=\"Tag\"></a>Tag</h2><h3 id=\"Tag-的创建和删除\"><a href=\"#Tag-的创建和删除\" class=\"headerlink\" title=\"Tag 的创建和删除\"></a>Tag 的创建和删除</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># Create a tag 'v2.1' and push it to remote server</span></div><div class=\"line\">$ git tag -m<span class=\"string\">'release v2.1'</span> v2.1</div><div class=\"line\">$ git push origin v2.1</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Remove the created tag 'v2.1'</span></div><div class=\"line\">$ git tag -d v2.1</div><div class=\"line\">$ git push origin :v2.1</div></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Tag\"><a href=\"#Tag\" class=\"headerlink\" title=\"Tag\"></a>Tag</h2><h3 id=\"Tag-的创建和删除\"><a href=\"#Tag-的创建和删除\" class=\"headerlink\" title=\"Tag 的创建和删除\"></a>Tag 的创建和删除</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># Create a tag 'v2.1' and push it to remote server</span></div><div class=\"line\">$ git tag -m<span class=\"string\">'release v2.1'</span> v2.1</div><div class=\"line\">$ git push origin v2.1</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># Remove the created tag 'v2.1'</span></div><div class=\"line\">$ git tag -d v2.1</div><div class=\"line\">$ git push origin :v2.1</div></pre></td></tr></table></figure>"},{"title":"PyPI","date":"2017-07-10T08:22:12.000Z","_content":"\n## 使用 pip2pi 构建本地镜像\n\npip2pi 一款构建 PyPi 仓库的工具，项目网址：https://github.com/wolever/pip2pi 。\n\n#### 安装\n``` bash\n$ pip install pip2pi\n```\n\n#### 下载所需要的包\n``` bash\n$ pip2tgz /var/www/pypi/ -r requirements.txt\n$ pip2tgz /var/www/pypi/ pyramid==1.2\n```\n\n#### 构建索引\n``` bash\n$ dir2pi /var/www/pypi/\n```\n\n#### 使用\n``` bash\n$ pip3 install -i http://myserver/pypi/simple --trusted-host myserver --upgrade pip\n```","source":"_posts/PyPI.md","raw":"---\ntitle: PyPI\ndate: 2017-07-10 16:22:12\ncategories: Python\ntags: [Python, PyPI, pip2pi]\n---\n\n## 使用 pip2pi 构建本地镜像\n\npip2pi 一款构建 PyPi 仓库的工具，项目网址：https://github.com/wolever/pip2pi 。\n\n#### 安装\n``` bash\n$ pip install pip2pi\n```\n\n#### 下载所需要的包\n``` bash\n$ pip2tgz /var/www/pypi/ -r requirements.txt\n$ pip2tgz /var/www/pypi/ pyramid==1.2\n```\n\n#### 构建索引\n``` bash\n$ dir2pi /var/www/pypi/\n```\n\n#### 使用\n``` bash\n$ pip3 install -i http://myserver/pypi/simple --trusted-host myserver --upgrade pip\n```","slug":"PyPI","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48dx0006nki3na5fp13j","content":"<h2 id=\"使用-pip2pi-构建本地镜像\"><a href=\"#使用-pip2pi-构建本地镜像\" class=\"headerlink\" title=\"使用 pip2pi 构建本地镜像\"></a>使用 pip2pi 构建本地镜像</h2><p>pip2pi 一款构建 PyPi 仓库的工具，项目网址：<a href=\"https://github.com/wolever/pip2pi\" target=\"_blank\" rel=\"external\">https://github.com/wolever/pip2pi</a> 。</p>\n<h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pip install pip2pi</div></pre></td></tr></table></figure>\n<h4 id=\"下载所需要的包\"><a href=\"#下载所需要的包\" class=\"headerlink\" title=\"下载所需要的包\"></a>下载所需要的包</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pip2tgz /var/www/pypi/ -r requirements.txt</div><div class=\"line\">$ pip2tgz /var/www/pypi/ pyramid==1.2</div></pre></td></tr></table></figure>\n<h4 id=\"构建索引\"><a href=\"#构建索引\" class=\"headerlink\" title=\"构建索引\"></a>构建索引</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ dir2pi /var/www/pypi/</div></pre></td></tr></table></figure>\n<h4 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pip3 install -i http://myserver/pypi/simple --trusted-host myserver --upgrade pip</div></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"使用-pip2pi-构建本地镜像\"><a href=\"#使用-pip2pi-构建本地镜像\" class=\"headerlink\" title=\"使用 pip2pi 构建本地镜像\"></a>使用 pip2pi 构建本地镜像</h2><p>pip2pi 一款构建 PyPi 仓库的工具，项目网址：<a href=\"https://github.com/wolever/pip2pi\" target=\"_blank\" rel=\"external\">https://github.com/wolever/pip2pi</a> 。</p>\n<h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pip install pip2pi</div></pre></td></tr></table></figure>\n<h4 id=\"下载所需要的包\"><a href=\"#下载所需要的包\" class=\"headerlink\" title=\"下载所需要的包\"></a>下载所需要的包</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pip2tgz /var/www/pypi/ -r requirements.txt</div><div class=\"line\">$ pip2tgz /var/www/pypi/ pyramid==1.2</div></pre></td></tr></table></figure>\n<h4 id=\"构建索引\"><a href=\"#构建索引\" class=\"headerlink\" title=\"构建索引\"></a>构建索引</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ dir2pi /var/www/pypi/</div></pre></td></tr></table></figure>\n<h4 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pip3 install -i http://myserver/pypi/simple --trusted-host myserver --upgrade pip</div></pre></td></tr></table></figure>"},{"title":"ROS","date":"2017-07-24T03:13:02.000Z","_content":"\n## ROS\n\n - [Running multiple instances of same node](http://answers.ros.org/question/160071/running-multiple-instances-of-same-node/)","source":"_posts/ROS.md","raw":"---\ntitle: ROS\ndate: 2017-07-24 11:13:02\ncategories: ROS\ntags: [Robot, ROS]\n---\n\n## ROS\n\n - [Running multiple instances of same node](http://answers.ros.org/question/160071/running-multiple-instances-of-same-node/)","slug":"ROS","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48dz0007nki34z9xmpty","content":"<h2 id=\"ROS\"><a href=\"#ROS\" class=\"headerlink\" title=\"ROS\"></a>ROS</h2><ul>\n<li><a href=\"http://answers.ros.org/question/160071/running-multiple-instances-of-same-node/\" target=\"_blank\" rel=\"external\">Running multiple instances of same node</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"ROS\"><a href=\"#ROS\" class=\"headerlink\" title=\"ROS\"></a>ROS</h2><ul>\n<li><a href=\"http://answers.ros.org/question/160071/running-multiple-instances-of-same-node/\" target=\"_blank\" rel=\"external\">Running multiple instances of same node</a></li>\n</ul>\n"},{"title":"Pyramid Startup","date":"2015-08-27T10:12:40.000Z","_content":"\nHere's a high-level time-ordered overview of what happens when you press return after running pserve development.ini.\n\n### Pserve command\nThe pserve command is invoked under your shell with the argument development.ini. As a result, Pyramid recognizes that it is meant to begin to run and serve an application using the information contained within the development.ini file.\n\n### Main section\nThe framework finds a section named either [app:main], [pipeline:main], or [composite:main] in the .ini file. This section represents the configuration of a WSGI application that will be served. If you're using a simple application (e.g. [app:main]), the application's paste.app_factory entry point will be named on the use= line within the section’s configuration.\n\nIf, instead of a simple application, you're using a WSGI pipeline (e.g. a [pipeline:main] section), the application named on the “last” element will refer to your Pyramid application. If instead of a simple application or a pipeline, you're using a “composite” (e.g. [composite:main]), refer to the documentation for that particular composite to understand how to make it refer to your Pyramid application. In most cases, a Pyramid application built from a scaffold will have a single [app:main] section in it, and this will be the application served.\n\n### Logging\nThe framework finds all logging related configuration in the .ini file and uses it to configure the Python standard library logging system for this application. See Logging Configuration for more information.\n\n### Application constructor\nThe application's constructor named by the entry point reference on the use= line of the section representing your Pyramid application is passed the key/value parameters mentioned within the section in which it’s defined. The constructor is meant to return a router instance, which is a WSGI application.<br>\nFor Pyramid applications, the constructor will be a function named main in the __init__.py file within the package in which your application lives. If this function succeeds, it will return a Pyramid router instance. Here’s the contents of an example __init__.py module:\n``` python\nfrom pyramid.config import Configurator\n\ndef main(global_config, **settings):\n    \"\"\" This function returns a Pyramid WSGI application.\n    \"\"\"\n    config = Configurator(settings=settings)\n    config.include('pyramid_chameleon')\n    config.add_static_view('static', 'static', cache_max_age=3600)\n    config.add_route('home', '/')\n    config.scan()\n    return config.make_wsgi_app()\n```\nNote that the constructor function accepts a global_config argument, which is a dictionary of key/value pairs mentioned in the [DEFAULT] section of an .ini file (if [DEFAULT] is present).\nIt also accepts a **settings argument, which collects another set of arbitrary key/value pairs. The arbitrary key/value pairs received by this function in **settings will be composed of all the key/value pairs that are present in the [app:main] section (except for the use= setting) when this function is called by when you run pserve.\n\nOur generated development.ini file looks like so:\n``` ini\n###\n# app configuration\n# http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/environment.html\n###\n\n[app:main]\nuse = egg:MyProject\n\npyramid.reload_templates = true\npyramid.debug_authorization = false\npyramid.debug_notfound = false\npyramid.debug_routematch = false\npyramid.default_locale_name = en\npyramid.includes =\npyramid_debugtoolbar\n\n# By default, the toolbar only appears for clients from IP addresses\n# '127.0.0.1' and '::1'.\n# debugtoolbar.hosts = 127.0.0.1 ::1\n\n###\n# wsgi server configuration\n###\n\n[server:main]\nuse = egg:waitress#main\nhost = 0.0.0.0\nport = 6543\n\n###\n# logging configuration\n# http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/logging.html\n###\n\n[loggers]\nkeys = root, myproject\n\n[handlers]\nkeys = console\n\n[formatters]\nkeys = generic\n\n[logger_root]\nlevel = INFO\nhandlers = console\n\n[logger_myproject]\nlevel = DEBUG\nhandlers =\nqualname = myproject\n\n[handler_console]\nclass = StreamHandler\nargs = (sys.stderr,)\nlevel = NOTSET\nformatter = generic\n\n[formatter_generic]\nformat = %(asctime)s %(levelname)-5.5s [%(name)s][%(threadName)s] %(message)s\n```\n\nIn this case, the myproject.__init__:main function referred to by the entry point URI egg:MyProject (see development.ini for more information about entry point URIs, and how they relate to callables), will receive the key/value pairs {'pyramid.reload_templates':'true', 'pyramid.debug_authorization':'false', 'pyramid.debug_notfound':'false', 'pyramid.debug_routematch':'false', 'pyramid.debug_templates':'true', 'pyramid.default_locale_name':'en'}. See Environment Variables and .ini File Settings for the meanings of these keys.\n\n### Settings dictinary\nThe main function first constructs a Configurator instance, passing the settings dictionary captured via the **settings kwarg as its settings argument.\n\nThe settings dictionary contains all the options in the [app:main] section of our .ini file except the use option (which is internal to PasteDeploy) such as pyramid.reload_templates,\npyramid.debug_authorization, etc.\n\n### Application registry\nThe main function then calls various methods on the instance of the class Configurator created in the previous step. The intent of calling these methods is to populate an application registry, which represents the Pyramid configuration related to the application.\n\n### Call make_wsgi_app\nThe make_wsgi_app() method is called. The result is a router instance. The router is associated with the application registry implied by the configurator previously populated by other methods run against the Configurator. The router is a WSGI application.\n\n### Emmit ApplicationCreated event\nAn ApplicationCreated event is emitted (see Using Events for more information about events).\n\n### Router\nAssuming there were no errors, the main function in myproject returns the router instance created by pyramid.config.Configurator.make_wsgi_app() back to pserve. As far as pserve is concerned, it is “just another WSGI application”.\n\n### WSGI server\npserve starts the WSGI server defined within the [server:main] section. In our case, this is the Waitress server (use = egg:waitress#main), and it will listen on all interfaces (host = 0.0.0.0), on port number 6543 (port = 6543). The server code itself is what prints serving on 0.0.0.0:6543 view at http://127.0.0.1:6543. The server serves the application, and the application is running, waiting to receive requests.\n\n**About development.ini**\n\nThe development.ini file is a PasteDeploy configuration file. Its purpose is to specify an application to run when you invoke pserve, as well as the deployment settings provided to that application.\n\nThis file contains several sections including [app:main], [server:main] and several other sections related to logging configuration.\n\nThe [app:main] section represents configuration for your Pyramid application. The use setting is the only setting required to be present in the [app:main] section. Its default value, egg:MyProject, indicates that our MyProject project contains the application that should be served. Other settings added to this section are passed as keyword arguments to the function named main in our package's __init__.py module. You can provide startup-time configuration parameters to your application by adding more settings to this section.\n\nThe line in [app:main] above that says use = egg:MyProject is actually shorthand for a longer spelling: use = egg:MyProject#main. The #main part is omitted for brevity, as #main is a default defined by PasteDeploy. egg:MyProject#main is a string which has meaning to PasteDeploy. It points at a setuptools entry point named main defined in the MyProject project.\n\nSee Entry Points and PasteDeploy .ini Files for more information about the meaning of the use = egg:MyProject value in this section.\n\nTake a look at the generated setup.py file for this project.\n``` python\nimport os\n\nfrom setuptools import setup, find_packages\n\nhere = os.path.abspath(os.path.dirname(__file__))\nwith open(os.path.join(here, 'README.txt')) as f:\n    README = f.read()\nwith open(os.path.join(here, 'CHANGES.txt')) as f:\n    CHANGES = f.read()\n\nrequires = [\n    'pyramid',\n    'pyramid_chameleon',\n    'pyramid_debugtoolbar',\n    'waitress',\n]\n\nsetup(name='MyProject',\n    version='0.0',\n    description='MyProject',\n    long_description=README + '\\n\\n' + CHANGES,\n    classifiers=[\n        \"Programming Language :: Python\",\n        \"Framework :: Pyramid\",\n        \"Topic :: Internet :: WWW/HTTP\",\n        \"Topic :: Internet :: WWW/HTTP :: WSGI :: Application\",\n    ],\n    author='',\n    author_email='',\n    url='',\n    keywords='web pyramid pylons',\n    packages=find_packages(),\n    include_package_data=True,\n    zip_safe=False,\n    install_requires=requires,\n    tests_require=requires,\n    test_suite=\"myproject\",\n    entry_points=\"\"\"\\\n    [paste.app_factory]\n    main = myproject:main\n    \"\"\",\n)\n```\n\nNote that entry_points is assigned a string which looks a lot like an .ini file. This string representation of an .ini file has a section named [paste.app_factory]. Within this section, there is a\nkey named main (the entry point name) which has a value myproject:main. The key main is what our egg:MyProject#main value of the use section in our config file is pointing at, although it isactually shortened to egg:MyProject there. The value represents a dotted Python name path, which refers to a callable in our myproject package's __init__.py module.\n\nThe egg: prefix in egg:MyProject indicates that this is an entry point URI specifier, where the “scheme” is “egg”. An “egg” is created when you run setup.py install or setup.py develop within your project.\n\nIn English, this entry point can thus be referred to as a “PasteDeploy application factory in the MyProject project which has the entry point named main where the entry point refers to a main function in the mypackage module”. Indeed, if you open up the __init__.py module generated within any scaffold-generated package, you'll see a main function. This is the function called by PasteDeploy when the pserve command is invoked against our application. It accepts a global configuration object and returns an instance of our application.","source":"_posts/Pyramid-Startup.md","raw":"---\ntitle: Pyramid Startup\ndate: 2015-08-27 18:12:40\ncategories: Python\ntags: [Python, Pyramid]\n---\n\nHere's a high-level time-ordered overview of what happens when you press return after running pserve development.ini.\n\n### Pserve command\nThe pserve command is invoked under your shell with the argument development.ini. As a result, Pyramid recognizes that it is meant to begin to run and serve an application using the information contained within the development.ini file.\n\n### Main section\nThe framework finds a section named either [app:main], [pipeline:main], or [composite:main] in the .ini file. This section represents the configuration of a WSGI application that will be served. If you're using a simple application (e.g. [app:main]), the application's paste.app_factory entry point will be named on the use= line within the section’s configuration.\n\nIf, instead of a simple application, you're using a WSGI pipeline (e.g. a [pipeline:main] section), the application named on the “last” element will refer to your Pyramid application. If instead of a simple application or a pipeline, you're using a “composite” (e.g. [composite:main]), refer to the documentation for that particular composite to understand how to make it refer to your Pyramid application. In most cases, a Pyramid application built from a scaffold will have a single [app:main] section in it, and this will be the application served.\n\n### Logging\nThe framework finds all logging related configuration in the .ini file and uses it to configure the Python standard library logging system for this application. See Logging Configuration for more information.\n\n### Application constructor\nThe application's constructor named by the entry point reference on the use= line of the section representing your Pyramid application is passed the key/value parameters mentioned within the section in which it’s defined. The constructor is meant to return a router instance, which is a WSGI application.<br>\nFor Pyramid applications, the constructor will be a function named main in the __init__.py file within the package in which your application lives. If this function succeeds, it will return a Pyramid router instance. Here’s the contents of an example __init__.py module:\n``` python\nfrom pyramid.config import Configurator\n\ndef main(global_config, **settings):\n    \"\"\" This function returns a Pyramid WSGI application.\n    \"\"\"\n    config = Configurator(settings=settings)\n    config.include('pyramid_chameleon')\n    config.add_static_view('static', 'static', cache_max_age=3600)\n    config.add_route('home', '/')\n    config.scan()\n    return config.make_wsgi_app()\n```\nNote that the constructor function accepts a global_config argument, which is a dictionary of key/value pairs mentioned in the [DEFAULT] section of an .ini file (if [DEFAULT] is present).\nIt also accepts a **settings argument, which collects another set of arbitrary key/value pairs. The arbitrary key/value pairs received by this function in **settings will be composed of all the key/value pairs that are present in the [app:main] section (except for the use= setting) when this function is called by when you run pserve.\n\nOur generated development.ini file looks like so:\n``` ini\n###\n# app configuration\n# http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/environment.html\n###\n\n[app:main]\nuse = egg:MyProject\n\npyramid.reload_templates = true\npyramid.debug_authorization = false\npyramid.debug_notfound = false\npyramid.debug_routematch = false\npyramid.default_locale_name = en\npyramid.includes =\npyramid_debugtoolbar\n\n# By default, the toolbar only appears for clients from IP addresses\n# '127.0.0.1' and '::1'.\n# debugtoolbar.hosts = 127.0.0.1 ::1\n\n###\n# wsgi server configuration\n###\n\n[server:main]\nuse = egg:waitress#main\nhost = 0.0.0.0\nport = 6543\n\n###\n# logging configuration\n# http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/logging.html\n###\n\n[loggers]\nkeys = root, myproject\n\n[handlers]\nkeys = console\n\n[formatters]\nkeys = generic\n\n[logger_root]\nlevel = INFO\nhandlers = console\n\n[logger_myproject]\nlevel = DEBUG\nhandlers =\nqualname = myproject\n\n[handler_console]\nclass = StreamHandler\nargs = (sys.stderr,)\nlevel = NOTSET\nformatter = generic\n\n[formatter_generic]\nformat = %(asctime)s %(levelname)-5.5s [%(name)s][%(threadName)s] %(message)s\n```\n\nIn this case, the myproject.__init__:main function referred to by the entry point URI egg:MyProject (see development.ini for more information about entry point URIs, and how they relate to callables), will receive the key/value pairs {'pyramid.reload_templates':'true', 'pyramid.debug_authorization':'false', 'pyramid.debug_notfound':'false', 'pyramid.debug_routematch':'false', 'pyramid.debug_templates':'true', 'pyramid.default_locale_name':'en'}. See Environment Variables and .ini File Settings for the meanings of these keys.\n\n### Settings dictinary\nThe main function first constructs a Configurator instance, passing the settings dictionary captured via the **settings kwarg as its settings argument.\n\nThe settings dictionary contains all the options in the [app:main] section of our .ini file except the use option (which is internal to PasteDeploy) such as pyramid.reload_templates,\npyramid.debug_authorization, etc.\n\n### Application registry\nThe main function then calls various methods on the instance of the class Configurator created in the previous step. The intent of calling these methods is to populate an application registry, which represents the Pyramid configuration related to the application.\n\n### Call make_wsgi_app\nThe make_wsgi_app() method is called. The result is a router instance. The router is associated with the application registry implied by the configurator previously populated by other methods run against the Configurator. The router is a WSGI application.\n\n### Emmit ApplicationCreated event\nAn ApplicationCreated event is emitted (see Using Events for more information about events).\n\n### Router\nAssuming there were no errors, the main function in myproject returns the router instance created by pyramid.config.Configurator.make_wsgi_app() back to pserve. As far as pserve is concerned, it is “just another WSGI application”.\n\n### WSGI server\npserve starts the WSGI server defined within the [server:main] section. In our case, this is the Waitress server (use = egg:waitress#main), and it will listen on all interfaces (host = 0.0.0.0), on port number 6543 (port = 6543). The server code itself is what prints serving on 0.0.0.0:6543 view at http://127.0.0.1:6543. The server serves the application, and the application is running, waiting to receive requests.\n\n**About development.ini**\n\nThe development.ini file is a PasteDeploy configuration file. Its purpose is to specify an application to run when you invoke pserve, as well as the deployment settings provided to that application.\n\nThis file contains several sections including [app:main], [server:main] and several other sections related to logging configuration.\n\nThe [app:main] section represents configuration for your Pyramid application. The use setting is the only setting required to be present in the [app:main] section. Its default value, egg:MyProject, indicates that our MyProject project contains the application that should be served. Other settings added to this section are passed as keyword arguments to the function named main in our package's __init__.py module. You can provide startup-time configuration parameters to your application by adding more settings to this section.\n\nThe line in [app:main] above that says use = egg:MyProject is actually shorthand for a longer spelling: use = egg:MyProject#main. The #main part is omitted for brevity, as #main is a default defined by PasteDeploy. egg:MyProject#main is a string which has meaning to PasteDeploy. It points at a setuptools entry point named main defined in the MyProject project.\n\nSee Entry Points and PasteDeploy .ini Files for more information about the meaning of the use = egg:MyProject value in this section.\n\nTake a look at the generated setup.py file for this project.\n``` python\nimport os\n\nfrom setuptools import setup, find_packages\n\nhere = os.path.abspath(os.path.dirname(__file__))\nwith open(os.path.join(here, 'README.txt')) as f:\n    README = f.read()\nwith open(os.path.join(here, 'CHANGES.txt')) as f:\n    CHANGES = f.read()\n\nrequires = [\n    'pyramid',\n    'pyramid_chameleon',\n    'pyramid_debugtoolbar',\n    'waitress',\n]\n\nsetup(name='MyProject',\n    version='0.0',\n    description='MyProject',\n    long_description=README + '\\n\\n' + CHANGES,\n    classifiers=[\n        \"Programming Language :: Python\",\n        \"Framework :: Pyramid\",\n        \"Topic :: Internet :: WWW/HTTP\",\n        \"Topic :: Internet :: WWW/HTTP :: WSGI :: Application\",\n    ],\n    author='',\n    author_email='',\n    url='',\n    keywords='web pyramid pylons',\n    packages=find_packages(),\n    include_package_data=True,\n    zip_safe=False,\n    install_requires=requires,\n    tests_require=requires,\n    test_suite=\"myproject\",\n    entry_points=\"\"\"\\\n    [paste.app_factory]\n    main = myproject:main\n    \"\"\",\n)\n```\n\nNote that entry_points is assigned a string which looks a lot like an .ini file. This string representation of an .ini file has a section named [paste.app_factory]. Within this section, there is a\nkey named main (the entry point name) which has a value myproject:main. The key main is what our egg:MyProject#main value of the use section in our config file is pointing at, although it isactually shortened to egg:MyProject there. The value represents a dotted Python name path, which refers to a callable in our myproject package's __init__.py module.\n\nThe egg: prefix in egg:MyProject indicates that this is an entry point URI specifier, where the “scheme” is “egg”. An “egg” is created when you run setup.py install or setup.py develop within your project.\n\nIn English, this entry point can thus be referred to as a “PasteDeploy application factory in the MyProject project which has the entry point named main where the entry point refers to a main function in the mypackage module”. Indeed, if you open up the __init__.py module generated within any scaffold-generated package, you'll see a main function. This is the function called by PasteDeploy when the pserve command is invoked against our application. It accepts a global configuration object and returns an instance of our application.","slug":"Pyramid-Startup","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48e2000anki3smiyib5l","content":"<p>Here’s a high-level time-ordered overview of what happens when you press return after running pserve development.ini.</p>\n<h3 id=\"Pserve-command\"><a href=\"#Pserve-command\" class=\"headerlink\" title=\"Pserve command\"></a>Pserve command</h3><p>The pserve command is invoked under your shell with the argument development.ini. As a result, Pyramid recognizes that it is meant to begin to run and serve an application using the information contained within the development.ini file.</p>\n<h3 id=\"Main-section\"><a href=\"#Main-section\" class=\"headerlink\" title=\"Main section\"></a>Main section</h3><p>The framework finds a section named either [app:main], [pipeline:main], or [composite:main] in the .ini file. This section represents the configuration of a WSGI application that will be served. If you’re using a simple application (e.g. [app:main]), the application’s paste.app_factory entry point will be named on the use= line within the section’s configuration.</p>\n<p>If, instead of a simple application, you’re using a WSGI pipeline (e.g. a [pipeline:main] section), the application named on the “last” element will refer to your Pyramid application. If instead of a simple application or a pipeline, you’re using a “composite” (e.g. [composite:main]), refer to the documentation for that particular composite to understand how to make it refer to your Pyramid application. In most cases, a Pyramid application built from a scaffold will have a single [app:main] section in it, and this will be the application served.</p>\n<h3 id=\"Logging\"><a href=\"#Logging\" class=\"headerlink\" title=\"Logging\"></a>Logging</h3><p>The framework finds all logging related configuration in the .ini file and uses it to configure the Python standard library logging system for this application. See Logging Configuration for more information.</p>\n<h3 id=\"Application-constructor\"><a href=\"#Application-constructor\" class=\"headerlink\" title=\"Application constructor\"></a>Application constructor</h3><p>The application’s constructor named by the entry point reference on the use= line of the section representing your Pyramid application is passed the key/value parameters mentioned within the section in which it’s defined. The constructor is meant to return a router instance, which is a WSGI application.<br><br>For Pyramid applications, the constructor will be a function named main in the <strong>init</strong>.py file within the package in which your application lives. If this function succeeds, it will return a Pyramid router instance. Here’s the contents of an example <strong>init</strong>.py module:<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">from</span> pyramid.config <span class=\"keyword\">import</span> Configurator</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">main</span><span class=\"params\">(global_config, **settings)</span>:</span></div><div class=\"line\">    <span class=\"string\">\"\"\" This function returns a Pyramid WSGI application.</span></div><div class=\"line\"><span class=\"string\">    \"\"\"</span></div><div class=\"line\">    config = Configurator(settings=settings)</div><div class=\"line\">    config.include(<span class=\"string\">'pyramid_chameleon'</span>)</div><div class=\"line\">    config.add_static_view(<span class=\"string\">'static'</span>, <span class=\"string\">'static'</span>, cache_max_age=<span class=\"number\">3600</span>)</div><div class=\"line\">    config.add_route(<span class=\"string\">'home'</span>, <span class=\"string\">'/'</span>)</div><div class=\"line\">    config.scan()</div><div class=\"line\">    <span class=\"keyword\">return</span> config.make_wsgi_app()</div></pre></td></tr></table></figure></p>\n<p>Note that the constructor function accepts a global_config argument, which is a dictionary of key/value pairs mentioned in the [DEFAULT] section of an .ini file (if [DEFAULT] is present).<br>It also accepts a <strong>settings argument, which collects another set of arbitrary key/value pairs. The arbitrary key/value pairs received by this function in </strong>settings will be composed of all the key/value pairs that are present in the [app:main] section (except for the use= setting) when this function is called by when you run pserve.</p>\n<p>Our generated development.ini file looks like so:<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"><span class=\"comment\"># app configuration</span></div><div class=\"line\"><span class=\"comment\"># http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/environment.html</span></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[app:main]</span></div><div class=\"line\"><span class=\"attr\">use</span> = egg:MyProject</div><div class=\"line\"></div><div class=\"line\">pyramid.reload_templates = true</div><div class=\"line\">pyramid.debug_authorization = false</div><div class=\"line\">pyramid.debug_notfound = false</div><div class=\"line\">pyramid.debug_routematch = false</div><div class=\"line\">pyramid.default_locale_name = en</div><div class=\"line\">pyramid.includes =</div><div class=\"line\">pyramid_debugtoolbar</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># By default, the toolbar only appears for clients from IP addresses</span></div><div class=\"line\"><span class=\"comment\"># '127.0.0.1' and '::1'.</span></div><div class=\"line\"><span class=\"comment\"># debugtoolbar.hosts = 127.0.0.1 ::1</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"><span class=\"comment\"># wsgi server configuration</span></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[server:main]</span></div><div class=\"line\"><span class=\"attr\">use</span> = egg:waitress#main</div><div class=\"line\"><span class=\"attr\">host</span> = <span class=\"number\">0.0</span>.<span class=\"number\">0.0</span></div><div class=\"line\"><span class=\"attr\">port</span> = <span class=\"number\">6543</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"><span class=\"comment\"># logging configuration</span></div><div class=\"line\"><span class=\"comment\"># http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/logging.html</span></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[loggers]</span></div><div class=\"line\"><span class=\"attr\">keys</span> = root, myproject</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[handlers]</span></div><div class=\"line\"><span class=\"attr\">keys</span> = console</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[formatters]</span></div><div class=\"line\"><span class=\"attr\">keys</span> = generic</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[logger_root]</span></div><div class=\"line\"><span class=\"attr\">level</span> = INFO</div><div class=\"line\"><span class=\"attr\">handlers</span> = console</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[logger_myproject]</span></div><div class=\"line\"><span class=\"attr\">level</span> = DEBUG</div><div class=\"line\"><span class=\"attr\">handlers</span> =</div><div class=\"line\"><span class=\"attr\">qualname</span> = myproject</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[handler_console]</span></div><div class=\"line\"><span class=\"attr\">class</span> = StreamHandler</div><div class=\"line\"><span class=\"attr\">args</span> = (sys.stderr,)</div><div class=\"line\"><span class=\"attr\">level</span> = NOTSET</div><div class=\"line\"><span class=\"attr\">formatter</span> = generic</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[formatter_generic]</span></div><div class=\"line\"><span class=\"attr\">format</span> = %(asctime)s %(levelname)-<span class=\"number\">5.5</span>s [%(name)s][%(threadName)s] %(message)s</div></pre></td></tr></table></figure></p>\n<p>In this case, the myproject.<strong>init</strong>:main function referred to by the entry point URI egg:MyProject (see development.ini for more information about entry point URIs, and how they relate to callables), will receive the key/value pairs {‘pyramid.reload_templates’:’true’, ‘pyramid.debug_authorization’:’false’, ‘pyramid.debug_notfound’:’false’, ‘pyramid.debug_routematch’:’false’, ‘pyramid.debug_templates’:’true’, ‘pyramid.default_locale_name’:’en’}. See Environment Variables and .ini File Settings for the meanings of these keys.</p>\n<h3 id=\"Settings-dictinary\"><a href=\"#Settings-dictinary\" class=\"headerlink\" title=\"Settings dictinary\"></a>Settings dictinary</h3><p>The main function first constructs a Configurator instance, passing the settings dictionary captured via the **settings kwarg as its settings argument.</p>\n<p>The settings dictionary contains all the options in the [app:main] section of our .ini file except the use option (which is internal to PasteDeploy) such as pyramid.reload_templates,<br>pyramid.debug_authorization, etc.</p>\n<h3 id=\"Application-registry\"><a href=\"#Application-registry\" class=\"headerlink\" title=\"Application registry\"></a>Application registry</h3><p>The main function then calls various methods on the instance of the class Configurator created in the previous step. The intent of calling these methods is to populate an application registry, which represents the Pyramid configuration related to the application.</p>\n<h3 id=\"Call-make-wsgi-app\"><a href=\"#Call-make-wsgi-app\" class=\"headerlink\" title=\"Call make_wsgi_app\"></a>Call make_wsgi_app</h3><p>The make_wsgi_app() method is called. The result is a router instance. The router is associated with the application registry implied by the configurator previously populated by other methods run against the Configurator. The router is a WSGI application.</p>\n<h3 id=\"Emmit-ApplicationCreated-event\"><a href=\"#Emmit-ApplicationCreated-event\" class=\"headerlink\" title=\"Emmit ApplicationCreated event\"></a>Emmit ApplicationCreated event</h3><p>An ApplicationCreated event is emitted (see Using Events for more information about events).</p>\n<h3 id=\"Router\"><a href=\"#Router\" class=\"headerlink\" title=\"Router\"></a>Router</h3><p>Assuming there were no errors, the main function in myproject returns the router instance created by pyramid.config.Configurator.make_wsgi_app() back to pserve. As far as pserve is concerned, it is “just another WSGI application”.</p>\n<h3 id=\"WSGI-server\"><a href=\"#WSGI-server\" class=\"headerlink\" title=\"WSGI server\"></a>WSGI server</h3><p>pserve starts the WSGI server defined within the [server:main] section. In our case, this is the Waitress server (use = egg:waitress#main), and it will listen on all interfaces (host = 0.0.0.0), on port number 6543 (port = 6543). The server code itself is what prints serving on 0.0.0.0:6543 view at <a href=\"http://127.0.0.1:6543\" target=\"_blank\" rel=\"external\">http://127.0.0.1:6543</a>. The server serves the application, and the application is running, waiting to receive requests.</p>\n<p><strong>About development.ini</strong></p>\n<p>The development.ini file is a PasteDeploy configuration file. Its purpose is to specify an application to run when you invoke pserve, as well as the deployment settings provided to that application.</p>\n<p>This file contains several sections including [app:main], [server:main] and several other sections related to logging configuration.</p>\n<p>The [app:main] section represents configuration for your Pyramid application. The use setting is the only setting required to be present in the [app:main] section. Its default value, egg:MyProject, indicates that our MyProject project contains the application that should be served. Other settings added to this section are passed as keyword arguments to the function named main in our package’s <strong>init</strong>.py module. You can provide startup-time configuration parameters to your application by adding more settings to this section.</p>\n<p>The line in [app:main] above that says use = egg:MyProject is actually shorthand for a longer spelling: use = egg:MyProject#main. The #main part is omitted for brevity, as #main is a default defined by PasteDeploy. egg:MyProject#main is a string which has meaning to PasteDeploy. It points at a setuptools entry point named main defined in the MyProject project.</p>\n<p>See Entry Points and PasteDeploy .ini Files for more information about the meaning of the use = egg:MyProject value in this section.</p>\n<p>Take a look at the generated setup.py file for this project.<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">import</span> os</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">from</span> setuptools <span class=\"keyword\">import</span> setup, find_packages</div><div class=\"line\"></div><div class=\"line\">here = os.path.abspath(os.path.dirname(__file__))</div><div class=\"line\"><span class=\"keyword\">with</span> open(os.path.join(here, <span class=\"string\">'README.txt'</span>)) <span class=\"keyword\">as</span> f:</div><div class=\"line\">    README = f.read()</div><div class=\"line\"><span class=\"keyword\">with</span> open(os.path.join(here, <span class=\"string\">'CHANGES.txt'</span>)) <span class=\"keyword\">as</span> f:</div><div class=\"line\">    CHANGES = f.read()</div><div class=\"line\"></div><div class=\"line\">requires = [</div><div class=\"line\">    <span class=\"string\">'pyramid'</span>,</div><div class=\"line\">    <span class=\"string\">'pyramid_chameleon'</span>,</div><div class=\"line\">    <span class=\"string\">'pyramid_debugtoolbar'</span>,</div><div class=\"line\">    <span class=\"string\">'waitress'</span>,</div><div class=\"line\">]</div><div class=\"line\"></div><div class=\"line\">setup(name=<span class=\"string\">'MyProject'</span>,</div><div class=\"line\">    version=<span class=\"string\">'0.0'</span>,</div><div class=\"line\">    description=<span class=\"string\">'MyProject'</span>,</div><div class=\"line\">    long_description=README + <span class=\"string\">'\\n\\n'</span> + CHANGES,</div><div class=\"line\">    classifiers=[</div><div class=\"line\">        <span class=\"string\">\"Programming Language :: Python\"</span>,</div><div class=\"line\">        <span class=\"string\">\"Framework :: Pyramid\"</span>,</div><div class=\"line\">        <span class=\"string\">\"Topic :: Internet :: WWW/HTTP\"</span>,</div><div class=\"line\">        <span class=\"string\">\"Topic :: Internet :: WWW/HTTP :: WSGI :: Application\"</span>,</div><div class=\"line\">    ],</div><div class=\"line\">    author=<span class=\"string\">''</span>,</div><div class=\"line\">    author_email=<span class=\"string\">''</span>,</div><div class=\"line\">    url=<span class=\"string\">''</span>,</div><div class=\"line\">    keywords=<span class=\"string\">'web pyramid pylons'</span>,</div><div class=\"line\">    packages=find_packages(),</div><div class=\"line\">    include_package_data=<span class=\"keyword\">True</span>,</div><div class=\"line\">    zip_safe=<span class=\"keyword\">False</span>,</div><div class=\"line\">    install_requires=requires,</div><div class=\"line\">    tests_require=requires,</div><div class=\"line\">    test_suite=<span class=\"string\">\"myproject\"</span>,</div><div class=\"line\">    entry_points=<span class=\"string\">\"\"\"\\</span></div><div class=\"line\"><span class=\"string\">    [paste.app_factory]</span></div><div class=\"line\"><span class=\"string\">    main = myproject:main</span></div><div class=\"line\"><span class=\"string\">    \"\"\"</span>,</div><div class=\"line\">)</div></pre></td></tr></table></figure></p>\n<p>Note that entry_points is assigned a string which looks a lot like an .ini file. This string representation of an .ini file has a section named [paste.app_factory]. Within this section, there is a<br>key named main (the entry point name) which has a value myproject:main. The key main is what our egg:MyProject#main value of the use section in our config file is pointing at, although it isactually shortened to egg:MyProject there. The value represents a dotted Python name path, which refers to a callable in our myproject package’s <strong>init</strong>.py module.</p>\n<p>The egg: prefix in egg:MyProject indicates that this is an entry point URI specifier, where the “scheme” is “egg”. An “egg” is created when you run setup.py install or setup.py develop within your project.</p>\n<p>In English, this entry point can thus be referred to as a “PasteDeploy application factory in the MyProject project which has the entry point named main where the entry point refers to a main function in the mypackage module”. Indeed, if you open up the <strong>init</strong>.py module generated within any scaffold-generated package, you’ll see a main function. This is the function called by PasteDeploy when the pserve command is invoked against our application. It accepts a global configuration object and returns an instance of our application.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Here’s a high-level time-ordered overview of what happens when you press return after running pserve development.ini.</p>\n<h3 id=\"Pserve-command\"><a href=\"#Pserve-command\" class=\"headerlink\" title=\"Pserve command\"></a>Pserve command</h3><p>The pserve command is invoked under your shell with the argument development.ini. As a result, Pyramid recognizes that it is meant to begin to run and serve an application using the information contained within the development.ini file.</p>\n<h3 id=\"Main-section\"><a href=\"#Main-section\" class=\"headerlink\" title=\"Main section\"></a>Main section</h3><p>The framework finds a section named either [app:main], [pipeline:main], or [composite:main] in the .ini file. This section represents the configuration of a WSGI application that will be served. If you’re using a simple application (e.g. [app:main]), the application’s paste.app_factory entry point will be named on the use= line within the section’s configuration.</p>\n<p>If, instead of a simple application, you’re using a WSGI pipeline (e.g. a [pipeline:main] section), the application named on the “last” element will refer to your Pyramid application. If instead of a simple application or a pipeline, you’re using a “composite” (e.g. [composite:main]), refer to the documentation for that particular composite to understand how to make it refer to your Pyramid application. In most cases, a Pyramid application built from a scaffold will have a single [app:main] section in it, and this will be the application served.</p>\n<h3 id=\"Logging\"><a href=\"#Logging\" class=\"headerlink\" title=\"Logging\"></a>Logging</h3><p>The framework finds all logging related configuration in the .ini file and uses it to configure the Python standard library logging system for this application. See Logging Configuration for more information.</p>\n<h3 id=\"Application-constructor\"><a href=\"#Application-constructor\" class=\"headerlink\" title=\"Application constructor\"></a>Application constructor</h3><p>The application’s constructor named by the entry point reference on the use= line of the section representing your Pyramid application is passed the key/value parameters mentioned within the section in which it’s defined. The constructor is meant to return a router instance, which is a WSGI application.<br><br>For Pyramid applications, the constructor will be a function named main in the <strong>init</strong>.py file within the package in which your application lives. If this function succeeds, it will return a Pyramid router instance. Here’s the contents of an example <strong>init</strong>.py module:<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">from</span> pyramid.config <span class=\"keyword\">import</span> Configurator</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">main</span><span class=\"params\">(global_config, **settings)</span>:</span></div><div class=\"line\">    <span class=\"string\">\"\"\" This function returns a Pyramid WSGI application.</span></div><div class=\"line\"><span class=\"string\">    \"\"\"</span></div><div class=\"line\">    config = Configurator(settings=settings)</div><div class=\"line\">    config.include(<span class=\"string\">'pyramid_chameleon'</span>)</div><div class=\"line\">    config.add_static_view(<span class=\"string\">'static'</span>, <span class=\"string\">'static'</span>, cache_max_age=<span class=\"number\">3600</span>)</div><div class=\"line\">    config.add_route(<span class=\"string\">'home'</span>, <span class=\"string\">'/'</span>)</div><div class=\"line\">    config.scan()</div><div class=\"line\">    <span class=\"keyword\">return</span> config.make_wsgi_app()</div></pre></td></tr></table></figure></p>\n<p>Note that the constructor function accepts a global_config argument, which is a dictionary of key/value pairs mentioned in the [DEFAULT] section of an .ini file (if [DEFAULT] is present).<br>It also accepts a <strong>settings argument, which collects another set of arbitrary key/value pairs. The arbitrary key/value pairs received by this function in </strong>settings will be composed of all the key/value pairs that are present in the [app:main] section (except for the use= setting) when this function is called by when you run pserve.</p>\n<p>Our generated development.ini file looks like so:<br><figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"><span class=\"comment\"># app configuration</span></div><div class=\"line\"><span class=\"comment\"># http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/environment.html</span></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[app:main]</span></div><div class=\"line\"><span class=\"attr\">use</span> = egg:MyProject</div><div class=\"line\"></div><div class=\"line\">pyramid.reload_templates = true</div><div class=\"line\">pyramid.debug_authorization = false</div><div class=\"line\">pyramid.debug_notfound = false</div><div class=\"line\">pyramid.debug_routematch = false</div><div class=\"line\">pyramid.default_locale_name = en</div><div class=\"line\">pyramid.includes =</div><div class=\"line\">pyramid_debugtoolbar</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># By default, the toolbar only appears for clients from IP addresses</span></div><div class=\"line\"><span class=\"comment\"># '127.0.0.1' and '::1'.</span></div><div class=\"line\"><span class=\"comment\"># debugtoolbar.hosts = 127.0.0.1 ::1</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"><span class=\"comment\"># wsgi server configuration</span></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[server:main]</span></div><div class=\"line\"><span class=\"attr\">use</span> = egg:waitress#main</div><div class=\"line\"><span class=\"attr\">host</span> = <span class=\"number\">0.0</span>.<span class=\"number\">0.0</span></div><div class=\"line\"><span class=\"attr\">port</span> = <span class=\"number\">6543</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"><span class=\"comment\"># logging configuration</span></div><div class=\"line\"><span class=\"comment\"># http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/logging.html</span></div><div class=\"line\"><span class=\"comment\">###</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[loggers]</span></div><div class=\"line\"><span class=\"attr\">keys</span> = root, myproject</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[handlers]</span></div><div class=\"line\"><span class=\"attr\">keys</span> = console</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[formatters]</span></div><div class=\"line\"><span class=\"attr\">keys</span> = generic</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[logger_root]</span></div><div class=\"line\"><span class=\"attr\">level</span> = INFO</div><div class=\"line\"><span class=\"attr\">handlers</span> = console</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[logger_myproject]</span></div><div class=\"line\"><span class=\"attr\">level</span> = DEBUG</div><div class=\"line\"><span class=\"attr\">handlers</span> =</div><div class=\"line\"><span class=\"attr\">qualname</span> = myproject</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[handler_console]</span></div><div class=\"line\"><span class=\"attr\">class</span> = StreamHandler</div><div class=\"line\"><span class=\"attr\">args</span> = (sys.stderr,)</div><div class=\"line\"><span class=\"attr\">level</span> = NOTSET</div><div class=\"line\"><span class=\"attr\">formatter</span> = generic</div><div class=\"line\"></div><div class=\"line\"><span class=\"section\">[formatter_generic]</span></div><div class=\"line\"><span class=\"attr\">format</span> = %(asctime)s %(levelname)-<span class=\"number\">5.5</span>s [%(name)s][%(threadName)s] %(message)s</div></pre></td></tr></table></figure></p>\n<p>In this case, the myproject.<strong>init</strong>:main function referred to by the entry point URI egg:MyProject (see development.ini for more information about entry point URIs, and how they relate to callables), will receive the key/value pairs {‘pyramid.reload_templates’:’true’, ‘pyramid.debug_authorization’:’false’, ‘pyramid.debug_notfound’:’false’, ‘pyramid.debug_routematch’:’false’, ‘pyramid.debug_templates’:’true’, ‘pyramid.default_locale_name’:’en’}. See Environment Variables and .ini File Settings for the meanings of these keys.</p>\n<h3 id=\"Settings-dictinary\"><a href=\"#Settings-dictinary\" class=\"headerlink\" title=\"Settings dictinary\"></a>Settings dictinary</h3><p>The main function first constructs a Configurator instance, passing the settings dictionary captured via the **settings kwarg as its settings argument.</p>\n<p>The settings dictionary contains all the options in the [app:main] section of our .ini file except the use option (which is internal to PasteDeploy) such as pyramid.reload_templates,<br>pyramid.debug_authorization, etc.</p>\n<h3 id=\"Application-registry\"><a href=\"#Application-registry\" class=\"headerlink\" title=\"Application registry\"></a>Application registry</h3><p>The main function then calls various methods on the instance of the class Configurator created in the previous step. The intent of calling these methods is to populate an application registry, which represents the Pyramid configuration related to the application.</p>\n<h3 id=\"Call-make-wsgi-app\"><a href=\"#Call-make-wsgi-app\" class=\"headerlink\" title=\"Call make_wsgi_app\"></a>Call make_wsgi_app</h3><p>The make_wsgi_app() method is called. The result is a router instance. The router is associated with the application registry implied by the configurator previously populated by other methods run against the Configurator. The router is a WSGI application.</p>\n<h3 id=\"Emmit-ApplicationCreated-event\"><a href=\"#Emmit-ApplicationCreated-event\" class=\"headerlink\" title=\"Emmit ApplicationCreated event\"></a>Emmit ApplicationCreated event</h3><p>An ApplicationCreated event is emitted (see Using Events for more information about events).</p>\n<h3 id=\"Router\"><a href=\"#Router\" class=\"headerlink\" title=\"Router\"></a>Router</h3><p>Assuming there were no errors, the main function in myproject returns the router instance created by pyramid.config.Configurator.make_wsgi_app() back to pserve. As far as pserve is concerned, it is “just another WSGI application”.</p>\n<h3 id=\"WSGI-server\"><a href=\"#WSGI-server\" class=\"headerlink\" title=\"WSGI server\"></a>WSGI server</h3><p>pserve starts the WSGI server defined within the [server:main] section. In our case, this is the Waitress server (use = egg:waitress#main), and it will listen on all interfaces (host = 0.0.0.0), on port number 6543 (port = 6543). The server code itself is what prints serving on 0.0.0.0:6543 view at <a href=\"http://127.0.0.1:6543\" target=\"_blank\" rel=\"external\">http://127.0.0.1:6543</a>. The server serves the application, and the application is running, waiting to receive requests.</p>\n<p><strong>About development.ini</strong></p>\n<p>The development.ini file is a PasteDeploy configuration file. Its purpose is to specify an application to run when you invoke pserve, as well as the deployment settings provided to that application.</p>\n<p>This file contains several sections including [app:main], [server:main] and several other sections related to logging configuration.</p>\n<p>The [app:main] section represents configuration for your Pyramid application. The use setting is the only setting required to be present in the [app:main] section. Its default value, egg:MyProject, indicates that our MyProject project contains the application that should be served. Other settings added to this section are passed as keyword arguments to the function named main in our package’s <strong>init</strong>.py module. You can provide startup-time configuration parameters to your application by adding more settings to this section.</p>\n<p>The line in [app:main] above that says use = egg:MyProject is actually shorthand for a longer spelling: use = egg:MyProject#main. The #main part is omitted for brevity, as #main is a default defined by PasteDeploy. egg:MyProject#main is a string which has meaning to PasteDeploy. It points at a setuptools entry point named main defined in the MyProject project.</p>\n<p>See Entry Points and PasteDeploy .ini Files for more information about the meaning of the use = egg:MyProject value in this section.</p>\n<p>Take a look at the generated setup.py file for this project.<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">import</span> os</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">from</span> setuptools <span class=\"keyword\">import</span> setup, find_packages</div><div class=\"line\"></div><div class=\"line\">here = os.path.abspath(os.path.dirname(__file__))</div><div class=\"line\"><span class=\"keyword\">with</span> open(os.path.join(here, <span class=\"string\">'README.txt'</span>)) <span class=\"keyword\">as</span> f:</div><div class=\"line\">    README = f.read()</div><div class=\"line\"><span class=\"keyword\">with</span> open(os.path.join(here, <span class=\"string\">'CHANGES.txt'</span>)) <span class=\"keyword\">as</span> f:</div><div class=\"line\">    CHANGES = f.read()</div><div class=\"line\"></div><div class=\"line\">requires = [</div><div class=\"line\">    <span class=\"string\">'pyramid'</span>,</div><div class=\"line\">    <span class=\"string\">'pyramid_chameleon'</span>,</div><div class=\"line\">    <span class=\"string\">'pyramid_debugtoolbar'</span>,</div><div class=\"line\">    <span class=\"string\">'waitress'</span>,</div><div class=\"line\">]</div><div class=\"line\"></div><div class=\"line\">setup(name=<span class=\"string\">'MyProject'</span>,</div><div class=\"line\">    version=<span class=\"string\">'0.0'</span>,</div><div class=\"line\">    description=<span class=\"string\">'MyProject'</span>,</div><div class=\"line\">    long_description=README + <span class=\"string\">'\\n\\n'</span> + CHANGES,</div><div class=\"line\">    classifiers=[</div><div class=\"line\">        <span class=\"string\">\"Programming Language :: Python\"</span>,</div><div class=\"line\">        <span class=\"string\">\"Framework :: Pyramid\"</span>,</div><div class=\"line\">        <span class=\"string\">\"Topic :: Internet :: WWW/HTTP\"</span>,</div><div class=\"line\">        <span class=\"string\">\"Topic :: Internet :: WWW/HTTP :: WSGI :: Application\"</span>,</div><div class=\"line\">    ],</div><div class=\"line\">    author=<span class=\"string\">''</span>,</div><div class=\"line\">    author_email=<span class=\"string\">''</span>,</div><div class=\"line\">    url=<span class=\"string\">''</span>,</div><div class=\"line\">    keywords=<span class=\"string\">'web pyramid pylons'</span>,</div><div class=\"line\">    packages=find_packages(),</div><div class=\"line\">    include_package_data=<span class=\"keyword\">True</span>,</div><div class=\"line\">    zip_safe=<span class=\"keyword\">False</span>,</div><div class=\"line\">    install_requires=requires,</div><div class=\"line\">    tests_require=requires,</div><div class=\"line\">    test_suite=<span class=\"string\">\"myproject\"</span>,</div><div class=\"line\">    entry_points=<span class=\"string\">\"\"\"\\</span></div><div class=\"line\"><span class=\"string\">    [paste.app_factory]</span></div><div class=\"line\"><span class=\"string\">    main = myproject:main</span></div><div class=\"line\"><span class=\"string\">    \"\"\"</span>,</div><div class=\"line\">)</div></pre></td></tr></table></figure></p>\n<p>Note that entry_points is assigned a string which looks a lot like an .ini file. This string representation of an .ini file has a section named [paste.app_factory]. Within this section, there is a<br>key named main (the entry point name) which has a value myproject:main. The key main is what our egg:MyProject#main value of the use section in our config file is pointing at, although it isactually shortened to egg:MyProject there. The value represents a dotted Python name path, which refers to a callable in our myproject package’s <strong>init</strong>.py module.</p>\n<p>The egg: prefix in egg:MyProject indicates that this is an entry point URI specifier, where the “scheme” is “egg”. An “egg” is created when you run setup.py install or setup.py develop within your project.</p>\n<p>In English, this entry point can thus be referred to as a “PasteDeploy application factory in the MyProject project which has the entry point named main where the entry point refers to a main function in the mypackage module”. Indeed, if you open up the <strong>init</strong>.py module generated within any scaffold-generated package, you’ll see a main function. This is the function called by PasteDeploy when the pserve command is invoked against our application. It accepts a global configuration object and returns an instance of our application.</p>\n"},{"title":"Robot","date":"2017-07-18T07:42:13.000Z","_content":"\n## 基础知识\n\n - [欧拉角与万向节死锁](http://v.youku.com/v_show/id_XNzkyOTIyMTI=.html)","source":"_posts/Robot.md","raw":"---\ntitle: Robot\ndate: 2017-07-18 15:42:13\ncategories: Robot\ntags: Robot\n---\n\n## 基础知识\n\n - [欧拉角与万向节死锁](http://v.youku.com/v_show/id_XNzkyOTIyMTI=.html)","slug":"Robot","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48e6000cnki3bgzlgm7o","content":"<h2 id=\"基础知识\"><a href=\"#基础知识\" class=\"headerlink\" title=\"基础知识\"></a>基础知识</h2><ul>\n<li><a href=\"http://v.youku.com/v_show/id_XNzkyOTIyMTI=.html\" target=\"_blank\" rel=\"external\">欧拉角与万向节死锁</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"基础知识\"><a href=\"#基础知识\" class=\"headerlink\" title=\"基础知识\"></a>基础知识</h2><ul>\n<li><a href=\"http://v.youku.com/v_show/id_XNzkyOTIyMTI=.html\" target=\"_blank\" rel=\"external\">欧拉角与万向节死锁</a></li>\n</ul>\n"},{"title":"Tango Example hello video","date":"2017-07-28T01:24:52.000Z","_content":"\n## Basic example hello video\n\n完整的代码可以在 [github](https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_video) 上找到。\n\n## On tango service connected\n\n范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：\n``` cpp\nJNIEXPORT void JNICALL\nJava_com_projecttango_examples_cpp_hellovideo_TangoJniNative_onTangoServiceConnected(\n    JNIEnv* env, jobject, jobject binder) {\n  app.OnTangoServiceConnected(env, binder);\n}\n```\n\n``` cpp\nvoid HelloVideoApp::OnTangoServiceConnected(JNIEnv* env, jobject binder) {\n  ...\n  // Enable color camera from config.\n  int ret = TangoConfig_setBool(tango_config_, \"config_enable_color_camera\",\n                                true);\n  ret = TangoService_connectOnFrameAvailable(TANGO_CAMERA_COLOR, this,\n                                             OnFrameAvailableRouter);\n  ...\n}\n```\n从上面的代码可以看到我们启用了 color camera，并注册了 FrameAvailbale 的回调 OnFrameAvailableRouter。\n\n## On frame available\n\n接下来我们看看在回调函数中是如何处理每一帧数据的：\n``` cpp\nnamespace {\nconstexpr int kTangoCoreMinimumVersion = 9377;\nvoid OnFrameAvailableRouter(void* context, TangoCameraId,\n                            const TangoImageBuffer* buffer) {\n  hello_video::HelloVideoApp* app =\n      static_cast<hello_video::HelloVideoApp*>(context);\n  app->OnFrameAvailable(buffer);\n}\n}  // namespace\n```\n\n``` cpp\nvoid HelloVideoApp::OnFrameAvailable(const TangoImageBuffer* buffer) {\n  if (current_texture_method_ != TextureMethod::kYuv) {\n    return;\n  }\n\n  if (yuv_drawable_->GetTextureId() == 0) {\n    LOGE(\"HelloVideoApp::yuv texture id not valid\");\n    return;\n  }\n\n  if (buffer->format != TANGO_HAL_PIXEL_FORMAT_YCrCb_420_SP) {\n    LOGE(\"HelloVideoApp::yuv texture format is not supported by this app\");\n    return;\n  }\n\n  // The memory needs to be allocated after we get the first frame because we\n  // need to know the size of the image.\n  if (!is_yuv_texture_available_) {\n    yuv_width_ = buffer->width;\n    yuv_height_ = buffer->height;\n    uv_buffer_offset_ = yuv_width_ * yuv_height_;\n\n    yuv_size_ = yuv_width_ * yuv_height_ + yuv_width_ * yuv_height_ / 2;\n\n    // Reserve and resize the buffer size for RGB and YUV data.\n    yuv_buffer_.resize(yuv_size_);\n    yuv_temp_buffer_.resize(yuv_size_);\n    rgb_buffer_.resize(yuv_width_ * yuv_height_ * 3);\n\n    AllocateTexture(yuv_drawable_->GetTextureId(), yuv_width_, yuv_height_);\n    is_yuv_texture_available_ = true;\n  }\n\n  std::lock_guard<std::mutex> lock(yuv_buffer_mutex_);\n  memcpy(&yuv_temp_buffer_[0], buffer->data, yuv_size_);\n  swap_buffer_signal_ = true;\n}\n```\n从 tango color camera 获取的是 YUV 格式，单帧数据被保存到成员变量 yuv_temp_buffer_ 中，yuv_temp_buffer_ 的定义如下：\n``` cpp\nstd::vector<uint8_t> yuv_temp_buffer_;\n```\n\n## Render YUV\n\nyuv_temp_buffer_ 所保存的数据进行渲染：\n``` cpp\nvoid HelloVideoApp::OnDrawFrame() {\n  glClearColor(1.0f, 1.0f, 1.0f, 1.0f);\n  glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);\n\n  if (!is_service_connected_) {\n    return;\n  }\n\n  if (!is_texture_id_set_) {\n    is_texture_id_set_ = true;\n    // Connect color camera texture. TangoService_connectTextureId expects a\n    // valid texture id from the caller, so we will need to wait until the GL\n    // content is properly allocated.\n    int texture_id = static_cast<int>(video_overlay_drawable_->GetTextureId());\n    TangoErrorType ret = TangoService_connectTextureId(\n        TANGO_CAMERA_COLOR, texture_id, nullptr, nullptr);\n    if (ret != TANGO_SUCCESS) {\n      LOGE(\n          \"HelloVideoApp: Failed to connect the texture id with error\"\n          \"code: %d\",\n          ret);\n    }\n  }\n\n  if (!is_video_overlay_rotation_set_) {\n    video_overlay_drawable_->SetDisplayRotation(display_rotation_);\n    yuv_drawable_->SetDisplayRotation(display_rotation_);\n    is_video_overlay_rotation_set_ = true;\n  }\n\n  switch (current_texture_method_) {\n    case TextureMethod::kYuv:\n      RenderYuv();\n      break;\n    case TextureMethod::kTextureId:\n      RenderTextureId();\n      break;\n  }\n}\n\nvoid HelloVideoApp::RenderYuv() {\n  if (!is_yuv_texture_available_) {\n    return;\n  }\n  {\n    std::lock_guard<std::mutex> lock(yuv_buffer_mutex_);\n    if (swap_buffer_signal_) {\n      std::swap(yuv_buffer_, yuv_temp_buffer_);\n      swap_buffer_signal_ = false;\n    }\n  }\n\n  for (size_t i = 0; i < yuv_height_; ++i) {\n    for (size_t j = 0; j < yuv_width_; ++j) {\n      size_t x_index = j;\n      if (j % 2 != 0) {\n        x_index = j - 1;\n      }\n\n      size_t rgb_index = (i * yuv_width_ + j) * 3;\n\n      // The YUV texture format is NV21,\n      // yuv_buffer_ buffer layout:\n      //   [y0, y1, y2, ..., yn, v0, u0, v1, u1, ..., v(n/4), u(n/4)]\n      Yuv2Rgb(\n          yuv_buffer_[i * yuv_width_ + j],\n          yuv_buffer_[uv_buffer_offset_ + (i / 2) * yuv_width_ + x_index + 1],\n          yuv_buffer_[uv_buffer_offset_ + (i / 2) * yuv_width_ + x_index],\n          &rgb_buffer_[rgb_index], &rgb_buffer_[rgb_index + 1],\n          &rgb_buffer_[rgb_index + 2]);\n    }\n  }\n\n  glBindTexture(GL_TEXTURE_2D, yuv_drawable_->GetTextureId());\n  glTexImage2D(GL_TEXTURE_2D, 0, GL_RGB, yuv_width_, yuv_height_, 0, GL_RGB,\n               GL_UNSIGNED_BYTE, rgb_buffer_.data());\n\n  yuv_drawable_->Render(glm::mat4(1.0f), glm::mat4(1.0f));\n}\n```\n在上面 RenderYuv 函数告诉了我们更多信息，color camera 获取的是 YUV NV21 格式，如何将它转为 RGB：\n``` cpp\n// We could do this conversion in a fragment shader if all we care about is\n// rendering, but we show it here as an example of how people can use RGB data\n// on the CPU.\ninline void Yuv2Rgb(uint8_t y_value, uint8_t u_value, uint8_t v_value,\n                    uint8_t* r, uint8_t* g, uint8_t* b) {\n  float float_r = y_value + (1.370705 * (v_value - 128));\n  float float_g =\n      y_value - (0.698001 * (v_value - 128)) - (0.337633 * (u_value - 128));\n  float float_b = y_value + (1.732446 * (u_value - 128));\n\n  float_r = float_r * !(float_r < 0);\n  float_g = float_g * !(float_g < 0);\n  float_b = float_b * !(float_b < 0);\n\n  *r = float_r * (!(float_r > 255)) + 255 * (float_r > 255);\n  *g = float_g * (!(float_g > 255)) + 255 * (float_g > 255);\n  *b = float_b * (!(float_b > 255)) + 255 * (float_b > 255);\n}\n```\n","source":"_posts/Tango-Example-Hello-Video.md","raw":"---\ntitle: Tango Example hello video\ndate: 2017-07-28 09:24:52\ncategories: Tango\ntags: [Project Tango]\n---\n\n## Basic example hello video\n\n完整的代码可以在 [github](https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_video) 上找到。\n\n## On tango service connected\n\n范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：\n``` cpp\nJNIEXPORT void JNICALL\nJava_com_projecttango_examples_cpp_hellovideo_TangoJniNative_onTangoServiceConnected(\n    JNIEnv* env, jobject, jobject binder) {\n  app.OnTangoServiceConnected(env, binder);\n}\n```\n\n``` cpp\nvoid HelloVideoApp::OnTangoServiceConnected(JNIEnv* env, jobject binder) {\n  ...\n  // Enable color camera from config.\n  int ret = TangoConfig_setBool(tango_config_, \"config_enable_color_camera\",\n                                true);\n  ret = TangoService_connectOnFrameAvailable(TANGO_CAMERA_COLOR, this,\n                                             OnFrameAvailableRouter);\n  ...\n}\n```\n从上面的代码可以看到我们启用了 color camera，并注册了 FrameAvailbale 的回调 OnFrameAvailableRouter。\n\n## On frame available\n\n接下来我们看看在回调函数中是如何处理每一帧数据的：\n``` cpp\nnamespace {\nconstexpr int kTangoCoreMinimumVersion = 9377;\nvoid OnFrameAvailableRouter(void* context, TangoCameraId,\n                            const TangoImageBuffer* buffer) {\n  hello_video::HelloVideoApp* app =\n      static_cast<hello_video::HelloVideoApp*>(context);\n  app->OnFrameAvailable(buffer);\n}\n}  // namespace\n```\n\n``` cpp\nvoid HelloVideoApp::OnFrameAvailable(const TangoImageBuffer* buffer) {\n  if (current_texture_method_ != TextureMethod::kYuv) {\n    return;\n  }\n\n  if (yuv_drawable_->GetTextureId() == 0) {\n    LOGE(\"HelloVideoApp::yuv texture id not valid\");\n    return;\n  }\n\n  if (buffer->format != TANGO_HAL_PIXEL_FORMAT_YCrCb_420_SP) {\n    LOGE(\"HelloVideoApp::yuv texture format is not supported by this app\");\n    return;\n  }\n\n  // The memory needs to be allocated after we get the first frame because we\n  // need to know the size of the image.\n  if (!is_yuv_texture_available_) {\n    yuv_width_ = buffer->width;\n    yuv_height_ = buffer->height;\n    uv_buffer_offset_ = yuv_width_ * yuv_height_;\n\n    yuv_size_ = yuv_width_ * yuv_height_ + yuv_width_ * yuv_height_ / 2;\n\n    // Reserve and resize the buffer size for RGB and YUV data.\n    yuv_buffer_.resize(yuv_size_);\n    yuv_temp_buffer_.resize(yuv_size_);\n    rgb_buffer_.resize(yuv_width_ * yuv_height_ * 3);\n\n    AllocateTexture(yuv_drawable_->GetTextureId(), yuv_width_, yuv_height_);\n    is_yuv_texture_available_ = true;\n  }\n\n  std::lock_guard<std::mutex> lock(yuv_buffer_mutex_);\n  memcpy(&yuv_temp_buffer_[0], buffer->data, yuv_size_);\n  swap_buffer_signal_ = true;\n}\n```\n从 tango color camera 获取的是 YUV 格式，单帧数据被保存到成员变量 yuv_temp_buffer_ 中，yuv_temp_buffer_ 的定义如下：\n``` cpp\nstd::vector<uint8_t> yuv_temp_buffer_;\n```\n\n## Render YUV\n\nyuv_temp_buffer_ 所保存的数据进行渲染：\n``` cpp\nvoid HelloVideoApp::OnDrawFrame() {\n  glClearColor(1.0f, 1.0f, 1.0f, 1.0f);\n  glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);\n\n  if (!is_service_connected_) {\n    return;\n  }\n\n  if (!is_texture_id_set_) {\n    is_texture_id_set_ = true;\n    // Connect color camera texture. TangoService_connectTextureId expects a\n    // valid texture id from the caller, so we will need to wait until the GL\n    // content is properly allocated.\n    int texture_id = static_cast<int>(video_overlay_drawable_->GetTextureId());\n    TangoErrorType ret = TangoService_connectTextureId(\n        TANGO_CAMERA_COLOR, texture_id, nullptr, nullptr);\n    if (ret != TANGO_SUCCESS) {\n      LOGE(\n          \"HelloVideoApp: Failed to connect the texture id with error\"\n          \"code: %d\",\n          ret);\n    }\n  }\n\n  if (!is_video_overlay_rotation_set_) {\n    video_overlay_drawable_->SetDisplayRotation(display_rotation_);\n    yuv_drawable_->SetDisplayRotation(display_rotation_);\n    is_video_overlay_rotation_set_ = true;\n  }\n\n  switch (current_texture_method_) {\n    case TextureMethod::kYuv:\n      RenderYuv();\n      break;\n    case TextureMethod::kTextureId:\n      RenderTextureId();\n      break;\n  }\n}\n\nvoid HelloVideoApp::RenderYuv() {\n  if (!is_yuv_texture_available_) {\n    return;\n  }\n  {\n    std::lock_guard<std::mutex> lock(yuv_buffer_mutex_);\n    if (swap_buffer_signal_) {\n      std::swap(yuv_buffer_, yuv_temp_buffer_);\n      swap_buffer_signal_ = false;\n    }\n  }\n\n  for (size_t i = 0; i < yuv_height_; ++i) {\n    for (size_t j = 0; j < yuv_width_; ++j) {\n      size_t x_index = j;\n      if (j % 2 != 0) {\n        x_index = j - 1;\n      }\n\n      size_t rgb_index = (i * yuv_width_ + j) * 3;\n\n      // The YUV texture format is NV21,\n      // yuv_buffer_ buffer layout:\n      //   [y0, y1, y2, ..., yn, v0, u0, v1, u1, ..., v(n/4), u(n/4)]\n      Yuv2Rgb(\n          yuv_buffer_[i * yuv_width_ + j],\n          yuv_buffer_[uv_buffer_offset_ + (i / 2) * yuv_width_ + x_index + 1],\n          yuv_buffer_[uv_buffer_offset_ + (i / 2) * yuv_width_ + x_index],\n          &rgb_buffer_[rgb_index], &rgb_buffer_[rgb_index + 1],\n          &rgb_buffer_[rgb_index + 2]);\n    }\n  }\n\n  glBindTexture(GL_TEXTURE_2D, yuv_drawable_->GetTextureId());\n  glTexImage2D(GL_TEXTURE_2D, 0, GL_RGB, yuv_width_, yuv_height_, 0, GL_RGB,\n               GL_UNSIGNED_BYTE, rgb_buffer_.data());\n\n  yuv_drawable_->Render(glm::mat4(1.0f), glm::mat4(1.0f));\n}\n```\n在上面 RenderYuv 函数告诉了我们更多信息，color camera 获取的是 YUV NV21 格式，如何将它转为 RGB：\n``` cpp\n// We could do this conversion in a fragment shader if all we care about is\n// rendering, but we show it here as an example of how people can use RGB data\n// on the CPU.\ninline void Yuv2Rgb(uint8_t y_value, uint8_t u_value, uint8_t v_value,\n                    uint8_t* r, uint8_t* g, uint8_t* b) {\n  float float_r = y_value + (1.370705 * (v_value - 128));\n  float float_g =\n      y_value - (0.698001 * (v_value - 128)) - (0.337633 * (u_value - 128));\n  float float_b = y_value + (1.732446 * (u_value - 128));\n\n  float_r = float_r * !(float_r < 0);\n  float_g = float_g * !(float_g < 0);\n  float_b = float_b * !(float_b < 0);\n\n  *r = float_r * (!(float_r > 255)) + 255 * (float_r > 255);\n  *g = float_g * (!(float_g > 255)) + 255 * (float_g > 255);\n  *b = float_b * (!(float_b > 255)) + 255 * (float_b > 255);\n}\n```\n","slug":"Tango-Example-Hello-Video","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48ea000gnki3aq9mfomh","content":"<h2 id=\"Basic-example-hello-video\"><a href=\"#Basic-example-hello-video\" class=\"headerlink\" title=\"Basic example hello video\"></a>Basic example hello video</h2><p>完整的代码可以在 <a href=\"https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_video\" target=\"_blank\" rel=\"external\">github</a> 上找到。</p>\n<h2 id=\"On-tango-service-connected\"><a href=\"#On-tango-service-connected\" class=\"headerlink\" title=\"On tango service connected\"></a>On tango service connected</h2><p>范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">JNIEXPORT <span class=\"keyword\">void</span> JNICALL</div><div class=\"line\">Java_com_projecttango_examples_cpp_hellovideo_TangoJniNative_onTangoServiceConnected(</div><div class=\"line\">    JNIEnv* env, jobject, jobject binder) &#123;</div><div class=\"line\">  app.OnTangoServiceConnected(env, binder);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::OnTangoServiceConnected(JNIEnv* env, jobject binder) &#123;</div><div class=\"line\">  ...</div><div class=\"line\">  <span class=\"comment\">// Enable color camera from config.</span></div><div class=\"line\">  <span class=\"keyword\">int</span> ret = TangoConfig_setBool(tango_config_, <span class=\"string\">\"config_enable_color_camera\"</span>,</div><div class=\"line\">                                <span class=\"literal\">true</span>);</div><div class=\"line\">  ret = TangoService_connectOnFrameAvailable(TANGO_CAMERA_COLOR, <span class=\"keyword\">this</span>,</div><div class=\"line\">                                             OnFrameAvailableRouter);</div><div class=\"line\">  ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>从上面的代码可以看到我们启用了 color camera，并注册了 FrameAvailbale 的回调 OnFrameAvailableRouter。</p>\n<h2 id=\"On-frame-available\"><a href=\"#On-frame-available\" class=\"headerlink\" title=\"On frame available\"></a>On frame available</h2><p>接下来我们看看在回调函数中是如何处理每一帧数据的：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">namespace</span> &#123;</div><div class=\"line\"><span class=\"keyword\">constexpr</span> <span class=\"keyword\">int</span> kTangoCoreMinimumVersion = <span class=\"number\">9377</span>;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnFrameAvailableRouter</span><span class=\"params\">(<span class=\"keyword\">void</span>* context, TangoCameraId,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">                            <span class=\"keyword\">const</span> TangoImageBuffer* buffer)</span> </span>&#123;</div><div class=\"line\">  hello_video::HelloVideoApp* app =</div><div class=\"line\">      <span class=\"keyword\">static_cast</span>&lt;hello_video::HelloVideoApp*&gt;(context);</div><div class=\"line\">  app-&gt;OnFrameAvailable(buffer);</div><div class=\"line\">&#125;</div><div class=\"line\">&#125;  <span class=\"comment\">// namespace</span></div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::OnFrameAvailable(<span class=\"keyword\">const</span> TangoImageBuffer* buffer) &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (current_texture_method_ != TextureMethod::kYuv) &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (yuv_drawable_-&gt;GetTextureId() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">    LOGE(<span class=\"string\">\"HelloVideoApp::yuv texture id not valid\"</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (buffer-&gt;format != TANGO_HAL_PIXEL_FORMAT_YCrCb_420_SP) &#123;</div><div class=\"line\">    LOGE(<span class=\"string\">\"HelloVideoApp::yuv texture format is not supported by this app\"</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The memory needs to be allocated after we get the first frame because we</span></div><div class=\"line\">  <span class=\"comment\">// need to know the size of the image.</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_yuv_texture_available_) &#123;</div><div class=\"line\">    yuv_width_ = buffer-&gt;width;</div><div class=\"line\">    yuv_height_ = buffer-&gt;height;</div><div class=\"line\">    uv_buffer_offset_ = yuv_width_ * yuv_height_;</div><div class=\"line\"></div><div class=\"line\">    yuv_size_ = yuv_width_ * yuv_height_ + yuv_width_ * yuv_height_ / <span class=\"number\">2</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// Reserve and resize the buffer size for RGB and YUV data.</span></div><div class=\"line\">    yuv_buffer_.resize(yuv_size_);</div><div class=\"line\">    yuv_temp_buffer_.resize(yuv_size_);</div><div class=\"line\">    rgb_buffer_.resize(yuv_width_ * yuv_height_ * <span class=\"number\">3</span>);</div><div class=\"line\"></div><div class=\"line\">    AllocateTexture(yuv_drawable_-&gt;GetTextureId(), yuv_width_, yuv_height_);</div><div class=\"line\">    is_yuv_texture_available_ = <span class=\"literal\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"built_in\">std</span>::lock_guard&lt;<span class=\"built_in\">std</span>::mutex&gt; lock(yuv_buffer_mutex_);</div><div class=\"line\">  <span class=\"built_in\">memcpy</span>(&amp;yuv_temp_buffer_[<span class=\"number\">0</span>], buffer-&gt;data, yuv_size_);</div><div class=\"line\">  swap_buffer_signal_ = <span class=\"literal\">true</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>从 tango color camera 获取的是 YUV 格式，单帧数据被保存到成员变量 yuv_temp<em>buffer</em> 中，yuv_temp<em>buffer</em> 的定义如下：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">std</span>::<span class=\"built_in\">vector</span>&lt;<span class=\"keyword\">uint8_t</span>&gt; yuv_temp_buffer_;</div></pre></td></tr></table></figure></p>\n<h2 id=\"Render-YUV\"><a href=\"#Render-YUV\" class=\"headerlink\" title=\"Render YUV\"></a>Render YUV</h2><p>yuv_temp<em>buffer</em> 所保存的数据进行渲染：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::OnDrawFrame() &#123;</div><div class=\"line\">  glClearColor(<span class=\"number\">1.0f</span>, <span class=\"number\">1.0f</span>, <span class=\"number\">1.0f</span>, <span class=\"number\">1.0f</span>);</div><div class=\"line\">  glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_service_connected_) &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_texture_id_set_) &#123;</div><div class=\"line\">    is_texture_id_set_ = <span class=\"literal\">true</span>;</div><div class=\"line\">    <span class=\"comment\">// Connect color camera texture. TangoService_connectTextureId expects a</span></div><div class=\"line\">    <span class=\"comment\">// valid texture id from the caller, so we will need to wait until the GL</span></div><div class=\"line\">    <span class=\"comment\">// content is properly allocated.</span></div><div class=\"line\">    <span class=\"keyword\">int</span> texture_id = <span class=\"keyword\">static_cast</span>&lt;<span class=\"keyword\">int</span>&gt;(video_overlay_drawable_-&gt;GetTextureId());</div><div class=\"line\">    TangoErrorType ret = TangoService_connectTextureId(</div><div class=\"line\">        TANGO_CAMERA_COLOR, texture_id, <span class=\"literal\">nullptr</span>, <span class=\"literal\">nullptr</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">      LOGE(</div><div class=\"line\">          <span class=\"string\">\"HelloVideoApp: Failed to connect the texture id with error\"</span></div><div class=\"line\">          <span class=\"string\">\"code: %d\"</span>,</div><div class=\"line\">          ret);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_video_overlay_rotation_set_) &#123;</div><div class=\"line\">    video_overlay_drawable_-&gt;SetDisplayRotation(display_rotation_);</div><div class=\"line\">    yuv_drawable_-&gt;SetDisplayRotation(display_rotation_);</div><div class=\"line\">    is_video_overlay_rotation_set_ = <span class=\"literal\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">switch</span> (current_texture_method_) &#123;</div><div class=\"line\">    <span class=\"keyword\">case</span> TextureMethod::kYuv:</div><div class=\"line\">      RenderYuv();</div><div class=\"line\">      <span class=\"keyword\">break</span>;</div><div class=\"line\">    <span class=\"keyword\">case</span> TextureMethod::kTextureId:</div><div class=\"line\">      RenderTextureId();</div><div class=\"line\">      <span class=\"keyword\">break</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::RenderYuv() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_yuv_texture_available_) &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">  &#123;</div><div class=\"line\">    <span class=\"built_in\">std</span>::lock_guard&lt;<span class=\"built_in\">std</span>::mutex&gt; lock(yuv_buffer_mutex_);</div><div class=\"line\">    <span class=\"keyword\">if</span> (swap_buffer_signal_) &#123;</div><div class=\"line\">      <span class=\"built_in\">std</span>::swap(yuv_buffer_, yuv_temp_buffer_);</div><div class=\"line\">      swap_buffer_signal_ = <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">size_t</span> i = <span class=\"number\">0</span>; i &lt; yuv_height_; ++i) &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">size_t</span> j = <span class=\"number\">0</span>; j &lt; yuv_width_; ++j) &#123;</div><div class=\"line\">      <span class=\"keyword\">size_t</span> x_index = j;</div><div class=\"line\">      <span class=\"keyword\">if</span> (j % <span class=\"number\">2</span> != <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        x_index = j - <span class=\"number\">1</span>;</div><div class=\"line\">      &#125;</div><div class=\"line\"></div><div class=\"line\">      <span class=\"keyword\">size_t</span> rgb_index = (i * yuv_width_ + j) * <span class=\"number\">3</span>;</div><div class=\"line\"></div><div class=\"line\">      <span class=\"comment\">// The YUV texture format is NV21,</span></div><div class=\"line\">      <span class=\"comment\">// yuv_buffer_ buffer layout:</span></div><div class=\"line\">      <span class=\"comment\">//   [y0, y1, y2, ..., yn, v0, u0, v1, u1, ..., v(n/4), u(n/4)]</span></div><div class=\"line\">      Yuv2Rgb(</div><div class=\"line\">          yuv_buffer_[i * yuv_width_ + j],</div><div class=\"line\">          yuv_buffer_[uv_buffer_offset_ + (i / <span class=\"number\">2</span>) * yuv_width_ + x_index + <span class=\"number\">1</span>],</div><div class=\"line\">          yuv_buffer_[uv_buffer_offset_ + (i / <span class=\"number\">2</span>) * yuv_width_ + x_index],</div><div class=\"line\">          &amp;rgb_buffer_[rgb_index], &amp;rgb_buffer_[rgb_index + <span class=\"number\">1</span>],</div><div class=\"line\">          &amp;rgb_buffer_[rgb_index + <span class=\"number\">2</span>]);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  glBindTexture(GL_TEXTURE_2D, yuv_drawable_-&gt;GetTextureId());</div><div class=\"line\">  glTexImage2D(GL_TEXTURE_2D, <span class=\"number\">0</span>, GL_RGB, yuv_width_, yuv_height_, <span class=\"number\">0</span>, GL_RGB,</div><div class=\"line\">               GL_UNSIGNED_BYTE, rgb_buffer_.data());</div><div class=\"line\"></div><div class=\"line\">  yuv_drawable_-&gt;Render(glm::mat4(<span class=\"number\">1.0f</span>), glm::mat4(<span class=\"number\">1.0f</span>));</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>在上面 RenderYuv 函数告诉了我们更多信息，color camera 获取的是 YUV NV21 格式，如何将它转为 RGB：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// We could do this conversion in a fragment shader if all we care about is</span></div><div class=\"line\"><span class=\"comment\">// rendering, but we show it here as an example of how people can use RGB data</span></div><div class=\"line\"><span class=\"comment\">// on the CPU.</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"keyword\">void</span> <span class=\"title\">Yuv2Rgb</span><span class=\"params\">(<span class=\"keyword\">uint8_t</span> y_value, <span class=\"keyword\">uint8_t</span> u_value, <span class=\"keyword\">uint8_t</span> v_value,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">                    <span class=\"keyword\">uint8_t</span>* r, <span class=\"keyword\">uint8_t</span>* g, <span class=\"keyword\">uint8_t</span>* b)</span> </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">float</span> float_r = y_value + (<span class=\"number\">1.370705</span> * (v_value - <span class=\"number\">128</span>));</div><div class=\"line\">  <span class=\"keyword\">float</span> float_g =</div><div class=\"line\">      y_value - (<span class=\"number\">0.698001</span> * (v_value - <span class=\"number\">128</span>)) - (<span class=\"number\">0.337633</span> * (u_value - <span class=\"number\">128</span>));</div><div class=\"line\">  <span class=\"keyword\">float</span> float_b = y_value + (<span class=\"number\">1.732446</span> * (u_value - <span class=\"number\">128</span>));</div><div class=\"line\"></div><div class=\"line\">  float_r = float_r * !(float_r &lt; <span class=\"number\">0</span>);</div><div class=\"line\">  float_g = float_g * !(float_g &lt; <span class=\"number\">0</span>);</div><div class=\"line\">  float_b = float_b * !(float_b &lt; <span class=\"number\">0</span>);</div><div class=\"line\"></div><div class=\"line\">  *r = float_r * (!(float_r &gt; <span class=\"number\">255</span>)) + <span class=\"number\">255</span> * (float_r &gt; <span class=\"number\">255</span>);</div><div class=\"line\">  *g = float_g * (!(float_g &gt; <span class=\"number\">255</span>)) + <span class=\"number\">255</span> * (float_g &gt; <span class=\"number\">255</span>);</div><div class=\"line\">  *b = float_b * (!(float_b &gt; <span class=\"number\">255</span>)) + <span class=\"number\">255</span> * (float_b &gt; <span class=\"number\">255</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Basic-example-hello-video\"><a href=\"#Basic-example-hello-video\" class=\"headerlink\" title=\"Basic example hello video\"></a>Basic example hello video</h2><p>完整的代码可以在 <a href=\"https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_video\" target=\"_blank\" rel=\"external\">github</a> 上找到。</p>\n<h2 id=\"On-tango-service-connected\"><a href=\"#On-tango-service-connected\" class=\"headerlink\" title=\"On tango service connected\"></a>On tango service connected</h2><p>范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">JNIEXPORT <span class=\"keyword\">void</span> JNICALL</div><div class=\"line\">Java_com_projecttango_examples_cpp_hellovideo_TangoJniNative_onTangoServiceConnected(</div><div class=\"line\">    JNIEnv* env, jobject, jobject binder) &#123;</div><div class=\"line\">  app.OnTangoServiceConnected(env, binder);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::OnTangoServiceConnected(JNIEnv* env, jobject binder) &#123;</div><div class=\"line\">  ...</div><div class=\"line\">  <span class=\"comment\">// Enable color camera from config.</span></div><div class=\"line\">  <span class=\"keyword\">int</span> ret = TangoConfig_setBool(tango_config_, <span class=\"string\">\"config_enable_color_camera\"</span>,</div><div class=\"line\">                                <span class=\"literal\">true</span>);</div><div class=\"line\">  ret = TangoService_connectOnFrameAvailable(TANGO_CAMERA_COLOR, <span class=\"keyword\">this</span>,</div><div class=\"line\">                                             OnFrameAvailableRouter);</div><div class=\"line\">  ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>从上面的代码可以看到我们启用了 color camera，并注册了 FrameAvailbale 的回调 OnFrameAvailableRouter。</p>\n<h2 id=\"On-frame-available\"><a href=\"#On-frame-available\" class=\"headerlink\" title=\"On frame available\"></a>On frame available</h2><p>接下来我们看看在回调函数中是如何处理每一帧数据的：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">namespace</span> &#123;</div><div class=\"line\"><span class=\"keyword\">constexpr</span> <span class=\"keyword\">int</span> kTangoCoreMinimumVersion = <span class=\"number\">9377</span>;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnFrameAvailableRouter</span><span class=\"params\">(<span class=\"keyword\">void</span>* context, TangoCameraId,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">                            <span class=\"keyword\">const</span> TangoImageBuffer* buffer)</span> </span>&#123;</div><div class=\"line\">  hello_video::HelloVideoApp* app =</div><div class=\"line\">      <span class=\"keyword\">static_cast</span>&lt;hello_video::HelloVideoApp*&gt;(context);</div><div class=\"line\">  app-&gt;OnFrameAvailable(buffer);</div><div class=\"line\">&#125;</div><div class=\"line\">&#125;  <span class=\"comment\">// namespace</span></div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::OnFrameAvailable(<span class=\"keyword\">const</span> TangoImageBuffer* buffer) &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (current_texture_method_ != TextureMethod::kYuv) &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (yuv_drawable_-&gt;GetTextureId() == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">    LOGE(<span class=\"string\">\"HelloVideoApp::yuv texture id not valid\"</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (buffer-&gt;format != TANGO_HAL_PIXEL_FORMAT_YCrCb_420_SP) &#123;</div><div class=\"line\">    LOGE(<span class=\"string\">\"HelloVideoApp::yuv texture format is not supported by this app\"</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// The memory needs to be allocated after we get the first frame because we</span></div><div class=\"line\">  <span class=\"comment\">// need to know the size of the image.</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_yuv_texture_available_) &#123;</div><div class=\"line\">    yuv_width_ = buffer-&gt;width;</div><div class=\"line\">    yuv_height_ = buffer-&gt;height;</div><div class=\"line\">    uv_buffer_offset_ = yuv_width_ * yuv_height_;</div><div class=\"line\"></div><div class=\"line\">    yuv_size_ = yuv_width_ * yuv_height_ + yuv_width_ * yuv_height_ / <span class=\"number\">2</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// Reserve and resize the buffer size for RGB and YUV data.</span></div><div class=\"line\">    yuv_buffer_.resize(yuv_size_);</div><div class=\"line\">    yuv_temp_buffer_.resize(yuv_size_);</div><div class=\"line\">    rgb_buffer_.resize(yuv_width_ * yuv_height_ * <span class=\"number\">3</span>);</div><div class=\"line\"></div><div class=\"line\">    AllocateTexture(yuv_drawable_-&gt;GetTextureId(), yuv_width_, yuv_height_);</div><div class=\"line\">    is_yuv_texture_available_ = <span class=\"literal\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"built_in\">std</span>::lock_guard&lt;<span class=\"built_in\">std</span>::mutex&gt; lock(yuv_buffer_mutex_);</div><div class=\"line\">  <span class=\"built_in\">memcpy</span>(&amp;yuv_temp_buffer_[<span class=\"number\">0</span>], buffer-&gt;data, yuv_size_);</div><div class=\"line\">  swap_buffer_signal_ = <span class=\"literal\">true</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>从 tango color camera 获取的是 YUV 格式，单帧数据被保存到成员变量 yuv_temp<em>buffer</em> 中，yuv_temp<em>buffer</em> 的定义如下：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">std</span>::<span class=\"built_in\">vector</span>&lt;<span class=\"keyword\">uint8_t</span>&gt; yuv_temp_buffer_;</div></pre></td></tr></table></figure></p>\n<h2 id=\"Render-YUV\"><a href=\"#Render-YUV\" class=\"headerlink\" title=\"Render YUV\"></a>Render YUV</h2><p>yuv_temp<em>buffer</em> 所保存的数据进行渲染：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::OnDrawFrame() &#123;</div><div class=\"line\">  glClearColor(<span class=\"number\">1.0f</span>, <span class=\"number\">1.0f</span>, <span class=\"number\">1.0f</span>, <span class=\"number\">1.0f</span>);</div><div class=\"line\">  glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_service_connected_) &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_texture_id_set_) &#123;</div><div class=\"line\">    is_texture_id_set_ = <span class=\"literal\">true</span>;</div><div class=\"line\">    <span class=\"comment\">// Connect color camera texture. TangoService_connectTextureId expects a</span></div><div class=\"line\">    <span class=\"comment\">// valid texture id from the caller, so we will need to wait until the GL</span></div><div class=\"line\">    <span class=\"comment\">// content is properly allocated.</span></div><div class=\"line\">    <span class=\"keyword\">int</span> texture_id = <span class=\"keyword\">static_cast</span>&lt;<span class=\"keyword\">int</span>&gt;(video_overlay_drawable_-&gt;GetTextureId());</div><div class=\"line\">    TangoErrorType ret = TangoService_connectTextureId(</div><div class=\"line\">        TANGO_CAMERA_COLOR, texture_id, <span class=\"literal\">nullptr</span>, <span class=\"literal\">nullptr</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">      LOGE(</div><div class=\"line\">          <span class=\"string\">\"HelloVideoApp: Failed to connect the texture id with error\"</span></div><div class=\"line\">          <span class=\"string\">\"code: %d\"</span>,</div><div class=\"line\">          ret);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_video_overlay_rotation_set_) &#123;</div><div class=\"line\">    video_overlay_drawable_-&gt;SetDisplayRotation(display_rotation_);</div><div class=\"line\">    yuv_drawable_-&gt;SetDisplayRotation(display_rotation_);</div><div class=\"line\">    is_video_overlay_rotation_set_ = <span class=\"literal\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">switch</span> (current_texture_method_) &#123;</div><div class=\"line\">    <span class=\"keyword\">case</span> TextureMethod::kYuv:</div><div class=\"line\">      RenderYuv();</div><div class=\"line\">      <span class=\"keyword\">break</span>;</div><div class=\"line\">    <span class=\"keyword\">case</span> TextureMethod::kTextureId:</div><div class=\"line\">      RenderTextureId();</div><div class=\"line\">      <span class=\"keyword\">break</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::RenderYuv() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (!is_yuv_texture_available_) &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">  &#123;</div><div class=\"line\">    <span class=\"built_in\">std</span>::lock_guard&lt;<span class=\"built_in\">std</span>::mutex&gt; lock(yuv_buffer_mutex_);</div><div class=\"line\">    <span class=\"keyword\">if</span> (swap_buffer_signal_) &#123;</div><div class=\"line\">      <span class=\"built_in\">std</span>::swap(yuv_buffer_, yuv_temp_buffer_);</div><div class=\"line\">      swap_buffer_signal_ = <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">size_t</span> i = <span class=\"number\">0</span>; i &lt; yuv_height_; ++i) &#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">size_t</span> j = <span class=\"number\">0</span>; j &lt; yuv_width_; ++j) &#123;</div><div class=\"line\">      <span class=\"keyword\">size_t</span> x_index = j;</div><div class=\"line\">      <span class=\"keyword\">if</span> (j % <span class=\"number\">2</span> != <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        x_index = j - <span class=\"number\">1</span>;</div><div class=\"line\">      &#125;</div><div class=\"line\"></div><div class=\"line\">      <span class=\"keyword\">size_t</span> rgb_index = (i * yuv_width_ + j) * <span class=\"number\">3</span>;</div><div class=\"line\"></div><div class=\"line\">      <span class=\"comment\">// The YUV texture format is NV21,</span></div><div class=\"line\">      <span class=\"comment\">// yuv_buffer_ buffer layout:</span></div><div class=\"line\">      <span class=\"comment\">//   [y0, y1, y2, ..., yn, v0, u0, v1, u1, ..., v(n/4), u(n/4)]</span></div><div class=\"line\">      Yuv2Rgb(</div><div class=\"line\">          yuv_buffer_[i * yuv_width_ + j],</div><div class=\"line\">          yuv_buffer_[uv_buffer_offset_ + (i / <span class=\"number\">2</span>) * yuv_width_ + x_index + <span class=\"number\">1</span>],</div><div class=\"line\">          yuv_buffer_[uv_buffer_offset_ + (i / <span class=\"number\">2</span>) * yuv_width_ + x_index],</div><div class=\"line\">          &amp;rgb_buffer_[rgb_index], &amp;rgb_buffer_[rgb_index + <span class=\"number\">1</span>],</div><div class=\"line\">          &amp;rgb_buffer_[rgb_index + <span class=\"number\">2</span>]);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  glBindTexture(GL_TEXTURE_2D, yuv_drawable_-&gt;GetTextureId());</div><div class=\"line\">  glTexImage2D(GL_TEXTURE_2D, <span class=\"number\">0</span>, GL_RGB, yuv_width_, yuv_height_, <span class=\"number\">0</span>, GL_RGB,</div><div class=\"line\">               GL_UNSIGNED_BYTE, rgb_buffer_.data());</div><div class=\"line\"></div><div class=\"line\">  yuv_drawable_-&gt;Render(glm::mat4(<span class=\"number\">1.0f</span>), glm::mat4(<span class=\"number\">1.0f</span>));</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>在上面 RenderYuv 函数告诉了我们更多信息，color camera 获取的是 YUV NV21 格式，如何将它转为 RGB：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// We could do this conversion in a fragment shader if all we care about is</span></div><div class=\"line\"><span class=\"comment\">// rendering, but we show it here as an example of how people can use RGB data</span></div><div class=\"line\"><span class=\"comment\">// on the CPU.</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">inline</span> <span class=\"keyword\">void</span> <span class=\"title\">Yuv2Rgb</span><span class=\"params\">(<span class=\"keyword\">uint8_t</span> y_value, <span class=\"keyword\">uint8_t</span> u_value, <span class=\"keyword\">uint8_t</span> v_value,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">                    <span class=\"keyword\">uint8_t</span>* r, <span class=\"keyword\">uint8_t</span>* g, <span class=\"keyword\">uint8_t</span>* b)</span> </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">float</span> float_r = y_value + (<span class=\"number\">1.370705</span> * (v_value - <span class=\"number\">128</span>));</div><div class=\"line\">  <span class=\"keyword\">float</span> float_g =</div><div class=\"line\">      y_value - (<span class=\"number\">0.698001</span> * (v_value - <span class=\"number\">128</span>)) - (<span class=\"number\">0.337633</span> * (u_value - <span class=\"number\">128</span>));</div><div class=\"line\">  <span class=\"keyword\">float</span> float_b = y_value + (<span class=\"number\">1.732446</span> * (u_value - <span class=\"number\">128</span>));</div><div class=\"line\"></div><div class=\"line\">  float_r = float_r * !(float_r &lt; <span class=\"number\">0</span>);</div><div class=\"line\">  float_g = float_g * !(float_g &lt; <span class=\"number\">0</span>);</div><div class=\"line\">  float_b = float_b * !(float_b &lt; <span class=\"number\">0</span>);</div><div class=\"line\"></div><div class=\"line\">  *r = float_r * (!(float_r &gt; <span class=\"number\">255</span>)) + <span class=\"number\">255</span> * (float_r &gt; <span class=\"number\">255</span>);</div><div class=\"line\">  *g = float_g * (!(float_g &gt; <span class=\"number\">255</span>)) + <span class=\"number\">255</span> * (float_g &gt; <span class=\"number\">255</span>);</div><div class=\"line\">  *b = float_b * (!(float_b &gt; <span class=\"number\">255</span>)) + <span class=\"number\">255</span> * (float_b &gt; <span class=\"number\">255</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n"},{"title":"Tango Example hello area description","date":"2017-07-28T02:26:42.000Z","_content":"\n## Basic example hello depth perception\n\n完整的代码可以在 [github](https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_area_description) 上找到。\n\n## On tango service connected\n\n范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：\n``` cpp\nJNIEXPORT void JNICALL\nJava_com_projecttango_examples_cpp_helloareadescription_TangoJniNative_onTangoServiceConnected(\n    JNIEnv* env, jobject, jobject binder, jboolean is_area_learning_enabled,\n    jboolean is_loading_area_description) {\n  app.OnTangoServiceConnected(env, binder, is_area_learning_enabled,\n                              is_loading_area_description);\n}\n```\n\n``` cpp\nvoid AreaLearningApp::OnTangoServiceConnected(\n    JNIEnv* env, jobject binder, bool is_area_learning_enabled,\n    bool is_loading_area_description) {\n  ...\n\n  if (is_area_learning_enabled || is_loading_area_description) {\n    // Here, we'll configure the service to run in the way we'd want. For this\n    // application, we'll start from the default configuration\n    // (TANGO_CONFIG_DEFAULT). This enables basic motion tracking capabilities.\n    tango_config_ = TangoService_getConfig(TANGO_CONFIG_DEFAULT);\n    if (tango_config_ == nullptr) {\n      LOGE(\"AreaLearningApp: Failed to get default config form\");\n      std::exit(EXIT_SUCCESS);\n    }\n\n    int ret = TangoConfig_setBool(tango_config_, \"config_enable_learning_mode\",\n                                  is_area_learning_enabled);\n    if (ret != TANGO_SUCCESS) {\n      LOGE(\n          \"AreaLearningApp: config_enable_learning_mode failed with error\"\n          \"code: %d\",\n          ret);\n      std::exit(EXIT_SUCCESS);\n    }\n\n    // If load ADF, load the most recent saved ADF.\n    if (is_loading_area_description) {\n      std::vector<std::string> adf_list;\n      GetAdfUuids(&adf_list);\n      if (!adf_list.empty()) {\n        std::string adf_uuid = adf_list.back();\n        std::ostringstream adf_str_stream;\n        adf_str_stream << \"Number of ADFs:\" << adf_list.size()\n                       << \", Loaded ADF: \" << adf_uuid;\n        loaded_adf_string_ = adf_str_stream.str();\n        ret = TangoConfig_setString(tango_config_,\n                                    \"config_load_area_description_UUID\",\n                                    adf_uuid.c_str());\n        if (ret != TANGO_SUCCESS) {\n          LOGE(\"AreaLearningApp: get ADF UUID failed with error code: %d\", ret);\n        }\n      }\n    }\n\n    // Setting up the frame pair for the onPoseAvailable callback.\n    TangoCoordinateFramePair pairs[3] = {\n        {TANGO_COORDINATE_FRAME_START_OF_SERVICE,\n         TANGO_COORDINATE_FRAME_DEVICE},\n        {TANGO_COORDINATE_FRAME_AREA_DESCRIPTION,\n         TANGO_COORDINATE_FRAME_DEVICE},\n        {TANGO_COORDINATE_FRAME_AREA_DESCRIPTION,\n         TANGO_COORDINATE_FRAME_START_OF_SERVICE}};\n\n    // Attach onPoseAvailable callback.\n    // The callback will be called after the service is connected.\n    ret = TangoService_connectOnPoseAvailable(3, pairs, onPoseAvailableRouter);\n    if (ret != TANGO_SUCCESS) {\n      LOGE(\n          \"AreaLearningApp: Failed to connect to pose callback with error\"\n          \"code: %d\",\n          ret);\n      std::exit(EXIT_SUCCESS);\n    }\n\n    // Connect to the Tango Service, the service will start running:\n    // point clouds can be queried and callbacks will be called.\n    ret = TangoService_connect(this, tango_config_);\n    if (ret != TANGO_SUCCESS) {\n      LOGE(\n          \"AreaLearningApp::OnTangoServiceConnected,\"\n          \"Failed to connect to the Tango service with error code: %d\",\n          ret);\n      std::exit(EXIT_SUCCESS);\n    }\n  }\n}\n```\n相较与 color 和 depth，pose 的初始设置更复杂，其中有大量是关于 ADF（Automatic Direction Finder：自动方位搜寻器）的，实际代码还另有大量处理 ADF 的函数被定义和实现，请参考原始代码。\n\n我们这里重点关注 PoseAvailable 的回调 OnPoseAvailableRouter。\n\n## On pose available\n\n接下来我们看看在回调函数中如何处理 pose 数据：\n``` cpp\nnamespace {\n// The minimum Tango Core version required from this application.\nconstexpr int kTangoCoreMinimumVersion = 9377;\nconst int kVersionStringLength = 128;\n\n// This function routes onPoseAvailable callbacks to the application object for\n// handling.\n//\n// @param context, context will be a pointer to a AreaLearningApp\n//        instance on which to call callbacks.\n// @param pose, pose data to route to onPoseAvailable function.\nvoid onPoseAvailableRouter(void* context, const TangoPoseData* pose) {\n  hello_area_description::AreaLearningApp* app =\n      static_cast<hello_area_description::AreaLearningApp*>(context);\n  app->onPoseAvailable(pose);\n}\n}  // namespace\n\nvoid AreaLearningApp::onPoseAvailable(const TangoPoseData* pose) {\n  std::lock_guard<std::mutex> lock(pose_mutex_);\n  pose_data_.UpdatePose(*pose);\n}\n```\nPose 数据被保存在成员变量 pose_data_ 中，它的定义：\n``` cpp\n  // pose_data_ handles all pose onPoseAvailable callbacks, onPoseAvailable()\n  // in this object will be routed to pose_data_ to handle.\n  PoseData pose_data_;\n```\n\n## PoseData\n\n这里出现的 PoseData 并非 SDK 提供，其完整定义如下。\n``` cpp\n// PoseData holds all pose related data. E.g. pose position, rotation and time-\n// stamp. It also produce the debug information strings.\nclass PoseData {\n public:\n  PoseData();\n  ~PoseData();\n\n  // Update current pose and previous pose.\n  //\n  // @param pose: pose data of current frame.\n  void UpdatePose(const TangoPoseData& pose_data);\n\n  // Reset all saved pose data.\n  void ResetPoseData();\n\n  // Get pose data in current frame.\n  //\n  // @return: curent pose data.\n  TangoPoseData GetCurrentPoseData();\n\n  // Check if the device is relocalized.\n  //\n  // @return: relocalized flag.\n  bool IsRelocalized() { return is_relocalized_; }\n\n private:\n  // Relocalized flag, the relocalization is determined by the pose in start of\n  // service with respect to ADF turns to valid.\n  bool is_relocalized_ = false;\n\n  TangoPoseData adf_T_device_pose_;\n  TangoPoseData start_service_T_device_pose_;\n};\n```\n\n``` cpp\nPoseData::PoseData() {}\n\nPoseData::~PoseData() {}\n\nvoid PoseData::UpdatePose(const TangoPoseData& pose_data) {\n  // We check the frame pair received in the pose_data instance, and store it\n  // in the proper cooresponding local member.\n  //\n  // The frame pairs are the one we registred in the\n  // TangoService_connectOnPoseAvailable functions during the setup of the\n  // Tango configuration file.\n  if (pose_data.frame.base == TANGO_COORDINATE_FRAME_START_OF_SERVICE &&\n      pose_data.frame.target == TANGO_COORDINATE_FRAME_DEVICE) {\n    start_service_T_device_pose_ = pose_data;\n  } else if (pose_data.frame.base == TANGO_COORDINATE_FRAME_AREA_DESCRIPTION &&\n             pose_data.frame.target == TANGO_COORDINATE_FRAME_DEVICE) {\n    adf_T_device_pose_ = pose_data;\n  } else if (pose_data.frame.base == TANGO_COORDINATE_FRAME_AREA_DESCRIPTION &&\n             pose_data.frame.target ==\n                 TANGO_COORDINATE_FRAME_START_OF_SERVICE) {\n    is_relocalized_ = (pose_data.status_code == TANGO_POSE_VALID);\n  } else {\n    return;\n  }\n}\n\nvoid PoseData::ResetPoseData() { is_relocalized_ = false; }\n\nTangoPoseData PoseData::GetCurrentPoseData() {\n  if (is_relocalized_) {\n    return adf_T_device_pose_;\n  } else {\n    return start_service_T_device_pose_;\n  }\n}\n```\n\n## TangoPoseData\n\nSDK 所提供的 TangoPoseData，完整信息请查看 [官方文档](https://developers.google.com/tango/apis/c/reference/struct/tango-pose-data)，下面只重点说明几个公共属性。\n\n### frame\n\n``` cpp\nTangoCoordinateFramePair TangoPoseData::frame\n```\nThe pair of coordinate frames for this pose.\n\nWe retrieve a pose for a target coordinate frame (such as the Tango device) against a base coordinate frame (such as a learned area).\n\n### orientation\n\n``` cpp\ndouble TangoPoseData::orientation[4]\n```\nOrientation, as a quaternion, of the pose of the target frame with reference to the base frame.\n\nSpecified as (x,y,z,w) where RotationAngle is in radians:\n\n``` cpp\nx = RotationAxis.x * sin(RotationAngle / 2)\ny = RotationAxis.y * sin(RotationAngle / 2)\nz = RotationAxis.z * sin(RotationAngle / 2)\nw = cos(RotationAngle / 2)\n```\n\n### status_code\n\n``` cpp\nTangoPoseStatusType TangoPoseData::status_code\n```\nThe status of the pose, according to the pose lifecycle.\n\n### timestamp\n\n``` cpp\ndouble TangoPoseData::timestamp\n```\nThe timestamp of the pose estimate, in seconds.\n\n### translation\n\n``` cpp\ndouble TangoPoseData::translation[3]\n```\nTranslation, ordered x, y, z, of the pose of the target frame with reference to the base frame.\n","source":"_posts/Tango-Example-hello-area-description.md","raw":"---\ntitle: Tango Example hello area description\ndate: 2017-07-28 10:26:42\ncategories: Tango\ntags: [Project Tango]\n---\n\n## Basic example hello depth perception\n\n完整的代码可以在 [github](https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_area_description) 上找到。\n\n## On tango service connected\n\n范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：\n``` cpp\nJNIEXPORT void JNICALL\nJava_com_projecttango_examples_cpp_helloareadescription_TangoJniNative_onTangoServiceConnected(\n    JNIEnv* env, jobject, jobject binder, jboolean is_area_learning_enabled,\n    jboolean is_loading_area_description) {\n  app.OnTangoServiceConnected(env, binder, is_area_learning_enabled,\n                              is_loading_area_description);\n}\n```\n\n``` cpp\nvoid AreaLearningApp::OnTangoServiceConnected(\n    JNIEnv* env, jobject binder, bool is_area_learning_enabled,\n    bool is_loading_area_description) {\n  ...\n\n  if (is_area_learning_enabled || is_loading_area_description) {\n    // Here, we'll configure the service to run in the way we'd want. For this\n    // application, we'll start from the default configuration\n    // (TANGO_CONFIG_DEFAULT). This enables basic motion tracking capabilities.\n    tango_config_ = TangoService_getConfig(TANGO_CONFIG_DEFAULT);\n    if (tango_config_ == nullptr) {\n      LOGE(\"AreaLearningApp: Failed to get default config form\");\n      std::exit(EXIT_SUCCESS);\n    }\n\n    int ret = TangoConfig_setBool(tango_config_, \"config_enable_learning_mode\",\n                                  is_area_learning_enabled);\n    if (ret != TANGO_SUCCESS) {\n      LOGE(\n          \"AreaLearningApp: config_enable_learning_mode failed with error\"\n          \"code: %d\",\n          ret);\n      std::exit(EXIT_SUCCESS);\n    }\n\n    // If load ADF, load the most recent saved ADF.\n    if (is_loading_area_description) {\n      std::vector<std::string> adf_list;\n      GetAdfUuids(&adf_list);\n      if (!adf_list.empty()) {\n        std::string adf_uuid = adf_list.back();\n        std::ostringstream adf_str_stream;\n        adf_str_stream << \"Number of ADFs:\" << adf_list.size()\n                       << \", Loaded ADF: \" << adf_uuid;\n        loaded_adf_string_ = adf_str_stream.str();\n        ret = TangoConfig_setString(tango_config_,\n                                    \"config_load_area_description_UUID\",\n                                    adf_uuid.c_str());\n        if (ret != TANGO_SUCCESS) {\n          LOGE(\"AreaLearningApp: get ADF UUID failed with error code: %d\", ret);\n        }\n      }\n    }\n\n    // Setting up the frame pair for the onPoseAvailable callback.\n    TangoCoordinateFramePair pairs[3] = {\n        {TANGO_COORDINATE_FRAME_START_OF_SERVICE,\n         TANGO_COORDINATE_FRAME_DEVICE},\n        {TANGO_COORDINATE_FRAME_AREA_DESCRIPTION,\n         TANGO_COORDINATE_FRAME_DEVICE},\n        {TANGO_COORDINATE_FRAME_AREA_DESCRIPTION,\n         TANGO_COORDINATE_FRAME_START_OF_SERVICE}};\n\n    // Attach onPoseAvailable callback.\n    // The callback will be called after the service is connected.\n    ret = TangoService_connectOnPoseAvailable(3, pairs, onPoseAvailableRouter);\n    if (ret != TANGO_SUCCESS) {\n      LOGE(\n          \"AreaLearningApp: Failed to connect to pose callback with error\"\n          \"code: %d\",\n          ret);\n      std::exit(EXIT_SUCCESS);\n    }\n\n    // Connect to the Tango Service, the service will start running:\n    // point clouds can be queried and callbacks will be called.\n    ret = TangoService_connect(this, tango_config_);\n    if (ret != TANGO_SUCCESS) {\n      LOGE(\n          \"AreaLearningApp::OnTangoServiceConnected,\"\n          \"Failed to connect to the Tango service with error code: %d\",\n          ret);\n      std::exit(EXIT_SUCCESS);\n    }\n  }\n}\n```\n相较与 color 和 depth，pose 的初始设置更复杂，其中有大量是关于 ADF（Automatic Direction Finder：自动方位搜寻器）的，实际代码还另有大量处理 ADF 的函数被定义和实现，请参考原始代码。\n\n我们这里重点关注 PoseAvailable 的回调 OnPoseAvailableRouter。\n\n## On pose available\n\n接下来我们看看在回调函数中如何处理 pose 数据：\n``` cpp\nnamespace {\n// The minimum Tango Core version required from this application.\nconstexpr int kTangoCoreMinimumVersion = 9377;\nconst int kVersionStringLength = 128;\n\n// This function routes onPoseAvailable callbacks to the application object for\n// handling.\n//\n// @param context, context will be a pointer to a AreaLearningApp\n//        instance on which to call callbacks.\n// @param pose, pose data to route to onPoseAvailable function.\nvoid onPoseAvailableRouter(void* context, const TangoPoseData* pose) {\n  hello_area_description::AreaLearningApp* app =\n      static_cast<hello_area_description::AreaLearningApp*>(context);\n  app->onPoseAvailable(pose);\n}\n}  // namespace\n\nvoid AreaLearningApp::onPoseAvailable(const TangoPoseData* pose) {\n  std::lock_guard<std::mutex> lock(pose_mutex_);\n  pose_data_.UpdatePose(*pose);\n}\n```\nPose 数据被保存在成员变量 pose_data_ 中，它的定义：\n``` cpp\n  // pose_data_ handles all pose onPoseAvailable callbacks, onPoseAvailable()\n  // in this object will be routed to pose_data_ to handle.\n  PoseData pose_data_;\n```\n\n## PoseData\n\n这里出现的 PoseData 并非 SDK 提供，其完整定义如下。\n``` cpp\n// PoseData holds all pose related data. E.g. pose position, rotation and time-\n// stamp. It also produce the debug information strings.\nclass PoseData {\n public:\n  PoseData();\n  ~PoseData();\n\n  // Update current pose and previous pose.\n  //\n  // @param pose: pose data of current frame.\n  void UpdatePose(const TangoPoseData& pose_data);\n\n  // Reset all saved pose data.\n  void ResetPoseData();\n\n  // Get pose data in current frame.\n  //\n  // @return: curent pose data.\n  TangoPoseData GetCurrentPoseData();\n\n  // Check if the device is relocalized.\n  //\n  // @return: relocalized flag.\n  bool IsRelocalized() { return is_relocalized_; }\n\n private:\n  // Relocalized flag, the relocalization is determined by the pose in start of\n  // service with respect to ADF turns to valid.\n  bool is_relocalized_ = false;\n\n  TangoPoseData adf_T_device_pose_;\n  TangoPoseData start_service_T_device_pose_;\n};\n```\n\n``` cpp\nPoseData::PoseData() {}\n\nPoseData::~PoseData() {}\n\nvoid PoseData::UpdatePose(const TangoPoseData& pose_data) {\n  // We check the frame pair received in the pose_data instance, and store it\n  // in the proper cooresponding local member.\n  //\n  // The frame pairs are the one we registred in the\n  // TangoService_connectOnPoseAvailable functions during the setup of the\n  // Tango configuration file.\n  if (pose_data.frame.base == TANGO_COORDINATE_FRAME_START_OF_SERVICE &&\n      pose_data.frame.target == TANGO_COORDINATE_FRAME_DEVICE) {\n    start_service_T_device_pose_ = pose_data;\n  } else if (pose_data.frame.base == TANGO_COORDINATE_FRAME_AREA_DESCRIPTION &&\n             pose_data.frame.target == TANGO_COORDINATE_FRAME_DEVICE) {\n    adf_T_device_pose_ = pose_data;\n  } else if (pose_data.frame.base == TANGO_COORDINATE_FRAME_AREA_DESCRIPTION &&\n             pose_data.frame.target ==\n                 TANGO_COORDINATE_FRAME_START_OF_SERVICE) {\n    is_relocalized_ = (pose_data.status_code == TANGO_POSE_VALID);\n  } else {\n    return;\n  }\n}\n\nvoid PoseData::ResetPoseData() { is_relocalized_ = false; }\n\nTangoPoseData PoseData::GetCurrentPoseData() {\n  if (is_relocalized_) {\n    return adf_T_device_pose_;\n  } else {\n    return start_service_T_device_pose_;\n  }\n}\n```\n\n## TangoPoseData\n\nSDK 所提供的 TangoPoseData，完整信息请查看 [官方文档](https://developers.google.com/tango/apis/c/reference/struct/tango-pose-data)，下面只重点说明几个公共属性。\n\n### frame\n\n``` cpp\nTangoCoordinateFramePair TangoPoseData::frame\n```\nThe pair of coordinate frames for this pose.\n\nWe retrieve a pose for a target coordinate frame (such as the Tango device) against a base coordinate frame (such as a learned area).\n\n### orientation\n\n``` cpp\ndouble TangoPoseData::orientation[4]\n```\nOrientation, as a quaternion, of the pose of the target frame with reference to the base frame.\n\nSpecified as (x,y,z,w) where RotationAngle is in radians:\n\n``` cpp\nx = RotationAxis.x * sin(RotationAngle / 2)\ny = RotationAxis.y * sin(RotationAngle / 2)\nz = RotationAxis.z * sin(RotationAngle / 2)\nw = cos(RotationAngle / 2)\n```\n\n### status_code\n\n``` cpp\nTangoPoseStatusType TangoPoseData::status_code\n```\nThe status of the pose, according to the pose lifecycle.\n\n### timestamp\n\n``` cpp\ndouble TangoPoseData::timestamp\n```\nThe timestamp of the pose estimate, in seconds.\n\n### translation\n\n``` cpp\ndouble TangoPoseData::translation[3]\n```\nTranslation, ordered x, y, z, of the pose of the target frame with reference to the base frame.\n","slug":"Tango-Example-hello-area-description","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48ed000jnki35o7fufci","content":"<h2 id=\"Basic-example-hello-depth-perception\"><a href=\"#Basic-example-hello-depth-perception\" class=\"headerlink\" title=\"Basic example hello depth perception\"></a>Basic example hello depth perception</h2><p>完整的代码可以在 <a href=\"https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_area_description\" target=\"_blank\" rel=\"external\">github</a> 上找到。</p>\n<h2 id=\"On-tango-service-connected\"><a href=\"#On-tango-service-connected\" class=\"headerlink\" title=\"On tango service connected\"></a>On tango service connected</h2><p>范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">JNIEXPORT <span class=\"keyword\">void</span> JNICALL</div><div class=\"line\">Java_com_projecttango_examples_cpp_helloareadescription_TangoJniNative_onTangoServiceConnected(</div><div class=\"line\">    JNIEnv* env, jobject, jobject binder, jboolean is_area_learning_enabled,</div><div class=\"line\">    jboolean is_loading_area_description) &#123;</div><div class=\"line\">  app.OnTangoServiceConnected(env, binder, is_area_learning_enabled,</div><div class=\"line\">                              is_loading_area_description);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> AreaLearningApp::OnTangoServiceConnected(</div><div class=\"line\">    JNIEnv* env, jobject binder, <span class=\"keyword\">bool</span> is_area_learning_enabled,</div><div class=\"line\">    <span class=\"keyword\">bool</span> is_loading_area_description) &#123;</div><div class=\"line\">  ...</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (is_area_learning_enabled || is_loading_area_description) &#123;</div><div class=\"line\">    <span class=\"comment\">// Here, we'll configure the service to run in the way we'd want. For this</span></div><div class=\"line\">    <span class=\"comment\">// application, we'll start from the default configuration</span></div><div class=\"line\">    <span class=\"comment\">// (TANGO_CONFIG_DEFAULT). This enables basic motion tracking capabilities.</span></div><div class=\"line\">    tango_config_ = TangoService_getConfig(TANGO_CONFIG_DEFAULT);</div><div class=\"line\">    <span class=\"keyword\">if</span> (tango_config_ == <span class=\"literal\">nullptr</span>) &#123;</div><div class=\"line\">      LOGE(<span class=\"string\">\"AreaLearningApp: Failed to get default config form\"</span>);</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">int</span> ret = TangoConfig_setBool(tango_config_, <span class=\"string\">\"config_enable_learning_mode\"</span>,</div><div class=\"line\">                                  is_area_learning_enabled);</div><div class=\"line\">    <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">      LOGE(</div><div class=\"line\">          <span class=\"string\">\"AreaLearningApp: config_enable_learning_mode failed with error\"</span></div><div class=\"line\">          <span class=\"string\">\"code: %d\"</span>,</div><div class=\"line\">          ret);</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// If load ADF, load the most recent saved ADF.</span></div><div class=\"line\">    <span class=\"keyword\">if</span> (is_loading_area_description) &#123;</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">vector</span>&lt;<span class=\"built_in\">std</span>::<span class=\"built_in\">string</span>&gt; adf_list;</div><div class=\"line\">      GetAdfUuids(&amp;adf_list);</div><div class=\"line\">      <span class=\"keyword\">if</span> (!adf_list.empty()) &#123;</div><div class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> adf_uuid = adf_list.back();</div><div class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">ostringstream</span> adf_str_stream;</div><div class=\"line\">        adf_str_stream &lt;&lt; <span class=\"string\">\"Number of ADFs:\"</span> &lt;&lt; adf_list.size()</div><div class=\"line\">                       &lt;&lt; <span class=\"string\">\", Loaded ADF: \"</span> &lt;&lt; adf_uuid;</div><div class=\"line\">        loaded_adf_string_ = adf_str_stream.str();</div><div class=\"line\">        ret = TangoConfig_setString(tango_config_,</div><div class=\"line\">                                    <span class=\"string\">\"config_load_area_description_UUID\"</span>,</div><div class=\"line\">                                    adf_uuid.c_str());</div><div class=\"line\">        <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">          LOGE(<span class=\"string\">\"AreaLearningApp: get ADF UUID failed with error code: %d\"</span>, ret);</div><div class=\"line\">        &#125;</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// Setting up the frame pair for the onPoseAvailable callback.</span></div><div class=\"line\">    TangoCoordinateFramePair pairs[<span class=\"number\">3</span>] = &#123;</div><div class=\"line\">        &#123;TANGO_COORDINATE_FRAME_START_OF_SERVICE,</div><div class=\"line\">         TANGO_COORDINATE_FRAME_DEVICE&#125;,</div><div class=\"line\">        &#123;TANGO_COORDINATE_FRAME_AREA_DESCRIPTION,</div><div class=\"line\">         TANGO_COORDINATE_FRAME_DEVICE&#125;,</div><div class=\"line\">        &#123;TANGO_COORDINATE_FRAME_AREA_DESCRIPTION,</div><div class=\"line\">         TANGO_COORDINATE_FRAME_START_OF_SERVICE&#125;&#125;;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// Attach onPoseAvailable callback.</span></div><div class=\"line\">    <span class=\"comment\">// The callback will be called after the service is connected.</span></div><div class=\"line\">    ret = TangoService_connectOnPoseAvailable(<span class=\"number\">3</span>, pairs, onPoseAvailableRouter);</div><div class=\"line\">    <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">      LOGE(</div><div class=\"line\">          <span class=\"string\">\"AreaLearningApp: Failed to connect to pose callback with error\"</span></div><div class=\"line\">          <span class=\"string\">\"code: %d\"</span>,</div><div class=\"line\">          ret);</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// Connect to the Tango Service, the service will start running:</span></div><div class=\"line\">    <span class=\"comment\">// point clouds can be queried and callbacks will be called.</span></div><div class=\"line\">    ret = TangoService_connect(<span class=\"keyword\">this</span>, tango_config_);</div><div class=\"line\">    <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">      LOGE(</div><div class=\"line\">          <span class=\"string\">\"AreaLearningApp::OnTangoServiceConnected,\"</span></div><div class=\"line\">          <span class=\"string\">\"Failed to connect to the Tango service with error code: %d\"</span>,</div><div class=\"line\">          ret);</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>相较与 color 和 depth，pose 的初始设置更复杂，其中有大量是关于 ADF（Automatic Direction Finder：自动方位搜寻器）的，实际代码还另有大量处理 ADF 的函数被定义和实现，请参考原始代码。</p>\n<p>我们这里重点关注 PoseAvailable 的回调 OnPoseAvailableRouter。</p>\n<h2 id=\"On-pose-available\"><a href=\"#On-pose-available\" class=\"headerlink\" title=\"On pose available\"></a>On pose available</h2><p>接下来我们看看在回调函数中如何处理 pose 数据：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">namespace</span> &#123;</div><div class=\"line\"><span class=\"comment\">// The minimum Tango Core version required from this application.</span></div><div class=\"line\"><span class=\"keyword\">constexpr</span> <span class=\"keyword\">int</span> kTangoCoreMinimumVersion = <span class=\"number\">9377</span>;</div><div class=\"line\"><span class=\"keyword\">const</span> <span class=\"keyword\">int</span> kVersionStringLength = <span class=\"number\">128</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// This function routes onPoseAvailable callbacks to the application object for</span></div><div class=\"line\"><span class=\"comment\">// handling.</span></div><div class=\"line\"><span class=\"comment\">//</span></div><div class=\"line\"><span class=\"comment\">// @param context, context will be a pointer to a AreaLearningApp</span></div><div class=\"line\"><span class=\"comment\">//        instance on which to call callbacks.</span></div><div class=\"line\"><span class=\"comment\">// @param pose, pose data to route to onPoseAvailable function.</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onPoseAvailableRouter</span><span class=\"params\">(<span class=\"keyword\">void</span>* context, <span class=\"keyword\">const</span> TangoPoseData* pose)</span> </span>&#123;</div><div class=\"line\">  hello_area_description::AreaLearningApp* app =</div><div class=\"line\">      <span class=\"keyword\">static_cast</span>&lt;hello_area_description::AreaLearningApp*&gt;(context);</div><div class=\"line\">  app-&gt;onPoseAvailable(pose);</div><div class=\"line\">&#125;</div><div class=\"line\">&#125;  <span class=\"comment\">// namespace</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> AreaLearningApp::onPoseAvailable(<span class=\"keyword\">const</span> TangoPoseData* pose) &#123;</div><div class=\"line\">  <span class=\"built_in\">std</span>::lock_guard&lt;<span class=\"built_in\">std</span>::mutex&gt; lock(pose_mutex_);</div><div class=\"line\">  pose_data_.UpdatePose(*pose);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>Pose 数据被保存在成员变量 pose<em>data</em> 中，它的定义：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// pose_data_ handles all pose onPoseAvailable callbacks, onPoseAvailable()</span></div><div class=\"line\"><span class=\"comment\">// in this object will be routed to pose_data_ to handle.</span></div><div class=\"line\">PoseData pose_data_;</div></pre></td></tr></table></figure></p>\n<h2 id=\"PoseData\"><a href=\"#PoseData\" class=\"headerlink\" title=\"PoseData\"></a>PoseData</h2><p>这里出现的 PoseData 并非 SDK 提供，其完整定义如下。<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// PoseData holds all pose related data. E.g. pose position, rotation and time-</span></div><div class=\"line\"><span class=\"comment\">// stamp. It also produce the debug information strings.</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PoseData</span> &#123;</span></div><div class=\"line\"> <span class=\"keyword\">public</span>:</div><div class=\"line\">  PoseData();</div><div class=\"line\">  ~PoseData();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Update current pose and previous pose.</span></div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// @param pose: pose data of current frame.</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">UpdatePose</span><span class=\"params\">(<span class=\"keyword\">const</span> TangoPoseData&amp; pose_data)</span></span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Reset all saved pose data.</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">ResetPoseData</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Get pose data in current frame.</span></div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// @return: curent pose data.</span></div><div class=\"line\">  <span class=\"function\">TangoPoseData <span class=\"title\">GetCurrentPoseData</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Check if the device is relocalized.</span></div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// @return: relocalized flag.</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">bool</span> <span class=\"title\">IsRelocalized</span><span class=\"params\">()</span> </span>&#123; <span class=\"keyword\">return</span> is_relocalized_; &#125;</div><div class=\"line\"></div><div class=\"line\"> <span class=\"keyword\">private</span>:</div><div class=\"line\">  <span class=\"comment\">// Relocalized flag, the relocalization is determined by the pose in start of</span></div><div class=\"line\">  <span class=\"comment\">// service with respect to ADF turns to valid.</span></div><div class=\"line\">  <span class=\"keyword\">bool</span> is_relocalized_ = <span class=\"literal\">false</span>;</div><div class=\"line\"></div><div class=\"line\">  TangoPoseData adf_T_device_pose_;</div><div class=\"line\">  TangoPoseData start_service_T_device_pose_;</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\">PoseData::PoseData() &#123;&#125;</div><div class=\"line\"></div><div class=\"line\">PoseData::~PoseData() &#123;&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> PoseData::UpdatePose(<span class=\"keyword\">const</span> TangoPoseData&amp; pose_data) &#123;</div><div class=\"line\">  <span class=\"comment\">// We check the frame pair received in the pose_data instance, and store it</span></div><div class=\"line\">  <span class=\"comment\">// in the proper cooresponding local member.</span></div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// The frame pairs are the one we registred in the</span></div><div class=\"line\">  <span class=\"comment\">// TangoService_connectOnPoseAvailable functions during the setup of the</span></div><div class=\"line\">  <span class=\"comment\">// Tango configuration file.</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (pose_data.frame.base == TANGO_COORDINATE_FRAME_START_OF_SERVICE &amp;&amp;</div><div class=\"line\">      pose_data.frame.target == TANGO_COORDINATE_FRAME_DEVICE) &#123;</div><div class=\"line\">    start_service_T_device_pose_ = pose_data;</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pose_data.frame.base == TANGO_COORDINATE_FRAME_AREA_DESCRIPTION &amp;&amp;</div><div class=\"line\">             pose_data.frame.target == TANGO_COORDINATE_FRAME_DEVICE) &#123;</div><div class=\"line\">    adf_T_device_pose_ = pose_data;</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pose_data.frame.base == TANGO_COORDINATE_FRAME_AREA_DESCRIPTION &amp;&amp;</div><div class=\"line\">             pose_data.frame.target ==</div><div class=\"line\">                 TANGO_COORDINATE_FRAME_START_OF_SERVICE) &#123;</div><div class=\"line\">    is_relocalized_ = (pose_data.status_code == TANGO_POSE_VALID);</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> PoseData::ResetPoseData() &#123; is_relocalized_ = <span class=\"literal\">false</span>; &#125;</div><div class=\"line\"></div><div class=\"line\">TangoPoseData PoseData::GetCurrentPoseData() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (is_relocalized_) &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> adf_T_device_pose_;</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> start_service_T_device_pose_;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"TangoPoseData\"><a href=\"#TangoPoseData\" class=\"headerlink\" title=\"TangoPoseData\"></a>TangoPoseData</h2><p>SDK 所提供的 TangoPoseData，完整信息请查看 <a href=\"https://developers.google.com/tango/apis/c/reference/struct/tango-pose-data\" target=\"_blank\" rel=\"external\">官方文档</a>，下面只重点说明几个公共属性。</p>\n<h3 id=\"frame\"><a href=\"#frame\" class=\"headerlink\" title=\"frame\"></a>frame</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">TangoCoordinateFramePair TangoPoseData::frame</div></pre></td></tr></table></figure>\n<p>The pair of coordinate frames for this pose.</p>\n<p>We retrieve a pose for a target coordinate frame (such as the Tango device) against a base coordinate frame (such as a learned area).</p>\n<h3 id=\"orientation\"><a href=\"#orientation\" class=\"headerlink\" title=\"orientation\"></a>orientation</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">double</span> TangoPoseData::orientation[<span class=\"number\">4</span>]</div></pre></td></tr></table></figure>\n<p>Orientation, as a quaternion, of the pose of the target frame with reference to the base frame.</p>\n<p>Specified as (x,y,z,w) where RotationAngle is in radians:</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">x = RotationAxis.x * <span class=\"built_in\">sin</span>(RotationAngle / <span class=\"number\">2</span>)</div><div class=\"line\">y = RotationAxis.y * <span class=\"built_in\">sin</span>(RotationAngle / <span class=\"number\">2</span>)</div><div class=\"line\">z = RotationAxis.z * <span class=\"built_in\">sin</span>(RotationAngle / <span class=\"number\">2</span>)</div><div class=\"line\">w = <span class=\"built_in\">cos</span>(RotationAngle / <span class=\"number\">2</span>)</div></pre></td></tr></table></figure>\n<h3 id=\"status-code\"><a href=\"#status-code\" class=\"headerlink\" title=\"status_code\"></a>status_code</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">TangoPoseStatusType TangoPoseData::status_code</div></pre></td></tr></table></figure>\n<p>The status of the pose, according to the pose lifecycle.</p>\n<h3 id=\"timestamp\"><a href=\"#timestamp\" class=\"headerlink\" title=\"timestamp\"></a>timestamp</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">double</span> TangoPoseData::timestamp</div></pre></td></tr></table></figure>\n<p>The timestamp of the pose estimate, in seconds.</p>\n<h3 id=\"translation\"><a href=\"#translation\" class=\"headerlink\" title=\"translation\"></a>translation</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">double</span> TangoPoseData::translation[<span class=\"number\">3</span>]</div></pre></td></tr></table></figure>\n<p>Translation, ordered x, y, z, of the pose of the target frame with reference to the base frame.</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Basic-example-hello-depth-perception\"><a href=\"#Basic-example-hello-depth-perception\" class=\"headerlink\" title=\"Basic example hello depth perception\"></a>Basic example hello depth perception</h2><p>完整的代码可以在 <a href=\"https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_area_description\" target=\"_blank\" rel=\"external\">github</a> 上找到。</p>\n<h2 id=\"On-tango-service-connected\"><a href=\"#On-tango-service-connected\" class=\"headerlink\" title=\"On tango service connected\"></a>On tango service connected</h2><p>范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">JNIEXPORT <span class=\"keyword\">void</span> JNICALL</div><div class=\"line\">Java_com_projecttango_examples_cpp_helloareadescription_TangoJniNative_onTangoServiceConnected(</div><div class=\"line\">    JNIEnv* env, jobject, jobject binder, jboolean is_area_learning_enabled,</div><div class=\"line\">    jboolean is_loading_area_description) &#123;</div><div class=\"line\">  app.OnTangoServiceConnected(env, binder, is_area_learning_enabled,</div><div class=\"line\">                              is_loading_area_description);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> AreaLearningApp::OnTangoServiceConnected(</div><div class=\"line\">    JNIEnv* env, jobject binder, <span class=\"keyword\">bool</span> is_area_learning_enabled,</div><div class=\"line\">    <span class=\"keyword\">bool</span> is_loading_area_description) &#123;</div><div class=\"line\">  ...</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (is_area_learning_enabled || is_loading_area_description) &#123;</div><div class=\"line\">    <span class=\"comment\">// Here, we'll configure the service to run in the way we'd want. For this</span></div><div class=\"line\">    <span class=\"comment\">// application, we'll start from the default configuration</span></div><div class=\"line\">    <span class=\"comment\">// (TANGO_CONFIG_DEFAULT). This enables basic motion tracking capabilities.</span></div><div class=\"line\">    tango_config_ = TangoService_getConfig(TANGO_CONFIG_DEFAULT);</div><div class=\"line\">    <span class=\"keyword\">if</span> (tango_config_ == <span class=\"literal\">nullptr</span>) &#123;</div><div class=\"line\">      LOGE(<span class=\"string\">\"AreaLearningApp: Failed to get default config form\"</span>);</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">int</span> ret = TangoConfig_setBool(tango_config_, <span class=\"string\">\"config_enable_learning_mode\"</span>,</div><div class=\"line\">                                  is_area_learning_enabled);</div><div class=\"line\">    <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">      LOGE(</div><div class=\"line\">          <span class=\"string\">\"AreaLearningApp: config_enable_learning_mode failed with error\"</span></div><div class=\"line\">          <span class=\"string\">\"code: %d\"</span>,</div><div class=\"line\">          ret);</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// If load ADF, load the most recent saved ADF.</span></div><div class=\"line\">    <span class=\"keyword\">if</span> (is_loading_area_description) &#123;</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">vector</span>&lt;<span class=\"built_in\">std</span>::<span class=\"built_in\">string</span>&gt; adf_list;</div><div class=\"line\">      GetAdfUuids(&amp;adf_list);</div><div class=\"line\">      <span class=\"keyword\">if</span> (!adf_list.empty()) &#123;</div><div class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">string</span> adf_uuid = adf_list.back();</div><div class=\"line\">        <span class=\"built_in\">std</span>::<span class=\"built_in\">ostringstream</span> adf_str_stream;</div><div class=\"line\">        adf_str_stream &lt;&lt; <span class=\"string\">\"Number of ADFs:\"</span> &lt;&lt; adf_list.size()</div><div class=\"line\">                       &lt;&lt; <span class=\"string\">\", Loaded ADF: \"</span> &lt;&lt; adf_uuid;</div><div class=\"line\">        loaded_adf_string_ = adf_str_stream.str();</div><div class=\"line\">        ret = TangoConfig_setString(tango_config_,</div><div class=\"line\">                                    <span class=\"string\">\"config_load_area_description_UUID\"</span>,</div><div class=\"line\">                                    adf_uuid.c_str());</div><div class=\"line\">        <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">          LOGE(<span class=\"string\">\"AreaLearningApp: get ADF UUID failed with error code: %d\"</span>, ret);</div><div class=\"line\">        &#125;</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// Setting up the frame pair for the onPoseAvailable callback.</span></div><div class=\"line\">    TangoCoordinateFramePair pairs[<span class=\"number\">3</span>] = &#123;</div><div class=\"line\">        &#123;TANGO_COORDINATE_FRAME_START_OF_SERVICE,</div><div class=\"line\">         TANGO_COORDINATE_FRAME_DEVICE&#125;,</div><div class=\"line\">        &#123;TANGO_COORDINATE_FRAME_AREA_DESCRIPTION,</div><div class=\"line\">         TANGO_COORDINATE_FRAME_DEVICE&#125;,</div><div class=\"line\">        &#123;TANGO_COORDINATE_FRAME_AREA_DESCRIPTION,</div><div class=\"line\">         TANGO_COORDINATE_FRAME_START_OF_SERVICE&#125;&#125;;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// Attach onPoseAvailable callback.</span></div><div class=\"line\">    <span class=\"comment\">// The callback will be called after the service is connected.</span></div><div class=\"line\">    ret = TangoService_connectOnPoseAvailable(<span class=\"number\">3</span>, pairs, onPoseAvailableRouter);</div><div class=\"line\">    <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">      LOGE(</div><div class=\"line\">          <span class=\"string\">\"AreaLearningApp: Failed to connect to pose callback with error\"</span></div><div class=\"line\">          <span class=\"string\">\"code: %d\"</span>,</div><div class=\"line\">          ret);</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// Connect to the Tango Service, the service will start running:</span></div><div class=\"line\">    <span class=\"comment\">// point clouds can be queried and callbacks will be called.</span></div><div class=\"line\">    ret = TangoService_connect(<span class=\"keyword\">this</span>, tango_config_);</div><div class=\"line\">    <span class=\"keyword\">if</span> (ret != TANGO_SUCCESS) &#123;</div><div class=\"line\">      LOGE(</div><div class=\"line\">          <span class=\"string\">\"AreaLearningApp::OnTangoServiceConnected,\"</span></div><div class=\"line\">          <span class=\"string\">\"Failed to connect to the Tango service with error code: %d\"</span>,</div><div class=\"line\">          ret);</div><div class=\"line\">      <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>相较与 color 和 depth，pose 的初始设置更复杂，其中有大量是关于 ADF（Automatic Direction Finder：自动方位搜寻器）的，实际代码还另有大量处理 ADF 的函数被定义和实现，请参考原始代码。</p>\n<p>我们这里重点关注 PoseAvailable 的回调 OnPoseAvailableRouter。</p>\n<h2 id=\"On-pose-available\"><a href=\"#On-pose-available\" class=\"headerlink\" title=\"On pose available\"></a>On pose available</h2><p>接下来我们看看在回调函数中如何处理 pose 数据：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">namespace</span> &#123;</div><div class=\"line\"><span class=\"comment\">// The minimum Tango Core version required from this application.</span></div><div class=\"line\"><span class=\"keyword\">constexpr</span> <span class=\"keyword\">int</span> kTangoCoreMinimumVersion = <span class=\"number\">9377</span>;</div><div class=\"line\"><span class=\"keyword\">const</span> <span class=\"keyword\">int</span> kVersionStringLength = <span class=\"number\">128</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// This function routes onPoseAvailable callbacks to the application object for</span></div><div class=\"line\"><span class=\"comment\">// handling.</span></div><div class=\"line\"><span class=\"comment\">//</span></div><div class=\"line\"><span class=\"comment\">// @param context, context will be a pointer to a AreaLearningApp</span></div><div class=\"line\"><span class=\"comment\">//        instance on which to call callbacks.</span></div><div class=\"line\"><span class=\"comment\">// @param pose, pose data to route to onPoseAvailable function.</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onPoseAvailableRouter</span><span class=\"params\">(<span class=\"keyword\">void</span>* context, <span class=\"keyword\">const</span> TangoPoseData* pose)</span> </span>&#123;</div><div class=\"line\">  hello_area_description::AreaLearningApp* app =</div><div class=\"line\">      <span class=\"keyword\">static_cast</span>&lt;hello_area_description::AreaLearningApp*&gt;(context);</div><div class=\"line\">  app-&gt;onPoseAvailable(pose);</div><div class=\"line\">&#125;</div><div class=\"line\">&#125;  <span class=\"comment\">// namespace</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> AreaLearningApp::onPoseAvailable(<span class=\"keyword\">const</span> TangoPoseData* pose) &#123;</div><div class=\"line\">  <span class=\"built_in\">std</span>::lock_guard&lt;<span class=\"built_in\">std</span>::mutex&gt; lock(pose_mutex_);</div><div class=\"line\">  pose_data_.UpdatePose(*pose);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>Pose 数据被保存在成员变量 pose<em>data</em> 中，它的定义：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// pose_data_ handles all pose onPoseAvailable callbacks, onPoseAvailable()</span></div><div class=\"line\"><span class=\"comment\">// in this object will be routed to pose_data_ to handle.</span></div><div class=\"line\">PoseData pose_data_;</div></pre></td></tr></table></figure></p>\n<h2 id=\"PoseData\"><a href=\"#PoseData\" class=\"headerlink\" title=\"PoseData\"></a>PoseData</h2><p>这里出现的 PoseData 并非 SDK 提供，其完整定义如下。<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// PoseData holds all pose related data. E.g. pose position, rotation and time-</span></div><div class=\"line\"><span class=\"comment\">// stamp. It also produce the debug information strings.</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PoseData</span> &#123;</span></div><div class=\"line\"> <span class=\"keyword\">public</span>:</div><div class=\"line\">  PoseData();</div><div class=\"line\">  ~PoseData();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Update current pose and previous pose.</span></div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// @param pose: pose data of current frame.</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">UpdatePose</span><span class=\"params\">(<span class=\"keyword\">const</span> TangoPoseData&amp; pose_data)</span></span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Reset all saved pose data.</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">ResetPoseData</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Get pose data in current frame.</span></div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// @return: curent pose data.</span></div><div class=\"line\">  <span class=\"function\">TangoPoseData <span class=\"title\">GetCurrentPoseData</span><span class=\"params\">()</span></span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Check if the device is relocalized.</span></div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// @return: relocalized flag.</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">bool</span> <span class=\"title\">IsRelocalized</span><span class=\"params\">()</span> </span>&#123; <span class=\"keyword\">return</span> is_relocalized_; &#125;</div><div class=\"line\"></div><div class=\"line\"> <span class=\"keyword\">private</span>:</div><div class=\"line\">  <span class=\"comment\">// Relocalized flag, the relocalization is determined by the pose in start of</span></div><div class=\"line\">  <span class=\"comment\">// service with respect to ADF turns to valid.</span></div><div class=\"line\">  <span class=\"keyword\">bool</span> is_relocalized_ = <span class=\"literal\">false</span>;</div><div class=\"line\"></div><div class=\"line\">  TangoPoseData adf_T_device_pose_;</div><div class=\"line\">  TangoPoseData start_service_T_device_pose_;</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div></pre></td><td class=\"code\"><pre><div class=\"line\">PoseData::PoseData() &#123;&#125;</div><div class=\"line\"></div><div class=\"line\">PoseData::~PoseData() &#123;&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> PoseData::UpdatePose(<span class=\"keyword\">const</span> TangoPoseData&amp; pose_data) &#123;</div><div class=\"line\">  <span class=\"comment\">// We check the frame pair received in the pose_data instance, and store it</span></div><div class=\"line\">  <span class=\"comment\">// in the proper cooresponding local member.</span></div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// The frame pairs are the one we registred in the</span></div><div class=\"line\">  <span class=\"comment\">// TangoService_connectOnPoseAvailable functions during the setup of the</span></div><div class=\"line\">  <span class=\"comment\">// Tango configuration file.</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (pose_data.frame.base == TANGO_COORDINATE_FRAME_START_OF_SERVICE &amp;&amp;</div><div class=\"line\">      pose_data.frame.target == TANGO_COORDINATE_FRAME_DEVICE) &#123;</div><div class=\"line\">    start_service_T_device_pose_ = pose_data;</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pose_data.frame.base == TANGO_COORDINATE_FRAME_AREA_DESCRIPTION &amp;&amp;</div><div class=\"line\">             pose_data.frame.target == TANGO_COORDINATE_FRAME_DEVICE) &#123;</div><div class=\"line\">    adf_T_device_pose_ = pose_data;</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pose_data.frame.base == TANGO_COORDINATE_FRAME_AREA_DESCRIPTION &amp;&amp;</div><div class=\"line\">             pose_data.frame.target ==</div><div class=\"line\">                 TANGO_COORDINATE_FRAME_START_OF_SERVICE) &#123;</div><div class=\"line\">    is_relocalized_ = (pose_data.status_code == TANGO_POSE_VALID);</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> PoseData::ResetPoseData() &#123; is_relocalized_ = <span class=\"literal\">false</span>; &#125;</div><div class=\"line\"></div><div class=\"line\">TangoPoseData PoseData::GetCurrentPoseData() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (is_relocalized_) &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> adf_T_device_pose_;</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> start_service_T_device_pose_;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"TangoPoseData\"><a href=\"#TangoPoseData\" class=\"headerlink\" title=\"TangoPoseData\"></a>TangoPoseData</h2><p>SDK 所提供的 TangoPoseData，完整信息请查看 <a href=\"https://developers.google.com/tango/apis/c/reference/struct/tango-pose-data\" target=\"_blank\" rel=\"external\">官方文档</a>，下面只重点说明几个公共属性。</p>\n<h3 id=\"frame\"><a href=\"#frame\" class=\"headerlink\" title=\"frame\"></a>frame</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">TangoCoordinateFramePair TangoPoseData::frame</div></pre></td></tr></table></figure>\n<p>The pair of coordinate frames for this pose.</p>\n<p>We retrieve a pose for a target coordinate frame (such as the Tango device) against a base coordinate frame (such as a learned area).</p>\n<h3 id=\"orientation\"><a href=\"#orientation\" class=\"headerlink\" title=\"orientation\"></a>orientation</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">double</span> TangoPoseData::orientation[<span class=\"number\">4</span>]</div></pre></td></tr></table></figure>\n<p>Orientation, as a quaternion, of the pose of the target frame with reference to the base frame.</p>\n<p>Specified as (x,y,z,w) where RotationAngle is in radians:</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">x = RotationAxis.x * <span class=\"built_in\">sin</span>(RotationAngle / <span class=\"number\">2</span>)</div><div class=\"line\">y = RotationAxis.y * <span class=\"built_in\">sin</span>(RotationAngle / <span class=\"number\">2</span>)</div><div class=\"line\">z = RotationAxis.z * <span class=\"built_in\">sin</span>(RotationAngle / <span class=\"number\">2</span>)</div><div class=\"line\">w = <span class=\"built_in\">cos</span>(RotationAngle / <span class=\"number\">2</span>)</div></pre></td></tr></table></figure>\n<h3 id=\"status-code\"><a href=\"#status-code\" class=\"headerlink\" title=\"status_code\"></a>status_code</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">TangoPoseStatusType TangoPoseData::status_code</div></pre></td></tr></table></figure>\n<p>The status of the pose, according to the pose lifecycle.</p>\n<h3 id=\"timestamp\"><a href=\"#timestamp\" class=\"headerlink\" title=\"timestamp\"></a>timestamp</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">double</span> TangoPoseData::timestamp</div></pre></td></tr></table></figure>\n<p>The timestamp of the pose estimate, in seconds.</p>\n<h3 id=\"translation\"><a href=\"#translation\" class=\"headerlink\" title=\"translation\"></a>translation</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">double</span> TangoPoseData::translation[<span class=\"number\">3</span>]</div></pre></td></tr></table></figure>\n<p>Translation, ordered x, y, z, of the pose of the target frame with reference to the base frame.</p>\n"},{"title":"Tango Example hello depth perception","date":"2017-07-28T02:03:28.000Z","_content":"\n## Basic example hello depth perception\n\n完整的代码可以在 [github](https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_depth_perception) 上找到。\n\n## On tango service connected\n\n范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：\n``` cpp\nJNIEXPORT void JNICALL\nJava_com_projecttango_examples_cpp_hellodepthperception_TangoJniNative_onTangoServiceConnected(\n    JNIEnv* env, jobject, jobject binder) {\n  app.OnTangoServiceConnected(env, binder);\n}\n```\n\n``` cpp\nvoid HelloVideoApp::OnTangoServiceConnected(JNIEnv* env, jobject binder) {\n  ...\n  // Enable Depth Perception.\n  TangoErrorType err =\n      TangoConfig_setBool(tango_config_, \"config_enable_depth\", true);\n  if (err != TANGO_SUCCESS) {\n    LOGE(\n        \"HelloDepthPerceptionApp::OnTangoServiceConnected,\"\n        \"config_enable_depth() failed with error code: %d.\",\n        err);\n    std::exit(EXIT_SUCCESS);\n  }\n\n  // Need to specify the depth_mode as XYZC.\n  err = TangoConfig_setInt32(tango_config_, \"config_depth_mode\",\n                             TANGO_POINTCLOUD_XYZC);\n  if (err != TANGO_SUCCESS) {\n    LOGE(\n        \"Failed to set 'depth_mode' configuration flag with error\"\n        \" code: %d\",\n        err);\n    std::exit(EXIT_SUCCESS);\n  }\n\n  // Attach the OnPointCloudAvailable callback to the OnPointCloudAvailable\n  // function defined above. The callback will be called every time a new\n  // point cloud is acquired, after the service is connected.\n  err = TangoService_connectOnPointCloudAvailable(OnPointCloudAvailable);\n  if (err != TANGO_SUCCESS) {\n    LOGE(\n        \"HelloDepthPerceptionApp::OnTangoServiceConnected,\"\n        \"Failed to connect to point cloud callback with error code: %d\",\n        err);\n    std::exit(EXIT_SUCCESS);\n  }\n\n  // Connect to the Tango Service, the service will start running:\n  // point clouds can be queried and callbacks will be called.\n  err = TangoService_connect(this, tango_config_);\n  if (err != TANGO_SUCCESS) {\n    LOGE(\n        \"HelloDepthPerceptionApp::OnTangoServiceConnected,\"\n        \"Failed to connect to the Tango service with error code: %d\",\n        err);\n    std::exit(EXIT_SUCCESS);\n  }\n}\n```\n从上面的代码可以看到我们启用了 depth 并设定格式为 XYZC，然后注册了 PointCloudAvailable 的回调 OnPointCloudAvailable。\n\n## On point cloud available\n\n接下来我们看看在回调函数中如何处理点云数据：\n``` cpp\nnamespace {\n// The minimum Tango Core version required from this application.\nconstexpr int kTangoCoreMinimumVersion = 9377;\n\n// This function logs point cloud data from OnPointCloudAvailable callbacks.\n//\n// @param context, this will be a pointer to a HelloDepthPerceptionApp\n//        instance on which to call callbacks. This parameter is hidden\n//        since it is not used.\n// @param *point_cloud, point cloud data to log.\nvoid OnPointCloudAvailable(void* /*context*/,\n                           const TangoPointCloud* point_cloud) {\n  // Number of points in the point cloud.\n  float average_depth;\n\n  // Calculate the average depth.\n  average_depth = 0;\n  // Each xyzc point has 4 coordinates.\n  for (size_t i = 0; i < point_cloud->num_points; ++i) {\n    average_depth += point_cloud->points[i][2];\n  }\n  if (point_cloud->num_points) {\n    average_depth /= point_cloud->num_points;\n  }\n\n  // Log the number of points and average depth.\n  LOGI(\"HelloDepthPerceptionApp: Point count: %d. Average depth (m): %.3f\",\n       point_cloud->num_points, average_depth);\n}\n}  // anonymous namespace\n```\n点云数据被存储在一个叫做  TangoPointCloud 的结构体数组中，Tango SDK 提供了其描述文档。\n\n## struct TangoPointCloud\n\nSDK 所提供的 TangoPointCloud，完整信息请查看 [官方文档](https://developers.google.com/tango/apis/c/reference/struct/tango-point-cloud)，下面只重点说明几个公共属性。\n\n### num_points\n``` cpp\nuint32_t TangoPointCloud::num_points\n```\nThe number of points in depth_data_buffer populated successfully.\n\nThis is variable with each call to the function, and is returned as number of (x,y,z,c) points populated.\n\n### points\n``` cpp\nfloat(* TangoPointCloud::points)[4]\n```\nAn array of packed {X, Y, Z, C} values.\n\n{X, Y, Z} is a coordinate triplet (in meters). C is a confidence value, in the range of [0, 1], where 1 corresponds to full confidence. +Z points in the direction of the camera's optical axis, perpendicular to the plane of the camera. +X points toward the user's right, and +Y points toward the bottom of the screen. The origin is the focal center of the depth camera.\n\n### timestamp\n``` cpp\ndouble TangoPointCloud::timestamp\n```\nTime of capture of the depth data for this struct (in seconds).\n\n### version\n``` cpp\nuint32_t TangoPointCloud::version\n```\nAn integer denoting the version of the structure.\n","source":"_posts/Tango-Example-hello-depth-perception.md","raw":"---\ntitle: Tango Example hello depth perception\ndate: 2017-07-28 10:03:28\ncategories: Tango\ntags: [Project Tango, Point Cloud]\n---\n\n## Basic example hello depth perception\n\n完整的代码可以在 [github](https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_depth_perception) 上找到。\n\n## On tango service connected\n\n范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：\n``` cpp\nJNIEXPORT void JNICALL\nJava_com_projecttango_examples_cpp_hellodepthperception_TangoJniNative_onTangoServiceConnected(\n    JNIEnv* env, jobject, jobject binder) {\n  app.OnTangoServiceConnected(env, binder);\n}\n```\n\n``` cpp\nvoid HelloVideoApp::OnTangoServiceConnected(JNIEnv* env, jobject binder) {\n  ...\n  // Enable Depth Perception.\n  TangoErrorType err =\n      TangoConfig_setBool(tango_config_, \"config_enable_depth\", true);\n  if (err != TANGO_SUCCESS) {\n    LOGE(\n        \"HelloDepthPerceptionApp::OnTangoServiceConnected,\"\n        \"config_enable_depth() failed with error code: %d.\",\n        err);\n    std::exit(EXIT_SUCCESS);\n  }\n\n  // Need to specify the depth_mode as XYZC.\n  err = TangoConfig_setInt32(tango_config_, \"config_depth_mode\",\n                             TANGO_POINTCLOUD_XYZC);\n  if (err != TANGO_SUCCESS) {\n    LOGE(\n        \"Failed to set 'depth_mode' configuration flag with error\"\n        \" code: %d\",\n        err);\n    std::exit(EXIT_SUCCESS);\n  }\n\n  // Attach the OnPointCloudAvailable callback to the OnPointCloudAvailable\n  // function defined above. The callback will be called every time a new\n  // point cloud is acquired, after the service is connected.\n  err = TangoService_connectOnPointCloudAvailable(OnPointCloudAvailable);\n  if (err != TANGO_SUCCESS) {\n    LOGE(\n        \"HelloDepthPerceptionApp::OnTangoServiceConnected,\"\n        \"Failed to connect to point cloud callback with error code: %d\",\n        err);\n    std::exit(EXIT_SUCCESS);\n  }\n\n  // Connect to the Tango Service, the service will start running:\n  // point clouds can be queried and callbacks will be called.\n  err = TangoService_connect(this, tango_config_);\n  if (err != TANGO_SUCCESS) {\n    LOGE(\n        \"HelloDepthPerceptionApp::OnTangoServiceConnected,\"\n        \"Failed to connect to the Tango service with error code: %d\",\n        err);\n    std::exit(EXIT_SUCCESS);\n  }\n}\n```\n从上面的代码可以看到我们启用了 depth 并设定格式为 XYZC，然后注册了 PointCloudAvailable 的回调 OnPointCloudAvailable。\n\n## On point cloud available\n\n接下来我们看看在回调函数中如何处理点云数据：\n``` cpp\nnamespace {\n// The minimum Tango Core version required from this application.\nconstexpr int kTangoCoreMinimumVersion = 9377;\n\n// This function logs point cloud data from OnPointCloudAvailable callbacks.\n//\n// @param context, this will be a pointer to a HelloDepthPerceptionApp\n//        instance on which to call callbacks. This parameter is hidden\n//        since it is not used.\n// @param *point_cloud, point cloud data to log.\nvoid OnPointCloudAvailable(void* /*context*/,\n                           const TangoPointCloud* point_cloud) {\n  // Number of points in the point cloud.\n  float average_depth;\n\n  // Calculate the average depth.\n  average_depth = 0;\n  // Each xyzc point has 4 coordinates.\n  for (size_t i = 0; i < point_cloud->num_points; ++i) {\n    average_depth += point_cloud->points[i][2];\n  }\n  if (point_cloud->num_points) {\n    average_depth /= point_cloud->num_points;\n  }\n\n  // Log the number of points and average depth.\n  LOGI(\"HelloDepthPerceptionApp: Point count: %d. Average depth (m): %.3f\",\n       point_cloud->num_points, average_depth);\n}\n}  // anonymous namespace\n```\n点云数据被存储在一个叫做  TangoPointCloud 的结构体数组中，Tango SDK 提供了其描述文档。\n\n## struct TangoPointCloud\n\nSDK 所提供的 TangoPointCloud，完整信息请查看 [官方文档](https://developers.google.com/tango/apis/c/reference/struct/tango-point-cloud)，下面只重点说明几个公共属性。\n\n### num_points\n``` cpp\nuint32_t TangoPointCloud::num_points\n```\nThe number of points in depth_data_buffer populated successfully.\n\nThis is variable with each call to the function, and is returned as number of (x,y,z,c) points populated.\n\n### points\n``` cpp\nfloat(* TangoPointCloud::points)[4]\n```\nAn array of packed {X, Y, Z, C} values.\n\n{X, Y, Z} is a coordinate triplet (in meters). C is a confidence value, in the range of [0, 1], where 1 corresponds to full confidence. +Z points in the direction of the camera's optical axis, perpendicular to the plane of the camera. +X points toward the user's right, and +Y points toward the bottom of the screen. The origin is the focal center of the depth camera.\n\n### timestamp\n``` cpp\ndouble TangoPointCloud::timestamp\n```\nTime of capture of the depth data for this struct (in seconds).\n\n### version\n``` cpp\nuint32_t TangoPointCloud::version\n```\nAn integer denoting the version of the structure.\n","slug":"Tango-Example-hello-depth-perception","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48eh000onki3ymltujpg","content":"<h2 id=\"Basic-example-hello-depth-perception\"><a href=\"#Basic-example-hello-depth-perception\" class=\"headerlink\" title=\"Basic example hello depth perception\"></a>Basic example hello depth perception</h2><p>完整的代码可以在 <a href=\"https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_depth_perception\" target=\"_blank\" rel=\"external\">github</a> 上找到。</p>\n<h2 id=\"On-tango-service-connected\"><a href=\"#On-tango-service-connected\" class=\"headerlink\" title=\"On tango service connected\"></a>On tango service connected</h2><p>范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">JNIEXPORT <span class=\"keyword\">void</span> JNICALL</div><div class=\"line\">Java_com_projecttango_examples_cpp_hellodepthperception_TangoJniNative_onTangoServiceConnected(</div><div class=\"line\">    JNIEnv* env, jobject, jobject binder) &#123;</div><div class=\"line\">  app.OnTangoServiceConnected(env, binder);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::OnTangoServiceConnected(JNIEnv* env, jobject binder) &#123;</div><div class=\"line\">  ...</div><div class=\"line\">  <span class=\"comment\">// Enable Depth Perception.</span></div><div class=\"line\">  TangoErrorType err =</div><div class=\"line\">      TangoConfig_setBool(tango_config_, <span class=\"string\">\"config_enable_depth\"</span>, <span class=\"literal\">true</span>);</div><div class=\"line\">  <span class=\"keyword\">if</span> (err != TANGO_SUCCESS) &#123;</div><div class=\"line\">    LOGE(</div><div class=\"line\">        <span class=\"string\">\"HelloDepthPerceptionApp::OnTangoServiceConnected,\"</span></div><div class=\"line\">        <span class=\"string\">\"config_enable_depth() failed with error code: %d.\"</span>,</div><div class=\"line\">        err);</div><div class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Need to specify the depth_mode as XYZC.</span></div><div class=\"line\">  err = TangoConfig_setInt32(tango_config_, <span class=\"string\">\"config_depth_mode\"</span>,</div><div class=\"line\">                             TANGO_POINTCLOUD_XYZC);</div><div class=\"line\">  <span class=\"keyword\">if</span> (err != TANGO_SUCCESS) &#123;</div><div class=\"line\">    LOGE(</div><div class=\"line\">        <span class=\"string\">\"Failed to set 'depth_mode' configuration flag with error\"</span></div><div class=\"line\">        <span class=\"string\">\" code: %d\"</span>,</div><div class=\"line\">        err);</div><div class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Attach the OnPointCloudAvailable callback to the OnPointCloudAvailable</span></div><div class=\"line\">  <span class=\"comment\">// function defined above. The callback will be called every time a new</span></div><div class=\"line\">  <span class=\"comment\">// point cloud is acquired, after the service is connected.</span></div><div class=\"line\">  err = TangoService_connectOnPointCloudAvailable(OnPointCloudAvailable);</div><div class=\"line\">  <span class=\"keyword\">if</span> (err != TANGO_SUCCESS) &#123;</div><div class=\"line\">    LOGE(</div><div class=\"line\">        <span class=\"string\">\"HelloDepthPerceptionApp::OnTangoServiceConnected,\"</span></div><div class=\"line\">        <span class=\"string\">\"Failed to connect to point cloud callback with error code: %d\"</span>,</div><div class=\"line\">        err);</div><div class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Connect to the Tango Service, the service will start running:</span></div><div class=\"line\">  <span class=\"comment\">// point clouds can be queried and callbacks will be called.</span></div><div class=\"line\">  err = TangoService_connect(<span class=\"keyword\">this</span>, tango_config_);</div><div class=\"line\">  <span class=\"keyword\">if</span> (err != TANGO_SUCCESS) &#123;</div><div class=\"line\">    LOGE(</div><div class=\"line\">        <span class=\"string\">\"HelloDepthPerceptionApp::OnTangoServiceConnected,\"</span></div><div class=\"line\">        <span class=\"string\">\"Failed to connect to the Tango service with error code: %d\"</span>,</div><div class=\"line\">        err);</div><div class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>从上面的代码可以看到我们启用了 depth 并设定格式为 XYZC，然后注册了 PointCloudAvailable 的回调 OnPointCloudAvailable。</p>\n<h2 id=\"On-point-cloud-available\"><a href=\"#On-point-cloud-available\" class=\"headerlink\" title=\"On point cloud available\"></a>On point cloud available</h2><p>接下来我们看看在回调函数中如何处理点云数据：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">namespace</span> &#123;</div><div class=\"line\"><span class=\"comment\">// The minimum Tango Core version required from this application.</span></div><div class=\"line\"><span class=\"keyword\">constexpr</span> <span class=\"keyword\">int</span> kTangoCoreMinimumVersion = <span class=\"number\">9377</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// This function logs point cloud data from OnPointCloudAvailable callbacks.</span></div><div class=\"line\"><span class=\"comment\">//</span></div><div class=\"line\"><span class=\"comment\">// @param context, this will be a pointer to a HelloDepthPerceptionApp</span></div><div class=\"line\"><span class=\"comment\">//        instance on which to call callbacks. This parameter is hidden</span></div><div class=\"line\"><span class=\"comment\">//        since it is not used.</span></div><div class=\"line\"><span class=\"comment\">// @param *point_cloud, point cloud data to log.</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnPointCloudAvailable</span><span class=\"params\">(<span class=\"keyword\">void</span>* <span class=\"comment\">/*context*/</span>,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">                           <span class=\"keyword\">const</span> TangoPointCloud* point_cloud)</span> </span>&#123;</div><div class=\"line\">  <span class=\"comment\">// Number of points in the point cloud.</span></div><div class=\"line\">  <span class=\"keyword\">float</span> average_depth;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Calculate the average depth.</span></div><div class=\"line\">  average_depth = <span class=\"number\">0</span>;</div><div class=\"line\">  <span class=\"comment\">// Each xyzc point has 4 coordinates.</span></div><div class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">size_t</span> i = <span class=\"number\">0</span>; i &lt; point_cloud-&gt;num_points; ++i) &#123;</div><div class=\"line\">    average_depth += point_cloud-&gt;points[i][<span class=\"number\">2</span>];</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"keyword\">if</span> (point_cloud-&gt;num_points) &#123;</div><div class=\"line\">    average_depth /= point_cloud-&gt;num_points;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Log the number of points and average depth.</span></div><div class=\"line\">  LOGI(<span class=\"string\">\"HelloDepthPerceptionApp: Point count: %d. Average depth (m): %.3f\"</span>,</div><div class=\"line\">       point_cloud-&gt;num_points, average_depth);</div><div class=\"line\">&#125;</div><div class=\"line\">&#125;  <span class=\"comment\">// anonymous namespace</span></div></pre></td></tr></table></figure></p>\n<p>点云数据被存储在一个叫做  TangoPointCloud 的结构体数组中，Tango SDK 提供了其描述文档。</p>\n<h2 id=\"struct-TangoPointCloud\"><a href=\"#struct-TangoPointCloud\" class=\"headerlink\" title=\"struct TangoPointCloud\"></a>struct TangoPointCloud</h2><p>SDK 所提供的 TangoPointCloud，完整信息请查看 <a href=\"https://developers.google.com/tango/apis/c/reference/struct/tango-point-cloud\" target=\"_blank\" rel=\"external\">官方文档</a>，下面只重点说明几个公共属性。</p>\n<h3 id=\"num-points\"><a href=\"#num-points\" class=\"headerlink\" title=\"num_points\"></a>num_points</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">uint32_t</span> TangoPointCloud::num_points</div></pre></td></tr></table></figure>\n<p>The number of points in depth_data_buffer populated successfully.</p>\n<p>This is variable with each call to the function, and is returned as number of (x,y,z,c) points populated.</p>\n<h3 id=\"points\"><a href=\"#points\" class=\"headerlink\" title=\"points\"></a>points</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">float</span>(* TangoPointCloud::points)[<span class=\"number\">4</span>]</div></pre></td></tr></table></figure>\n<p>An array of packed {X, Y, Z, C} values.</p>\n<p>{X, Y, Z} is a coordinate triplet (in meters). C is a confidence value, in the range of [0, 1], where 1 corresponds to full confidence. +Z points in the direction of the camera’s optical axis, perpendicular to the plane of the camera. +X points toward the user’s right, and +Y points toward the bottom of the screen. The origin is the focal center of the depth camera.</p>\n<h3 id=\"timestamp\"><a href=\"#timestamp\" class=\"headerlink\" title=\"timestamp\"></a>timestamp</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">double</span> TangoPointCloud::timestamp</div></pre></td></tr></table></figure>\n<p>Time of capture of the depth data for this struct (in seconds).</p>\n<h3 id=\"version\"><a href=\"#version\" class=\"headerlink\" title=\"version\"></a>version</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">uint32_t</span> TangoPointCloud::version</div></pre></td></tr></table></figure>\n<p>An integer denoting the version of the structure.</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Basic-example-hello-depth-perception\"><a href=\"#Basic-example-hello-depth-perception\" class=\"headerlink\" title=\"Basic example hello depth perception\"></a>Basic example hello depth perception</h2><p>完整的代码可以在 <a href=\"https://github.com/googlesamples/tango-examples-c/blob/master/cpp_basic_examples/hello_depth_perception\" target=\"_blank\" rel=\"external\">github</a> 上找到。</p>\n<h2 id=\"On-tango-service-connected\"><a href=\"#On-tango-service-connected\" class=\"headerlink\" title=\"On tango service connected\"></a>On tango service connected</h2><p>范例基于 Android 开发，我们从 JNI 以下的代码说起。当连接到 tango 设备时的回调处理：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">JNIEXPORT <span class=\"keyword\">void</span> JNICALL</div><div class=\"line\">Java_com_projecttango_examples_cpp_hellodepthperception_TangoJniNative_onTangoServiceConnected(</div><div class=\"line\">    JNIEnv* env, jobject, jobject binder) &#123;</div><div class=\"line\">  app.OnTangoServiceConnected(env, binder);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> HelloVideoApp::OnTangoServiceConnected(JNIEnv* env, jobject binder) &#123;</div><div class=\"line\">  ...</div><div class=\"line\">  <span class=\"comment\">// Enable Depth Perception.</span></div><div class=\"line\">  TangoErrorType err =</div><div class=\"line\">      TangoConfig_setBool(tango_config_, <span class=\"string\">\"config_enable_depth\"</span>, <span class=\"literal\">true</span>);</div><div class=\"line\">  <span class=\"keyword\">if</span> (err != TANGO_SUCCESS) &#123;</div><div class=\"line\">    LOGE(</div><div class=\"line\">        <span class=\"string\">\"HelloDepthPerceptionApp::OnTangoServiceConnected,\"</span></div><div class=\"line\">        <span class=\"string\">\"config_enable_depth() failed with error code: %d.\"</span>,</div><div class=\"line\">        err);</div><div class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Need to specify the depth_mode as XYZC.</span></div><div class=\"line\">  err = TangoConfig_setInt32(tango_config_, <span class=\"string\">\"config_depth_mode\"</span>,</div><div class=\"line\">                             TANGO_POINTCLOUD_XYZC);</div><div class=\"line\">  <span class=\"keyword\">if</span> (err != TANGO_SUCCESS) &#123;</div><div class=\"line\">    LOGE(</div><div class=\"line\">        <span class=\"string\">\"Failed to set 'depth_mode' configuration flag with error\"</span></div><div class=\"line\">        <span class=\"string\">\" code: %d\"</span>,</div><div class=\"line\">        err);</div><div class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Attach the OnPointCloudAvailable callback to the OnPointCloudAvailable</span></div><div class=\"line\">  <span class=\"comment\">// function defined above. The callback will be called every time a new</span></div><div class=\"line\">  <span class=\"comment\">// point cloud is acquired, after the service is connected.</span></div><div class=\"line\">  err = TangoService_connectOnPointCloudAvailable(OnPointCloudAvailable);</div><div class=\"line\">  <span class=\"keyword\">if</span> (err != TANGO_SUCCESS) &#123;</div><div class=\"line\">    LOGE(</div><div class=\"line\">        <span class=\"string\">\"HelloDepthPerceptionApp::OnTangoServiceConnected,\"</span></div><div class=\"line\">        <span class=\"string\">\"Failed to connect to point cloud callback with error code: %d\"</span>,</div><div class=\"line\">        err);</div><div class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Connect to the Tango Service, the service will start running:</span></div><div class=\"line\">  <span class=\"comment\">// point clouds can be queried and callbacks will be called.</span></div><div class=\"line\">  err = TangoService_connect(<span class=\"keyword\">this</span>, tango_config_);</div><div class=\"line\">  <span class=\"keyword\">if</span> (err != TANGO_SUCCESS) &#123;</div><div class=\"line\">    LOGE(</div><div class=\"line\">        <span class=\"string\">\"HelloDepthPerceptionApp::OnTangoServiceConnected,\"</span></div><div class=\"line\">        <span class=\"string\">\"Failed to connect to the Tango service with error code: %d\"</span>,</div><div class=\"line\">        err);</div><div class=\"line\">    <span class=\"built_in\">std</span>::<span class=\"built_in\">exit</span>(EXIT_SUCCESS);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>从上面的代码可以看到我们启用了 depth 并设定格式为 XYZC，然后注册了 PointCloudAvailable 的回调 OnPointCloudAvailable。</p>\n<h2 id=\"On-point-cloud-available\"><a href=\"#On-point-cloud-available\" class=\"headerlink\" title=\"On point cloud available\"></a>On point cloud available</h2><p>接下来我们看看在回调函数中如何处理点云数据：<br><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">namespace</span> &#123;</div><div class=\"line\"><span class=\"comment\">// The minimum Tango Core version required from this application.</span></div><div class=\"line\"><span class=\"keyword\">constexpr</span> <span class=\"keyword\">int</span> kTangoCoreMinimumVersion = <span class=\"number\">9377</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// This function logs point cloud data from OnPointCloudAvailable callbacks.</span></div><div class=\"line\"><span class=\"comment\">//</span></div><div class=\"line\"><span class=\"comment\">// @param context, this will be a pointer to a HelloDepthPerceptionApp</span></div><div class=\"line\"><span class=\"comment\">//        instance on which to call callbacks. This parameter is hidden</span></div><div class=\"line\"><span class=\"comment\">//        since it is not used.</span></div><div class=\"line\"><span class=\"comment\">// @param *point_cloud, point cloud data to log.</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">OnPointCloudAvailable</span><span class=\"params\">(<span class=\"keyword\">void</span>* <span class=\"comment\">/*context*/</span>,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">                           <span class=\"keyword\">const</span> TangoPointCloud* point_cloud)</span> </span>&#123;</div><div class=\"line\">  <span class=\"comment\">// Number of points in the point cloud.</span></div><div class=\"line\">  <span class=\"keyword\">float</span> average_depth;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Calculate the average depth.</span></div><div class=\"line\">  average_depth = <span class=\"number\">0</span>;</div><div class=\"line\">  <span class=\"comment\">// Each xyzc point has 4 coordinates.</span></div><div class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">size_t</span> i = <span class=\"number\">0</span>; i &lt; point_cloud-&gt;num_points; ++i) &#123;</div><div class=\"line\">    average_depth += point_cloud-&gt;points[i][<span class=\"number\">2</span>];</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"keyword\">if</span> (point_cloud-&gt;num_points) &#123;</div><div class=\"line\">    average_depth /= point_cloud-&gt;num_points;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Log the number of points and average depth.</span></div><div class=\"line\">  LOGI(<span class=\"string\">\"HelloDepthPerceptionApp: Point count: %d. Average depth (m): %.3f\"</span>,</div><div class=\"line\">       point_cloud-&gt;num_points, average_depth);</div><div class=\"line\">&#125;</div><div class=\"line\">&#125;  <span class=\"comment\">// anonymous namespace</span></div></pre></td></tr></table></figure></p>\n<p>点云数据被存储在一个叫做  TangoPointCloud 的结构体数组中，Tango SDK 提供了其描述文档。</p>\n<h2 id=\"struct-TangoPointCloud\"><a href=\"#struct-TangoPointCloud\" class=\"headerlink\" title=\"struct TangoPointCloud\"></a>struct TangoPointCloud</h2><p>SDK 所提供的 TangoPointCloud，完整信息请查看 <a href=\"https://developers.google.com/tango/apis/c/reference/struct/tango-point-cloud\" target=\"_blank\" rel=\"external\">官方文档</a>，下面只重点说明几个公共属性。</p>\n<h3 id=\"num-points\"><a href=\"#num-points\" class=\"headerlink\" title=\"num_points\"></a>num_points</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">uint32_t</span> TangoPointCloud::num_points</div></pre></td></tr></table></figure>\n<p>The number of points in depth_data_buffer populated successfully.</p>\n<p>This is variable with each call to the function, and is returned as number of (x,y,z,c) points populated.</p>\n<h3 id=\"points\"><a href=\"#points\" class=\"headerlink\" title=\"points\"></a>points</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">float</span>(* TangoPointCloud::points)[<span class=\"number\">4</span>]</div></pre></td></tr></table></figure>\n<p>An array of packed {X, Y, Z, C} values.</p>\n<p>{X, Y, Z} is a coordinate triplet (in meters). C is a confidence value, in the range of [0, 1], where 1 corresponds to full confidence. +Z points in the direction of the camera’s optical axis, perpendicular to the plane of the camera. +X points toward the user’s right, and +Y points toward the bottom of the screen. The origin is the focal center of the depth camera.</p>\n<h3 id=\"timestamp\"><a href=\"#timestamp\" class=\"headerlink\" title=\"timestamp\"></a>timestamp</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">double</span> TangoPointCloud::timestamp</div></pre></td></tr></table></figure>\n<p>Time of capture of the depth data for this struct (in seconds).</p>\n<h3 id=\"version\"><a href=\"#version\" class=\"headerlink\" title=\"version\"></a>version</h3><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">uint32_t</span> TangoPointCloud::version</div></pre></td></tr></table></figure>\n<p>An integer denoting the version of the structure.</p>\n"},{"title":"apt-mirror","date":"2017-07-10T07:54:58.000Z","_content":"\n## 安装 apt-mirror\n\n安装很简单，PPA自带：\n``` bash\n$ sudo apt-get install apt-mirror\n```\n\n## 配置 apt-mirror\n\napt-mirror 的配置文件位于 /etc/apt/mirror.list，我们在使用前做一下配置：\n``` bash\n$ sudo vim /etc/apt/mirror.list\n```\n\n``` bash\n############# config ##################\n#\nset base_path    /var/wwwroot/apt-mirror\nset run_postmirror 0\nset nthreads     20\nset _tilde 0\n#\n############# end config ##############\n\ndeb http://mirrors.aliyun.com/ubuntu/ xenial main restricted\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted\ndeb http://mirrors.aliyun.com/ubuntu/ xenial universe\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe\ndeb http://mirrors.aliyun.com/ubuntu/ xenial multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-security universe\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverse\ndeb https://download.docker.com/linux/ubuntu xenial stable\n\nclean http://mirrors.aliyun.com/ubuntu\nclean https://download.docker.com/linux/ubuntu\n```\n\n关于这个配置文件：\n  * base_path 告诉 apt-mirror 下载的数据存在哪里。\n  * run_postmirror 置为 0 告诉 apt-mirror 不要运行 post script，虽然这个不设置也不影响正常使用，但在 apt-mirror 运行结束时会报一个讨厌的错误信息。\n  * deb 这些行告诉 apt-mirror 从哪里获取 package，这里我们选择了 aliyun 的镜像服务。另外，我们也把 docker 官方源给加了进去。\n  * deb-src 也是被支持的，我们这里没有使用，如果你需要的话请自行加上去。\n  * deb [arch=amd64]，可以这样使用来告诉 apt-mirror 取 64 位版本，否则 apt-mirror 以默认方式取与本机架构一致的版本。\n  * 这个是 Ubuntu 16.04（即 xenial）版本，其他版本请自行调整。\n  * clean 结束时做一些清理工作。\n\n## 运行 apt-mirror\n\n``` bash\n$ sudo apt-mirror\n```\n\n运行结束后，可以查看一下结果：\n``` bash\n$ tree -L 4 /var/wwwroot/apt-mirror\n/var/wwwroot/apt-mirror/\n├── mirror\n│   ├── download.docker.com\n│   │   └── linux\n│   │       └── ubuntu\n│   ├── mirrors.aliyun.com\n│   │   └── ubuntu\n│   │       ├── dists\n│   │       └── pool\n├── skel\n│   ├── download.docker.com\n│   │   └── linux\n│   │       └── ubuntu\n│   ├── mirrors.aliyun.com\n│   │   ├── robots.txt\n│   │   └── ubuntu\n│   │       └── dists\n└── var\n    ├── ALL\n    ├── archive-log.0\n    ├── archive-log.1\n```\n\n## 配置 HTTP Server\n\n配置 HTTP Server，使得可以通过 HTTP 访问刚获取到的 mirror 仓库。以 Apache 为例：\n``` xml\n<VirtualHost *>\n    ...\n\n    <Location /apt-mirror>\n        Options Indexes FollowSymLinks\n        AllowOverride All\n        Require all granted\n    </Location>\n</VirtualHost>\n```\n\n## 应用 mirror\n\n``` bash\n$ sudo vim /etc/apt/sources.list\n```\n\n``` bash\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial main restricted\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates main restricted\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial universe\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates universe\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial multiverse\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates multiverse\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security main restricted\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security universe\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security multiverse\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/download.docker.com/linux/ubuntu/ xenial stable\n```\n\n配置文件里面的 192.168.0.11 是内部 mirror 服务器的 IP 地址。\n\n[arch=amd64] 是必须的，否则服务器会报 404 错误。32 位版本请做调整。\n\n## 其他\n\n请定时运行 apt-mirror 程序以更新本地仓库。","source":"_posts/Ubuntu-apt-mirror.md","raw":"---\ntitle: apt-mirror\ndate: 2017-07-10 15:54:58\ncategories: Ubuntu\ntags: [Ubuntu, apt mirror]\n---\n\n## 安装 apt-mirror\n\n安装很简单，PPA自带：\n``` bash\n$ sudo apt-get install apt-mirror\n```\n\n## 配置 apt-mirror\n\napt-mirror 的配置文件位于 /etc/apt/mirror.list，我们在使用前做一下配置：\n``` bash\n$ sudo vim /etc/apt/mirror.list\n```\n\n``` bash\n############# config ##################\n#\nset base_path    /var/wwwroot/apt-mirror\nset run_postmirror 0\nset nthreads     20\nset _tilde 0\n#\n############# end config ##############\n\ndeb http://mirrors.aliyun.com/ubuntu/ xenial main restricted\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted\ndeb http://mirrors.aliyun.com/ubuntu/ xenial universe\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe\ndeb http://mirrors.aliyun.com/ubuntu/ xenial multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-security universe\ndeb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverse\ndeb https://download.docker.com/linux/ubuntu xenial stable\n\nclean http://mirrors.aliyun.com/ubuntu\nclean https://download.docker.com/linux/ubuntu\n```\n\n关于这个配置文件：\n  * base_path 告诉 apt-mirror 下载的数据存在哪里。\n  * run_postmirror 置为 0 告诉 apt-mirror 不要运行 post script，虽然这个不设置也不影响正常使用，但在 apt-mirror 运行结束时会报一个讨厌的错误信息。\n  * deb 这些行告诉 apt-mirror 从哪里获取 package，这里我们选择了 aliyun 的镜像服务。另外，我们也把 docker 官方源给加了进去。\n  * deb-src 也是被支持的，我们这里没有使用，如果你需要的话请自行加上去。\n  * deb [arch=amd64]，可以这样使用来告诉 apt-mirror 取 64 位版本，否则 apt-mirror 以默认方式取与本机架构一致的版本。\n  * 这个是 Ubuntu 16.04（即 xenial）版本，其他版本请自行调整。\n  * clean 结束时做一些清理工作。\n\n## 运行 apt-mirror\n\n``` bash\n$ sudo apt-mirror\n```\n\n运行结束后，可以查看一下结果：\n``` bash\n$ tree -L 4 /var/wwwroot/apt-mirror\n/var/wwwroot/apt-mirror/\n├── mirror\n│   ├── download.docker.com\n│   │   └── linux\n│   │       └── ubuntu\n│   ├── mirrors.aliyun.com\n│   │   └── ubuntu\n│   │       ├── dists\n│   │       └── pool\n├── skel\n│   ├── download.docker.com\n│   │   └── linux\n│   │       └── ubuntu\n│   ├── mirrors.aliyun.com\n│   │   ├── robots.txt\n│   │   └── ubuntu\n│   │       └── dists\n└── var\n    ├── ALL\n    ├── archive-log.0\n    ├── archive-log.1\n```\n\n## 配置 HTTP Server\n\n配置 HTTP Server，使得可以通过 HTTP 访问刚获取到的 mirror 仓库。以 Apache 为例：\n``` xml\n<VirtualHost *>\n    ...\n\n    <Location /apt-mirror>\n        Options Indexes FollowSymLinks\n        AllowOverride All\n        Require all granted\n    </Location>\n</VirtualHost>\n```\n\n## 应用 mirror\n\n``` bash\n$ sudo vim /etc/apt/sources.list\n```\n\n``` bash\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial main restricted\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates main restricted\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial universe\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates universe\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial multiverse\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates multiverse\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security main restricted\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security universe\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security multiverse\ndeb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/download.docker.com/linux/ubuntu/ xenial stable\n```\n\n配置文件里面的 192.168.0.11 是内部 mirror 服务器的 IP 地址。\n\n[arch=amd64] 是必须的，否则服务器会报 404 错误。32 位版本请做调整。\n\n## 其他\n\n请定时运行 apt-mirror 程序以更新本地仓库。","slug":"Ubuntu-apt-mirror","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48ek000qnki3ydxddbe0","content":"<h2 id=\"安装-apt-mirror\"><a href=\"#安装-apt-mirror\" class=\"headerlink\" title=\"安装 apt-mirror\"></a>安装 apt-mirror</h2><p>安装很简单，PPA自带：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo apt-get install apt-mirror</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置-apt-mirror\"><a href=\"#配置-apt-mirror\" class=\"headerlink\" title=\"配置 apt-mirror\"></a>配置 apt-mirror</h2><p>apt-mirror 的配置文件位于 /etc/apt/mirror.list，我们在使用前做一下配置：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo vim /etc/apt/mirror.list</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">############# config ##################</span></div><div class=\"line\"><span class=\"comment\">#</span></div><div class=\"line\"><span class=\"built_in\">set</span> base_path    /var/wwwroot/apt-mirror</div><div class=\"line\"><span class=\"built_in\">set</span> run_postmirror 0</div><div class=\"line\"><span class=\"built_in\">set</span> nthreads     20</div><div class=\"line\"><span class=\"built_in\">set</span> _tilde 0</div><div class=\"line\"><span class=\"comment\">#</span></div><div class=\"line\"><span class=\"comment\">############# end config ##############</span></div><div class=\"line\"></div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial universe</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial multiverse</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiverse</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverse</div><div class=\"line\">deb https://download.docker.com/linux/ubuntu xenial stable</div><div class=\"line\"></div><div class=\"line\">clean http://mirrors.aliyun.com/ubuntu</div><div class=\"line\">clean https://download.docker.com/linux/ubuntu</div></pre></td></tr></table></figure>\n<p>关于这个配置文件：</p>\n<ul>\n<li>base_path 告诉 apt-mirror 下载的数据存在哪里。</li>\n<li>run_postmirror 置为 0 告诉 apt-mirror 不要运行 post script，虽然这个不设置也不影响正常使用，但在 apt-mirror 运行结束时会报一个讨厌的错误信息。</li>\n<li>deb 这些行告诉 apt-mirror 从哪里获取 package，这里我们选择了 aliyun 的镜像服务。另外，我们也把 docker 官方源给加了进去。</li>\n<li>deb-src 也是被支持的，我们这里没有使用，如果你需要的话请自行加上去。</li>\n<li>deb [arch=amd64]，可以这样使用来告诉 apt-mirror 取 64 位版本，否则 apt-mirror 以默认方式取与本机架构一致的版本。</li>\n<li>这个是 Ubuntu 16.04（即 xenial）版本，其他版本请自行调整。</li>\n<li>clean 结束时做一些清理工作。</li>\n</ul>\n<h2 id=\"运行-apt-mirror\"><a href=\"#运行-apt-mirror\" class=\"headerlink\" title=\"运行 apt-mirror\"></a>运行 apt-mirror</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo apt-mirror</div></pre></td></tr></table></figure>\n<p>运行结束后，可以查看一下结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ tree -L 4 /var/wwwroot/apt-mirror</div><div class=\"line\">/var/wwwroot/apt-mirror/</div><div class=\"line\">├── mirror</div><div class=\"line\">│   ├── download.docker.com</div><div class=\"line\">│   │   └── linux</div><div class=\"line\">│   │       └── ubuntu</div><div class=\"line\">│   ├── mirrors.aliyun.com</div><div class=\"line\">│   │   └── ubuntu</div><div class=\"line\">│   │       ├── dists</div><div class=\"line\">│   │       └── pool</div><div class=\"line\">├── skel</div><div class=\"line\">│   ├── download.docker.com</div><div class=\"line\">│   │   └── linux</div><div class=\"line\">│   │       └── ubuntu</div><div class=\"line\">│   ├── mirrors.aliyun.com</div><div class=\"line\">│   │   ├── robots.txt</div><div class=\"line\">│   │   └── ubuntu</div><div class=\"line\">│   │       └── dists</div><div class=\"line\">└── var</div><div class=\"line\">    ├── ALL</div><div class=\"line\">    ├── archive-log.0</div><div class=\"line\">    ├── archive-log.1</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置-HTTP-Server\"><a href=\"#配置-HTTP-Server\" class=\"headerlink\" title=\"配置 HTTP Server\"></a>配置 HTTP Server</h2><p>配置 HTTP Server，使得可以通过 HTTP 访问刚获取到的 mirror 仓库。以 Apache 为例：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">VirtualHost</span> *&gt;</span></div><div class=\"line\">    ...</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Location</span> /<span class=\"attr\">apt-mirror</span>&gt;</span></div><div class=\"line\">        Options Indexes FollowSymLinks</div><div class=\"line\">        AllowOverride All</div><div class=\"line\">        Require all granted</div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Location</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">VirtualHost</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<h2 id=\"应用-mirror\"><a href=\"#应用-mirror\" class=\"headerlink\" title=\"应用 mirror\"></a>应用 mirror</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo vim /etc/apt/sources.list</div></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial main restricted</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates main restricted</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial universe</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates universe</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial multiverse</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates multiverse</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security main restricted</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security universe</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security multiverse</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/download.docker.com/linux/ubuntu/ xenial stable</div></pre></td></tr></table></figure>\n<p>配置文件里面的 192.168.0.11 是内部 mirror 服务器的 IP 地址。</p>\n<p>[arch=amd64] 是必须的，否则服务器会报 404 错误。32 位版本请做调整。</p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><p>请定时运行 apt-mirror 程序以更新本地仓库。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"安装-apt-mirror\"><a href=\"#安装-apt-mirror\" class=\"headerlink\" title=\"安装 apt-mirror\"></a>安装 apt-mirror</h2><p>安装很简单，PPA自带：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo apt-get install apt-mirror</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置-apt-mirror\"><a href=\"#配置-apt-mirror\" class=\"headerlink\" title=\"配置 apt-mirror\"></a>配置 apt-mirror</h2><p>apt-mirror 的配置文件位于 /etc/apt/mirror.list，我们在使用前做一下配置：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo vim /etc/apt/mirror.list</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">############# config ##################</span></div><div class=\"line\"><span class=\"comment\">#</span></div><div class=\"line\"><span class=\"built_in\">set</span> base_path    /var/wwwroot/apt-mirror</div><div class=\"line\"><span class=\"built_in\">set</span> run_postmirror 0</div><div class=\"line\"><span class=\"built_in\">set</span> nthreads     20</div><div class=\"line\"><span class=\"built_in\">set</span> _tilde 0</div><div class=\"line\"><span class=\"comment\">#</span></div><div class=\"line\"><span class=\"comment\">############# end config ##############</span></div><div class=\"line\"></div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial universe</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial multiverse</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiverse</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe</div><div class=\"line\">deb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverse</div><div class=\"line\">deb https://download.docker.com/linux/ubuntu xenial stable</div><div class=\"line\"></div><div class=\"line\">clean http://mirrors.aliyun.com/ubuntu</div><div class=\"line\">clean https://download.docker.com/linux/ubuntu</div></pre></td></tr></table></figure>\n<p>关于这个配置文件：</p>\n<ul>\n<li>base_path 告诉 apt-mirror 下载的数据存在哪里。</li>\n<li>run_postmirror 置为 0 告诉 apt-mirror 不要运行 post script，虽然这个不设置也不影响正常使用，但在 apt-mirror 运行结束时会报一个讨厌的错误信息。</li>\n<li>deb 这些行告诉 apt-mirror 从哪里获取 package，这里我们选择了 aliyun 的镜像服务。另外，我们也把 docker 官方源给加了进去。</li>\n<li>deb-src 也是被支持的，我们这里没有使用，如果你需要的话请自行加上去。</li>\n<li>deb [arch=amd64]，可以这样使用来告诉 apt-mirror 取 64 位版本，否则 apt-mirror 以默认方式取与本机架构一致的版本。</li>\n<li>这个是 Ubuntu 16.04（即 xenial）版本，其他版本请自行调整。</li>\n<li>clean 结束时做一些清理工作。</li>\n</ul>\n<h2 id=\"运行-apt-mirror\"><a href=\"#运行-apt-mirror\" class=\"headerlink\" title=\"运行 apt-mirror\"></a>运行 apt-mirror</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo apt-mirror</div></pre></td></tr></table></figure>\n<p>运行结束后，可以查看一下结果：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ tree -L 4 /var/wwwroot/apt-mirror</div><div class=\"line\">/var/wwwroot/apt-mirror/</div><div class=\"line\">├── mirror</div><div class=\"line\">│   ├── download.docker.com</div><div class=\"line\">│   │   └── linux</div><div class=\"line\">│   │       └── ubuntu</div><div class=\"line\">│   ├── mirrors.aliyun.com</div><div class=\"line\">│   │   └── ubuntu</div><div class=\"line\">│   │       ├── dists</div><div class=\"line\">│   │       └── pool</div><div class=\"line\">├── skel</div><div class=\"line\">│   ├── download.docker.com</div><div class=\"line\">│   │   └── linux</div><div class=\"line\">│   │       └── ubuntu</div><div class=\"line\">│   ├── mirrors.aliyun.com</div><div class=\"line\">│   │   ├── robots.txt</div><div class=\"line\">│   │   └── ubuntu</div><div class=\"line\">│   │       └── dists</div><div class=\"line\">└── var</div><div class=\"line\">    ├── ALL</div><div class=\"line\">    ├── archive-log.0</div><div class=\"line\">    ├── archive-log.1</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置-HTTP-Server\"><a href=\"#配置-HTTP-Server\" class=\"headerlink\" title=\"配置 HTTP Server\"></a>配置 HTTP Server</h2><p>配置 HTTP Server，使得可以通过 HTTP 访问刚获取到的 mirror 仓库。以 Apache 为例：<br><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">VirtualHost</span> *&gt;</span></div><div class=\"line\">    ...</div><div class=\"line\"></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Location</span> /<span class=\"attr\">apt-mirror</span>&gt;</span></div><div class=\"line\">        Options Indexes FollowSymLinks</div><div class=\"line\">        AllowOverride All</div><div class=\"line\">        Require all granted</div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Location</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">VirtualHost</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<h2 id=\"应用-mirror\"><a href=\"#应用-mirror\" class=\"headerlink\" title=\"应用 mirror\"></a>应用 mirror</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ sudo vim /etc/apt/sources.list</div></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial main restricted</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates main restricted</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial universe</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates universe</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial multiverse</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates multiverse</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security main restricted</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security universe</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security multiverse</div><div class=\"line\">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/download.docker.com/linux/ubuntu/ xenial stable</div></pre></td></tr></table></figure>\n<p>配置文件里面的 192.168.0.11 是内部 mirror 服务器的 IP 地址。</p>\n<p>[arch=amd64] 是必须的，否则服务器会报 404 错误。32 位版本请做调整。</p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><p>请定时运行 apt-mirror 程序以更新本地仓库。</p>\n"},{"title":"Ubuntu 用户与权限","date":"2017-06-06T07:49:40.000Z","_content":"\n## 增加用户\n可以使用 adduser 和 useradd 来给 Ubuntu 系统添加用户，下面以 adduser 为例。\n``` bash\n# 添加用户 username\nsudo adduser username\n\n# 将用户 username 添加到 sudo 组\nsudo adduser username sudo\n```\n\n## 删除用户\n删除用户需要用到 userdel，前提要求目标用户当时未登录。\n``` bash\n# 删除用户 username\nsudo userdel username\n```\n\n## 修改密码\n使用 passwd 修改密码。\n``` bash\n# 修改当前用户的密码\npasswd\n\n# 修改别人（username）的密码\nsudo passwd username\n```\n\n## 文件系统权限\n``` bash\n# 只有所有者有读和写的权限\nchmod 600 ×××\n# 所有者有读和写的权限，组用户只有读的权限\nchmod 644 ×××\n# 只有所有者有读和写以及执行的权限\nchmod 700 ×××\n# 每个人都有读和写的权限\nchmod 666 ×××\n# 每个人都有读和写以及执行的权限\nchmod 777 ×××\n```","source":"_posts/Ubuntu-用户与权限.md","raw":"---\ntitle: Ubuntu 用户与权限\ndate: 2017-06-06 15:49:40\ncategories: Ubuntu\ntags: Ubuntu\n---\n\n## 增加用户\n可以使用 adduser 和 useradd 来给 Ubuntu 系统添加用户，下面以 adduser 为例。\n``` bash\n# 添加用户 username\nsudo adduser username\n\n# 将用户 username 添加到 sudo 组\nsudo adduser username sudo\n```\n\n## 删除用户\n删除用户需要用到 userdel，前提要求目标用户当时未登录。\n``` bash\n# 删除用户 username\nsudo userdel username\n```\n\n## 修改密码\n使用 passwd 修改密码。\n``` bash\n# 修改当前用户的密码\npasswd\n\n# 修改别人（username）的密码\nsudo passwd username\n```\n\n## 文件系统权限\n``` bash\n# 只有所有者有读和写的权限\nchmod 600 ×××\n# 所有者有读和写的权限，组用户只有读的权限\nchmod 644 ×××\n# 只有所有者有读和写以及执行的权限\nchmod 700 ×××\n# 每个人都有读和写的权限\nchmod 666 ×××\n# 每个人都有读和写以及执行的权限\nchmod 777 ×××\n```","slug":"Ubuntu-用户与权限","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48em000unki3j9ly7lky","content":"<h2 id=\"增加用户\"><a href=\"#增加用户\" class=\"headerlink\" title=\"增加用户\"></a>增加用户</h2><p>可以使用 adduser 和 useradd 来给 Ubuntu 系统添加用户，下面以 adduser 为例。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># 添加用户 username</span></div><div class=\"line\">sudo adduser username</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># 将用户 username 添加到 sudo 组</span></div><div class=\"line\">sudo adduser username sudo</div></pre></td></tr></table></figure></p>\n<h2 id=\"删除用户\"><a href=\"#删除用户\" class=\"headerlink\" title=\"删除用户\"></a>删除用户</h2><p>删除用户需要用到 userdel，前提要求目标用户当时未登录。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># 删除用户 username</span></div><div class=\"line\">sudo userdel username</div></pre></td></tr></table></figure></p>\n<h2 id=\"修改密码\"><a href=\"#修改密码\" class=\"headerlink\" title=\"修改密码\"></a>修改密码</h2><p>使用 passwd 修改密码。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># 修改当前用户的密码</span></div><div class=\"line\">passwd</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># 修改别人（username）的密码</span></div><div class=\"line\">sudo passwd username</div></pre></td></tr></table></figure></p>\n<h2 id=\"文件系统权限\"><a href=\"#文件系统权限\" class=\"headerlink\" title=\"文件系统权限\"></a>文件系统权限</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># 只有所有者有读和写的权限</span></div><div class=\"line\">chmod 600 ×××</div><div class=\"line\"><span class=\"comment\"># 所有者有读和写的权限，组用户只有读的权限</span></div><div class=\"line\">chmod 644 ×××</div><div class=\"line\"><span class=\"comment\"># 只有所有者有读和写以及执行的权限</span></div><div class=\"line\">chmod 700 ×××</div><div class=\"line\"><span class=\"comment\"># 每个人都有读和写的权限</span></div><div class=\"line\">chmod 666 ×××</div><div class=\"line\"><span class=\"comment\"># 每个人都有读和写以及执行的权限</span></div><div class=\"line\">chmod 777 ×××</div></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"增加用户\"><a href=\"#增加用户\" class=\"headerlink\" title=\"增加用户\"></a>增加用户</h2><p>可以使用 adduser 和 useradd 来给 Ubuntu 系统添加用户，下面以 adduser 为例。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># 添加用户 username</span></div><div class=\"line\">sudo adduser username</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># 将用户 username 添加到 sudo 组</span></div><div class=\"line\">sudo adduser username sudo</div></pre></td></tr></table></figure></p>\n<h2 id=\"删除用户\"><a href=\"#删除用户\" class=\"headerlink\" title=\"删除用户\"></a>删除用户</h2><p>删除用户需要用到 userdel，前提要求目标用户当时未登录。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># 删除用户 username</span></div><div class=\"line\">sudo userdel username</div></pre></td></tr></table></figure></p>\n<h2 id=\"修改密码\"><a href=\"#修改密码\" class=\"headerlink\" title=\"修改密码\"></a>修改密码</h2><p>使用 passwd 修改密码。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># 修改当前用户的密码</span></div><div class=\"line\">passwd</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># 修改别人（username）的密码</span></div><div class=\"line\">sudo passwd username</div></pre></td></tr></table></figure></p>\n<h2 id=\"文件系统权限\"><a href=\"#文件系统权限\" class=\"headerlink\" title=\"文件系统权限\"></a>文件系统权限</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># 只有所有者有读和写的权限</span></div><div class=\"line\">chmod 600 ×××</div><div class=\"line\"><span class=\"comment\"># 所有者有读和写的权限，组用户只有读的权限</span></div><div class=\"line\">chmod 644 ×××</div><div class=\"line\"><span class=\"comment\"># 只有所有者有读和写以及执行的权限</span></div><div class=\"line\">chmod 700 ×××</div><div class=\"line\"><span class=\"comment\"># 每个人都有读和写的权限</span></div><div class=\"line\">chmod 666 ×××</div><div class=\"line\"><span class=\"comment\"># 每个人都有读和写以及执行的权限</span></div><div class=\"line\">chmod 777 ×××</div></pre></td></tr></table></figure>"},{"title":"Ubuntu 配置 Gerrit 与 Apache","date":"2017-05-26T08:07:15.000Z","_content":"\n## Gerrit 相关配置\n\n### Review Site 配置文件\n``` ini\n[gerrit]\n\tbasePath = git\n\tserverId = 9e2f813e-92e4-43a7-a3ad-8c16bc7492d0\n\tcanonicalWebUrl = http://xxx.com/gerrit/\n[database]\n\ttype = mysql\n\thostname = localhost\n\tdatabase = reviewdb\n\tusername = gerrit2\n[index]\n\ttype = LUCENE\n[auth]\n\ttype = HTTP\n\tlogoutUrl = http://someone:xxx@xxx.com/gerrit/\n[receive]\n\tenableSignedPush = false\n[sendemail]\n\tsmtpServer = smtp.ym.163.com\n\tsmtpServerPort = 25\n\tsmtpUser = gerrit@xxx.com\n\tfrom = gerrit@xxx.com\n\tsslVerify = false\n[container]\n\tuser = gerrit2\n\tjavaHome = /usr/lib/jvm/java-8-oracle/jre\n[sshd]\n\tlistenAddress = *:29418\n[httpd]\n\tlistenUrl = proxy-http://*:8081/gerrit/\n[cache]\n\tdirectory = cache\n[gitweb]\n\ttype = gitweb\n\tcgi = /usr/lib/cgi-bin/gitweb.cgi\n```\n\n## Apache 配置文件\n下面的配置文件包含了：\n  - http://xxx.com\n  - http://xxx.com/gerrit/\n  - http://xxx.com/redmine/\n``` apache\n<VirtualHost *>\n    ServerName xxx.com\n    DocumentRoot /var/www/html\n\n    #\n    # Gerrit configurations\n    # Access http://xxx.com/gerrit/\n    #\n\n    ProxyRequests Off\n    ProxyVia Off\n    ProxyPreserveHost On\n\n    <Proxy http://localhost:8081/gerrit/>\n        Order deny,allow\n        Allow from all\n    </Proxy>\n\n    # Access limited\n    <Location \"/gerrit/\">\n        AuthType Basic\n        AuthName \"Gerrit Code Review\"\n        Require valid-user\n        AuthBasicProvider file\n        AuthUserFile \"/home/passwords\"\n    </Location>\n\n    # Can access without athorization\n    <Location \"/gerrit/external\">\n        # All access controls and authentication are disabled in this directory\n        Satisfy Any\n        Allow from all\n    </Location>\n\n    AllowEncodedSlashes On\n    ProxyPass /gerrit/ http://localhost:8081/gerrit/ nocanon\n\n    #\n    # Redmine configurations\n    # Rewrite xxx.com/redmine/ to xxx.com:8080/redmine/\n    #\n\n    RewriteEngine On\n    RewriteCond %{REQUEST_URI} ^/redmine/ [NC]\n    RewriteRule /redmine/(.*) http://xxx.com:8080/redmine/$1 [R=permanent,L]\n</VirtualHost>\n\n# vim: syntax=apache ts=4 sw=4 sts=4 sr noet\n```","source":"_posts/Ubuntu-配置-Gerrit-与-Apache.md","raw":"---\ntitle: Ubuntu 配置 Gerrit 与 Apache\ndate: 2017-05-26 16:07:15\ncategories: Gerrit\ntags: [Ubuntu, Gerrit, Apache]\n---\n\n## Gerrit 相关配置\n\n### Review Site 配置文件\n``` ini\n[gerrit]\n\tbasePath = git\n\tserverId = 9e2f813e-92e4-43a7-a3ad-8c16bc7492d0\n\tcanonicalWebUrl = http://xxx.com/gerrit/\n[database]\n\ttype = mysql\n\thostname = localhost\n\tdatabase = reviewdb\n\tusername = gerrit2\n[index]\n\ttype = LUCENE\n[auth]\n\ttype = HTTP\n\tlogoutUrl = http://someone:xxx@xxx.com/gerrit/\n[receive]\n\tenableSignedPush = false\n[sendemail]\n\tsmtpServer = smtp.ym.163.com\n\tsmtpServerPort = 25\n\tsmtpUser = gerrit@xxx.com\n\tfrom = gerrit@xxx.com\n\tsslVerify = false\n[container]\n\tuser = gerrit2\n\tjavaHome = /usr/lib/jvm/java-8-oracle/jre\n[sshd]\n\tlistenAddress = *:29418\n[httpd]\n\tlistenUrl = proxy-http://*:8081/gerrit/\n[cache]\n\tdirectory = cache\n[gitweb]\n\ttype = gitweb\n\tcgi = /usr/lib/cgi-bin/gitweb.cgi\n```\n\n## Apache 配置文件\n下面的配置文件包含了：\n  - http://xxx.com\n  - http://xxx.com/gerrit/\n  - http://xxx.com/redmine/\n``` apache\n<VirtualHost *>\n    ServerName xxx.com\n    DocumentRoot /var/www/html\n\n    #\n    # Gerrit configurations\n    # Access http://xxx.com/gerrit/\n    #\n\n    ProxyRequests Off\n    ProxyVia Off\n    ProxyPreserveHost On\n\n    <Proxy http://localhost:8081/gerrit/>\n        Order deny,allow\n        Allow from all\n    </Proxy>\n\n    # Access limited\n    <Location \"/gerrit/\">\n        AuthType Basic\n        AuthName \"Gerrit Code Review\"\n        Require valid-user\n        AuthBasicProvider file\n        AuthUserFile \"/home/passwords\"\n    </Location>\n\n    # Can access without athorization\n    <Location \"/gerrit/external\">\n        # All access controls and authentication are disabled in this directory\n        Satisfy Any\n        Allow from all\n    </Location>\n\n    AllowEncodedSlashes On\n    ProxyPass /gerrit/ http://localhost:8081/gerrit/ nocanon\n\n    #\n    # Redmine configurations\n    # Rewrite xxx.com/redmine/ to xxx.com:8080/redmine/\n    #\n\n    RewriteEngine On\n    RewriteCond %{REQUEST_URI} ^/redmine/ [NC]\n    RewriteRule /redmine/(.*) http://xxx.com:8080/redmine/$1 [R=permanent,L]\n</VirtualHost>\n\n# vim: syntax=apache ts=4 sw=4 sts=4 sr noet\n```","slug":"Ubuntu-配置-Gerrit-与-Apache","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48en000vnki3p73r4val","content":"<h2 id=\"Gerrit-相关配置\"><a href=\"#Gerrit-相关配置\" class=\"headerlink\" title=\"Gerrit 相关配置\"></a>Gerrit 相关配置</h2><h3 id=\"Review-Site-配置文件\"><a href=\"#Review-Site-配置文件\" class=\"headerlink\" title=\"Review Site 配置文件\"></a>Review Site 配置文件</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"section\">[gerrit]</span></div><div class=\"line\">\tbasePath = git</div><div class=\"line\">\tserverId = 9e2f813e-92e4-43a7-a3ad-8c16bc7492d0</div><div class=\"line\">\tcanonicalWebUrl = http://xxx.com/gerrit/</div><div class=\"line\"><span class=\"section\">[database]</span></div><div class=\"line\">\ttype = mysql</div><div class=\"line\">\thostname = localhost</div><div class=\"line\">\tdatabase = reviewdb</div><div class=\"line\">\tusername = gerrit2</div><div class=\"line\"><span class=\"section\">[index]</span></div><div class=\"line\">\ttype = LUCENE</div><div class=\"line\"><span class=\"section\">[auth]</span></div><div class=\"line\">\ttype = HTTP</div><div class=\"line\">\tlogoutUrl = http://someone:xxx@xxx.com/gerrit/</div><div class=\"line\"><span class=\"section\">[receive]</span></div><div class=\"line\">\tenableSignedPush = false</div><div class=\"line\"><span class=\"section\">[sendemail]</span></div><div class=\"line\">\tsmtpServer = smtp.ym.163.com</div><div class=\"line\">\tsmtpServerPort = 25</div><div class=\"line\">\tsmtpUser = gerrit@xxx.com</div><div class=\"line\">\tfrom = gerrit@xxx.com</div><div class=\"line\">\tsslVerify = false</div><div class=\"line\"><span class=\"section\">[container]</span></div><div class=\"line\">\tuser = gerrit2</div><div class=\"line\">\tjavaHome = /usr/lib/jvm/java-8-oracle/jre</div><div class=\"line\"><span class=\"section\">[sshd]</span></div><div class=\"line\">\tlistenAddress = *:29418</div><div class=\"line\"><span class=\"section\">[httpd]</span></div><div class=\"line\">\tlistenUrl = proxy-http://*:8081/gerrit/</div><div class=\"line\"><span class=\"section\">[cache]</span></div><div class=\"line\">\tdirectory = cache</div><div class=\"line\"><span class=\"section\">[gitweb]</span></div><div class=\"line\">\ttype = gitweb</div><div class=\"line\">\tcgi = /usr/lib/cgi-bin/gitweb.cgi</div></pre></td></tr></table></figure>\n<h2 id=\"Apache-配置文件\"><a href=\"#Apache-配置文件\" class=\"headerlink\" title=\"Apache 配置文件\"></a>Apache 配置文件</h2><p>下面的配置文件包含了：</p>\n<ul>\n<li><a href=\"http://xxx.com\" target=\"_blank\" rel=\"external\">http://xxx.com</a></li>\n<li><a href=\"http://xxx.com/gerrit/\" target=\"_blank\" rel=\"external\">http://xxx.com/gerrit/</a></li>\n<li><a href=\"http://xxx.com/redmine/\" target=\"_blank\" rel=\"external\">http://xxx.com/redmine/</a><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"section\">&lt;VirtualHost *&gt;</span></div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">ServerName</span></span> xxx.com</div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">DocumentRoot</span></span> /var/www/html</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">#</span></div><div class=\"line\">    <span class=\"comment\"># Gerrit configurations</span></div><div class=\"line\">    <span class=\"comment\"># Access http://xxx.com/gerrit/</span></div><div class=\"line\">    <span class=\"comment\">#</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">ProxyRequests</span> <span class=\"literal\">Off</span></div><div class=\"line\">    <span class=\"attribute\">ProxyVia</span> <span class=\"literal\">Off</span></div><div class=\"line\">    <span class=\"attribute\">ProxyPreserveHost</span> <span class=\"literal\">On</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"section\">&lt;Proxy http://localhost:8081/gerrit/&gt;</span></div><div class=\"line\">        <span class=\"attribute\"><span class=\"nomarkup\">Order</span></span> deny,allow</div><div class=\"line\">        <span class=\"attribute\"><span class=\"nomarkup\">Allow</span></span> from <span class=\"literal\">all</span></div><div class=\"line\">    <span class=\"section\">&lt;/Proxy&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\"># Access limited</span></div><div class=\"line\">    <span class=\"section\">&lt;Location \"/gerrit/\"&gt;</span></div><div class=\"line\">        <span class=\"attribute\">AuthType</span> Basic</div><div class=\"line\">        <span class=\"attribute\">AuthName</span> <span class=\"string\">\"Gerrit Code Review\"</span></div><div class=\"line\">        <span class=\"attribute\">Require</span> valid-user</div><div class=\"line\">        <span class=\"attribute\">AuthBasicProvider</span> file</div><div class=\"line\">        <span class=\"attribute\">AuthUserFile</span> <span class=\"string\">\"/home/passwords\"</span></div><div class=\"line\">    <span class=\"section\">&lt;/Location&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\"># Can access without athorization</span></div><div class=\"line\">    <span class=\"section\">&lt;Location \"/gerrit/external\"&gt;</span></div><div class=\"line\">        <span class=\"comment\"># All access controls and authentication are disabled in this directory</span></div><div class=\"line\">        <span class=\"attribute\">Satisfy</span> Any</div><div class=\"line\">        <span class=\"attribute\"><span class=\"nomarkup\">Allow</span></span> from <span class=\"literal\">all</span></div><div class=\"line\">    <span class=\"section\">&lt;/Location&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">AllowEncodedSlashes</span> <span class=\"literal\">On</span></div><div class=\"line\">    <span class=\"attribute\">ProxyPass</span> /gerrit/ http://localhost:8081/gerrit/ nocanon</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">#</span></div><div class=\"line\">    <span class=\"comment\"># Redmine configurations</span></div><div class=\"line\">    <span class=\"comment\"># Rewrite xxx.com/redmine/ to xxx.com:8080/redmine/</span></div><div class=\"line\">    <span class=\"comment\">#</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">RewriteEngine</span></span> <span class=\"literal\">On</span></div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">RewriteCond</span></span> <span class=\"variable\">%&#123;REQUEST_URI&#125;</span> ^/redmine/<span class=\"meta\"> [NC]</span></div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">RewriteRule</span></span> /redmine/(.*) http://xxx.com:8080/redmine/<span class=\"number\">$1</span><span class=\"meta\"> [R=permanent,L]</span></div><div class=\"line\"><span class=\"section\">&lt;/VirtualHost&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span></div></pre></td></tr></table></figure></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Gerrit-相关配置\"><a href=\"#Gerrit-相关配置\" class=\"headerlink\" title=\"Gerrit 相关配置\"></a>Gerrit 相关配置</h2><h3 id=\"Review-Site-配置文件\"><a href=\"#Review-Site-配置文件\" class=\"headerlink\" title=\"Review Site 配置文件\"></a>Review Site 配置文件</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"section\">[gerrit]</span></div><div class=\"line\">\tbasePath = git</div><div class=\"line\">\tserverId = 9e2f813e-92e4-43a7-a3ad-8c16bc7492d0</div><div class=\"line\">\tcanonicalWebUrl = http://xxx.com/gerrit/</div><div class=\"line\"><span class=\"section\">[database]</span></div><div class=\"line\">\ttype = mysql</div><div class=\"line\">\thostname = localhost</div><div class=\"line\">\tdatabase = reviewdb</div><div class=\"line\">\tusername = gerrit2</div><div class=\"line\"><span class=\"section\">[index]</span></div><div class=\"line\">\ttype = LUCENE</div><div class=\"line\"><span class=\"section\">[auth]</span></div><div class=\"line\">\ttype = HTTP</div><div class=\"line\">\tlogoutUrl = http://someone:xxx@xxx.com/gerrit/</div><div class=\"line\"><span class=\"section\">[receive]</span></div><div class=\"line\">\tenableSignedPush = false</div><div class=\"line\"><span class=\"section\">[sendemail]</span></div><div class=\"line\">\tsmtpServer = smtp.ym.163.com</div><div class=\"line\">\tsmtpServerPort = 25</div><div class=\"line\">\tsmtpUser = gerrit@xxx.com</div><div class=\"line\">\tfrom = gerrit@xxx.com</div><div class=\"line\">\tsslVerify = false</div><div class=\"line\"><span class=\"section\">[container]</span></div><div class=\"line\">\tuser = gerrit2</div><div class=\"line\">\tjavaHome = /usr/lib/jvm/java-8-oracle/jre</div><div class=\"line\"><span class=\"section\">[sshd]</span></div><div class=\"line\">\tlistenAddress = *:29418</div><div class=\"line\"><span class=\"section\">[httpd]</span></div><div class=\"line\">\tlistenUrl = proxy-http://*:8081/gerrit/</div><div class=\"line\"><span class=\"section\">[cache]</span></div><div class=\"line\">\tdirectory = cache</div><div class=\"line\"><span class=\"section\">[gitweb]</span></div><div class=\"line\">\ttype = gitweb</div><div class=\"line\">\tcgi = /usr/lib/cgi-bin/gitweb.cgi</div></pre></td></tr></table></figure>\n<h2 id=\"Apache-配置文件\"><a href=\"#Apache-配置文件\" class=\"headerlink\" title=\"Apache 配置文件\"></a>Apache 配置文件</h2><p>下面的配置文件包含了：</p>\n<ul>\n<li><a href=\"http://xxx.com\" target=\"_blank\" rel=\"external\">http://xxx.com</a></li>\n<li><a href=\"http://xxx.com/gerrit/\" target=\"_blank\" rel=\"external\">http://xxx.com/gerrit/</a></li>\n<li><a href=\"http://xxx.com/redmine/\" target=\"_blank\" rel=\"external\">http://xxx.com/redmine/</a><figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"section\">&lt;VirtualHost *&gt;</span></div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">ServerName</span></span> xxx.com</div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">DocumentRoot</span></span> /var/www/html</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">#</span></div><div class=\"line\">    <span class=\"comment\"># Gerrit configurations</span></div><div class=\"line\">    <span class=\"comment\"># Access http://xxx.com/gerrit/</span></div><div class=\"line\">    <span class=\"comment\">#</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">ProxyRequests</span> <span class=\"literal\">Off</span></div><div class=\"line\">    <span class=\"attribute\">ProxyVia</span> <span class=\"literal\">Off</span></div><div class=\"line\">    <span class=\"attribute\">ProxyPreserveHost</span> <span class=\"literal\">On</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"section\">&lt;Proxy http://localhost:8081/gerrit/&gt;</span></div><div class=\"line\">        <span class=\"attribute\"><span class=\"nomarkup\">Order</span></span> deny,allow</div><div class=\"line\">        <span class=\"attribute\"><span class=\"nomarkup\">Allow</span></span> from <span class=\"literal\">all</span></div><div class=\"line\">    <span class=\"section\">&lt;/Proxy&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\"># Access limited</span></div><div class=\"line\">    <span class=\"section\">&lt;Location \"/gerrit/\"&gt;</span></div><div class=\"line\">        <span class=\"attribute\">AuthType</span> Basic</div><div class=\"line\">        <span class=\"attribute\">AuthName</span> <span class=\"string\">\"Gerrit Code Review\"</span></div><div class=\"line\">        <span class=\"attribute\">Require</span> valid-user</div><div class=\"line\">        <span class=\"attribute\">AuthBasicProvider</span> file</div><div class=\"line\">        <span class=\"attribute\">AuthUserFile</span> <span class=\"string\">\"/home/passwords\"</span></div><div class=\"line\">    <span class=\"section\">&lt;/Location&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\"># Can access without athorization</span></div><div class=\"line\">    <span class=\"section\">&lt;Location \"/gerrit/external\"&gt;</span></div><div class=\"line\">        <span class=\"comment\"># All access controls and authentication are disabled in this directory</span></div><div class=\"line\">        <span class=\"attribute\">Satisfy</span> Any</div><div class=\"line\">        <span class=\"attribute\"><span class=\"nomarkup\">Allow</span></span> from <span class=\"literal\">all</span></div><div class=\"line\">    <span class=\"section\">&lt;/Location&gt;</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">AllowEncodedSlashes</span> <span class=\"literal\">On</span></div><div class=\"line\">    <span class=\"attribute\">ProxyPass</span> /gerrit/ http://localhost:8081/gerrit/ nocanon</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">#</span></div><div class=\"line\">    <span class=\"comment\"># Redmine configurations</span></div><div class=\"line\">    <span class=\"comment\"># Rewrite xxx.com/redmine/ to xxx.com:8080/redmine/</span></div><div class=\"line\">    <span class=\"comment\">#</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">RewriteEngine</span></span> <span class=\"literal\">On</span></div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">RewriteCond</span></span> <span class=\"variable\">%&#123;REQUEST_URI&#125;</span> ^/redmine/<span class=\"meta\"> [NC]</span></div><div class=\"line\">    <span class=\"attribute\"><span class=\"nomarkup\">RewriteRule</span></span> /redmine/(.*) http://xxx.com:8080/redmine/<span class=\"number\">$1</span><span class=\"meta\"> [R=permanent,L]</span></div><div class=\"line\"><span class=\"section\">&lt;/VirtualHost&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span></div></pre></td></tr></table></figure></li>\n</ul>\n"},{"title":"WebKit渲染流程","date":"2015-04-09T06:51:03.000Z","_content":"\n注意：代码并不完整，只是摘录。\n\n## UI 驱动\n\n直接绘制 content(PictureSet)。\n\n``` cpp\n// WebKit/gaia/frameworks/webkit/WebView.cpp\n\nvoid WebView::onDraw(const sp<Canvas>& canvas) {\n  int saveCount = canvas->save();\n  drawContent(canvas, drawNativeRings);\n  canvas->restoreToCount(saveCount);\n\n  if (AUTO_REDRAW_HACK && mAutoRedraw)\n    invalidate();\n\n  mWebViewCore->signalRepaintDone();\n}\n\nvoid WebView::drawContent(const sp<Canvas>& canvas, bool drawRings) {\n  drawCoreAndCursorRing(canvas, mBackgroundColor, mDrawCursorRing && drawRings);\n}\n\nvoid WebView::drawCoreAndCursorRing(const sp<Canvas>& canvas, int color, bool drawCursorRing) {\n  if (mDrawHistory) {\n    canvas->scale(mZoomManager->getScale(), mZoomManager->getScale());\n    canvas->drawPicture(mHistoryPicture);\n    return;\n  }\n\n  int saveCount = canvas->save();\n  if (animateZoom)\n    mZoomManager->animateZoom(canvas);\n  else if (!canvas->isHardwareAccelerated())\n    canvas->scale(mZoomManager->getScale(), mZoomManager->getScale());\n\n  calcOurContentVisibleRectF(mVisibleContentRect);\n\n  if (!canvas->isHardwareAccelerated()) {\n    sp<DrawFilter> df = NULL;\n\n    if (mZoomManager->isZoomAnimating() || UIAnimationsRunning)\n      df = mZoomFilter;\n    else if (animateScroll)\n      df = mScrollFilter;\n\n    canvas->setDrawFilter(df);\n    // XXX: Revisit splitting content.  Right now it causes a\n    // synchronization problem with layers.\n    int content = nativeDraw(canvas, mVisibleContentRect, color, extras, false);\n    canvas->setDrawFilter(NULL);\n    if (!mBlockWebkitViewMessages && content != 0)\n      mWebViewCore->sendMessage(EventHub::SPLIT_PICTURE_SET, content, 0);\n  }\n\n  canvas->restoreToCount(saveCount);\n}\n\n// gaia/nav/WebView.cpp\n\nint nativeDraw(WebKit::WebViewProxy* proxy, SkCanvas* canvas,\n               SkRect visibleRect, int color,\n               int extras, bool split) {\n  WebView* webView = reinterpret_cast<WebView*>(proxy->mNativeClass);\n  webView->setVisibleRect(visibleRect);\n  PictureSet* pictureSet = webView->draw(canvas, color, extras, split);\n  return reinterpret_cast<int>(pictureSet);\n}\n\nPictureSet* draw(SkCanvas* canvas, SkColor bgColor, int extras, bool split) {\n  // draw the content of the base layer first\n  PictureSet* content = m_baseLayer->content();\n  int sc = canvas->save(SkCanvas::kClip_SaveFlag);\n  canvas->clipRect(SkRect::MakeLTRB(0, 0, content->width(),\n                                    content->height()), SkRegion::kDifference_Op);\n  canvas->drawColor(bgColor);\n  canvas->restoreToCount(sc);\n  if (content->draw(canvas))\n    ret = split ? new PictureSet(*content) : 0;\n  return ret;\n}\n```\n\n## WebCore 驱动\n\n使得 content(PictureSet) 被更新。\n\n``` cpp\nvoid FrameView::layout(bool allowSubtree) {\n  // Now update the positions of all layers.\n  beginDeferredRepaints();\n  IntPoint cachedOffset;\n  if (m_doFullRepaint)\n    root->view()->repaint(); // FIXME: This isn't really right, since the RenderView doesn't fully encompass the visibleContentRect(). It just happens\n                             // to work out most of the time, since first layouts and printing don't have you scrolled anywhere.\n\n  layer->updateLayerPositions((m_doFullRepaint ? 0 : RenderLayer::CheckForRepaint)\n                                  | RenderLayer::IsCompositingUpdateRoot\n                                  | RenderLayer::UpdateCompositingLayers,\n                              subtree ? 0 : &cachedOffset);\n  endDeferredRepaints();\n\n#if USE(ACCELERATED_COMPOSITING)\n  updateCompositingLayers();\n#endif\n\n  m_layoutCount++;\n  ASSERT(!root->needsLayout());\n  updateCanBlitOnScrollRecursively();\n\n  if (document->hasListenerType(Document::OVERFLOWCHANGED_LISTENER))\n    updateOverflowStatus(layoutWidth() < contentsWidth(),\n                         layoutHeight() < contentsHeight());\n\n  if (!m_hasPendingPostLayoutTasks) {\n    if (!m_inSynchronousPostLayout && !inSubframeLayoutWithFrameFlattening) {\n      m_inSynchronousPostLayout = true;\n      // Calls resumeScheduledEvents()\n      performPostLayoutTasks();\n      m_inSynchronousPostLayout = false;\n    }\n\n    if (!m_hasPendingPostLayoutTasks &&\n        (needsLayout() || m_inSynchronousPostLayout || inSubframeLayoutWithFrameFlattening)) {\n      // If we need layout or are already in a synchronous call to postLayoutTasks(),\n      // defer widget updates and event dispatch until after we return. postLayoutTasks()\n      // can make us need to update again, and we can get stuck in a nasty cycle unless\n      // we call it through the timer here.\n      m_hasPendingPostLayoutTasks = true;\n      m_postLayoutTasksTimer.startOneShot(0);\n      if (needsLayout()) {\n        m_actionScheduler->pause();\n        layout();\n      }\n    }\n  } else {\n    m_actionScheduler->resume();\n  }\n\n  InspectorInstrumentation::didLayout(cookie);\n\n  m_nestedLayoutCount--;\n#if ENABLE(ANDROID_OVERFLOW_SCROLL)\n  // Reset to false each time we layout in case the overflow status changed.\n  bool hasOverflowScroll = false;\n  RenderObject* ownerRenderer = m_frame->ownerRenderer();\n  if (ownerRenderer && ownerRenderer->isRenderIFrame()) {\n    RenderLayer* layer = ownerRenderer->enclosingLayer();\n    if (layer) {\n      // Some sites use tiny iframes for loading so don't composite those.\n      if (canHaveScrollbars() && layoutWidth() > 1 && layoutHeight() > 1)\n        hasOverflowScroll = layoutWidth() < contentsWidth() || layoutHeight() < contentsHeight();\n    }\n  }\n\n  if (RenderView* view = m_frame->contentRenderer()) {\n    if (hasOverflowScroll != m_hasOverflowScroll) {\n      if (hasOverflowScroll)\n        enterCompositingMode();\n      else {\n        // We are leaving overflow mode so we need to update the layer\n        // tree in case that is the reason we were composited.\n        view->compositor()->scheduleCompositingLayerUpdate();\n      }\n    }\n  }\n\n  m_hasOverflowScroll = hasOverflowScroll;\n#endif\n}\n\n// Sometimes (for plug-ins) we need to eagerly go into compositing mode.\nvoid FrameView::enterCompositingMode() {\n#if USE(ACCELERATED_COMPOSITING)\n  if (RenderView* view = m_frame->contentRenderer()) {\n    view->compositor()->enableCompositingMode();\n    if (!needsLayout())\n      view->compositor()->scheduleCompositingLayerUpdate();\n  }\n#endif\n}\n\n// Note that this gets called at painting time.\nvoid FrameView::setIsOverlapped(bool isOverlapped) {\n  if (isOverlapped == m_isOverlapped)\n    return;\n\n  m_isOverlapped = isOverlapped;\n  updateCanBlitOnScrollRecursively();\n\n#if USE(ACCELERATED_COMPOSITING)\n  if (hasCompositedContentIncludingDescendants()) {\n    // Overlap can affect compositing tests, so if it changes, we need to trigger\n    // a layer update in the parent document.\n    if (Frame* parentFrame = m_frame->tree()->parent()) {\n      if (RenderView* parentView = parentFrame->contentRenderer()) {\n        RenderLayerCompositor* compositor = parentView->compositor();\n        compositor->setCompositingLayersNeedRebuild();\n        compositor->scheduleCompositingLayerUpdate();\n      }\n    }\n\n    if (RenderLayerCompositor::allowsIndependentlyCompositedFrames(this)) {\n      // We also need to trigger reevaluation for this and all descendant frames,\n      // since a frame uses compositing if any ancestor is compositing.\n      for (Frame* frame = m_frame.get(); frame; frame = frame->tree()->traverseNext(m_frame.get())) {\n        if (RenderView* view = frame->contentRenderer()) {\n          RenderLayerCompositor* compositor = view->compositor();\n          compositor->setCompositingLayersNeedRebuild();\n          compositor->scheduleCompositingLayerUpdate();\n        }\n      }\n    }\n  }\n#endif\n}\n\nvoid RenderLayerCompositor::scheduleCompositingLayerUpdate() {\n  if (!m_updateCompositingLayersTimer.isActive())\n    m_updateCompositingLayersTimer.startOneShot(0);\n}\n\nbool RenderLayerCompositor::compositingLayerUpdatePending() const {\n  return m_updateCompositingLayersTimer.isActive();\n}\n\nvoid RenderLayerCompositor::updateCompositingLayersTimerFired(Timer<RenderLayerCompositor>*) {\n  updateCompositingLayers();\n}\n\n// WebCore/platform/graphics/android/GraphicsLayerAndroid.cpp\n\nbool GraphicsLayerAndroid::setChildren(const WTF::Vector<GraphicsLayer*>& children)\n\nvoid GraphicsLayerAndroid::addChild(GraphicsLayer* childLayer)\n\nvoid GraphicsLayerAndroid::addChildAtIndex(GraphicsLayer* childLayer, int index)\n\nvoid GraphicsLayerAndroid::addChildBelow(GraphicsLayer* childLayer, GraphicsLayer* sibling)\n\nvoid GraphicsLayerAndroid::addChildAbove(GraphicsLayer* childLayer, GraphicsLayer* sibling)\n\nbool GraphicsLayerAndroid::replaceChild(GraphicsLayer* oldChild, GraphicsLayer* newChild)\n\nvoid GraphicsLayerAndroid::removeFromParent()\n\nvoid GraphicsLayerAndroid::setZPosition(float position)\n\n...\n\n{\n  askForSync();\n}\n\nvoid GraphicsLayerAndroid::askForSync() {\n  if (m_client)\n    m_client->notifySyncRequired(this);\n}\n\n// WebCore/rendering/RenderLayerBacking.cpp\n\nvoid RenderLayerBacking::notifySyncRequired(const GraphicsLayer*) {\n  if (!renderer()->documentBeingDestroyed())\n    compositor()->scheduleLayerFlush();\n}\n\n// WebCore/rendering/RenderLayerCompositor.h\n\nvoid RenderLayerCompositor::notifySyncRequired(const GraphicsLayer*) {\n  scheduleLayerFlush();\n}\n\n// WebCore/rendering/RenderLayerCompositor.cpp\n\nvoid RenderLayerCompositor::scheduleLayerFlush() {\n  page->chrome()->client()->scheduleCompositingLayerSync();\n}\n```\n\n## documentDidBecomeActive 驱动\n\n``` cpp\nvoid Document::documentDidBecomeActive() {\n  HashSet<Element*>::iterator end = m_documentActivationCallbackElements.end();\n  for (HashSet<Element*>::iterator i = m_documentActivationCallbackElements.begin(); i != end; ++i)\n    (*i)->documentDidBecomeActive();\n\n#if USE(ACCELERATED_COMPOSITING)\n  if (renderer())\n    renderView()->didMoveOnscreen();\n#endif\n\n  ASSERT(m_frame);\n  m_frame->loader()->client()->dispatchDidBecomeFrameset(isFrameSet());\n}\n\n// WebCore/rendering/RenderLayerCompositor.cpp\n\nvoid RenderLayerCompositor::didMoveOnscreen() {\n  RootLayerAttachment attachment = shouldPropagateCompositingToEnclosingFrame() ? RootLayerAttachedViaEnclosingFrame\n                                                                                : RootLayerAttachedViaChromeClient;\n  attachRootPlatformLayer(attachment);\n}\n\nvoid RenderLayerCompositor::attachRootPlatformLayer(RootLayerAttachment attachment) {\n  switch (attachment) {\n    case RootLayerAttachedViaChromeClient: {\n      page->chrome()->client()->attachRootGraphicsLayer(frame, rootPlatformLayer());\n      break;\n    }\n    case RootLayerAttachedViaEnclosingFrame: {\n      // The layer will get hooked up via RenderLayerBacking::updateGraphicsLayerConfiguration()\n      // for the frame's renderer in the parent document.\n      scheduleNeedsStyleRecalc(m_renderView->document()->ownerElement());\n      break;\n    }\n  }\n}\n\n// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp\n\nvoid ChromeClientAndroid::attachRootGraphicsLayer(WebCore::Frame*, WebCore::GraphicsLayer* layer) {\n  scheduleCompositingLayerSync();\n}\n\n// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp\nvoid ChromeClientAndroid::scheduleCompositingLayerSync() {\n  if (m_needsLayerSync)\n    return;\n\n  m_needsLayerSync = true;\n  WebViewCore* webViewCore = WebViewCore::getWebViewCore(m_webFrame->page()->mainFrame()->view());\n  if (webViewCore)\n    webViewCore->layersDraw();\n}\n\n// WebKit/gaia/frameworks/webkit/WebViewCore.cpp\n\nvoid WebViewCore::layersDraw() {\n  mEventHub->sendMessage(gaia::Message::obtain(NULL, EventHub::WEBKIT_DRAW_LAYERS));\n}\n\n// WebKit/gaia/frameworks/webkit/inner/EventHub.cpp\n\nvoid EventHub::EventHubHandler::handleMessage(const sp<gaia::Message>& msg) {\n  case WEBKIT_DRAW:\n    webViewCore->webkitDraw();\n    break;\n\n  case WEBKIT_DRAW_LAYERS:\n    webViewCore->webkitDrawLayers();\n    break;\n}\n\n// WebKit/gaia/frameworks/webkit/WebViewCore.cpp\n\nvoid WebViewCore::webkitDrawLayers() {\n  mDrawLayersIsScheduled = false;\n  if (mDrawIsScheduled || mLastDrawData == NULL) {\n    removeMessages(EventHub::WEBKIT_DRAW);\n    webkitDraw();\n    return;\n  }\n\n  // Directly update the layers we last passed to the UI side\n  if (nativeUpdateLayers(mProxy->mNativeClass, mLastDrawData->mBaseLayer)) {\n    // If anything more complex than position has been touched, let's do a full draw\n    webkitDraw();\n  }\n}\n\nvoid WebViewCore::webkitDraw() {\n  mDrawIsScheduled = false;\n  sp<DrawData> draw = new DrawData();\n  draw->mBaseLayer = nativeRecordContent(draw->mInvalRegion, draw->mContentSize);\n  if (draw->mBaseLayer == 0) {\n    sp <WebView> spWebView = mWebView.promote();\n    if (spWebView != NULL && !spWebView->isPaused()) {\n      LOGV(\"webkitDraw abort, resending draw message\");\n      mEventHub->sendMessage(gaia::Message::obtain(NULL, EventHub::WEBKIT_DRAW));\n    } else\n      LOGV(\"webkitDraw abort, webview paused\");\n    return;\n  }\n\n  mLastDrawData = draw;\n  webkitDraw(draw);\n}\n```\n\n``` cpp\n// WebKit/gaia/frameworks/webkit/WebViewCore.cpp\n\nvoid WebViewCore::webkitDraw(const sp<DrawData>& draw) {\n  sp <WebView> spWebView = mWebView.promote();\n  if (spWebView != NULL) {\n    draw->mFocusSizeChanged = nativeFocusBoundsChanged();\n    draw->mViewSize = new GPoint(mCurrentViewWidth, mCurrentViewHeight);\n    if (mSettings->getUseWideViewPort()) {\n      draw->mMinPrefWidth = std::max(\n          mViewportWidth == -1 ? WebView::DEFAULT_VIEWPORT_WIDTH\n                               : (mViewportWidth == 0 ? mCurrentViewWidth\n                                                      : mViewportWidth),\n          nativeGetContentMinPrefWidth());\n    }\n    if (mInitialViewState != NULL) {\n      draw->mViewState = mInitialViewState;\n      mInitialViewState = NULL;\n    }\n    if (mFirstLayoutForNonStandardLoad) {\n      draw->mFirstLayoutForNonStandardLoad = true;\n      mFirstLayoutForNonStandardLoad = false;\n    }\n    if (DebugFlags::WEB_VIEW_CORE)\n      LOGV(\"webkitDraw NEW_PICTURE_MSG_ID\");\n\n    sp<gaia::Message> message = gaia::Message::obtain(spWebView->mPrivateHandler,\n                                                                WebView::NEW_PICTURE_MSG_ID, draw);\n    SAFETY_ON_NULL_RETURN(message);\n    message->sendToTarget();\n  }\n}\n\nvoid PrivateHandler::handleMessage(const sp<gaia::Message>& msg) {\n  case WebView::NEW_PICTURE_MSG_ID: {\n    // called for new content\n    sp<DrawData> draw = safe_cast<DrawData*>(msg->obj);\n    webView->setNewPicture(draw, true);\n    break;\n  }\n}\n\nBaseLayerAndroid* WebViewCore::recordContent(SkRegion* region, SkIPoint* point) {\n  float progress = (float) m_mainFrame->page()->progress()->estimatedProgress();\n  m_progressDone = progress <= 0.0f || progress >= 1.0f;\n  recordPictureSet(&m_content);\n  return createBaseLayer(region);\n}\n\nvoid WebViewCore::recordPictureSet(PictureSet* content) {\n  // Rebuild the pictureset (webkit repaint)\n  rebuildPictureSet(content);\n\n  updateFrameCache();\n}\n\nvoid WebViewCore::rebuildPictureSet(PictureSet* pictureSet) {\n  WebCore::FrameView* view = m_mainFrame->view();\n  size_t size = pictureSet->size();\n  for (size_t index = 0; index < size; index++) {\n    if (pictureSet->upToDate(index))\n      continue;\n\n    const SkIRect& inval = pictureSet->bounds(index);\n    pictureSet->setPicture(index, rebuildPicture(inval));\n  }\n\n  pictureSet->validate(__FUNCTION__);\n}\n\nSkPicture* WebViewCore::rebuildPicture(const SkIRect& inval) {\n  WebCore::FrameView* view = m_mainFrame->view();\n  int width = view->contentsWidth();\n  int height = view->contentsHeight();\n  SkPicture* picture = new SkPicture();\n  SkAutoPictureRecord arp(picture, width, height, PICT_RECORD_FLAGS);\n  SkAutoMemoryUsageProbe mup(__FUNCTION__);\n  SkCanvas* recordingCanvas = arp.getRecordingCanvas();\n\n  WebCore::PlatformGraphicsContext pgc(recordingCanvas);\n  WebCore::GraphicsContext gc(&pgc);\n  IntPoint origin = view->minimumScrollPosition();\n  // Line commented because of highlight problem\n  // WebCore::IntRect drawArea(inval.fLeft + origin.x(), inval.fTop + origin.y(), inval.width(), inval.height());\n  recordingCanvas->translate(-drawArea.x(), -drawArea.y());\n  recordingCanvas->save();\n  view->platformWidget()->draw(&gc, drawArea);\n  m_rebuildInval.op(inval, SkRegion::kUnion_Op);\n  return picture;\n}\n\nBaseLayerAndroid* WebViewCore::createBaseLayer(SkRegion* region) {\n  BaseLayerAndroid* base = new BaseLayerAndroid();\n  base->setContent(m_content);\n\n  m_skipContentDraw = true;\n  bool layoutSucceeded = layoutIfNeededRecursive(m_mainFrame);\n  m_skipContentDraw = false;\n\n#if USE(ACCELERATED_COMPOSITING)\n  // We set the background color\n  if (m_mainFrame && m_mainFrame->document()\n      && m_mainFrame->document()->body()) {\n    Document* document = m_mainFrame->document();\n    RefPtr<RenderStyle> style = document->styleForElementIgnoringPendingStylesheets(document->body());\n    if (style->hasBackground()) {\n      Color color = style->visitedDependentColor(CSSPropertyBackgroundColor);\n      if (color.isValid() && color.alpha() > 0)\n        base->setBackgroundColor(color);\n    }\n  }\n\n  // We update the layers\n  ChromeClientAndroid* chromeC = static_cast<ChromeClientAndroid*>(m_mainFrame->page()->chrome()->client());\n  GraphicsLayerAndroid* root = static_cast<GraphicsLayerAndroid*>(chromeC->layersSync());\n  if (root) {\n    LayerAndroid* copyLayer = new LayerAndroid(*root->contentLayer());\n    base->addChild(copyLayer);\n    copyLayer->unref();\n    root->contentLayer()->clearDirtyRegion();\n  }\n#endif\n\n  return base;\n}\n```","source":"_posts/WebKit渲染流程.md","raw":"---\ntitle: WebKit渲染流程\ndate: 2015-04-09 14:51:03\ncategories: WebKit\ntags: WebKit\n---\n\n注意：代码并不完整，只是摘录。\n\n## UI 驱动\n\n直接绘制 content(PictureSet)。\n\n``` cpp\n// WebKit/gaia/frameworks/webkit/WebView.cpp\n\nvoid WebView::onDraw(const sp<Canvas>& canvas) {\n  int saveCount = canvas->save();\n  drawContent(canvas, drawNativeRings);\n  canvas->restoreToCount(saveCount);\n\n  if (AUTO_REDRAW_HACK && mAutoRedraw)\n    invalidate();\n\n  mWebViewCore->signalRepaintDone();\n}\n\nvoid WebView::drawContent(const sp<Canvas>& canvas, bool drawRings) {\n  drawCoreAndCursorRing(canvas, mBackgroundColor, mDrawCursorRing && drawRings);\n}\n\nvoid WebView::drawCoreAndCursorRing(const sp<Canvas>& canvas, int color, bool drawCursorRing) {\n  if (mDrawHistory) {\n    canvas->scale(mZoomManager->getScale(), mZoomManager->getScale());\n    canvas->drawPicture(mHistoryPicture);\n    return;\n  }\n\n  int saveCount = canvas->save();\n  if (animateZoom)\n    mZoomManager->animateZoom(canvas);\n  else if (!canvas->isHardwareAccelerated())\n    canvas->scale(mZoomManager->getScale(), mZoomManager->getScale());\n\n  calcOurContentVisibleRectF(mVisibleContentRect);\n\n  if (!canvas->isHardwareAccelerated()) {\n    sp<DrawFilter> df = NULL;\n\n    if (mZoomManager->isZoomAnimating() || UIAnimationsRunning)\n      df = mZoomFilter;\n    else if (animateScroll)\n      df = mScrollFilter;\n\n    canvas->setDrawFilter(df);\n    // XXX: Revisit splitting content.  Right now it causes a\n    // synchronization problem with layers.\n    int content = nativeDraw(canvas, mVisibleContentRect, color, extras, false);\n    canvas->setDrawFilter(NULL);\n    if (!mBlockWebkitViewMessages && content != 0)\n      mWebViewCore->sendMessage(EventHub::SPLIT_PICTURE_SET, content, 0);\n  }\n\n  canvas->restoreToCount(saveCount);\n}\n\n// gaia/nav/WebView.cpp\n\nint nativeDraw(WebKit::WebViewProxy* proxy, SkCanvas* canvas,\n               SkRect visibleRect, int color,\n               int extras, bool split) {\n  WebView* webView = reinterpret_cast<WebView*>(proxy->mNativeClass);\n  webView->setVisibleRect(visibleRect);\n  PictureSet* pictureSet = webView->draw(canvas, color, extras, split);\n  return reinterpret_cast<int>(pictureSet);\n}\n\nPictureSet* draw(SkCanvas* canvas, SkColor bgColor, int extras, bool split) {\n  // draw the content of the base layer first\n  PictureSet* content = m_baseLayer->content();\n  int sc = canvas->save(SkCanvas::kClip_SaveFlag);\n  canvas->clipRect(SkRect::MakeLTRB(0, 0, content->width(),\n                                    content->height()), SkRegion::kDifference_Op);\n  canvas->drawColor(bgColor);\n  canvas->restoreToCount(sc);\n  if (content->draw(canvas))\n    ret = split ? new PictureSet(*content) : 0;\n  return ret;\n}\n```\n\n## WebCore 驱动\n\n使得 content(PictureSet) 被更新。\n\n``` cpp\nvoid FrameView::layout(bool allowSubtree) {\n  // Now update the positions of all layers.\n  beginDeferredRepaints();\n  IntPoint cachedOffset;\n  if (m_doFullRepaint)\n    root->view()->repaint(); // FIXME: This isn't really right, since the RenderView doesn't fully encompass the visibleContentRect(). It just happens\n                             // to work out most of the time, since first layouts and printing don't have you scrolled anywhere.\n\n  layer->updateLayerPositions((m_doFullRepaint ? 0 : RenderLayer::CheckForRepaint)\n                                  | RenderLayer::IsCompositingUpdateRoot\n                                  | RenderLayer::UpdateCompositingLayers,\n                              subtree ? 0 : &cachedOffset);\n  endDeferredRepaints();\n\n#if USE(ACCELERATED_COMPOSITING)\n  updateCompositingLayers();\n#endif\n\n  m_layoutCount++;\n  ASSERT(!root->needsLayout());\n  updateCanBlitOnScrollRecursively();\n\n  if (document->hasListenerType(Document::OVERFLOWCHANGED_LISTENER))\n    updateOverflowStatus(layoutWidth() < contentsWidth(),\n                         layoutHeight() < contentsHeight());\n\n  if (!m_hasPendingPostLayoutTasks) {\n    if (!m_inSynchronousPostLayout && !inSubframeLayoutWithFrameFlattening) {\n      m_inSynchronousPostLayout = true;\n      // Calls resumeScheduledEvents()\n      performPostLayoutTasks();\n      m_inSynchronousPostLayout = false;\n    }\n\n    if (!m_hasPendingPostLayoutTasks &&\n        (needsLayout() || m_inSynchronousPostLayout || inSubframeLayoutWithFrameFlattening)) {\n      // If we need layout or are already in a synchronous call to postLayoutTasks(),\n      // defer widget updates and event dispatch until after we return. postLayoutTasks()\n      // can make us need to update again, and we can get stuck in a nasty cycle unless\n      // we call it through the timer here.\n      m_hasPendingPostLayoutTasks = true;\n      m_postLayoutTasksTimer.startOneShot(0);\n      if (needsLayout()) {\n        m_actionScheduler->pause();\n        layout();\n      }\n    }\n  } else {\n    m_actionScheduler->resume();\n  }\n\n  InspectorInstrumentation::didLayout(cookie);\n\n  m_nestedLayoutCount--;\n#if ENABLE(ANDROID_OVERFLOW_SCROLL)\n  // Reset to false each time we layout in case the overflow status changed.\n  bool hasOverflowScroll = false;\n  RenderObject* ownerRenderer = m_frame->ownerRenderer();\n  if (ownerRenderer && ownerRenderer->isRenderIFrame()) {\n    RenderLayer* layer = ownerRenderer->enclosingLayer();\n    if (layer) {\n      // Some sites use tiny iframes for loading so don't composite those.\n      if (canHaveScrollbars() && layoutWidth() > 1 && layoutHeight() > 1)\n        hasOverflowScroll = layoutWidth() < contentsWidth() || layoutHeight() < contentsHeight();\n    }\n  }\n\n  if (RenderView* view = m_frame->contentRenderer()) {\n    if (hasOverflowScroll != m_hasOverflowScroll) {\n      if (hasOverflowScroll)\n        enterCompositingMode();\n      else {\n        // We are leaving overflow mode so we need to update the layer\n        // tree in case that is the reason we were composited.\n        view->compositor()->scheduleCompositingLayerUpdate();\n      }\n    }\n  }\n\n  m_hasOverflowScroll = hasOverflowScroll;\n#endif\n}\n\n// Sometimes (for plug-ins) we need to eagerly go into compositing mode.\nvoid FrameView::enterCompositingMode() {\n#if USE(ACCELERATED_COMPOSITING)\n  if (RenderView* view = m_frame->contentRenderer()) {\n    view->compositor()->enableCompositingMode();\n    if (!needsLayout())\n      view->compositor()->scheduleCompositingLayerUpdate();\n  }\n#endif\n}\n\n// Note that this gets called at painting time.\nvoid FrameView::setIsOverlapped(bool isOverlapped) {\n  if (isOverlapped == m_isOverlapped)\n    return;\n\n  m_isOverlapped = isOverlapped;\n  updateCanBlitOnScrollRecursively();\n\n#if USE(ACCELERATED_COMPOSITING)\n  if (hasCompositedContentIncludingDescendants()) {\n    // Overlap can affect compositing tests, so if it changes, we need to trigger\n    // a layer update in the parent document.\n    if (Frame* parentFrame = m_frame->tree()->parent()) {\n      if (RenderView* parentView = parentFrame->contentRenderer()) {\n        RenderLayerCompositor* compositor = parentView->compositor();\n        compositor->setCompositingLayersNeedRebuild();\n        compositor->scheduleCompositingLayerUpdate();\n      }\n    }\n\n    if (RenderLayerCompositor::allowsIndependentlyCompositedFrames(this)) {\n      // We also need to trigger reevaluation for this and all descendant frames,\n      // since a frame uses compositing if any ancestor is compositing.\n      for (Frame* frame = m_frame.get(); frame; frame = frame->tree()->traverseNext(m_frame.get())) {\n        if (RenderView* view = frame->contentRenderer()) {\n          RenderLayerCompositor* compositor = view->compositor();\n          compositor->setCompositingLayersNeedRebuild();\n          compositor->scheduleCompositingLayerUpdate();\n        }\n      }\n    }\n  }\n#endif\n}\n\nvoid RenderLayerCompositor::scheduleCompositingLayerUpdate() {\n  if (!m_updateCompositingLayersTimer.isActive())\n    m_updateCompositingLayersTimer.startOneShot(0);\n}\n\nbool RenderLayerCompositor::compositingLayerUpdatePending() const {\n  return m_updateCompositingLayersTimer.isActive();\n}\n\nvoid RenderLayerCompositor::updateCompositingLayersTimerFired(Timer<RenderLayerCompositor>*) {\n  updateCompositingLayers();\n}\n\n// WebCore/platform/graphics/android/GraphicsLayerAndroid.cpp\n\nbool GraphicsLayerAndroid::setChildren(const WTF::Vector<GraphicsLayer*>& children)\n\nvoid GraphicsLayerAndroid::addChild(GraphicsLayer* childLayer)\n\nvoid GraphicsLayerAndroid::addChildAtIndex(GraphicsLayer* childLayer, int index)\n\nvoid GraphicsLayerAndroid::addChildBelow(GraphicsLayer* childLayer, GraphicsLayer* sibling)\n\nvoid GraphicsLayerAndroid::addChildAbove(GraphicsLayer* childLayer, GraphicsLayer* sibling)\n\nbool GraphicsLayerAndroid::replaceChild(GraphicsLayer* oldChild, GraphicsLayer* newChild)\n\nvoid GraphicsLayerAndroid::removeFromParent()\n\nvoid GraphicsLayerAndroid::setZPosition(float position)\n\n...\n\n{\n  askForSync();\n}\n\nvoid GraphicsLayerAndroid::askForSync() {\n  if (m_client)\n    m_client->notifySyncRequired(this);\n}\n\n// WebCore/rendering/RenderLayerBacking.cpp\n\nvoid RenderLayerBacking::notifySyncRequired(const GraphicsLayer*) {\n  if (!renderer()->documentBeingDestroyed())\n    compositor()->scheduleLayerFlush();\n}\n\n// WebCore/rendering/RenderLayerCompositor.h\n\nvoid RenderLayerCompositor::notifySyncRequired(const GraphicsLayer*) {\n  scheduleLayerFlush();\n}\n\n// WebCore/rendering/RenderLayerCompositor.cpp\n\nvoid RenderLayerCompositor::scheduleLayerFlush() {\n  page->chrome()->client()->scheduleCompositingLayerSync();\n}\n```\n\n## documentDidBecomeActive 驱动\n\n``` cpp\nvoid Document::documentDidBecomeActive() {\n  HashSet<Element*>::iterator end = m_documentActivationCallbackElements.end();\n  for (HashSet<Element*>::iterator i = m_documentActivationCallbackElements.begin(); i != end; ++i)\n    (*i)->documentDidBecomeActive();\n\n#if USE(ACCELERATED_COMPOSITING)\n  if (renderer())\n    renderView()->didMoveOnscreen();\n#endif\n\n  ASSERT(m_frame);\n  m_frame->loader()->client()->dispatchDidBecomeFrameset(isFrameSet());\n}\n\n// WebCore/rendering/RenderLayerCompositor.cpp\n\nvoid RenderLayerCompositor::didMoveOnscreen() {\n  RootLayerAttachment attachment = shouldPropagateCompositingToEnclosingFrame() ? RootLayerAttachedViaEnclosingFrame\n                                                                                : RootLayerAttachedViaChromeClient;\n  attachRootPlatformLayer(attachment);\n}\n\nvoid RenderLayerCompositor::attachRootPlatformLayer(RootLayerAttachment attachment) {\n  switch (attachment) {\n    case RootLayerAttachedViaChromeClient: {\n      page->chrome()->client()->attachRootGraphicsLayer(frame, rootPlatformLayer());\n      break;\n    }\n    case RootLayerAttachedViaEnclosingFrame: {\n      // The layer will get hooked up via RenderLayerBacking::updateGraphicsLayerConfiguration()\n      // for the frame's renderer in the parent document.\n      scheduleNeedsStyleRecalc(m_renderView->document()->ownerElement());\n      break;\n    }\n  }\n}\n\n// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp\n\nvoid ChromeClientAndroid::attachRootGraphicsLayer(WebCore::Frame*, WebCore::GraphicsLayer* layer) {\n  scheduleCompositingLayerSync();\n}\n\n// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp\nvoid ChromeClientAndroid::scheduleCompositingLayerSync() {\n  if (m_needsLayerSync)\n    return;\n\n  m_needsLayerSync = true;\n  WebViewCore* webViewCore = WebViewCore::getWebViewCore(m_webFrame->page()->mainFrame()->view());\n  if (webViewCore)\n    webViewCore->layersDraw();\n}\n\n// WebKit/gaia/frameworks/webkit/WebViewCore.cpp\n\nvoid WebViewCore::layersDraw() {\n  mEventHub->sendMessage(gaia::Message::obtain(NULL, EventHub::WEBKIT_DRAW_LAYERS));\n}\n\n// WebKit/gaia/frameworks/webkit/inner/EventHub.cpp\n\nvoid EventHub::EventHubHandler::handleMessage(const sp<gaia::Message>& msg) {\n  case WEBKIT_DRAW:\n    webViewCore->webkitDraw();\n    break;\n\n  case WEBKIT_DRAW_LAYERS:\n    webViewCore->webkitDrawLayers();\n    break;\n}\n\n// WebKit/gaia/frameworks/webkit/WebViewCore.cpp\n\nvoid WebViewCore::webkitDrawLayers() {\n  mDrawLayersIsScheduled = false;\n  if (mDrawIsScheduled || mLastDrawData == NULL) {\n    removeMessages(EventHub::WEBKIT_DRAW);\n    webkitDraw();\n    return;\n  }\n\n  // Directly update the layers we last passed to the UI side\n  if (nativeUpdateLayers(mProxy->mNativeClass, mLastDrawData->mBaseLayer)) {\n    // If anything more complex than position has been touched, let's do a full draw\n    webkitDraw();\n  }\n}\n\nvoid WebViewCore::webkitDraw() {\n  mDrawIsScheduled = false;\n  sp<DrawData> draw = new DrawData();\n  draw->mBaseLayer = nativeRecordContent(draw->mInvalRegion, draw->mContentSize);\n  if (draw->mBaseLayer == 0) {\n    sp <WebView> spWebView = mWebView.promote();\n    if (spWebView != NULL && !spWebView->isPaused()) {\n      LOGV(\"webkitDraw abort, resending draw message\");\n      mEventHub->sendMessage(gaia::Message::obtain(NULL, EventHub::WEBKIT_DRAW));\n    } else\n      LOGV(\"webkitDraw abort, webview paused\");\n    return;\n  }\n\n  mLastDrawData = draw;\n  webkitDraw(draw);\n}\n```\n\n``` cpp\n// WebKit/gaia/frameworks/webkit/WebViewCore.cpp\n\nvoid WebViewCore::webkitDraw(const sp<DrawData>& draw) {\n  sp <WebView> spWebView = mWebView.promote();\n  if (spWebView != NULL) {\n    draw->mFocusSizeChanged = nativeFocusBoundsChanged();\n    draw->mViewSize = new GPoint(mCurrentViewWidth, mCurrentViewHeight);\n    if (mSettings->getUseWideViewPort()) {\n      draw->mMinPrefWidth = std::max(\n          mViewportWidth == -1 ? WebView::DEFAULT_VIEWPORT_WIDTH\n                               : (mViewportWidth == 0 ? mCurrentViewWidth\n                                                      : mViewportWidth),\n          nativeGetContentMinPrefWidth());\n    }\n    if (mInitialViewState != NULL) {\n      draw->mViewState = mInitialViewState;\n      mInitialViewState = NULL;\n    }\n    if (mFirstLayoutForNonStandardLoad) {\n      draw->mFirstLayoutForNonStandardLoad = true;\n      mFirstLayoutForNonStandardLoad = false;\n    }\n    if (DebugFlags::WEB_VIEW_CORE)\n      LOGV(\"webkitDraw NEW_PICTURE_MSG_ID\");\n\n    sp<gaia::Message> message = gaia::Message::obtain(spWebView->mPrivateHandler,\n                                                                WebView::NEW_PICTURE_MSG_ID, draw);\n    SAFETY_ON_NULL_RETURN(message);\n    message->sendToTarget();\n  }\n}\n\nvoid PrivateHandler::handleMessage(const sp<gaia::Message>& msg) {\n  case WebView::NEW_PICTURE_MSG_ID: {\n    // called for new content\n    sp<DrawData> draw = safe_cast<DrawData*>(msg->obj);\n    webView->setNewPicture(draw, true);\n    break;\n  }\n}\n\nBaseLayerAndroid* WebViewCore::recordContent(SkRegion* region, SkIPoint* point) {\n  float progress = (float) m_mainFrame->page()->progress()->estimatedProgress();\n  m_progressDone = progress <= 0.0f || progress >= 1.0f;\n  recordPictureSet(&m_content);\n  return createBaseLayer(region);\n}\n\nvoid WebViewCore::recordPictureSet(PictureSet* content) {\n  // Rebuild the pictureset (webkit repaint)\n  rebuildPictureSet(content);\n\n  updateFrameCache();\n}\n\nvoid WebViewCore::rebuildPictureSet(PictureSet* pictureSet) {\n  WebCore::FrameView* view = m_mainFrame->view();\n  size_t size = pictureSet->size();\n  for (size_t index = 0; index < size; index++) {\n    if (pictureSet->upToDate(index))\n      continue;\n\n    const SkIRect& inval = pictureSet->bounds(index);\n    pictureSet->setPicture(index, rebuildPicture(inval));\n  }\n\n  pictureSet->validate(__FUNCTION__);\n}\n\nSkPicture* WebViewCore::rebuildPicture(const SkIRect& inval) {\n  WebCore::FrameView* view = m_mainFrame->view();\n  int width = view->contentsWidth();\n  int height = view->contentsHeight();\n  SkPicture* picture = new SkPicture();\n  SkAutoPictureRecord arp(picture, width, height, PICT_RECORD_FLAGS);\n  SkAutoMemoryUsageProbe mup(__FUNCTION__);\n  SkCanvas* recordingCanvas = arp.getRecordingCanvas();\n\n  WebCore::PlatformGraphicsContext pgc(recordingCanvas);\n  WebCore::GraphicsContext gc(&pgc);\n  IntPoint origin = view->minimumScrollPosition();\n  // Line commented because of highlight problem\n  // WebCore::IntRect drawArea(inval.fLeft + origin.x(), inval.fTop + origin.y(), inval.width(), inval.height());\n  recordingCanvas->translate(-drawArea.x(), -drawArea.y());\n  recordingCanvas->save();\n  view->platformWidget()->draw(&gc, drawArea);\n  m_rebuildInval.op(inval, SkRegion::kUnion_Op);\n  return picture;\n}\n\nBaseLayerAndroid* WebViewCore::createBaseLayer(SkRegion* region) {\n  BaseLayerAndroid* base = new BaseLayerAndroid();\n  base->setContent(m_content);\n\n  m_skipContentDraw = true;\n  bool layoutSucceeded = layoutIfNeededRecursive(m_mainFrame);\n  m_skipContentDraw = false;\n\n#if USE(ACCELERATED_COMPOSITING)\n  // We set the background color\n  if (m_mainFrame && m_mainFrame->document()\n      && m_mainFrame->document()->body()) {\n    Document* document = m_mainFrame->document();\n    RefPtr<RenderStyle> style = document->styleForElementIgnoringPendingStylesheets(document->body());\n    if (style->hasBackground()) {\n      Color color = style->visitedDependentColor(CSSPropertyBackgroundColor);\n      if (color.isValid() && color.alpha() > 0)\n        base->setBackgroundColor(color);\n    }\n  }\n\n  // We update the layers\n  ChromeClientAndroid* chromeC = static_cast<ChromeClientAndroid*>(m_mainFrame->page()->chrome()->client());\n  GraphicsLayerAndroid* root = static_cast<GraphicsLayerAndroid*>(chromeC->layersSync());\n  if (root) {\n    LayerAndroid* copyLayer = new LayerAndroid(*root->contentLayer());\n    base->addChild(copyLayer);\n    copyLayer->unref();\n    root->contentLayer()->clearDirtyRegion();\n  }\n#endif\n\n  return base;\n}\n```","slug":"WebKit渲染流程","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48ep000xnki3tutxt3j4","content":"<p>注意：代码并不完整，只是摘录。</p>\n<h2 id=\"UI-驱动\"><a href=\"#UI-驱动\" class=\"headerlink\" title=\"UI 驱动\"></a>UI 驱动</h2><p>直接绘制 content(PictureSet)。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/WebView.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebView::onDraw(<span class=\"keyword\">const</span> sp&lt;Canvas&gt;&amp; canvas) &#123;</div><div class=\"line\">  <span class=\"keyword\">int</span> saveCount = canvas-&gt;save();</div><div class=\"line\">  drawContent(canvas, drawNativeRings);</div><div class=\"line\">  canvas-&gt;restoreToCount(saveCount);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (AUTO_REDRAW_HACK &amp;&amp; mAutoRedraw)</div><div class=\"line\">    invalidate();</div><div class=\"line\"></div><div class=\"line\">  mWebViewCore-&gt;signalRepaintDone();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebView::drawContent(<span class=\"keyword\">const</span> sp&lt;Canvas&gt;&amp; canvas, <span class=\"keyword\">bool</span> drawRings) &#123;</div><div class=\"line\">  drawCoreAndCursorRing(canvas, mBackgroundColor, mDrawCursorRing &amp;&amp; drawRings);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebView::drawCoreAndCursorRing(<span class=\"keyword\">const</span> sp&lt;Canvas&gt;&amp; canvas, <span class=\"keyword\">int</span> color, <span class=\"keyword\">bool</span> drawCursorRing) &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (mDrawHistory) &#123;</div><div class=\"line\">    canvas-&gt;scale(mZoomManager-&gt;getScale(), mZoomManager-&gt;getScale());</div><div class=\"line\">    canvas-&gt;drawPicture(mHistoryPicture);</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">int</span> saveCount = canvas-&gt;save();</div><div class=\"line\">  <span class=\"keyword\">if</span> (animateZoom)</div><div class=\"line\">    mZoomManager-&gt;animateZoom(canvas);</div><div class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!canvas-&gt;isHardwareAccelerated())</div><div class=\"line\">    canvas-&gt;scale(mZoomManager-&gt;getScale(), mZoomManager-&gt;getScale());</div><div class=\"line\"></div><div class=\"line\">  calcOurContentVisibleRectF(mVisibleContentRect);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!canvas-&gt;isHardwareAccelerated()) &#123;</div><div class=\"line\">    sp&lt;DrawFilter&gt; df = <span class=\"literal\">NULL</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (mZoomManager-&gt;isZoomAnimating() || UIAnimationsRunning)</div><div class=\"line\">      df = mZoomFilter;</div><div class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (animateScroll)</div><div class=\"line\">      df = mScrollFilter;</div><div class=\"line\"></div><div class=\"line\">    canvas-&gt;setDrawFilter(df);</div><div class=\"line\">    <span class=\"comment\">// <span class=\"doctag\">XXX:</span> Revisit splitting content.  Right now it causes a</span></div><div class=\"line\">    <span class=\"comment\">// synchronization problem with layers.</span></div><div class=\"line\">    <span class=\"keyword\">int</span> content = nativeDraw(canvas, mVisibleContentRect, color, extras, <span class=\"literal\">false</span>);</div><div class=\"line\">    canvas-&gt;setDrawFilter(<span class=\"literal\">NULL</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (!mBlockWebkitViewMessages &amp;&amp; content != <span class=\"number\">0</span>)</div><div class=\"line\">      mWebViewCore-&gt;sendMessage(EventHub::SPLIT_PICTURE_SET, content, <span class=\"number\">0</span>);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  canvas-&gt;restoreToCount(saveCount);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// gaia/nav/WebView.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">nativeDraw</span><span class=\"params\">(WebKit::WebViewProxy* proxy, SkCanvas* canvas,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">               SkRect visibleRect, <span class=\"keyword\">int</span> color,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">               <span class=\"keyword\">int</span> extras, <span class=\"keyword\">bool</span> split)</span> </span>&#123;</div><div class=\"line\">  WebView* webView = <span class=\"keyword\">reinterpret_cast</span>&lt;WebView*&gt;(proxy-&gt;mNativeClass);</div><div class=\"line\">  webView-&gt;setVisibleRect(visibleRect);</div><div class=\"line\">  PictureSet* pictureSet = webView-&gt;draw(canvas, color, extras, split);</div><div class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"keyword\">int</span>&gt;(pictureSet);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\">PictureSet* <span class=\"title\">draw</span><span class=\"params\">(SkCanvas* canvas, SkColor bgColor, <span class=\"keyword\">int</span> extras, <span class=\"keyword\">bool</span> split)</span> </span>&#123;</div><div class=\"line\">  <span class=\"comment\">// draw the content of the base layer first</span></div><div class=\"line\">  PictureSet* content = m_baseLayer-&gt;content();</div><div class=\"line\">  <span class=\"keyword\">int</span> sc = canvas-&gt;save(SkCanvas::kClip_SaveFlag);</div><div class=\"line\">  canvas-&gt;clipRect(SkRect::MakeLTRB(<span class=\"number\">0</span>, <span class=\"number\">0</span>, content-&gt;width(),</div><div class=\"line\">                                    content-&gt;height()), SkRegion::kDifference_Op);</div><div class=\"line\">  canvas-&gt;drawColor(bgColor);</div><div class=\"line\">  canvas-&gt;restoreToCount(sc);</div><div class=\"line\">  <span class=\"keyword\">if</span> (content-&gt;draw(canvas))</div><div class=\"line\">    ret = split ? <span class=\"keyword\">new</span> PictureSet(*content) : <span class=\"number\">0</span>;</div><div class=\"line\">  <span class=\"keyword\">return</span> ret;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"WebCore-驱动\"><a href=\"#WebCore-驱动\" class=\"headerlink\" title=\"WebCore 驱动\"></a>WebCore 驱动</h2><p>使得 content(PictureSet) 被更新。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> FrameView::layout(<span class=\"keyword\">bool</span> allowSubtree) &#123;</div><div class=\"line\">  <span class=\"comment\">// Now update the positions of all layers.</span></div><div class=\"line\">  beginDeferredRepaints();</div><div class=\"line\">  IntPoint cachedOffset;</div><div class=\"line\">  <span class=\"keyword\">if</span> (m_doFullRepaint)</div><div class=\"line\">    root-&gt;view()-&gt;repaint(); <span class=\"comment\">// <span class=\"doctag\">FIXME:</span> This isn't really right, since the RenderView doesn't fully encompass the visibleContentRect(). It just happens</span></div><div class=\"line\">                             <span class=\"comment\">// to work out most of the time, since first layouts and printing don't have you scrolled anywhere.</span></div><div class=\"line\"></div><div class=\"line\">  layer-&gt;updateLayerPositions((m_doFullRepaint ? <span class=\"number\">0</span> : RenderLayer::CheckForRepaint)</div><div class=\"line\">                                  | RenderLayer::IsCompositingUpdateRoot</div><div class=\"line\">                                  | RenderLayer::UpdateCompositingLayers,</div><div class=\"line\">                              subtree ? <span class=\"number\">0</span> : &amp;cachedOffset);</div><div class=\"line\">  endDeferredRepaints();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  updateCompositingLayers();</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\"></div><div class=\"line\">  m_layoutCount++;</div><div class=\"line\">  ASSERT(!root-&gt;needsLayout());</div><div class=\"line\">  updateCanBlitOnScrollRecursively();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (document-&gt;hasListenerType(Document::OVERFLOWCHANGED_LISTENER))</div><div class=\"line\">    updateOverflowStatus(layoutWidth() &lt; contentsWidth(),</div><div class=\"line\">                         layoutHeight() &lt; contentsHeight());</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!m_hasPendingPostLayoutTasks) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!m_inSynchronousPostLayout &amp;&amp; !inSubframeLayoutWithFrameFlattening) &#123;</div><div class=\"line\">      m_inSynchronousPostLayout = <span class=\"literal\">true</span>;</div><div class=\"line\">      <span class=\"comment\">// Calls resumeScheduledEvents()</span></div><div class=\"line\">      performPostLayoutTasks();</div><div class=\"line\">      m_inSynchronousPostLayout = <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (!m_hasPendingPostLayoutTasks &amp;&amp;</div><div class=\"line\">        (needsLayout() || m_inSynchronousPostLayout || inSubframeLayoutWithFrameFlattening)) &#123;</div><div class=\"line\">      <span class=\"comment\">// If we need layout or are already in a synchronous call to postLayoutTasks(),</span></div><div class=\"line\">      <span class=\"comment\">// defer widget updates and event dispatch until after we return. postLayoutTasks()</span></div><div class=\"line\">      <span class=\"comment\">// can make us need to update again, and we can get stuck in a nasty cycle unless</span></div><div class=\"line\">      <span class=\"comment\">// we call it through the timer here.</span></div><div class=\"line\">      m_hasPendingPostLayoutTasks = <span class=\"literal\">true</span>;</div><div class=\"line\">      m_postLayoutTasksTimer.startOneShot(<span class=\"number\">0</span>);</div><div class=\"line\">      <span class=\"keyword\">if</span> (needsLayout()) &#123;</div><div class=\"line\">        m_actionScheduler-&gt;pause();</div><div class=\"line\">        layout();</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">    m_actionScheduler-&gt;resume();</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  InspectorInstrumentation::didLayout(cookie);</div><div class=\"line\"></div><div class=\"line\">  m_nestedLayoutCount--;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> ENABLE(ANDROID_OVERFLOW_SCROLL)</span></div><div class=\"line\">  <span class=\"comment\">// Reset to false each time we layout in case the overflow status changed.</span></div><div class=\"line\">  <span class=\"keyword\">bool</span> hasOverflowScroll = <span class=\"literal\">false</span>;</div><div class=\"line\">  RenderObject* ownerRenderer = m_frame-&gt;ownerRenderer();</div><div class=\"line\">  <span class=\"keyword\">if</span> (ownerRenderer &amp;&amp; ownerRenderer-&gt;isRenderIFrame()) &#123;</div><div class=\"line\">    RenderLayer* layer = ownerRenderer-&gt;enclosingLayer();</div><div class=\"line\">    <span class=\"keyword\">if</span> (layer) &#123;</div><div class=\"line\">      <span class=\"comment\">// Some sites use tiny iframes for loading so don't composite those.</span></div><div class=\"line\">      <span class=\"keyword\">if</span> (canHaveScrollbars() &amp;&amp; layoutWidth() &gt; <span class=\"number\">1</span> &amp;&amp; layoutHeight() &gt; <span class=\"number\">1</span>)</div><div class=\"line\">        hasOverflowScroll = layoutWidth() &lt; contentsWidth() || layoutHeight() &lt; contentsHeight();</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (RenderView* view = m_frame-&gt;contentRenderer()) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (hasOverflowScroll != m_hasOverflowScroll) &#123;</div><div class=\"line\">      <span class=\"keyword\">if</span> (hasOverflowScroll)</div><div class=\"line\">        enterCompositingMode();</div><div class=\"line\">      <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        <span class=\"comment\">// We are leaving overflow mode so we need to update the layer</span></div><div class=\"line\">        <span class=\"comment\">// tree in case that is the reason we were composited.</span></div><div class=\"line\">        view-&gt;compositor()-&gt;scheduleCompositingLayerUpdate();</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  m_hasOverflowScroll = hasOverflowScroll;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Sometimes (for plug-ins) we need to eagerly go into compositing mode.</span></div><div class=\"line\"><span class=\"keyword\">void</span> FrameView::enterCompositingMode() &#123;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (RenderView* view = m_frame-&gt;contentRenderer()) &#123;</div><div class=\"line\">    view-&gt;compositor()-&gt;enableCompositingMode();</div><div class=\"line\">    <span class=\"keyword\">if</span> (!needsLayout())</div><div class=\"line\">      view-&gt;compositor()-&gt;scheduleCompositingLayerUpdate();</div><div class=\"line\">  &#125;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Note that this gets called at painting time.</span></div><div class=\"line\"><span class=\"keyword\">void</span> FrameView::setIsOverlapped(<span class=\"keyword\">bool</span> isOverlapped) &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (isOverlapped == m_isOverlapped)</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\"></div><div class=\"line\">  m_isOverlapped = isOverlapped;</div><div class=\"line\">  updateCanBlitOnScrollRecursively();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (hasCompositedContentIncludingDescendants()) &#123;</div><div class=\"line\">    <span class=\"comment\">// Overlap can affect compositing tests, so if it changes, we need to trigger</span></div><div class=\"line\">    <span class=\"comment\">// a layer update in the parent document.</span></div><div class=\"line\">    <span class=\"keyword\">if</span> (Frame* parentFrame = m_frame-&gt;tree()-&gt;parent()) &#123;</div><div class=\"line\">      <span class=\"keyword\">if</span> (RenderView* parentView = parentFrame-&gt;contentRenderer()) &#123;</div><div class=\"line\">        RenderLayerCompositor* compositor = parentView-&gt;compositor();</div><div class=\"line\">        compositor-&gt;setCompositingLayersNeedRebuild();</div><div class=\"line\">        compositor-&gt;scheduleCompositingLayerUpdate();</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (RenderLayerCompositor::allowsIndependentlyCompositedFrames(<span class=\"keyword\">this</span>)) &#123;</div><div class=\"line\">      <span class=\"comment\">// We also need to trigger reevaluation for this and all descendant frames,</span></div><div class=\"line\">      <span class=\"comment\">// since a frame uses compositing if any ancestor is compositing.</span></div><div class=\"line\">      <span class=\"keyword\">for</span> (Frame* frame = m_frame.get(); frame; frame = frame-&gt;tree()-&gt;traverseNext(m_frame.get())) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (RenderView* view = frame-&gt;contentRenderer()) &#123;</div><div class=\"line\">          RenderLayerCompositor* compositor = view-&gt;compositor();</div><div class=\"line\">          compositor-&gt;setCompositingLayersNeedRebuild();</div><div class=\"line\">          compositor-&gt;scheduleCompositingLayerUpdate();</div><div class=\"line\">        &#125;</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::scheduleCompositingLayerUpdate() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (!m_updateCompositingLayersTimer.isActive())</div><div class=\"line\">    m_updateCompositingLayersTimer.startOneShot(<span class=\"number\">0</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">bool</span> RenderLayerCompositor::compositingLayerUpdatePending() <span class=\"keyword\">const</span> &#123;</div><div class=\"line\">  <span class=\"keyword\">return</span> m_updateCompositingLayersTimer.isActive();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::updateCompositingLayersTimerFired(Timer&lt;RenderLayerCompositor&gt;*) &#123;</div><div class=\"line\">  updateCompositingLayers();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/platform/graphics/android/GraphicsLayerAndroid.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">bool</span> GraphicsLayerAndroid::setChildren(<span class=\"keyword\">const</span> WTF::Vector&lt;GraphicsLayer*&gt;&amp; children)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::addChild(GraphicsLayer* childLayer)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::addChildAtIndex(GraphicsLayer* childLayer, <span class=\"keyword\">int</span> index)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::addChildBelow(GraphicsLayer* childLayer, GraphicsLayer* sibling)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::addChildAbove(GraphicsLayer* childLayer, GraphicsLayer* sibling)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">bool</span> GraphicsLayerAndroid::replaceChild(GraphicsLayer* oldChild, GraphicsLayer* newChild)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::removeFromParent()</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::setZPosition(<span class=\"keyword\">float</span> position)</div><div class=\"line\"></div><div class=\"line\">...</div><div class=\"line\"></div><div class=\"line\">&#123;</div><div class=\"line\">  askForSync();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::askForSync() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (m_client)</div><div class=\"line\">    m_client-&gt;notifySyncRequired(<span class=\"keyword\">this</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/rendering/RenderLayerBacking.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerBacking::notifySyncRequired(<span class=\"keyword\">const</span> GraphicsLayer*) &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (!renderer()-&gt;documentBeingDestroyed())</div><div class=\"line\">    compositor()-&gt;scheduleLayerFlush();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/rendering/RenderLayerCompositor.h</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::notifySyncRequired(<span class=\"keyword\">const</span> GraphicsLayer*) &#123;</div><div class=\"line\">  scheduleLayerFlush();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/rendering/RenderLayerCompositor.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::scheduleLayerFlush() &#123;</div><div class=\"line\">  page-&gt;chrome()-&gt;client()-&gt;scheduleCompositingLayerSync();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"documentDidBecomeActive-驱动\"><a href=\"#documentDidBecomeActive-驱动\" class=\"headerlink\" title=\"documentDidBecomeActive 驱动\"></a>documentDidBecomeActive 驱动</h2><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> Document::documentDidBecomeActive() &#123;</div><div class=\"line\">  HashSet&lt;Element*&gt;::iterator end = m_documentActivationCallbackElements.end();</div><div class=\"line\">  <span class=\"keyword\">for</span> (HashSet&lt;Element*&gt;::iterator i = m_documentActivationCallbackElements.begin(); i != end; ++i)</div><div class=\"line\">    (*i)-&gt;documentDidBecomeActive();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (renderer())</div><div class=\"line\">    renderView()-&gt;didMoveOnscreen();</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\"></div><div class=\"line\">  ASSERT(m_frame);</div><div class=\"line\">  m_frame-&gt;loader()-&gt;client()-&gt;dispatchDidBecomeFrameset(isFrameSet());</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/rendering/RenderLayerCompositor.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::didMoveOnscreen() &#123;</div><div class=\"line\">  RootLayerAttachment attachment = shouldPropagateCompositingToEnclosingFrame() ? RootLayerAttachedViaEnclosingFrame</div><div class=\"line\">                                                                                : RootLayerAttachedViaChromeClient;</div><div class=\"line\">  attachRootPlatformLayer(attachment);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::attachRootPlatformLayer(RootLayerAttachment attachment) &#123;</div><div class=\"line\">  <span class=\"keyword\">switch</span> (attachment) &#123;</div><div class=\"line\">    <span class=\"keyword\">case</span> RootLayerAttachedViaChromeClient: &#123;</div><div class=\"line\">      page-&gt;chrome()-&gt;client()-&gt;attachRootGraphicsLayer(frame, rootPlatformLayer());</div><div class=\"line\">      <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">case</span> RootLayerAttachedViaEnclosingFrame: &#123;</div><div class=\"line\">      <span class=\"comment\">// The layer will get hooked up via RenderLayerBacking::updateGraphicsLayerConfiguration()</span></div><div class=\"line\">      <span class=\"comment\">// for the frame's renderer in the parent document.</span></div><div class=\"line\">      scheduleNeedsStyleRecalc(m_renderView-&gt;document()-&gt;ownerElement());</div><div class=\"line\">      <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> ChromeClientAndroid::attachRootGraphicsLayer(WebCore::Frame*, WebCore::GraphicsLayer* layer) &#123;</div><div class=\"line\">  scheduleCompositingLayerSync();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp</span></div><div class=\"line\"><span class=\"keyword\">void</span> ChromeClientAndroid::scheduleCompositingLayerSync() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (m_needsLayerSync)</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\"></div><div class=\"line\">  m_needsLayerSync = <span class=\"literal\">true</span>;</div><div class=\"line\">  WebViewCore* webViewCore = WebViewCore::getWebViewCore(m_webFrame-&gt;page()-&gt;mainFrame()-&gt;view());</div><div class=\"line\">  <span class=\"keyword\">if</span> (webViewCore)</div><div class=\"line\">    webViewCore-&gt;layersDraw();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/WebViewCore.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::layersDraw() &#123;</div><div class=\"line\">  mEventHub-&gt;sendMessage(gaia::Message::obtain(<span class=\"literal\">NULL</span>, EventHub::WEBKIT_DRAW_LAYERS));</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/inner/EventHub.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> EventHub::EventHubHandler::handleMessage(<span class=\"keyword\">const</span> sp&lt;gaia::Message&gt;&amp; msg) &#123;</div><div class=\"line\">  <span class=\"keyword\">case</span> WEBKIT_DRAW:</div><div class=\"line\">    webViewCore-&gt;webkitDraw();</div><div class=\"line\">    <span class=\"keyword\">break</span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">case</span> WEBKIT_DRAW_LAYERS:</div><div class=\"line\">    webViewCore-&gt;webkitDrawLayers();</div><div class=\"line\">    <span class=\"keyword\">break</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/WebViewCore.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::webkitDrawLayers() &#123;</div><div class=\"line\">  mDrawLayersIsScheduled = <span class=\"literal\">false</span>;</div><div class=\"line\">  <span class=\"keyword\">if</span> (mDrawIsScheduled || mLastDrawData == <span class=\"literal\">NULL</span>) &#123;</div><div class=\"line\">    removeMessages(EventHub::WEBKIT_DRAW);</div><div class=\"line\">    webkitDraw();</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Directly update the layers we last passed to the UI side</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (nativeUpdateLayers(mProxy-&gt;mNativeClass, mLastDrawData-&gt;mBaseLayer)) &#123;</div><div class=\"line\">    <span class=\"comment\">// If anything more complex than position has been touched, let's do a full draw</span></div><div class=\"line\">    webkitDraw();</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::webkitDraw() &#123;</div><div class=\"line\">  mDrawIsScheduled = <span class=\"literal\">false</span>;</div><div class=\"line\">  sp&lt;DrawData&gt; draw = <span class=\"keyword\">new</span> DrawData();</div><div class=\"line\">  draw-&gt;mBaseLayer = nativeRecordContent(draw-&gt;mInvalRegion, draw-&gt;mContentSize);</div><div class=\"line\">  <span class=\"keyword\">if</span> (draw-&gt;mBaseLayer == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">    sp &lt;WebView&gt; spWebView = mWebView.promote();</div><div class=\"line\">    <span class=\"keyword\">if</span> (spWebView != <span class=\"literal\">NULL</span> &amp;&amp; !spWebView-&gt;isPaused()) &#123;</div><div class=\"line\">      LOGV(<span class=\"string\">\"webkitDraw abort, resending draw message\"</span>);</div><div class=\"line\">      mEventHub-&gt;sendMessage(gaia::Message::obtain(<span class=\"literal\">NULL</span>, EventHub::WEBKIT_DRAW));</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span></div><div class=\"line\">      LOGV(<span class=\"string\">\"webkitDraw abort, webview paused\"</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  mLastDrawData = draw;</div><div class=\"line\">  webkitDraw(draw);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/WebViewCore.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::webkitDraw(<span class=\"keyword\">const</span> sp&lt;DrawData&gt;&amp; draw) &#123;</div><div class=\"line\">  sp &lt;WebView&gt; spWebView = mWebView.promote();</div><div class=\"line\">  <span class=\"keyword\">if</span> (spWebView != <span class=\"literal\">NULL</span>) &#123;</div><div class=\"line\">    draw-&gt;mFocusSizeChanged = nativeFocusBoundsChanged();</div><div class=\"line\">    draw-&gt;mViewSize = <span class=\"keyword\">new</span> GPoint(mCurrentViewWidth, mCurrentViewHeight);</div><div class=\"line\">    <span class=\"keyword\">if</span> (mSettings-&gt;getUseWideViewPort()) &#123;</div><div class=\"line\">      draw-&gt;mMinPrefWidth = <span class=\"built_in\">std</span>::max(</div><div class=\"line\">          mViewportWidth == <span class=\"number\">-1</span> ? WebView::DEFAULT_VIEWPORT_WIDTH</div><div class=\"line\">                               : (mViewportWidth == <span class=\"number\">0</span> ? mCurrentViewWidth</div><div class=\"line\">                                                      : mViewportWidth),</div><div class=\"line\">          nativeGetContentMinPrefWidth());</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mInitialViewState != <span class=\"literal\">NULL</span>) &#123;</div><div class=\"line\">      draw-&gt;mViewState = mInitialViewState;</div><div class=\"line\">      mInitialViewState = <span class=\"literal\">NULL</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mFirstLayoutForNonStandardLoad) &#123;</div><div class=\"line\">      draw-&gt;mFirstLayoutForNonStandardLoad = <span class=\"literal\">true</span>;</div><div class=\"line\">      mFirstLayoutForNonStandardLoad = <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (DebugFlags::WEB_VIEW_CORE)</div><div class=\"line\">      LOGV(<span class=\"string\">\"webkitDraw NEW_PICTURE_MSG_ID\"</span>);</div><div class=\"line\"></div><div class=\"line\">    sp&lt;gaia::Message&gt; message = gaia::Message::obtain(spWebView-&gt;mPrivateHandler,</div><div class=\"line\">                                                                WebView::NEW_PICTURE_MSG_ID, draw);</div><div class=\"line\">    SAFETY_ON_NULL_RETURN(message);</div><div class=\"line\">    message-&gt;sendToTarget();</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> PrivateHandler::handleMessage(<span class=\"keyword\">const</span> sp&lt;gaia::Message&gt;&amp; msg) &#123;</div><div class=\"line\">  <span class=\"keyword\">case</span> WebView::NEW_PICTURE_MSG_ID: &#123;</div><div class=\"line\">    <span class=\"comment\">// called for new content</span></div><div class=\"line\">    sp&lt;DrawData&gt; draw = safe_cast&lt;DrawData*&gt;(msg-&gt;obj);</div><div class=\"line\">    webView-&gt;setNewPicture(draw, <span class=\"literal\">true</span>);</div><div class=\"line\">    <span class=\"keyword\">break</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">BaseLayerAndroid* WebViewCore::recordContent(SkRegion* region, SkIPoint* point) &#123;</div><div class=\"line\">  <span class=\"keyword\">float</span> progress = (<span class=\"keyword\">float</span>) m_mainFrame-&gt;page()-&gt;progress()-&gt;estimatedProgress();</div><div class=\"line\">  m_progressDone = progress &lt;= <span class=\"number\">0.0f</span> || progress &gt;= <span class=\"number\">1.0f</span>;</div><div class=\"line\">  recordPictureSet(&amp;m_content);</div><div class=\"line\">  <span class=\"keyword\">return</span> createBaseLayer(region);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::recordPictureSet(PictureSet* content) &#123;</div><div class=\"line\">  <span class=\"comment\">// Rebuild the pictureset (webkit repaint)</span></div><div class=\"line\">  rebuildPictureSet(content);</div><div class=\"line\"></div><div class=\"line\">  updateFrameCache();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::rebuildPictureSet(PictureSet* pictureSet) &#123;</div><div class=\"line\">  WebCore::FrameView* view = m_mainFrame-&gt;view();</div><div class=\"line\">  <span class=\"keyword\">size_t</span> size = pictureSet-&gt;size();</div><div class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">size_t</span> index = <span class=\"number\">0</span>; index &lt; size; index++) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (pictureSet-&gt;upToDate(index))</div><div class=\"line\">      <span class=\"keyword\">continue</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">const</span> SkIRect&amp; inval = pictureSet-&gt;bounds(index);</div><div class=\"line\">    pictureSet-&gt;setPicture(index, rebuildPicture(inval));</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  pictureSet-&gt;validate(__FUNCTION__);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">SkPicture* WebViewCore::rebuildPicture(<span class=\"keyword\">const</span> SkIRect&amp; inval) &#123;</div><div class=\"line\">  WebCore::FrameView* view = m_mainFrame-&gt;view();</div><div class=\"line\">  <span class=\"keyword\">int</span> width = view-&gt;contentsWidth();</div><div class=\"line\">  <span class=\"keyword\">int</span> height = view-&gt;contentsHeight();</div><div class=\"line\">  SkPicture* picture = <span class=\"keyword\">new</span> SkPicture();</div><div class=\"line\">  <span class=\"function\">SkAutoPictureRecord <span class=\"title\">arp</span><span class=\"params\">(picture, width, height, PICT_RECORD_FLAGS)</span></span>;</div><div class=\"line\">  <span class=\"function\">SkAutoMemoryUsageProbe <span class=\"title\">mup</span><span class=\"params\">(__FUNCTION__)</span></span>;</div><div class=\"line\">  SkCanvas* recordingCanvas = arp.getRecordingCanvas();</div><div class=\"line\"></div><div class=\"line\">  WebCore::<span class=\"function\">PlatformGraphicsContext <span class=\"title\">pgc</span><span class=\"params\">(recordingCanvas)</span></span>;</div><div class=\"line\">  WebCore::<span class=\"function\">GraphicsContext <span class=\"title\">gc</span><span class=\"params\">(&amp;pgc)</span></span>;</div><div class=\"line\">  IntPoint origin = view-&gt;minimumScrollPosition();</div><div class=\"line\">  <span class=\"comment\">// Line commented because of highlight problem</span></div><div class=\"line\">  <span class=\"comment\">// WebCore::IntRect drawArea(inval.fLeft + origin.x(), inval.fTop + origin.y(), inval.width(), inval.height());</span></div><div class=\"line\">  recordingCanvas-&gt;translate(-drawArea.x(), -drawArea.y());</div><div class=\"line\">  recordingCanvas-&gt;save();</div><div class=\"line\">  view-&gt;platformWidget()-&gt;draw(&amp;gc, drawArea);</div><div class=\"line\">  m_rebuildInval.op(inval, SkRegion::kUnion_Op);</div><div class=\"line\">  <span class=\"keyword\">return</span> picture;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">BaseLayerAndroid* WebViewCore::createBaseLayer(SkRegion* region) &#123;</div><div class=\"line\">  BaseLayerAndroid* base = <span class=\"keyword\">new</span> BaseLayerAndroid();</div><div class=\"line\">  base-&gt;setContent(m_content);</div><div class=\"line\"></div><div class=\"line\">  m_skipContentDraw = <span class=\"literal\">true</span>;</div><div class=\"line\">  <span class=\"keyword\">bool</span> layoutSucceeded = layoutIfNeededRecursive(m_mainFrame);</div><div class=\"line\">  m_skipContentDraw = <span class=\"literal\">false</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  <span class=\"comment\">// We set the background color</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (m_mainFrame &amp;&amp; m_mainFrame-&gt;document()</div><div class=\"line\">      &amp;&amp; m_mainFrame-&gt;document()-&gt;body()) &#123;</div><div class=\"line\">    Document* document = m_mainFrame-&gt;document();</div><div class=\"line\">    RefPtr&lt;RenderStyle&gt; style = document-&gt;styleForElementIgnoringPendingStylesheets(document-&gt;body());</div><div class=\"line\">    <span class=\"keyword\">if</span> (style-&gt;hasBackground()) &#123;</div><div class=\"line\">      Color color = style-&gt;visitedDependentColor(CSSPropertyBackgroundColor);</div><div class=\"line\">      <span class=\"keyword\">if</span> (color.isValid() &amp;&amp; color.alpha() &gt; <span class=\"number\">0</span>)</div><div class=\"line\">        base-&gt;setBackgroundColor(color);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// We update the layers</span></div><div class=\"line\">  ChromeClientAndroid* chromeC = <span class=\"keyword\">static_cast</span>&lt;ChromeClientAndroid*&gt;(m_mainFrame-&gt;page()-&gt;chrome()-&gt;client());</div><div class=\"line\">  GraphicsLayerAndroid* root = <span class=\"keyword\">static_cast</span>&lt;GraphicsLayerAndroid*&gt;(chromeC-&gt;layersSync());</div><div class=\"line\">  <span class=\"keyword\">if</span> (root) &#123;</div><div class=\"line\">    LayerAndroid* copyLayer = <span class=\"keyword\">new</span> LayerAndroid(*root-&gt;contentLayer());</div><div class=\"line\">    base-&gt;addChild(copyLayer);</div><div class=\"line\">    copyLayer-&gt;unref();</div><div class=\"line\">    root-&gt;contentLayer()-&gt;clearDirtyRegion();</div><div class=\"line\">  &#125;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">return</span> base;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>注意：代码并不完整，只是摘录。</p>\n<h2 id=\"UI-驱动\"><a href=\"#UI-驱动\" class=\"headerlink\" title=\"UI 驱动\"></a>UI 驱动</h2><p>直接绘制 content(PictureSet)。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/WebView.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebView::onDraw(<span class=\"keyword\">const</span> sp&lt;Canvas&gt;&amp; canvas) &#123;</div><div class=\"line\">  <span class=\"keyword\">int</span> saveCount = canvas-&gt;save();</div><div class=\"line\">  drawContent(canvas, drawNativeRings);</div><div class=\"line\">  canvas-&gt;restoreToCount(saveCount);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (AUTO_REDRAW_HACK &amp;&amp; mAutoRedraw)</div><div class=\"line\">    invalidate();</div><div class=\"line\"></div><div class=\"line\">  mWebViewCore-&gt;signalRepaintDone();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebView::drawContent(<span class=\"keyword\">const</span> sp&lt;Canvas&gt;&amp; canvas, <span class=\"keyword\">bool</span> drawRings) &#123;</div><div class=\"line\">  drawCoreAndCursorRing(canvas, mBackgroundColor, mDrawCursorRing &amp;&amp; drawRings);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebView::drawCoreAndCursorRing(<span class=\"keyword\">const</span> sp&lt;Canvas&gt;&amp; canvas, <span class=\"keyword\">int</span> color, <span class=\"keyword\">bool</span> drawCursorRing) &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (mDrawHistory) &#123;</div><div class=\"line\">    canvas-&gt;scale(mZoomManager-&gt;getScale(), mZoomManager-&gt;getScale());</div><div class=\"line\">    canvas-&gt;drawPicture(mHistoryPicture);</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">int</span> saveCount = canvas-&gt;save();</div><div class=\"line\">  <span class=\"keyword\">if</span> (animateZoom)</div><div class=\"line\">    mZoomManager-&gt;animateZoom(canvas);</div><div class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!canvas-&gt;isHardwareAccelerated())</div><div class=\"line\">    canvas-&gt;scale(mZoomManager-&gt;getScale(), mZoomManager-&gt;getScale());</div><div class=\"line\"></div><div class=\"line\">  calcOurContentVisibleRectF(mVisibleContentRect);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!canvas-&gt;isHardwareAccelerated()) &#123;</div><div class=\"line\">    sp&lt;DrawFilter&gt; df = <span class=\"literal\">NULL</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (mZoomManager-&gt;isZoomAnimating() || UIAnimationsRunning)</div><div class=\"line\">      df = mZoomFilter;</div><div class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (animateScroll)</div><div class=\"line\">      df = mScrollFilter;</div><div class=\"line\"></div><div class=\"line\">    canvas-&gt;setDrawFilter(df);</div><div class=\"line\">    <span class=\"comment\">// <span class=\"doctag\">XXX:</span> Revisit splitting content.  Right now it causes a</span></div><div class=\"line\">    <span class=\"comment\">// synchronization problem with layers.</span></div><div class=\"line\">    <span class=\"keyword\">int</span> content = nativeDraw(canvas, mVisibleContentRect, color, extras, <span class=\"literal\">false</span>);</div><div class=\"line\">    canvas-&gt;setDrawFilter(<span class=\"literal\">NULL</span>);</div><div class=\"line\">    <span class=\"keyword\">if</span> (!mBlockWebkitViewMessages &amp;&amp; content != <span class=\"number\">0</span>)</div><div class=\"line\">      mWebViewCore-&gt;sendMessage(EventHub::SPLIT_PICTURE_SET, content, <span class=\"number\">0</span>);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  canvas-&gt;restoreToCount(saveCount);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// gaia/nav/WebView.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">nativeDraw</span><span class=\"params\">(WebKit::WebViewProxy* proxy, SkCanvas* canvas,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">               SkRect visibleRect, <span class=\"keyword\">int</span> color,</span></span></div><div class=\"line\"><span class=\"function\"><span class=\"params\">               <span class=\"keyword\">int</span> extras, <span class=\"keyword\">bool</span> split)</span> </span>&#123;</div><div class=\"line\">  WebView* webView = <span class=\"keyword\">reinterpret_cast</span>&lt;WebView*&gt;(proxy-&gt;mNativeClass);</div><div class=\"line\">  webView-&gt;setVisibleRect(visibleRect);</div><div class=\"line\">  PictureSet* pictureSet = webView-&gt;draw(canvas, color, extras, split);</div><div class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"keyword\">int</span>&gt;(pictureSet);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\">PictureSet* <span class=\"title\">draw</span><span class=\"params\">(SkCanvas* canvas, SkColor bgColor, <span class=\"keyword\">int</span> extras, <span class=\"keyword\">bool</span> split)</span> </span>&#123;</div><div class=\"line\">  <span class=\"comment\">// draw the content of the base layer first</span></div><div class=\"line\">  PictureSet* content = m_baseLayer-&gt;content();</div><div class=\"line\">  <span class=\"keyword\">int</span> sc = canvas-&gt;save(SkCanvas::kClip_SaveFlag);</div><div class=\"line\">  canvas-&gt;clipRect(SkRect::MakeLTRB(<span class=\"number\">0</span>, <span class=\"number\">0</span>, content-&gt;width(),</div><div class=\"line\">                                    content-&gt;height()), SkRegion::kDifference_Op);</div><div class=\"line\">  canvas-&gt;drawColor(bgColor);</div><div class=\"line\">  canvas-&gt;restoreToCount(sc);</div><div class=\"line\">  <span class=\"keyword\">if</span> (content-&gt;draw(canvas))</div><div class=\"line\">    ret = split ? <span class=\"keyword\">new</span> PictureSet(*content) : <span class=\"number\">0</span>;</div><div class=\"line\">  <span class=\"keyword\">return</span> ret;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"WebCore-驱动\"><a href=\"#WebCore-驱动\" class=\"headerlink\" title=\"WebCore 驱动\"></a>WebCore 驱动</h2><p>使得 content(PictureSet) 被更新。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> FrameView::layout(<span class=\"keyword\">bool</span> allowSubtree) &#123;</div><div class=\"line\">  <span class=\"comment\">// Now update the positions of all layers.</span></div><div class=\"line\">  beginDeferredRepaints();</div><div class=\"line\">  IntPoint cachedOffset;</div><div class=\"line\">  <span class=\"keyword\">if</span> (m_doFullRepaint)</div><div class=\"line\">    root-&gt;view()-&gt;repaint(); <span class=\"comment\">// <span class=\"doctag\">FIXME:</span> This isn't really right, since the RenderView doesn't fully encompass the visibleContentRect(). It just happens</span></div><div class=\"line\">                             <span class=\"comment\">// to work out most of the time, since first layouts and printing don't have you scrolled anywhere.</span></div><div class=\"line\"></div><div class=\"line\">  layer-&gt;updateLayerPositions((m_doFullRepaint ? <span class=\"number\">0</span> : RenderLayer::CheckForRepaint)</div><div class=\"line\">                                  | RenderLayer::IsCompositingUpdateRoot</div><div class=\"line\">                                  | RenderLayer::UpdateCompositingLayers,</div><div class=\"line\">                              subtree ? <span class=\"number\">0</span> : &amp;cachedOffset);</div><div class=\"line\">  endDeferredRepaints();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  updateCompositingLayers();</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\"></div><div class=\"line\">  m_layoutCount++;</div><div class=\"line\">  ASSERT(!root-&gt;needsLayout());</div><div class=\"line\">  updateCanBlitOnScrollRecursively();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (document-&gt;hasListenerType(Document::OVERFLOWCHANGED_LISTENER))</div><div class=\"line\">    updateOverflowStatus(layoutWidth() &lt; contentsWidth(),</div><div class=\"line\">                         layoutHeight() &lt; contentsHeight());</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (!m_hasPendingPostLayoutTasks) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (!m_inSynchronousPostLayout &amp;&amp; !inSubframeLayoutWithFrameFlattening) &#123;</div><div class=\"line\">      m_inSynchronousPostLayout = <span class=\"literal\">true</span>;</div><div class=\"line\">      <span class=\"comment\">// Calls resumeScheduledEvents()</span></div><div class=\"line\">      performPostLayoutTasks();</div><div class=\"line\">      m_inSynchronousPostLayout = <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (!m_hasPendingPostLayoutTasks &amp;&amp;</div><div class=\"line\">        (needsLayout() || m_inSynchronousPostLayout || inSubframeLayoutWithFrameFlattening)) &#123;</div><div class=\"line\">      <span class=\"comment\">// If we need layout or are already in a synchronous call to postLayoutTasks(),</span></div><div class=\"line\">      <span class=\"comment\">// defer widget updates and event dispatch until after we return. postLayoutTasks()</span></div><div class=\"line\">      <span class=\"comment\">// can make us need to update again, and we can get stuck in a nasty cycle unless</span></div><div class=\"line\">      <span class=\"comment\">// we call it through the timer here.</span></div><div class=\"line\">      m_hasPendingPostLayoutTasks = <span class=\"literal\">true</span>;</div><div class=\"line\">      m_postLayoutTasksTimer.startOneShot(<span class=\"number\">0</span>);</div><div class=\"line\">      <span class=\"keyword\">if</span> (needsLayout()) &#123;</div><div class=\"line\">        m_actionScheduler-&gt;pause();</div><div class=\"line\">        layout();</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">    m_actionScheduler-&gt;resume();</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  InspectorInstrumentation::didLayout(cookie);</div><div class=\"line\"></div><div class=\"line\">  m_nestedLayoutCount--;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> ENABLE(ANDROID_OVERFLOW_SCROLL)</span></div><div class=\"line\">  <span class=\"comment\">// Reset to false each time we layout in case the overflow status changed.</span></div><div class=\"line\">  <span class=\"keyword\">bool</span> hasOverflowScroll = <span class=\"literal\">false</span>;</div><div class=\"line\">  RenderObject* ownerRenderer = m_frame-&gt;ownerRenderer();</div><div class=\"line\">  <span class=\"keyword\">if</span> (ownerRenderer &amp;&amp; ownerRenderer-&gt;isRenderIFrame()) &#123;</div><div class=\"line\">    RenderLayer* layer = ownerRenderer-&gt;enclosingLayer();</div><div class=\"line\">    <span class=\"keyword\">if</span> (layer) &#123;</div><div class=\"line\">      <span class=\"comment\">// Some sites use tiny iframes for loading so don't composite those.</span></div><div class=\"line\">      <span class=\"keyword\">if</span> (canHaveScrollbars() &amp;&amp; layoutWidth() &gt; <span class=\"number\">1</span> &amp;&amp; layoutHeight() &gt; <span class=\"number\">1</span>)</div><div class=\"line\">        hasOverflowScroll = layoutWidth() &lt; contentsWidth() || layoutHeight() &lt; contentsHeight();</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">if</span> (RenderView* view = m_frame-&gt;contentRenderer()) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (hasOverflowScroll != m_hasOverflowScroll) &#123;</div><div class=\"line\">      <span class=\"keyword\">if</span> (hasOverflowScroll)</div><div class=\"line\">        enterCompositingMode();</div><div class=\"line\">      <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        <span class=\"comment\">// We are leaving overflow mode so we need to update the layer</span></div><div class=\"line\">        <span class=\"comment\">// tree in case that is the reason we were composited.</span></div><div class=\"line\">        view-&gt;compositor()-&gt;scheduleCompositingLayerUpdate();</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  m_hasOverflowScroll = hasOverflowScroll;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Sometimes (for plug-ins) we need to eagerly go into compositing mode.</span></div><div class=\"line\"><span class=\"keyword\">void</span> FrameView::enterCompositingMode() &#123;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (RenderView* view = m_frame-&gt;contentRenderer()) &#123;</div><div class=\"line\">    view-&gt;compositor()-&gt;enableCompositingMode();</div><div class=\"line\">    <span class=\"keyword\">if</span> (!needsLayout())</div><div class=\"line\">      view-&gt;compositor()-&gt;scheduleCompositingLayerUpdate();</div><div class=\"line\">  &#125;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Note that this gets called at painting time.</span></div><div class=\"line\"><span class=\"keyword\">void</span> FrameView::setIsOverlapped(<span class=\"keyword\">bool</span> isOverlapped) &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (isOverlapped == m_isOverlapped)</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\"></div><div class=\"line\">  m_isOverlapped = isOverlapped;</div><div class=\"line\">  updateCanBlitOnScrollRecursively();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (hasCompositedContentIncludingDescendants()) &#123;</div><div class=\"line\">    <span class=\"comment\">// Overlap can affect compositing tests, so if it changes, we need to trigger</span></div><div class=\"line\">    <span class=\"comment\">// a layer update in the parent document.</span></div><div class=\"line\">    <span class=\"keyword\">if</span> (Frame* parentFrame = m_frame-&gt;tree()-&gt;parent()) &#123;</div><div class=\"line\">      <span class=\"keyword\">if</span> (RenderView* parentView = parentFrame-&gt;contentRenderer()) &#123;</div><div class=\"line\">        RenderLayerCompositor* compositor = parentView-&gt;compositor();</div><div class=\"line\">        compositor-&gt;setCompositingLayersNeedRebuild();</div><div class=\"line\">        compositor-&gt;scheduleCompositingLayerUpdate();</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (RenderLayerCompositor::allowsIndependentlyCompositedFrames(<span class=\"keyword\">this</span>)) &#123;</div><div class=\"line\">      <span class=\"comment\">// We also need to trigger reevaluation for this and all descendant frames,</span></div><div class=\"line\">      <span class=\"comment\">// since a frame uses compositing if any ancestor is compositing.</span></div><div class=\"line\">      <span class=\"keyword\">for</span> (Frame* frame = m_frame.get(); frame; frame = frame-&gt;tree()-&gt;traverseNext(m_frame.get())) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (RenderView* view = frame-&gt;contentRenderer()) &#123;</div><div class=\"line\">          RenderLayerCompositor* compositor = view-&gt;compositor();</div><div class=\"line\">          compositor-&gt;setCompositingLayersNeedRebuild();</div><div class=\"line\">          compositor-&gt;scheduleCompositingLayerUpdate();</div><div class=\"line\">        &#125;</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::scheduleCompositingLayerUpdate() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (!m_updateCompositingLayersTimer.isActive())</div><div class=\"line\">    m_updateCompositingLayersTimer.startOneShot(<span class=\"number\">0</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">bool</span> RenderLayerCompositor::compositingLayerUpdatePending() <span class=\"keyword\">const</span> &#123;</div><div class=\"line\">  <span class=\"keyword\">return</span> m_updateCompositingLayersTimer.isActive();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::updateCompositingLayersTimerFired(Timer&lt;RenderLayerCompositor&gt;*) &#123;</div><div class=\"line\">  updateCompositingLayers();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/platform/graphics/android/GraphicsLayerAndroid.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">bool</span> GraphicsLayerAndroid::setChildren(<span class=\"keyword\">const</span> WTF::Vector&lt;GraphicsLayer*&gt;&amp; children)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::addChild(GraphicsLayer* childLayer)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::addChildAtIndex(GraphicsLayer* childLayer, <span class=\"keyword\">int</span> index)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::addChildBelow(GraphicsLayer* childLayer, GraphicsLayer* sibling)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::addChildAbove(GraphicsLayer* childLayer, GraphicsLayer* sibling)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">bool</span> GraphicsLayerAndroid::replaceChild(GraphicsLayer* oldChild, GraphicsLayer* newChild)</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::removeFromParent()</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::setZPosition(<span class=\"keyword\">float</span> position)</div><div class=\"line\"></div><div class=\"line\">...</div><div class=\"line\"></div><div class=\"line\">&#123;</div><div class=\"line\">  askForSync();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> GraphicsLayerAndroid::askForSync() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (m_client)</div><div class=\"line\">    m_client-&gt;notifySyncRequired(<span class=\"keyword\">this</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/rendering/RenderLayerBacking.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerBacking::notifySyncRequired(<span class=\"keyword\">const</span> GraphicsLayer*) &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (!renderer()-&gt;documentBeingDestroyed())</div><div class=\"line\">    compositor()-&gt;scheduleLayerFlush();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/rendering/RenderLayerCompositor.h</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::notifySyncRequired(<span class=\"keyword\">const</span> GraphicsLayer*) &#123;</div><div class=\"line\">  scheduleLayerFlush();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/rendering/RenderLayerCompositor.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::scheduleLayerFlush() &#123;</div><div class=\"line\">  page-&gt;chrome()-&gt;client()-&gt;scheduleCompositingLayerSync();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"documentDidBecomeActive-驱动\"><a href=\"#documentDidBecomeActive-驱动\" class=\"headerlink\" title=\"documentDidBecomeActive 驱动\"></a>documentDidBecomeActive 驱动</h2><figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">void</span> Document::documentDidBecomeActive() &#123;</div><div class=\"line\">  HashSet&lt;Element*&gt;::iterator end = m_documentActivationCallbackElements.end();</div><div class=\"line\">  <span class=\"keyword\">for</span> (HashSet&lt;Element*&gt;::iterator i = m_documentActivationCallbackElements.begin(); i != end; ++i)</div><div class=\"line\">    (*i)-&gt;documentDidBecomeActive();</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (renderer())</div><div class=\"line\">    renderView()-&gt;didMoveOnscreen();</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\"></div><div class=\"line\">  ASSERT(m_frame);</div><div class=\"line\">  m_frame-&gt;loader()-&gt;client()-&gt;dispatchDidBecomeFrameset(isFrameSet());</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebCore/rendering/RenderLayerCompositor.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::didMoveOnscreen() &#123;</div><div class=\"line\">  RootLayerAttachment attachment = shouldPropagateCompositingToEnclosingFrame() ? RootLayerAttachedViaEnclosingFrame</div><div class=\"line\">                                                                                : RootLayerAttachedViaChromeClient;</div><div class=\"line\">  attachRootPlatformLayer(attachment);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> RenderLayerCompositor::attachRootPlatformLayer(RootLayerAttachment attachment) &#123;</div><div class=\"line\">  <span class=\"keyword\">switch</span> (attachment) &#123;</div><div class=\"line\">    <span class=\"keyword\">case</span> RootLayerAttachedViaChromeClient: &#123;</div><div class=\"line\">      page-&gt;chrome()-&gt;client()-&gt;attachRootGraphicsLayer(frame, rootPlatformLayer());</div><div class=\"line\">      <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">case</span> RootLayerAttachedViaEnclosingFrame: &#123;</div><div class=\"line\">      <span class=\"comment\">// The layer will get hooked up via RenderLayerBacking::updateGraphicsLayerConfiguration()</span></div><div class=\"line\">      <span class=\"comment\">// for the frame's renderer in the parent document.</span></div><div class=\"line\">      scheduleNeedsStyleRecalc(m_renderView-&gt;document()-&gt;ownerElement());</div><div class=\"line\">      <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> ChromeClientAndroid::attachRootGraphicsLayer(WebCore::Frame*, WebCore::GraphicsLayer* layer) &#123;</div><div class=\"line\">  scheduleCompositingLayerSync();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp</span></div><div class=\"line\"><span class=\"keyword\">void</span> ChromeClientAndroid::scheduleCompositingLayerSync() &#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (m_needsLayerSync)</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\"></div><div class=\"line\">  m_needsLayerSync = <span class=\"literal\">true</span>;</div><div class=\"line\">  WebViewCore* webViewCore = WebViewCore::getWebViewCore(m_webFrame-&gt;page()-&gt;mainFrame()-&gt;view());</div><div class=\"line\">  <span class=\"keyword\">if</span> (webViewCore)</div><div class=\"line\">    webViewCore-&gt;layersDraw();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/WebViewCore.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::layersDraw() &#123;</div><div class=\"line\">  mEventHub-&gt;sendMessage(gaia::Message::obtain(<span class=\"literal\">NULL</span>, EventHub::WEBKIT_DRAW_LAYERS));</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/inner/EventHub.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> EventHub::EventHubHandler::handleMessage(<span class=\"keyword\">const</span> sp&lt;gaia::Message&gt;&amp; msg) &#123;</div><div class=\"line\">  <span class=\"keyword\">case</span> WEBKIT_DRAW:</div><div class=\"line\">    webViewCore-&gt;webkitDraw();</div><div class=\"line\">    <span class=\"keyword\">break</span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">case</span> WEBKIT_DRAW_LAYERS:</div><div class=\"line\">    webViewCore-&gt;webkitDrawLayers();</div><div class=\"line\">    <span class=\"keyword\">break</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/WebViewCore.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::webkitDrawLayers() &#123;</div><div class=\"line\">  mDrawLayersIsScheduled = <span class=\"literal\">false</span>;</div><div class=\"line\">  <span class=\"keyword\">if</span> (mDrawIsScheduled || mLastDrawData == <span class=\"literal\">NULL</span>) &#123;</div><div class=\"line\">    removeMessages(EventHub::WEBKIT_DRAW);</div><div class=\"line\">    webkitDraw();</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// Directly update the layers we last passed to the UI side</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (nativeUpdateLayers(mProxy-&gt;mNativeClass, mLastDrawData-&gt;mBaseLayer)) &#123;</div><div class=\"line\">    <span class=\"comment\">// If anything more complex than position has been touched, let's do a full draw</span></div><div class=\"line\">    webkitDraw();</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::webkitDraw() &#123;</div><div class=\"line\">  mDrawIsScheduled = <span class=\"literal\">false</span>;</div><div class=\"line\">  sp&lt;DrawData&gt; draw = <span class=\"keyword\">new</span> DrawData();</div><div class=\"line\">  draw-&gt;mBaseLayer = nativeRecordContent(draw-&gt;mInvalRegion, draw-&gt;mContentSize);</div><div class=\"line\">  <span class=\"keyword\">if</span> (draw-&gt;mBaseLayer == <span class=\"number\">0</span>) &#123;</div><div class=\"line\">    sp &lt;WebView&gt; spWebView = mWebView.promote();</div><div class=\"line\">    <span class=\"keyword\">if</span> (spWebView != <span class=\"literal\">NULL</span> &amp;&amp; !spWebView-&gt;isPaused()) &#123;</div><div class=\"line\">      LOGV(<span class=\"string\">\"webkitDraw abort, resending draw message\"</span>);</div><div class=\"line\">      mEventHub-&gt;sendMessage(gaia::Message::obtain(<span class=\"literal\">NULL</span>, EventHub::WEBKIT_DRAW));</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span></div><div class=\"line\">      LOGV(<span class=\"string\">\"webkitDraw abort, webview paused\"</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  mLastDrawData = draw;</div><div class=\"line\">  webkitDraw(draw);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// WebKit/gaia/frameworks/webkit/WebViewCore.cpp</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::webkitDraw(<span class=\"keyword\">const</span> sp&lt;DrawData&gt;&amp; draw) &#123;</div><div class=\"line\">  sp &lt;WebView&gt; spWebView = mWebView.promote();</div><div class=\"line\">  <span class=\"keyword\">if</span> (spWebView != <span class=\"literal\">NULL</span>) &#123;</div><div class=\"line\">    draw-&gt;mFocusSizeChanged = nativeFocusBoundsChanged();</div><div class=\"line\">    draw-&gt;mViewSize = <span class=\"keyword\">new</span> GPoint(mCurrentViewWidth, mCurrentViewHeight);</div><div class=\"line\">    <span class=\"keyword\">if</span> (mSettings-&gt;getUseWideViewPort()) &#123;</div><div class=\"line\">      draw-&gt;mMinPrefWidth = <span class=\"built_in\">std</span>::max(</div><div class=\"line\">          mViewportWidth == <span class=\"number\">-1</span> ? WebView::DEFAULT_VIEWPORT_WIDTH</div><div class=\"line\">                               : (mViewportWidth == <span class=\"number\">0</span> ? mCurrentViewWidth</div><div class=\"line\">                                                      : mViewportWidth),</div><div class=\"line\">          nativeGetContentMinPrefWidth());</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mInitialViewState != <span class=\"literal\">NULL</span>) &#123;</div><div class=\"line\">      draw-&gt;mViewState = mInitialViewState;</div><div class=\"line\">      mInitialViewState = <span class=\"literal\">NULL</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (mFirstLayoutForNonStandardLoad) &#123;</div><div class=\"line\">      draw-&gt;mFirstLayoutForNonStandardLoad = <span class=\"literal\">true</span>;</div><div class=\"line\">      mFirstLayoutForNonStandardLoad = <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">if</span> (DebugFlags::WEB_VIEW_CORE)</div><div class=\"line\">      LOGV(<span class=\"string\">\"webkitDraw NEW_PICTURE_MSG_ID\"</span>);</div><div class=\"line\"></div><div class=\"line\">    sp&lt;gaia::Message&gt; message = gaia::Message::obtain(spWebView-&gt;mPrivateHandler,</div><div class=\"line\">                                                                WebView::NEW_PICTURE_MSG_ID, draw);</div><div class=\"line\">    SAFETY_ON_NULL_RETURN(message);</div><div class=\"line\">    message-&gt;sendToTarget();</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> PrivateHandler::handleMessage(<span class=\"keyword\">const</span> sp&lt;gaia::Message&gt;&amp; msg) &#123;</div><div class=\"line\">  <span class=\"keyword\">case</span> WebView::NEW_PICTURE_MSG_ID: &#123;</div><div class=\"line\">    <span class=\"comment\">// called for new content</span></div><div class=\"line\">    sp&lt;DrawData&gt; draw = safe_cast&lt;DrawData*&gt;(msg-&gt;obj);</div><div class=\"line\">    webView-&gt;setNewPicture(draw, <span class=\"literal\">true</span>);</div><div class=\"line\">    <span class=\"keyword\">break</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">BaseLayerAndroid* WebViewCore::recordContent(SkRegion* region, SkIPoint* point) &#123;</div><div class=\"line\">  <span class=\"keyword\">float</span> progress = (<span class=\"keyword\">float</span>) m_mainFrame-&gt;page()-&gt;progress()-&gt;estimatedProgress();</div><div class=\"line\">  m_progressDone = progress &lt;= <span class=\"number\">0.0f</span> || progress &gt;= <span class=\"number\">1.0f</span>;</div><div class=\"line\">  recordPictureSet(&amp;m_content);</div><div class=\"line\">  <span class=\"keyword\">return</span> createBaseLayer(region);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::recordPictureSet(PictureSet* content) &#123;</div><div class=\"line\">  <span class=\"comment\">// Rebuild the pictureset (webkit repaint)</span></div><div class=\"line\">  rebuildPictureSet(content);</div><div class=\"line\"></div><div class=\"line\">  updateFrameCache();</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> WebViewCore::rebuildPictureSet(PictureSet* pictureSet) &#123;</div><div class=\"line\">  WebCore::FrameView* view = m_mainFrame-&gt;view();</div><div class=\"line\">  <span class=\"keyword\">size_t</span> size = pictureSet-&gt;size();</div><div class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">size_t</span> index = <span class=\"number\">0</span>; index &lt; size; index++) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (pictureSet-&gt;upToDate(index))</div><div class=\"line\">      <span class=\"keyword\">continue</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">const</span> SkIRect&amp; inval = pictureSet-&gt;bounds(index);</div><div class=\"line\">    pictureSet-&gt;setPicture(index, rebuildPicture(inval));</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  pictureSet-&gt;validate(__FUNCTION__);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">SkPicture* WebViewCore::rebuildPicture(<span class=\"keyword\">const</span> SkIRect&amp; inval) &#123;</div><div class=\"line\">  WebCore::FrameView* view = m_mainFrame-&gt;view();</div><div class=\"line\">  <span class=\"keyword\">int</span> width = view-&gt;contentsWidth();</div><div class=\"line\">  <span class=\"keyword\">int</span> height = view-&gt;contentsHeight();</div><div class=\"line\">  SkPicture* picture = <span class=\"keyword\">new</span> SkPicture();</div><div class=\"line\">  <span class=\"function\">SkAutoPictureRecord <span class=\"title\">arp</span><span class=\"params\">(picture, width, height, PICT_RECORD_FLAGS)</span></span>;</div><div class=\"line\">  <span class=\"function\">SkAutoMemoryUsageProbe <span class=\"title\">mup</span><span class=\"params\">(__FUNCTION__)</span></span>;</div><div class=\"line\">  SkCanvas* recordingCanvas = arp.getRecordingCanvas();</div><div class=\"line\"></div><div class=\"line\">  WebCore::<span class=\"function\">PlatformGraphicsContext <span class=\"title\">pgc</span><span class=\"params\">(recordingCanvas)</span></span>;</div><div class=\"line\">  WebCore::<span class=\"function\">GraphicsContext <span class=\"title\">gc</span><span class=\"params\">(&amp;pgc)</span></span>;</div><div class=\"line\">  IntPoint origin = view-&gt;minimumScrollPosition();</div><div class=\"line\">  <span class=\"comment\">// Line commented because of highlight problem</span></div><div class=\"line\">  <span class=\"comment\">// WebCore::IntRect drawArea(inval.fLeft + origin.x(), inval.fTop + origin.y(), inval.width(), inval.height());</span></div><div class=\"line\">  recordingCanvas-&gt;translate(-drawArea.x(), -drawArea.y());</div><div class=\"line\">  recordingCanvas-&gt;save();</div><div class=\"line\">  view-&gt;platformWidget()-&gt;draw(&amp;gc, drawArea);</div><div class=\"line\">  m_rebuildInval.op(inval, SkRegion::kUnion_Op);</div><div class=\"line\">  <span class=\"keyword\">return</span> picture;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">BaseLayerAndroid* WebViewCore::createBaseLayer(SkRegion* region) &#123;</div><div class=\"line\">  BaseLayerAndroid* base = <span class=\"keyword\">new</span> BaseLayerAndroid();</div><div class=\"line\">  base-&gt;setContent(m_content);</div><div class=\"line\"></div><div class=\"line\">  m_skipContentDraw = <span class=\"literal\">true</span>;</div><div class=\"line\">  <span class=\"keyword\">bool</span> layoutSucceeded = layoutIfNeededRecursive(m_mainFrame);</div><div class=\"line\">  m_skipContentDraw = <span class=\"literal\">false</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class=\"line\">  <span class=\"comment\">// We set the background color</span></div><div class=\"line\">  <span class=\"keyword\">if</span> (m_mainFrame &amp;&amp; m_mainFrame-&gt;document()</div><div class=\"line\">      &amp;&amp; m_mainFrame-&gt;document()-&gt;body()) &#123;</div><div class=\"line\">    Document* document = m_mainFrame-&gt;document();</div><div class=\"line\">    RefPtr&lt;RenderStyle&gt; style = document-&gt;styleForElementIgnoringPendingStylesheets(document-&gt;body());</div><div class=\"line\">    <span class=\"keyword\">if</span> (style-&gt;hasBackground()) &#123;</div><div class=\"line\">      Color color = style-&gt;visitedDependentColor(CSSPropertyBackgroundColor);</div><div class=\"line\">      <span class=\"keyword\">if</span> (color.isValid() &amp;&amp; color.alpha() &gt; <span class=\"number\">0</span>)</div><div class=\"line\">        base-&gt;setBackgroundColor(color);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// We update the layers</span></div><div class=\"line\">  ChromeClientAndroid* chromeC = <span class=\"keyword\">static_cast</span>&lt;ChromeClientAndroid*&gt;(m_mainFrame-&gt;page()-&gt;chrome()-&gt;client());</div><div class=\"line\">  GraphicsLayerAndroid* root = <span class=\"keyword\">static_cast</span>&lt;GraphicsLayerAndroid*&gt;(chromeC-&gt;layersSync());</div><div class=\"line\">  <span class=\"keyword\">if</span> (root) &#123;</div><div class=\"line\">    LayerAndroid* copyLayer = <span class=\"keyword\">new</span> LayerAndroid(*root-&gt;contentLayer());</div><div class=\"line\">    base-&gt;addChild(copyLayer);</div><div class=\"line\">    copyLayer-&gt;unref();</div><div class=\"line\">    root-&gt;contentLayer()-&gt;clearDirtyRegion();</div><div class=\"line\">  &#125;</div><div class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">return</span> base;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>"},{"title":"Hello Hexo","date":"2015-03-09T07:54:58.000Z","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Install node.js and npm\n\n``` bash\n$ cd ~/tools\n$ wget https://nodejs.org/dist/v6.11.1/node-v6.11.1-linux-x64.tar.xz\n$ tar xzvf node-v6.11.1-linux-x64.tar.xz\n$ echo \"export PATH=$HOME/tools/node-v6.11.1-linux-x64/bin:$PATH\" >> ~/.bashrc\n$ source ~/.bashrc\n```\n\n### Initialize web site\n\n``` bash\n$ git clone https://github.com/antkit/antkit.github.io.git\n$ git checkout -b develop origin/develop\n$ cd antkit.github.io.git\n$ npm install --registry=https://registry.npm.taobao.org\n```\n\nNow hexo is under directory ./node_modules/hexo/bin. You can run server:\n\n``` bash\n./node_modules/hexo/bin/hexo server\n```\n\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/deployment.html)\n","source":"_posts/hello-world.md","raw":"---\ntitle: Hello Hexo\ndate: 2015-03-09 15:54:58\ncategories: Hexo\ntags: [Hexo]\n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Install node.js and npm\n\n``` bash\n$ cd ~/tools\n$ wget https://nodejs.org/dist/v6.11.1/node-v6.11.1-linux-x64.tar.xz\n$ tar xzvf node-v6.11.1-linux-x64.tar.xz\n$ echo \"export PATH=$HOME/tools/node-v6.11.1-linux-x64/bin:$PATH\" >> ~/.bashrc\n$ source ~/.bashrc\n```\n\n### Initialize web site\n\n``` bash\n$ git clone https://github.com/antkit/antkit.github.io.git\n$ git checkout -b develop origin/develop\n$ cd antkit.github.io.git\n$ npm install --registry=https://registry.npm.taobao.org\n```\n\nNow hexo is under directory ./node_modules/hexo/bin. You can run server:\n\n``` bash\n./node_modules/hexo/bin/hexo server\n```\n\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/deployment.html)\n","slug":"hello-world","published":1,"updated":"2017-08-12T00:53:36.942Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj68r48es0011nki3v9l5kvjg","content":"<p>Welcome to <a href=\"https://hexo.io/\" target=\"_blank\" rel=\"external\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\" target=\"_blank\" rel=\"external\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\" target=\"_blank\" rel=\"external\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\" target=\"_blank\" rel=\"external\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Install-node-js-and-npm\"><a href=\"#Install-node-js-and-npm\" class=\"headerlink\" title=\"Install node.js and npm\"></a>Install node.js and npm</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ <span class=\"built_in\">cd</span> ~/tools</div><div class=\"line\">$ wget https://nodejs.org/dist/v6.11.1/node-v6.11.1-linux-x64.tar.xz</div><div class=\"line\">$ tar xzvf node-v6.11.1-linux-x64.tar.xz</div><div class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"export PATH=<span class=\"variable\">$HOME</span>/tools/node-v6.11.1-linux-x64/bin:<span class=\"variable\">$PATH</span>\"</span> &gt;&gt; ~/.bashrc</div><div class=\"line\">$ <span class=\"built_in\">source</span> ~/.bashrc</div></pre></td></tr></table></figure>\n<h3 id=\"Initialize-web-site\"><a href=\"#Initialize-web-site\" class=\"headerlink\" title=\"Initialize web site\"></a>Initialize web site</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git <span class=\"built_in\">clone</span> https://github.com/antkit/antkit.github.io.git</div><div class=\"line\">$ git checkout -b develop origin/develop</div><div class=\"line\">$ <span class=\"built_in\">cd</span> antkit.github.io.git</div><div class=\"line\">$ npm install --registry=https://registry.npm.taobao.org</div></pre></td></tr></table></figure>\n<p>Now hexo is under directory ./node_modules/hexo/bin. You can run server:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./node_modules/hexo/bin/hexo server</div></pre></td></tr></table></figure>\n<h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo new <span class=\"string\">\"My New Post\"</span></div></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\" target=\"_blank\" rel=\"external\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\" target=\"_blank\" rel=\"external\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo generate</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\" target=\"_blank\" rel=\"external\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/deployment.html\" target=\"_blank\" rel=\"external\">Deployment</a></p>\n","site":{"data":{}},"excerpt":"","more":"<p>Welcome to <a href=\"https://hexo.io/\" target=\"_blank\" rel=\"external\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\" target=\"_blank\" rel=\"external\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\" target=\"_blank\" rel=\"external\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\" target=\"_blank\" rel=\"external\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Install-node-js-and-npm\"><a href=\"#Install-node-js-and-npm\" class=\"headerlink\" title=\"Install node.js and npm\"></a>Install node.js and npm</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ <span class=\"built_in\">cd</span> ~/tools</div><div class=\"line\">$ wget https://nodejs.org/dist/v6.11.1/node-v6.11.1-linux-x64.tar.xz</div><div class=\"line\">$ tar xzvf node-v6.11.1-linux-x64.tar.xz</div><div class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"export PATH=<span class=\"variable\">$HOME</span>/tools/node-v6.11.1-linux-x64/bin:<span class=\"variable\">$PATH</span>\"</span> &gt;&gt; ~/.bashrc</div><div class=\"line\">$ <span class=\"built_in\">source</span> ~/.bashrc</div></pre></td></tr></table></figure>\n<h3 id=\"Initialize-web-site\"><a href=\"#Initialize-web-site\" class=\"headerlink\" title=\"Initialize web site\"></a>Initialize web site</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git <span class=\"built_in\">clone</span> https://github.com/antkit/antkit.github.io.git</div><div class=\"line\">$ git checkout -b develop origin/develop</div><div class=\"line\">$ <span class=\"built_in\">cd</span> antkit.github.io.git</div><div class=\"line\">$ npm install --registry=https://registry.npm.taobao.org</div></pre></td></tr></table></figure>\n<p>Now hexo is under directory ./node_modules/hexo/bin. You can run server:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./node_modules/hexo/bin/hexo server</div></pre></td></tr></table></figure>\n<h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo new <span class=\"string\">\"My New Post\"</span></div></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\" target=\"_blank\" rel=\"external\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\" target=\"_blank\" rel=\"external\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo generate</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\" target=\"_blank\" rel=\"external\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>More info: <a href=\"https://hexo.io/docs/deployment.html\" target=\"_blank\" rel=\"external\">Deployment</a></p>\n"},{"title":"HTTP Status Codes","date":"2017-09-13T02:33:49.000Z","_content":"\n# HTTP Status Codes\n\n这篇文章图文并茂地讲解了该如何 [Choosing an HTTP Status Code](http://racksburg.com/choosing-an-http-status-code) 。\n","source":"_posts/HTTP-Status-Codes.md","raw":"---\ntitle: HTTP Status Codes\ndate: 2017-09-13 10:33:49\ncategories: HTTP\ntags: [HTTP]\n---\n\n# HTTP Status Codes\n\n这篇文章图文并茂地讲解了该如何 [Choosing an HTTP Status Code](http://racksburg.com/choosing-an-http-status-code) 。\n","slug":"HTTP-Status-Codes","published":1,"updated":"2017-09-19T11:40:07.601Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj7rj4rp80000pri34h54bx13","content":"<h1 id=\"HTTP-Status-Codes\"><a href=\"#HTTP-Status-Codes\" class=\"headerlink\" title=\"HTTP Status Codes\"></a>HTTP Status Codes</h1><p>这篇文章图文并茂地讲解了该如何 <a href=\"http://racksburg.com/choosing-an-http-status-code\" target=\"_blank\" rel=\"external\">Choosing an HTTP Status Code</a> 。</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"HTTP-Status-Codes\"><a href=\"#HTTP-Status-Codes\" class=\"headerlink\" title=\"HTTP Status Codes\"></a>HTTP Status Codes</h1><p>这篇文章图文并茂地讲解了该如何 <a href=\"http://racksburg.com/choosing-an-http-status-code\" target=\"_blank\" rel=\"external\">Choosing an HTTP Status Code</a> 。</p>\n"},{"title":"硬件加速","date":"2017-09-10T14:09:39.000Z","_content":"\n# 硬件加速\n\n维基百科对于硬件加速的解释如下（对于这个词条，推荐看英文）：\n\nIn computing, hardware acceleration is the use of computer hardware to perform some functions more efficiently than is possible in software running on a more general-purpose CPU. Examples of hardware acceleration include blitting acceleration functionality in graphics processing units (GPUs) and regular expression hardware acceleration for spam control in the server industry.[1] The hardware that performs the acceleration, when in a separate unit from the CPU, is referred to as a hardware accelerator, or often more specifically as a 3D accelerator, cryptographic accelerator, etc.\n\nTraditionally, processors were sequential (instructions are executed one by one), and are designed to run general purpose algorithms controlled by instruction fetch (for example moving temporary results to and from a register file). Hardware accelerators improve the execution of a specific algorithm by allowing greater concurrency, having specific data-paths for its temporaries, and possibly reducing the overhead of instruction control. Modern processors are multi-core and often feature parallel SIMD units; however hardware acceleration still yields benefits. Hardware acceleration is suitable for any repetitive, intensive key algorithm. Depending upon granularity, hardware acceleration can vary from a small functional unit, to a large functional block (like motion estimation in MPEG-2).\n\nIn the hierarchy of general-purpose processors such as CPUs, more specialized processors such as GPUs, fixed-function implemented on FPGAs, and fixed-function implemented on ASICs; there is a tradeoff between flexibility and efficiency, with efficiency increasing by orders of magnitude when any given application is implemented higher up that hierarchy.[2][3]\n\n\n\n在计算中，硬件加速是使用计算机硬件在比较通用的CPU上运行的软件中更有效地执行某些功能。硬件加速示例包括图形处理单元（GPU）中的blitting加速功能和服务器行业垃圾邮件控制的正则表达式硬件加速。[1]当与CPU分离的单元中执行加速的硬件被称为硬件加速器，或者更具体地称为3D加速器，加密加速器等。\n\n传统上，处理器是顺序的（指令被逐个执行），并且被设计成运行通过指令提取控制的通用算法（例如，将临时结果移到和从寄存器文件移动）。硬件加速器通过允许更大的并发性，具有其临时性的特定数据路径，并且可能减少指令控制的开销来改进特定算法的执行。现代处理器是多核的，通常具有并行SIMD单元;然而硬件加速仍然产生好处。硬件加速适用于任何重复密集的密钥算法。根据粒度，硬件加速度可以从小功能单元变化到大功能块（如MPEG-2中的运动估计）。\n\n在诸如CPU的通用处理器的层次结构中，诸如GPU的更专业的处理器，在FPGA上实现的固定功能和在ASIC上实现的固定功能;在灵活性和效率之间存在折衷，当任何给定的应用程序在这种层次结构上执行时，效率提高了数量级。[2] [3]","source":"_posts/硬件加速.md","raw":"---\ntitle: 硬件加速\ndate: 2017-09-10 22:09:39\ncategories: 高性能计算\ntags: [高性能计算, 硬件加速, GPU]\n---\n\n# 硬件加速\n\n维基百科对于硬件加速的解释如下（对于这个词条，推荐看英文）：\n\nIn computing, hardware acceleration is the use of computer hardware to perform some functions more efficiently than is possible in software running on a more general-purpose CPU. Examples of hardware acceleration include blitting acceleration functionality in graphics processing units (GPUs) and regular expression hardware acceleration for spam control in the server industry.[1] The hardware that performs the acceleration, when in a separate unit from the CPU, is referred to as a hardware accelerator, or often more specifically as a 3D accelerator, cryptographic accelerator, etc.\n\nTraditionally, processors were sequential (instructions are executed one by one), and are designed to run general purpose algorithms controlled by instruction fetch (for example moving temporary results to and from a register file). Hardware accelerators improve the execution of a specific algorithm by allowing greater concurrency, having specific data-paths for its temporaries, and possibly reducing the overhead of instruction control. Modern processors are multi-core and often feature parallel SIMD units; however hardware acceleration still yields benefits. Hardware acceleration is suitable for any repetitive, intensive key algorithm. Depending upon granularity, hardware acceleration can vary from a small functional unit, to a large functional block (like motion estimation in MPEG-2).\n\nIn the hierarchy of general-purpose processors such as CPUs, more specialized processors such as GPUs, fixed-function implemented on FPGAs, and fixed-function implemented on ASICs; there is a tradeoff between flexibility and efficiency, with efficiency increasing by orders of magnitude when any given application is implemented higher up that hierarchy.[2][3]\n\n\n\n在计算中，硬件加速是使用计算机硬件在比较通用的CPU上运行的软件中更有效地执行某些功能。硬件加速示例包括图形处理单元（GPU）中的blitting加速功能和服务器行业垃圾邮件控制的正则表达式硬件加速。[1]当与CPU分离的单元中执行加速的硬件被称为硬件加速器，或者更具体地称为3D加速器，加密加速器等。\n\n传统上，处理器是顺序的（指令被逐个执行），并且被设计成运行通过指令提取控制的通用算法（例如，将临时结果移到和从寄存器文件移动）。硬件加速器通过允许更大的并发性，具有其临时性的特定数据路径，并且可能减少指令控制的开销来改进特定算法的执行。现代处理器是多核的，通常具有并行SIMD单元;然而硬件加速仍然产生好处。硬件加速适用于任何重复密集的密钥算法。根据粒度，硬件加速度可以从小功能单元变化到大功能块（如MPEG-2中的运动估计）。\n\n在诸如CPU的通用处理器的层次结构中，诸如GPU的更专业的处理器，在FPGA上实现的固定功能和在ASIC上实现的固定功能;在灵活性和效率之间存在折衷，当任何给定的应用程序在这种层次结构上执行时，效率提高了数量级。[2] [3]","slug":"硬件加速","published":1,"updated":"2017-09-10T14:36:15.902Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cj7rj4rrk0005pri39d6jwive","content":"<h1 id=\"硬件加速\"><a href=\"#硬件加速\" class=\"headerlink\" title=\"硬件加速\"></a>硬件加速</h1><p>维基百科对于硬件加速的解释如下（对于这个词条，推荐看英文）：</p>\n<p>In computing, hardware acceleration is the use of computer hardware to perform some functions more efficiently than is possible in software running on a more general-purpose CPU. Examples of hardware acceleration include blitting acceleration functionality in graphics processing units (GPUs) and regular expression hardware acceleration for spam control in the server industry.[1] The hardware that performs the acceleration, when in a separate unit from the CPU, is referred to as a hardware accelerator, or often more specifically as a 3D accelerator, cryptographic accelerator, etc.</p>\n<p>Traditionally, processors were sequential (instructions are executed one by one), and are designed to run general purpose algorithms controlled by instruction fetch (for example moving temporary results to and from a register file). Hardware accelerators improve the execution of a specific algorithm by allowing greater concurrency, having specific data-paths for its temporaries, and possibly reducing the overhead of instruction control. Modern processors are multi-core and often feature parallel SIMD units; however hardware acceleration still yields benefits. Hardware acceleration is suitable for any repetitive, intensive key algorithm. Depending upon granularity, hardware acceleration can vary from a small functional unit, to a large functional block (like motion estimation in MPEG-2).</p>\n<p>In the hierarchy of general-purpose processors such as CPUs, more specialized processors such as GPUs, fixed-function implemented on FPGAs, and fixed-function implemented on ASICs; there is a tradeoff between flexibility and efficiency, with efficiency increasing by orders of magnitude when any given application is implemented higher up that hierarchy.[2][3]</p>\n<p>在计算中，硬件加速是使用计算机硬件在比较通用的CPU上运行的软件中更有效地执行某些功能。硬件加速示例包括图形处理单元（GPU）中的blitting加速功能和服务器行业垃圾邮件控制的正则表达式硬件加速。[1]当与CPU分离的单元中执行加速的硬件被称为硬件加速器，或者更具体地称为3D加速器，加密加速器等。</p>\n<p>传统上，处理器是顺序的（指令被逐个执行），并且被设计成运行通过指令提取控制的通用算法（例如，将临时结果移到和从寄存器文件移动）。硬件加速器通过允许更大的并发性，具有其临时性的特定数据路径，并且可能减少指令控制的开销来改进特定算法的执行。现代处理器是多核的，通常具有并行SIMD单元;然而硬件加速仍然产生好处。硬件加速适用于任何重复密集的密钥算法。根据粒度，硬件加速度可以从小功能单元变化到大功能块（如MPEG-2中的运动估计）。</p>\n<p>在诸如CPU的通用处理器的层次结构中，诸如GPU的更专业的处理器，在FPGA上实现的固定功能和在ASIC上实现的固定功能;在灵活性和效率之间存在折衷，当任何给定的应用程序在这种层次结构上执行时，效率提高了数量级。[2] [3]</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"硬件加速\"><a href=\"#硬件加速\" class=\"headerlink\" title=\"硬件加速\"></a>硬件加速</h1><p>维基百科对于硬件加速的解释如下（对于这个词条，推荐看英文）：</p>\n<p>In computing, hardware acceleration is the use of computer hardware to perform some functions more efficiently than is possible in software running on a more general-purpose CPU. Examples of hardware acceleration include blitting acceleration functionality in graphics processing units (GPUs) and regular expression hardware acceleration for spam control in the server industry.[1] The hardware that performs the acceleration, when in a separate unit from the CPU, is referred to as a hardware accelerator, or often more specifically as a 3D accelerator, cryptographic accelerator, etc.</p>\n<p>Traditionally, processors were sequential (instructions are executed one by one), and are designed to run general purpose algorithms controlled by instruction fetch (for example moving temporary results to and from a register file). Hardware accelerators improve the execution of a specific algorithm by allowing greater concurrency, having specific data-paths for its temporaries, and possibly reducing the overhead of instruction control. Modern processors are multi-core and often feature parallel SIMD units; however hardware acceleration still yields benefits. Hardware acceleration is suitable for any repetitive, intensive key algorithm. Depending upon granularity, hardware acceleration can vary from a small functional unit, to a large functional block (like motion estimation in MPEG-2).</p>\n<p>In the hierarchy of general-purpose processors such as CPUs, more specialized processors such as GPUs, fixed-function implemented on FPGAs, and fixed-function implemented on ASICs; there is a tradeoff between flexibility and efficiency, with efficiency increasing by orders of magnitude when any given application is implemented higher up that hierarchy.[2][3]</p>\n<p>在计算中，硬件加速是使用计算机硬件在比较通用的CPU上运行的软件中更有效地执行某些功能。硬件加速示例包括图形处理单元（GPU）中的blitting加速功能和服务器行业垃圾邮件控制的正则表达式硬件加速。[1]当与CPU分离的单元中执行加速的硬件被称为硬件加速器，或者更具体地称为3D加速器，加密加速器等。</p>\n<p>传统上，处理器是顺序的（指令被逐个执行），并且被设计成运行通过指令提取控制的通用算法（例如，将临时结果移到和从寄存器文件移动）。硬件加速器通过允许更大的并发性，具有其临时性的特定数据路径，并且可能减少指令控制的开销来改进特定算法的执行。现代处理器是多核的，通常具有并行SIMD单元;然而硬件加速仍然产生好处。硬件加速适用于任何重复密集的密钥算法。根据粒度，硬件加速度可以从小功能单元变化到大功能块（如MPEG-2中的运动估计）。</p>\n<p>在诸如CPU的通用处理器的层次结构中，诸如GPU的更专业的处理器，在FPGA上实现的固定功能和在ASIC上实现的固定功能;在灵活性和效率之间存在折衷，当任何给定的应用程序在这种层次结构上执行时，效率提高了数量级。[2] [3]</p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cj68r48dx0006nki3na5fp13j","category_id":"cj68r48dp0003nki34bpxjago","_id":"cj68r48e6000bnki3mhs97vwu"},{"post_id":"cj68r48dd0000nki3mo9egksv","category_id":"cj68r48dp0003nki34bpxjago","_id":"cj68r48e9000fnki31jiyitxd"},{"post_id":"cj68r48e2000anki3smiyib5l","category_id":"cj68r48dp0003nki34bpxjago","_id":"cj68r48ec000inki3etzw9ewu"},{"post_id":"cj68r48dl0002nki3g55eo9z6","category_id":"cj68r48e10008nki3ssnhfjkv","_id":"cj68r48ef000nnki39iqon5wf"},{"post_id":"cj68r48dz0007nki34z9xmpty","category_id":"cj68r48ef000lnki3jwqia8la","_id":"cj68r48eo000wnki3cseh9amd"},{"post_id":"cj68r48en000vnki3p73r4val","category_id":"cj68r48e8000dnki3f0tmw7bn","_id":"cj68r48eu0012nki3ilahqgq0"},{"post_id":"cj68r48e6000cnki3bgzlgm7o","category_id":"cj68r48el000snki30sntc6pv","_id":"cj68r48ew0016nki3yltmoa6v"},{"post_id":"cj68r48ea000gnki3aq9mfomh","category_id":"cj68r48er000ynki3nma4hjtj","_id":"cj68r48ew0017nki3wdk5d4p0"},{"post_id":"cj68r48ed000jnki35o7fufci","category_id":"cj68r48er000ynki3nma4hjtj","_id":"cj68r48ex001bnki3tx94ug1m"},{"post_id":"cj68r48eh000onki3ymltujpg","category_id":"cj68r48er000ynki3nma4hjtj","_id":"cj68r48ey001gnki3j4x4v2e4"},{"post_id":"cj68r48ek000qnki3ydxddbe0","category_id":"cj68r48ey001cnki3gquf1vsn","_id":"cj68r48ez001knki313gvzx6z"},{"post_id":"cj68r48em000unki3j9ly7lky","category_id":"cj68r48ey001cnki3gquf1vsn","_id":"cj68r48f1001pnki3rad1sor3"},{"post_id":"cj68r48ep000xnki3tutxt3j4","category_id":"cj68r48ez001lnki3tasteoyq","_id":"cj68r48f5001unki31703twr1"},{"post_id":"cj68r48es0011nki3v9l5kvjg","category_id":"cj68r48f1001qnki3utooi4ns","_id":"cj68r48f6001xnki3qf7f1imd"},{"post_id":"cj68r48dt0005nki3ge775adz","category_id":"cj68r48e8000dnki3f0tmw7bn","_id":"cj68raiqv0001yki30cb2dq6c"},{"post_id":"cj7rj4rp80000pri34h54bx13","category_id":"cj7rj4rpj0001pri3cylf2tt1","_id":"cj7rj4rpq0004pri331fno420"},{"post_id":"cj7rj4rrk0005pri39d6jwive","category_id":"cj7rj4rrx0006pri3be8rzn8f","_id":"cj7rj4rs10009pri3uhkehyt8"}],"PostTag":[{"post_id":"cj68r48dd0000nki3mo9egksv","tag_id":"cj68r48ds0004nki3jv43hp54","_id":"cj68r48eb000hnki30e5i6qic"},{"post_id":"cj68r48dd0000nki3mo9egksv","tag_id":"cj68r48e10009nki3chidqmeq","_id":"cj68r48ee000knki34uro2er4"},{"post_id":"cj68r48dl0002nki3g55eo9z6","tag_id":"cj68r48e8000enki3wr3do0or","_id":"cj68r48ej000pnki3vvevlkel"},{"post_id":"cj68r48dx0006nki3na5fp13j","tag_id":"cj68r48ds0004nki3jv43hp54","_id":"cj68r48ex001anki3m64b7f9b"},{"post_id":"cj68r48dx0006nki3na5fp13j","tag_id":"cj68r48er000znki31cl4kqg2","_id":"cj68r48ey001dnki3pwasdmsy"},{"post_id":"cj68r48dx0006nki3na5fp13j","tag_id":"cj68r48ev0015nki32y148uzw","_id":"cj68r48ey001fnki3b5016oay"},{"post_id":"cj68r48dz0007nki34z9xmpty","tag_id":"cj68r48ex0019nki3fndndsfd","_id":"cj68r48ez001jnki3axpdxcry"},{"post_id":"cj68r48dz0007nki34z9xmpty","tag_id":"cj68r48ey001enki39z0tm9a5","_id":"cj68r48f0001mnki3klnqt77q"},{"post_id":"cj68r48e2000anki3smiyib5l","tag_id":"cj68r48ds0004nki3jv43hp54","_id":"cj68r48f1001onki34mcx92gp"},{"post_id":"cj68r48e2000anki3smiyib5l","tag_id":"cj68r48ez001inki3tebl32ka","_id":"cj68r48f3001rnki3r5hkrbkm"},{"post_id":"cj68r48e6000cnki3bgzlgm7o","tag_id":"cj68r48ex0019nki3fndndsfd","_id":"cj68r48f4001tnki3nc0ysppu"},{"post_id":"cj68r48ea000gnki3aq9mfomh","tag_id":"cj68r48f3001snki3ld0jy5ip","_id":"cj68r48f6001wnki3x6guckrt"},{"post_id":"cj68r48ed000jnki35o7fufci","tag_id":"cj68r48f3001snki3ld0jy5ip","_id":"cj68r48f8001znki3w5e2cbsi"},{"post_id":"cj68r48eh000onki3ymltujpg","tag_id":"cj68r48f3001snki3ld0jy5ip","_id":"cj68r48f90022nki3128pqte8"},{"post_id":"cj68r48eh000onki3ymltujpg","tag_id":"cj68r48f80020nki30z8m8sir","_id":"cj68r48f90023nki3qf1szdwb"},{"post_id":"cj68r48ek000qnki3ydxddbe0","tag_id":"cj68r48f90021nki3ikteobn0","_id":"cj68r48fa0026nki3advlduai"},{"post_id":"cj68r48ek000qnki3ydxddbe0","tag_id":"cj68r48f90024nki3yy2ij9vk","_id":"cj68r48fb0027nki3c0q39gln"},{"post_id":"cj68r48em000unki3j9ly7lky","tag_id":"cj68r48f90021nki3ikteobn0","_id":"cj68r48fd0029nki3gbeutxfj"},{"post_id":"cj68r48en000vnki3p73r4val","tag_id":"cj68r48f90021nki3ikteobn0","_id":"cj68r48ff002cnki3f672oazq"},{"post_id":"cj68r48en000vnki3p73r4val","tag_id":"cj68r48ef000mnki3rrde0wbp","_id":"cj68r48ff002dnki3h02vu2nv"},{"post_id":"cj68r48en000vnki3p73r4val","tag_id":"cj68r48fd002anki39ef9gwh7","_id":"cj68r48fg002fnki3gbmbvnnu"},{"post_id":"cj68r48ep000xnki3tutxt3j4","tag_id":"cj68r48fe002bnki3kso8bvjc","_id":"cj68r48fg002gnki3ygyxopi0"},{"post_id":"cj68r48es0011nki3v9l5kvjg","tag_id":"cj68r48ff002enki394zsrz01","_id":"cj68r48fh002hnki32taqm68k"},{"post_id":"cj68r48dt0005nki3ge775adz","tag_id":"cj68r48ef000mnki3rrde0wbp","_id":"cj68raiqv0000yki3gdud4jgc"},{"post_id":"cj68r48dt0005nki3ge775adz","tag_id":"cj68r48em000tnki3ndt5aaj7","_id":"cj68raiqw0002yki3owx6cjr0"},{"post_id":"cj7rj4rp80000pri34h54bx13","tag_id":"cj7rj4rpo0002pri37c6xynuk","_id":"cj7rj4rpq0003pri3qb066v63"},{"post_id":"cj7rj4rrk0005pri39d6jwive","tag_id":"cj7rj4rry0007pri3lwb1ap2c","_id":"cj7rj4rs2000bpri3yvy9vk5n"},{"post_id":"cj7rj4rrk0005pri39d6jwive","tag_id":"cj7rj4rrz0008pri3q0t86ld5","_id":"cj7rj4rs2000cpri3je98n483"},{"post_id":"cj7rj4rrk0005pri39d6jwive","tag_id":"cj7rj4rs1000apri3epkxt3zn","_id":"cj7rj4rs3000dpri3im6i7wnq"}],"Tag":[{"name":"Python","_id":"cj68r48ds0004nki3jv43hp54"},{"name":"Celery","_id":"cj68r48e10009nki3chidqmeq"},{"name":"Docker","_id":"cj68r48e8000enki3wr3do0or"},{"name":"Gerrit","_id":"cj68r48ef000mnki3rrde0wbp"},{"name":"Git","_id":"cj68r48em000tnki3ndt5aaj7"},{"name":"PyPI","_id":"cj68r48er000znki31cl4kqg2"},{"name":"pip2pi","_id":"cj68r48ev0015nki32y148uzw"},{"name":"Robot","_id":"cj68r48ex0019nki3fndndsfd"},{"name":"ROS","_id":"cj68r48ey001enki39z0tm9a5"},{"name":"Pyramid","_id":"cj68r48ez001inki3tebl32ka"},{"name":"Project Tango","_id":"cj68r48f3001snki3ld0jy5ip"},{"name":"Point Cloud","_id":"cj68r48f80020nki30z8m8sir"},{"name":"Ubuntu","_id":"cj68r48f90021nki3ikteobn0"},{"name":"apt mirror","_id":"cj68r48f90024nki3yy2ij9vk"},{"name":"Apache","_id":"cj68r48fd002anki39ef9gwh7"},{"name":"WebKit","_id":"cj68r48fe002bnki3kso8bvjc"},{"name":"Hexo","_id":"cj68r48ff002enki394zsrz01"},{"name":"HTTP","_id":"cj7rj4rpo0002pri37c6xynuk"},{"name":"高性能计算","_id":"cj7rj4rry0007pri3lwb1ap2c"},{"name":"硬件加速","_id":"cj7rj4rrz0008pri3q0t86ld5"},{"name":"GPU","_id":"cj7rj4rs1000apri3epkxt3zn"}]}}