<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Antkit">
<meta property="og:url" content="http://blog.antkit.com/page/2/index.html">
<meta property="og:site_name" content="Antkit">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Antkit">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.antkit.com/page/2/"/>




<link rel="stylesheet" href="/vendors/prettify/prettify.css" type="text/css">
<script src="/vendors/prettify/prettify.js" type="text/javascript"></script>


  <title>Antkit</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Antkit</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.antkit.com/2017/07/10/Celery/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antkit">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/10/Celery/" itemprop="url">Celery</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-10T16:11:29+08:00">
                2017-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="终止进程"><a href="#终止进程" class="headerlink" title="终止进程"></a>终止进程</h2><p>终止 Celery 相关进程：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps auxww | grep <span class="string">'celery worker'</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs <span class="built_in">kill</span> -9</div></pre></td></tr></table></figure></p>
<p>如果使用的是 celeryd：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps auxww | grep celeryd | awk <span class="string">'&#123;print $2&#125;'</span> | xargs <span class="built_in">kill</span> -9</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.antkit.com/2017/07/10/Ubuntu-apt-mirror/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antkit">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/10/Ubuntu-apt-mirror/" itemprop="url">apt-mirror</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-10T15:54:58+08:00">
                2017-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ubuntu/" itemprop="url" rel="index">
                    <span itemprop="name">Ubuntu</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="安装-apt-mirror"><a href="#安装-apt-mirror" class="headerlink" title="安装 apt-mirror"></a>安装 apt-mirror</h2><p>安装很简单，PPA自带：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install apt-mirror</div></pre></td></tr></table></figure></p>
<h2 id="配置-apt-mirror"><a href="#配置-apt-mirror" class="headerlink" title="配置 apt-mirror"></a>配置 apt-mirror</h2><p>apt-mirror 的配置文件位于 /etc/apt/mirror.list，我们在使用前做一下配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo vim /etc/apt/mirror.list</div></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">############# config ##################</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="built_in">set</span> base_path    /var/wwwroot/apt-mirror</div><div class="line"><span class="built_in">set</span> run_postmirror 0</div><div class="line"><span class="built_in">set</span> nthreads     20</div><div class="line"><span class="built_in">set</span> _tilde 0</div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">############# end config ##############</span></div><div class="line"></div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial universe</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial multiverse</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiverse</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverse</div><div class="line">deb https://download.docker.com/linux/ubuntu xenial stable</div><div class="line"></div><div class="line">clean http://mirrors.aliyun.com/ubuntu</div><div class="line">clean https://download.docker.com/linux/ubuntu</div></pre></td></tr></table></figure>
<p>关于这个配置文件：</p>
<ul>
<li>base_path 告诉 apt-mirror 下载的数据存在哪里。</li>
<li>run_postmirror 置为 0 告诉 apt-mirror 不要运行 post script，虽然这个不设置也不影响正常使用，但在 apt-mirror 运行结束时会报一个讨厌的错误信息。</li>
<li>deb 这些行告诉 apt-mirror 从哪里获取 package，这里我们选择了 aliyun 的镜像服务。另外，我们也把 docker 官方源给加了进去。</li>
<li>deb-src 也是被支持的，我们这里没有使用，如果你需要的话请自行加上去。</li>
<li>deb [arch=amd64]，可以这样使用来告诉 apt-mirror 取 64 位版本，否则 apt-mirror 以默认方式取与本机架构一致的版本。</li>
<li>这个是 Ubuntu 16.04（即 xenial）版本，其他版本请自行调整。</li>
<li>clean 结束时做一些清理工作。</li>
</ul>
<h2 id="运行-apt-mirror"><a href="#运行-apt-mirror" class="headerlink" title="运行 apt-mirror"></a>运行 apt-mirror</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-mirror</div></pre></td></tr></table></figure>
<p>运行结束后，可以查看一下结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$ tree -L 4 /var/wwwroot/apt-mirror</div><div class="line">/var/wwwroot/apt-mirror/</div><div class="line">├── mirror</div><div class="line">│   ├── download.docker.com</div><div class="line">│   │   └── linux</div><div class="line">│   │       └── ubuntu</div><div class="line">│   ├── mirrors.aliyun.com</div><div class="line">│   │   └── ubuntu</div><div class="line">│   │       ├── dists</div><div class="line">│   │       └── pool</div><div class="line">├── skel</div><div class="line">│   ├── download.docker.com</div><div class="line">│   │   └── linux</div><div class="line">│   │       └── ubuntu</div><div class="line">│   ├── mirrors.aliyun.com</div><div class="line">│   │   ├── robots.txt</div><div class="line">│   │   └── ubuntu</div><div class="line">│   │       └── dists</div><div class="line">└── var</div><div class="line">    ├── ALL</div><div class="line">    ├── archive-log.0</div><div class="line">    ├── archive-log.1</div></pre></td></tr></table></figure></p>
<h2 id="配置-HTTP-Server"><a href="#配置-HTTP-Server" class="headerlink" title="配置 HTTP Server"></a>配置 HTTP Server</h2><p>配置 HTTP Server，使得可以通过 HTTP 访问刚获取到的 mirror 仓库。以 Apache 为例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> *&gt;</span></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Location</span> /<span class="attr">apt-mirror</span>&gt;</span></div><div class="line">        Options Indexes FollowSymLinks</div><div class="line">        AllowOverride All</div><div class="line">        Require all granted</div><div class="line">    <span class="tag">&lt;/<span class="name">Location</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="应用-mirror"><a href="#应用-mirror" class="headerlink" title="应用 mirror"></a>应用 mirror</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo vim /etc/apt/sources.list</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial main restricted</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates main restricted</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial universe</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates universe</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial multiverse</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-updates multiverse</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security main restricted</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security universe</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/mirrors.aliyun.com/ubuntu/ xenial-security multiverse</div><div class="line">deb [arch=amd64] http://192.168.0.11/apt-mirror/mirror/download.docker.com/linux/ubuntu/ xenial stable</div></pre></td></tr></table></figure>
<p>配置文件里面的 192.168.0.11 是内部 mirror 服务器的 IP 地址。</p>
<p>[arch=amd64] 是必须的，否则服务器会报 404 错误。32 位版本请做调整。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>请定时运行 apt-mirror 程序以更新本地仓库。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.antkit.com/2017/06/06/Ubuntu-用户与权限/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antkit">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/06/Ubuntu-用户与权限/" itemprop="url">Ubuntu 用户与权限</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-06T15:49:40+08:00">
                2017-06-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ubuntu/" itemprop="url" rel="index">
                    <span itemprop="name">Ubuntu</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="增加用户"><a href="#增加用户" class="headerlink" title="增加用户"></a>增加用户</h2><p>可以使用 adduser 和 useradd 来给 Ubuntu 系统添加用户，下面以 adduser 为例。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 添加用户 username</span></div><div class="line">sudo adduser username</div><div class="line"></div><div class="line"><span class="comment"># 将用户 username 添加到 sudo 组</span></div><div class="line">sudo adduser username sudo</div></pre></td></tr></table></figure></p>
<h2 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h2><p>删除用户需要用到 userdel，前提要求目标用户当时未登录。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 删除用户 username</span></div><div class="line">sudo userdel username</div></pre></td></tr></table></figure></p>
<h2 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h2><p>使用 passwd 修改密码。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 修改当前用户的密码</span></div><div class="line">passwd</div><div class="line"></div><div class="line"><span class="comment"># 修改别人（username）的密码</span></div><div class="line">sudo passwd username</div></pre></td></tr></table></figure></p>
<h2 id="文件系统权限"><a href="#文件系统权限" class="headerlink" title="文件系统权限"></a>文件系统权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 只有所有者有读和写的权限</span></div><div class="line">chmod 600 ×××</div><div class="line"><span class="comment"># 所有者有读和写的权限，组用户只有读的权限</span></div><div class="line">chmod 644 ×××</div><div class="line"><span class="comment"># 只有所有者有读和写以及执行的权限</span></div><div class="line">chmod 700 ×××</div><div class="line"><span class="comment"># 每个人都有读和写的权限</span></div><div class="line">chmod 666 ×××</div><div class="line"><span class="comment"># 每个人都有读和写以及执行的权限</span></div><div class="line">chmod 777 ×××</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.antkit.com/2017/05/26/Ubuntu-配置-Gerrit-与-Apache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antkit">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/26/Ubuntu-配置-Gerrit-与-Apache/" itemprop="url">Ubuntu 配置 Gerrit 与 Apache</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-26T16:07:15+08:00">
                2017-05-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Gerrit/" itemprop="url" rel="index">
                    <span itemprop="name">Gerrit</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Gerrit-相关配置"><a href="#Gerrit-相关配置" class="headerlink" title="Gerrit 相关配置"></a>Gerrit 相关配置</h2><h3 id="Review-Site-配置文件"><a href="#Review-Site-配置文件" class="headerlink" title="Review Site 配置文件"></a>Review Site 配置文件</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="section">[gerrit]</span></div><div class="line">	basePath = git</div><div class="line">	serverId = 9e2f813e-92e4-43a7-a3ad-8c16bc7492d0</div><div class="line">	canonicalWebUrl = http://xxx.com/gerrit/</div><div class="line"><span class="section">[database]</span></div><div class="line">	type = mysql</div><div class="line">	hostname = localhost</div><div class="line">	database = reviewdb</div><div class="line">	username = gerrit2</div><div class="line"><span class="section">[index]</span></div><div class="line">	type = LUCENE</div><div class="line"><span class="section">[auth]</span></div><div class="line">	type = HTTP</div><div class="line">	logoutUrl = http://someone:xxx@xxx.com/gerrit/</div><div class="line"><span class="section">[receive]</span></div><div class="line">	enableSignedPush = false</div><div class="line"><span class="section">[sendemail]</span></div><div class="line">	smtpServer = smtp.ym.163.com</div><div class="line">	smtpServerPort = 25</div><div class="line">	smtpUser = gerrit@xxx.com</div><div class="line">	from = gerrit@xxx.com</div><div class="line">	sslVerify = false</div><div class="line"><span class="section">[container]</span></div><div class="line">	user = gerrit2</div><div class="line">	javaHome = /usr/lib/jvm/java-8-oracle/jre</div><div class="line"><span class="section">[sshd]</span></div><div class="line">	listenAddress = *:29418</div><div class="line"><span class="section">[httpd]</span></div><div class="line">	listenUrl = proxy-http://*:8081/gerrit/</div><div class="line"><span class="section">[cache]</span></div><div class="line">	directory = cache</div><div class="line"><span class="section">[gitweb]</span></div><div class="line">	type = gitweb</div><div class="line">	cgi = /usr/lib/cgi-bin/gitweb.cgi</div></pre></td></tr></table></figure>
<h2 id="Apache-配置文件"><a href="#Apache-配置文件" class="headerlink" title="Apache 配置文件"></a>Apache 配置文件</h2><p>下面的配置文件包含了：</p>
<ul>
<li><a href="http://xxx.com" target="_blank" rel="external">http://xxx.com</a></li>
<li><a href="http://xxx.com/gerrit/" target="_blank" rel="external">http://xxx.com/gerrit/</a></li>
<li><a href="http://xxx.com/redmine/" target="_blank" rel="external">http://xxx.com/redmine/</a><figure class="highlight apache"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="section">&lt;VirtualHost *&gt;</span></div><div class="line">    <span class="attribute"><span class="nomarkup">ServerName</span></span> xxx.com</div><div class="line">    <span class="attribute"><span class="nomarkup">DocumentRoot</span></span> /var/www/html</div><div class="line"></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># Gerrit configurations</span></div><div class="line">    <span class="comment"># Access http://xxx.com/gerrit/</span></div><div class="line">    <span class="comment">#</span></div><div class="line"></div><div class="line">    <span class="attribute">ProxyRequests</span> <span class="literal">Off</span></div><div class="line">    <span class="attribute">ProxyVia</span> <span class="literal">Off</span></div><div class="line">    <span class="attribute">ProxyPreserveHost</span> <span class="literal">On</span></div><div class="line"></div><div class="line">    <span class="section">&lt;Proxy http://localhost:8081/gerrit/&gt;</span></div><div class="line">        <span class="attribute"><span class="nomarkup">Order</span></span> deny,allow</div><div class="line">        <span class="attribute"><span class="nomarkup">Allow</span></span> from <span class="literal">all</span></div><div class="line">    <span class="section">&lt;/Proxy&gt;</span></div><div class="line"></div><div class="line">    <span class="comment"># Access limited</span></div><div class="line">    <span class="section">&lt;Location "/gerrit/"&gt;</span></div><div class="line">        <span class="attribute">AuthType</span> Basic</div><div class="line">        <span class="attribute">AuthName</span> <span class="string">"Gerrit Code Review"</span></div><div class="line">        <span class="attribute">Require</span> valid-user</div><div class="line">        <span class="attribute">AuthBasicProvider</span> file</div><div class="line">        <span class="attribute">AuthUserFile</span> <span class="string">"/home/passwords"</span></div><div class="line">    <span class="section">&lt;/Location&gt;</span></div><div class="line"></div><div class="line">    <span class="comment"># Can access without athorization</span></div><div class="line">    <span class="section">&lt;Location "/gerrit/external"&gt;</span></div><div class="line">        <span class="comment"># All access controls and authentication are disabled in this directory</span></div><div class="line">        <span class="attribute">Satisfy</span> Any</div><div class="line">        <span class="attribute"><span class="nomarkup">Allow</span></span> from <span class="literal">all</span></div><div class="line">    <span class="section">&lt;/Location&gt;</span></div><div class="line"></div><div class="line">    <span class="attribute">AllowEncodedSlashes</span> <span class="literal">On</span></div><div class="line">    <span class="attribute">ProxyPass</span> /gerrit/ http://localhost:8081/gerrit/ nocanon</div><div class="line"></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># Redmine configurations</span></div><div class="line">    <span class="comment"># Rewrite xxx.com/redmine/ to xxx.com:8080/redmine/</span></div><div class="line">    <span class="comment">#</span></div><div class="line"></div><div class="line">    <span class="attribute"><span class="nomarkup">RewriteEngine</span></span> <span class="literal">On</span></div><div class="line">    <span class="attribute"><span class="nomarkup">RewriteCond</span></span> <span class="variable">%&#123;REQUEST_URI&#125;</span> ^/redmine/<span class="meta"> [NC]</span></div><div class="line">    <span class="attribute"><span class="nomarkup">RewriteRule</span></span> /redmine/(.*) http://xxx.com:8080/redmine/<span class="number">$1</span><span class="meta"> [R=permanent,L]</span></div><div class="line"><span class="section">&lt;/VirtualHost&gt;</span></div><div class="line"></div><div class="line"><span class="comment"># vim: syntax=apache ts=4 sw=4 sts=4 sr noet</span></div></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.antkit.com/2015/08/27/Pyramid-Startup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antkit">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/08/27/Pyramid-Startup/" itemprop="url">Pyramid Startup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-08-27T18:12:40+08:00">
                2015-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Here’s a high-level time-ordered overview of what happens when you press return after running pserve development.ini.</p>
<h3 id="Pserve-command"><a href="#Pserve-command" class="headerlink" title="Pserve command"></a>Pserve command</h3><p>The pserve command is invoked under your shell with the argument development.ini. As a result, Pyramid recognizes that it is meant to begin to run and serve an application using the information contained within the development.ini file.</p>
<h3 id="Main-section"><a href="#Main-section" class="headerlink" title="Main section"></a>Main section</h3><p>The framework finds a section named either [app:main], [pipeline:main], or [composite:main] in the .ini file. This section represents the configuration of a WSGI application that will be served. If you’re using a simple application (e.g. [app:main]), the application’s paste.app_factory entry point will be named on the use= line within the section’s configuration.</p>
<p>If, instead of a simple application, you’re using a WSGI pipeline (e.g. a [pipeline:main] section), the application named on the “last” element will refer to your Pyramid application. If instead of a simple application or a pipeline, you’re using a “composite” (e.g. [composite:main]), refer to the documentation for that particular composite to understand how to make it refer to your Pyramid application. In most cases, a Pyramid application built from a scaffold will have a single [app:main] section in it, and this will be the application served.</p>
<h3 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h3><p>The framework finds all logging related configuration in the .ini file and uses it to configure the Python standard library logging system for this application. See Logging Configuration for more information.</p>
<h3 id="Application-constructor"><a href="#Application-constructor" class="headerlink" title="Application constructor"></a>Application constructor</h3><p>The application’s constructor named by the entry point reference on the use= line of the section representing your Pyramid application is passed the key/value parameters mentioned within the section in which it’s defined. The constructor is meant to return a router instance, which is a WSGI application.<br><br>For Pyramid applications, the constructor will be a function named main in the <strong>init</strong>.py file within the package in which your application lives. If this function succeeds, it will return a Pyramid router instance. Here’s the contents of an example <strong>init</strong>.py module:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pyramid.config <span class="keyword">import</span> Configurator</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(global_config, **settings)</span>:</span></div><div class="line">    <span class="string">""" This function returns a Pyramid WSGI application.</span></div><div class="line"><span class="string">    """</span></div><div class="line">    config = Configurator(settings=settings)</div><div class="line">    config.include(<span class="string">'pyramid_chameleon'</span>)</div><div class="line">    config.add_static_view(<span class="string">'static'</span>, <span class="string">'static'</span>, cache_max_age=<span class="number">3600</span>)</div><div class="line">    config.add_route(<span class="string">'home'</span>, <span class="string">'/'</span>)</div><div class="line">    config.scan()</div><div class="line">    <span class="keyword">return</span> config.make_wsgi_app()</div></pre></td></tr></table></figure></p>
<p>Note that the constructor function accepts a global_config argument, which is a dictionary of key/value pairs mentioned in the [DEFAULT] section of an .ini file (if [DEFAULT] is present).<br>It also accepts a <strong>settings argument, which collects another set of arbitrary key/value pairs. The arbitrary key/value pairs received by this function in </strong>settings will be composed of all the key/value pairs that are present in the [app:main] section (except for the use= setting) when this function is called by when you run pserve.</p>
<p>Our generated development.ini file looks like so:<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># app configuration</span></div><div class="line"><span class="comment"># http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/environment.html</span></div><div class="line"><span class="comment">###</span></div><div class="line"></div><div class="line"><span class="section">[app:main]</span></div><div class="line"><span class="attr">use</span> = egg:MyProject</div><div class="line"></div><div class="line">pyramid.reload_templates = true</div><div class="line">pyramid.debug_authorization = false</div><div class="line">pyramid.debug_notfound = false</div><div class="line">pyramid.debug_routematch = false</div><div class="line">pyramid.default_locale_name = en</div><div class="line">pyramid.includes =</div><div class="line">pyramid_debugtoolbar</div><div class="line"></div><div class="line"><span class="comment"># By default, the toolbar only appears for clients from IP addresses</span></div><div class="line"><span class="comment"># '127.0.0.1' and '::1'.</span></div><div class="line"><span class="comment"># debugtoolbar.hosts = 127.0.0.1 ::1</span></div><div class="line"></div><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># wsgi server configuration</span></div><div class="line"><span class="comment">###</span></div><div class="line"></div><div class="line"><span class="section">[server:main]</span></div><div class="line"><span class="attr">use</span> = egg:waitress#main</div><div class="line"><span class="attr">host</span> = <span class="number">0.0</span>.<span class="number">0.0</span></div><div class="line"><span class="attr">port</span> = <span class="number">6543</span></div><div class="line"></div><div class="line"><span class="comment">###</span></div><div class="line"><span class="comment"># logging configuration</span></div><div class="line"><span class="comment"># http://docs.pylonsproject.org/projects/pyramid/en/latest/narr/logging.html</span></div><div class="line"><span class="comment">###</span></div><div class="line"></div><div class="line"><span class="section">[loggers]</span></div><div class="line"><span class="attr">keys</span> = root, myproject</div><div class="line"></div><div class="line"><span class="section">[handlers]</span></div><div class="line"><span class="attr">keys</span> = console</div><div class="line"></div><div class="line"><span class="section">[formatters]</span></div><div class="line"><span class="attr">keys</span> = generic</div><div class="line"></div><div class="line"><span class="section">[logger_root]</span></div><div class="line"><span class="attr">level</span> = INFO</div><div class="line"><span class="attr">handlers</span> = console</div><div class="line"></div><div class="line"><span class="section">[logger_myproject]</span></div><div class="line"><span class="attr">level</span> = DEBUG</div><div class="line"><span class="attr">handlers</span> =</div><div class="line"><span class="attr">qualname</span> = myproject</div><div class="line"></div><div class="line"><span class="section">[handler_console]</span></div><div class="line"><span class="attr">class</span> = StreamHandler</div><div class="line"><span class="attr">args</span> = (sys.stderr,)</div><div class="line"><span class="attr">level</span> = NOTSET</div><div class="line"><span class="attr">formatter</span> = generic</div><div class="line"></div><div class="line"><span class="section">[formatter_generic]</span></div><div class="line"><span class="attr">format</span> = %(asctime)s %(levelname)-<span class="number">5.5</span>s [%(name)s][%(threadName)s] %(message)s</div></pre></td></tr></table></figure></p>
<p>In this case, the myproject.<strong>init</strong>:main function referred to by the entry point URI egg:MyProject (see development.ini for more information about entry point URIs, and how they relate to callables), will receive the key/value pairs {‘pyramid.reload_templates’:’true’, ‘pyramid.debug_authorization’:’false’, ‘pyramid.debug_notfound’:’false’, ‘pyramid.debug_routematch’:’false’, ‘pyramid.debug_templates’:’true’, ‘pyramid.default_locale_name’:’en’}. See Environment Variables and .ini File Settings for the meanings of these keys.</p>
<h3 id="Settings-dictinary"><a href="#Settings-dictinary" class="headerlink" title="Settings dictinary"></a>Settings dictinary</h3><p>The main function first constructs a Configurator instance, passing the settings dictionary captured via the **settings kwarg as its settings argument.</p>
<p>The settings dictionary contains all the options in the [app:main] section of our .ini file except the use option (which is internal to PasteDeploy) such as pyramid.reload_templates,<br>pyramid.debug_authorization, etc.</p>
<h3 id="Application-registry"><a href="#Application-registry" class="headerlink" title="Application registry"></a>Application registry</h3><p>The main function then calls various methods on the instance of the class Configurator created in the previous step. The intent of calling these methods is to populate an application registry, which represents the Pyramid configuration related to the application.</p>
<h3 id="Call-make-wsgi-app"><a href="#Call-make-wsgi-app" class="headerlink" title="Call make_wsgi_app"></a>Call make_wsgi_app</h3><p>The make_wsgi_app() method is called. The result is a router instance. The router is associated with the application registry implied by the configurator previously populated by other methods run against the Configurator. The router is a WSGI application.</p>
<h3 id="Emmit-ApplicationCreated-event"><a href="#Emmit-ApplicationCreated-event" class="headerlink" title="Emmit ApplicationCreated event"></a>Emmit ApplicationCreated event</h3><p>An ApplicationCreated event is emitted (see Using Events for more information about events).</p>
<h3 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h3><p>Assuming there were no errors, the main function in myproject returns the router instance created by pyramid.config.Configurator.make_wsgi_app() back to pserve. As far as pserve is concerned, it is “just another WSGI application”.</p>
<h3 id="WSGI-server"><a href="#WSGI-server" class="headerlink" title="WSGI server"></a>WSGI server</h3><p>pserve starts the WSGI server defined within the [server:main] section. In our case, this is the Waitress server (use = egg:waitress#main), and it will listen on all interfaces (host = 0.0.0.0), on port number 6543 (port = 6543). The server code itself is what prints serving on 0.0.0.0:6543 view at <a href="http://127.0.0.1:6543" target="_blank" rel="external">http://127.0.0.1:6543</a>. The server serves the application, and the application is running, waiting to receive requests.</p>
<p><strong>About development.ini</strong></p>
<p>The development.ini file is a PasteDeploy configuration file. Its purpose is to specify an application to run when you invoke pserve, as well as the deployment settings provided to that application.</p>
<p>This file contains several sections including [app:main], [server:main] and several other sections related to logging configuration.</p>
<p>The [app:main] section represents configuration for your Pyramid application. The use setting is the only setting required to be present in the [app:main] section. Its default value, egg:MyProject, indicates that our MyProject project contains the application that should be served. Other settings added to this section are passed as keyword arguments to the function named main in our package’s <strong>init</strong>.py module. You can provide startup-time configuration parameters to your application by adding more settings to this section.</p>
<p>The line in [app:main] above that says use = egg:MyProject is actually shorthand for a longer spelling: use = egg:MyProject#main. The #main part is omitted for brevity, as #main is a default defined by PasteDeploy. egg:MyProject#main is a string which has meaning to PasteDeploy. It points at a setuptools entry point named main defined in the MyProject project.</p>
<p>See Entry Points and PasteDeploy .ini Files for more information about the meaning of the use = egg:MyProject value in this section.</p>
<p>Take a look at the generated setup.py file for this project.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup, find_packages</div><div class="line"></div><div class="line">here = os.path.abspath(os.path.dirname(__file__))</div><div class="line"><span class="keyword">with</span> open(os.path.join(here, <span class="string">'README.txt'</span>)) <span class="keyword">as</span> f:</div><div class="line">    README = f.read()</div><div class="line"><span class="keyword">with</span> open(os.path.join(here, <span class="string">'CHANGES.txt'</span>)) <span class="keyword">as</span> f:</div><div class="line">    CHANGES = f.read()</div><div class="line"></div><div class="line">requires = [</div><div class="line">    <span class="string">'pyramid'</span>,</div><div class="line">    <span class="string">'pyramid_chameleon'</span>,</div><div class="line">    <span class="string">'pyramid_debugtoolbar'</span>,</div><div class="line">    <span class="string">'waitress'</span>,</div><div class="line">]</div><div class="line"></div><div class="line">setup(name=<span class="string">'MyProject'</span>,</div><div class="line">    version=<span class="string">'0.0'</span>,</div><div class="line">    description=<span class="string">'MyProject'</span>,</div><div class="line">    long_description=README + <span class="string">'\n\n'</span> + CHANGES,</div><div class="line">    classifiers=[</div><div class="line">        <span class="string">"Programming Language :: Python"</span>,</div><div class="line">        <span class="string">"Framework :: Pyramid"</span>,</div><div class="line">        <span class="string">"Topic :: Internet :: WWW/HTTP"</span>,</div><div class="line">        <span class="string">"Topic :: Internet :: WWW/HTTP :: WSGI :: Application"</span>,</div><div class="line">    ],</div><div class="line">    author=<span class="string">''</span>,</div><div class="line">    author_email=<span class="string">''</span>,</div><div class="line">    url=<span class="string">''</span>,</div><div class="line">    keywords=<span class="string">'web pyramid pylons'</span>,</div><div class="line">    packages=find_packages(),</div><div class="line">    include_package_data=<span class="keyword">True</span>,</div><div class="line">    zip_safe=<span class="keyword">False</span>,</div><div class="line">    install_requires=requires,</div><div class="line">    tests_require=requires,</div><div class="line">    test_suite=<span class="string">"myproject"</span>,</div><div class="line">    entry_points=<span class="string">"""\</span></div><div class="line"><span class="string">    [paste.app_factory]</span></div><div class="line"><span class="string">    main = myproject:main</span></div><div class="line"><span class="string">    """</span>,</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>Note that entry_points is assigned a string which looks a lot like an .ini file. This string representation of an .ini file has a section named [paste.app_factory]. Within this section, there is a<br>key named main (the entry point name) which has a value myproject:main. The key main is what our egg:MyProject#main value of the use section in our config file is pointing at, although it isactually shortened to egg:MyProject there. The value represents a dotted Python name path, which refers to a callable in our myproject package’s <strong>init</strong>.py module.</p>
<p>The egg: prefix in egg:MyProject indicates that this is an entry point URI specifier, where the “scheme” is “egg”. An “egg” is created when you run setup.py install or setup.py develop within your project.</p>
<p>In English, this entry point can thus be referred to as a “PasteDeploy application factory in the MyProject project which has the entry point named main where the entry point refers to a main function in the mypackage module”. Indeed, if you open up the <strong>init</strong>.py module generated within any scaffold-generated package, you’ll see a main function. This is the function called by PasteDeploy when the pserve command is invoked against our application. It accepts a global configuration object and returns an instance of our application.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.antkit.com/2015/04/09/WebKit渲染流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antkit">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/04/09/WebKit渲染流程/" itemprop="url">WebKit渲染流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-04-09T14:51:03+08:00">
                2015-04-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/WebKit/" itemprop="url" rel="index">
                    <span itemprop="name">WebKit</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>注意：代码并不完整，只是摘录。</p>
<h2 id="UI-驱动"><a href="#UI-驱动" class="headerlink" title="UI 驱动"></a>UI 驱动</h2><p>直接绘制 content(PictureSet)。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// WebKit/gaia/frameworks/webkit/WebView.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> WebView::onDraw(<span class="keyword">const</span> sp&lt;Canvas&gt;&amp; canvas) &#123;</div><div class="line">  <span class="keyword">int</span> saveCount = canvas-&gt;save();</div><div class="line">  drawContent(canvas, drawNativeRings);</div><div class="line">  canvas-&gt;restoreToCount(saveCount);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (AUTO_REDRAW_HACK &amp;&amp; mAutoRedraw)</div><div class="line">    invalidate();</div><div class="line"></div><div class="line">  mWebViewCore-&gt;signalRepaintDone();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> WebView::drawContent(<span class="keyword">const</span> sp&lt;Canvas&gt;&amp; canvas, <span class="keyword">bool</span> drawRings) &#123;</div><div class="line">  drawCoreAndCursorRing(canvas, mBackgroundColor, mDrawCursorRing &amp;&amp; drawRings);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> WebView::drawCoreAndCursorRing(<span class="keyword">const</span> sp&lt;Canvas&gt;&amp; canvas, <span class="keyword">int</span> color, <span class="keyword">bool</span> drawCursorRing) &#123;</div><div class="line">  <span class="keyword">if</span> (mDrawHistory) &#123;</div><div class="line">    canvas-&gt;scale(mZoomManager-&gt;getScale(), mZoomManager-&gt;getScale());</div><div class="line">    canvas-&gt;drawPicture(mHistoryPicture);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">int</span> saveCount = canvas-&gt;save();</div><div class="line">  <span class="keyword">if</span> (animateZoom)</div><div class="line">    mZoomManager-&gt;animateZoom(canvas);</div><div class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!canvas-&gt;isHardwareAccelerated())</div><div class="line">    canvas-&gt;scale(mZoomManager-&gt;getScale(), mZoomManager-&gt;getScale());</div><div class="line"></div><div class="line">  calcOurContentVisibleRectF(mVisibleContentRect);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!canvas-&gt;isHardwareAccelerated()) &#123;</div><div class="line">    sp&lt;DrawFilter&gt; df = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mZoomManager-&gt;isZoomAnimating() || UIAnimationsRunning)</div><div class="line">      df = mZoomFilter;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (animateScroll)</div><div class="line">      df = mScrollFilter;</div><div class="line"></div><div class="line">    canvas-&gt;setDrawFilter(df);</div><div class="line">    <span class="comment">// <span class="doctag">XXX:</span> Revisit splitting content.  Right now it causes a</span></div><div class="line">    <span class="comment">// synchronization problem with layers.</span></div><div class="line">    <span class="keyword">int</span> content = nativeDraw(canvas, mVisibleContentRect, color, extras, <span class="literal">false</span>);</div><div class="line">    canvas-&gt;setDrawFilter(<span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">if</span> (!mBlockWebkitViewMessages &amp;&amp; content != <span class="number">0</span>)</div><div class="line">      mWebViewCore-&gt;sendMessage(EventHub::SPLIT_PICTURE_SET, content, <span class="number">0</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  canvas-&gt;restoreToCount(saveCount);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// gaia/nav/WebView.cpp</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">nativeDraw</span><span class="params">(WebKit::WebViewProxy* proxy, SkCanvas* canvas,</span></span></div><div class="line"><span class="function"><span class="params">               SkRect visibleRect, <span class="keyword">int</span> color,</span></span></div><div class="line"><span class="function"><span class="params">               <span class="keyword">int</span> extras, <span class="keyword">bool</span> split)</span> </span>&#123;</div><div class="line">  WebView* webView = <span class="keyword">reinterpret_cast</span>&lt;WebView*&gt;(proxy-&gt;mNativeClass);</div><div class="line">  webView-&gt;setVisibleRect(visibleRect);</div><div class="line">  PictureSet* pictureSet = webView-&gt;draw(canvas, color, extras, split);</div><div class="line">  <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">int</span>&gt;(pictureSet);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">PictureSet* <span class="title">draw</span><span class="params">(SkCanvas* canvas, SkColor bgColor, <span class="keyword">int</span> extras, <span class="keyword">bool</span> split)</span> </span>&#123;</div><div class="line">  <span class="comment">// draw the content of the base layer first</span></div><div class="line">  PictureSet* content = m_baseLayer-&gt;content();</div><div class="line">  <span class="keyword">int</span> sc = canvas-&gt;save(SkCanvas::kClip_SaveFlag);</div><div class="line">  canvas-&gt;clipRect(SkRect::MakeLTRB(<span class="number">0</span>, <span class="number">0</span>, content-&gt;width(),</div><div class="line">                                    content-&gt;height()), SkRegion::kDifference_Op);</div><div class="line">  canvas-&gt;drawColor(bgColor);</div><div class="line">  canvas-&gt;restoreToCount(sc);</div><div class="line">  <span class="keyword">if</span> (content-&gt;draw(canvas))</div><div class="line">    ret = split ? <span class="keyword">new</span> PictureSet(*content) : <span class="number">0</span>;</div><div class="line">  <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="WebCore-驱动"><a href="#WebCore-驱动" class="headerlink" title="WebCore 驱动"></a>WebCore 驱动</h2><p>使得 content(PictureSet) 被更新。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> FrameView::layout(<span class="keyword">bool</span> allowSubtree) &#123;</div><div class="line">  <span class="comment">// Now update the positions of all layers.</span></div><div class="line">  beginDeferredRepaints();</div><div class="line">  IntPoint cachedOffset;</div><div class="line">  <span class="keyword">if</span> (m_doFullRepaint)</div><div class="line">    root-&gt;view()-&gt;repaint(); <span class="comment">// <span class="doctag">FIXME:</span> This isn't really right, since the RenderView doesn't fully encompass the visibleContentRect(). It just happens</span></div><div class="line">                             <span class="comment">// to work out most of the time, since first layouts and printing don't have you scrolled anywhere.</span></div><div class="line"></div><div class="line">  layer-&gt;updateLayerPositions((m_doFullRepaint ? <span class="number">0</span> : RenderLayer::CheckForRepaint)</div><div class="line">                                  | RenderLayer::IsCompositingUpdateRoot</div><div class="line">                                  | RenderLayer::UpdateCompositingLayers,</div><div class="line">                              subtree ? <span class="number">0</span> : &amp;cachedOffset);</div><div class="line">  endDeferredRepaints();</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class="line">  updateCompositingLayers();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">  m_layoutCount++;</div><div class="line">  ASSERT(!root-&gt;needsLayout());</div><div class="line">  updateCanBlitOnScrollRecursively();</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (document-&gt;hasListenerType(Document::OVERFLOWCHANGED_LISTENER))</div><div class="line">    updateOverflowStatus(layoutWidth() &lt; contentsWidth(),</div><div class="line">                         layoutHeight() &lt; contentsHeight());</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!m_hasPendingPostLayoutTasks) &#123;</div><div class="line">    <span class="keyword">if</span> (!m_inSynchronousPostLayout &amp;&amp; !inSubframeLayoutWithFrameFlattening) &#123;</div><div class="line">      m_inSynchronousPostLayout = <span class="literal">true</span>;</div><div class="line">      <span class="comment">// Calls resumeScheduledEvents()</span></div><div class="line">      performPostLayoutTasks();</div><div class="line">      m_inSynchronousPostLayout = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!m_hasPendingPostLayoutTasks &amp;&amp;</div><div class="line">        (needsLayout() || m_inSynchronousPostLayout || inSubframeLayoutWithFrameFlattening)) &#123;</div><div class="line">      <span class="comment">// If we need layout or are already in a synchronous call to postLayoutTasks(),</span></div><div class="line">      <span class="comment">// defer widget updates and event dispatch until after we return. postLayoutTasks()</span></div><div class="line">      <span class="comment">// can make us need to update again, and we can get stuck in a nasty cycle unless</span></div><div class="line">      <span class="comment">// we call it through the timer here.</span></div><div class="line">      m_hasPendingPostLayoutTasks = <span class="literal">true</span>;</div><div class="line">      m_postLayoutTasksTimer.startOneShot(<span class="number">0</span>);</div><div class="line">      <span class="keyword">if</span> (needsLayout()) &#123;</div><div class="line">        m_actionScheduler-&gt;pause();</div><div class="line">        layout();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    m_actionScheduler-&gt;resume();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  InspectorInstrumentation::didLayout(cookie);</div><div class="line"></div><div class="line">  m_nestedLayoutCount--;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE(ANDROID_OVERFLOW_SCROLL)</span></div><div class="line">  <span class="comment">// Reset to false each time we layout in case the overflow status changed.</span></div><div class="line">  <span class="keyword">bool</span> hasOverflowScroll = <span class="literal">false</span>;</div><div class="line">  RenderObject* ownerRenderer = m_frame-&gt;ownerRenderer();</div><div class="line">  <span class="keyword">if</span> (ownerRenderer &amp;&amp; ownerRenderer-&gt;isRenderIFrame()) &#123;</div><div class="line">    RenderLayer* layer = ownerRenderer-&gt;enclosingLayer();</div><div class="line">    <span class="keyword">if</span> (layer) &#123;</div><div class="line">      <span class="comment">// Some sites use tiny iframes for loading so don't composite those.</span></div><div class="line">      <span class="keyword">if</span> (canHaveScrollbars() &amp;&amp; layoutWidth() &gt; <span class="number">1</span> &amp;&amp; layoutHeight() &gt; <span class="number">1</span>)</div><div class="line">        hasOverflowScroll = layoutWidth() &lt; contentsWidth() || layoutHeight() &lt; contentsHeight();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (RenderView* view = m_frame-&gt;contentRenderer()) &#123;</div><div class="line">    <span class="keyword">if</span> (hasOverflowScroll != m_hasOverflowScroll) &#123;</div><div class="line">      <span class="keyword">if</span> (hasOverflowScroll)</div><div class="line">        enterCompositingMode();</div><div class="line">      <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// We are leaving overflow mode so we need to update the layer</span></div><div class="line">        <span class="comment">// tree in case that is the reason we were composited.</span></div><div class="line">        view-&gt;compositor()-&gt;scheduleCompositingLayerUpdate();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  m_hasOverflowScroll = hasOverflowScroll;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Sometimes (for plug-ins) we need to eagerly go into compositing mode.</span></div><div class="line"><span class="keyword">void</span> FrameView::enterCompositingMode() &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class="line">  <span class="keyword">if</span> (RenderView* view = m_frame-&gt;contentRenderer()) &#123;</div><div class="line">    view-&gt;compositor()-&gt;enableCompositingMode();</div><div class="line">    <span class="keyword">if</span> (!needsLayout())</div><div class="line">      view-&gt;compositor()-&gt;scheduleCompositingLayerUpdate();</div><div class="line">  &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Note that this gets called at painting time.</span></div><div class="line"><span class="keyword">void</span> FrameView::setIsOverlapped(<span class="keyword">bool</span> isOverlapped) &#123;</div><div class="line">  <span class="keyword">if</span> (isOverlapped == m_isOverlapped)</div><div class="line">    <span class="keyword">return</span>;</div><div class="line"></div><div class="line">  m_isOverlapped = isOverlapped;</div><div class="line">  updateCanBlitOnScrollRecursively();</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class="line">  <span class="keyword">if</span> (hasCompositedContentIncludingDescendants()) &#123;</div><div class="line">    <span class="comment">// Overlap can affect compositing tests, so if it changes, we need to trigger</span></div><div class="line">    <span class="comment">// a layer update in the parent document.</span></div><div class="line">    <span class="keyword">if</span> (Frame* parentFrame = m_frame-&gt;tree()-&gt;parent()) &#123;</div><div class="line">      <span class="keyword">if</span> (RenderView* parentView = parentFrame-&gt;contentRenderer()) &#123;</div><div class="line">        RenderLayerCompositor* compositor = parentView-&gt;compositor();</div><div class="line">        compositor-&gt;setCompositingLayersNeedRebuild();</div><div class="line">        compositor-&gt;scheduleCompositingLayerUpdate();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (RenderLayerCompositor::allowsIndependentlyCompositedFrames(<span class="keyword">this</span>)) &#123;</div><div class="line">      <span class="comment">// We also need to trigger reevaluation for this and all descendant frames,</span></div><div class="line">      <span class="comment">// since a frame uses compositing if any ancestor is compositing.</span></div><div class="line">      <span class="keyword">for</span> (Frame* frame = m_frame.get(); frame; frame = frame-&gt;tree()-&gt;traverseNext(m_frame.get())) &#123;</div><div class="line">        <span class="keyword">if</span> (RenderView* view = frame-&gt;contentRenderer()) &#123;</div><div class="line">          RenderLayerCompositor* compositor = view-&gt;compositor();</div><div class="line">          compositor-&gt;setCompositingLayersNeedRebuild();</div><div class="line">          compositor-&gt;scheduleCompositingLayerUpdate();</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> RenderLayerCompositor::scheduleCompositingLayerUpdate() &#123;</div><div class="line">  <span class="keyword">if</span> (!m_updateCompositingLayersTimer.isActive())</div><div class="line">    m_updateCompositingLayersTimer.startOneShot(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> RenderLayerCompositor::compositingLayerUpdatePending() <span class="keyword">const</span> &#123;</div><div class="line">  <span class="keyword">return</span> m_updateCompositingLayersTimer.isActive();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> RenderLayerCompositor::updateCompositingLayersTimerFired(Timer&lt;RenderLayerCompositor&gt;*) &#123;</div><div class="line">  updateCompositingLayers();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebCore/platform/graphics/android/GraphicsLayerAndroid.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">bool</span> GraphicsLayerAndroid::setChildren(<span class="keyword">const</span> WTF::Vector&lt;GraphicsLayer*&gt;&amp; children)</div><div class="line"></div><div class="line"><span class="keyword">void</span> GraphicsLayerAndroid::addChild(GraphicsLayer* childLayer)</div><div class="line"></div><div class="line"><span class="keyword">void</span> GraphicsLayerAndroid::addChildAtIndex(GraphicsLayer* childLayer, <span class="keyword">int</span> index)</div><div class="line"></div><div class="line"><span class="keyword">void</span> GraphicsLayerAndroid::addChildBelow(GraphicsLayer* childLayer, GraphicsLayer* sibling)</div><div class="line"></div><div class="line"><span class="keyword">void</span> GraphicsLayerAndroid::addChildAbove(GraphicsLayer* childLayer, GraphicsLayer* sibling)</div><div class="line"></div><div class="line"><span class="keyword">bool</span> GraphicsLayerAndroid::replaceChild(GraphicsLayer* oldChild, GraphicsLayer* newChild)</div><div class="line"></div><div class="line"><span class="keyword">void</span> GraphicsLayerAndroid::removeFromParent()</div><div class="line"></div><div class="line"><span class="keyword">void</span> GraphicsLayerAndroid::setZPosition(<span class="keyword">float</span> position)</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">&#123;</div><div class="line">  askForSync();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> GraphicsLayerAndroid::askForSync() &#123;</div><div class="line">  <span class="keyword">if</span> (m_client)</div><div class="line">    m_client-&gt;notifySyncRequired(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebCore/rendering/RenderLayerBacking.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> RenderLayerBacking::notifySyncRequired(<span class="keyword">const</span> GraphicsLayer*) &#123;</div><div class="line">  <span class="keyword">if</span> (!renderer()-&gt;documentBeingDestroyed())</div><div class="line">    compositor()-&gt;scheduleLayerFlush();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebCore/rendering/RenderLayerCompositor.h</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> RenderLayerCompositor::notifySyncRequired(<span class="keyword">const</span> GraphicsLayer*) &#123;</div><div class="line">  scheduleLayerFlush();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebCore/rendering/RenderLayerCompositor.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> RenderLayerCompositor::scheduleLayerFlush() &#123;</div><div class="line">  page-&gt;chrome()-&gt;client()-&gt;scheduleCompositingLayerSync();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="documentDidBecomeActive-驱动"><a href="#documentDidBecomeActive-驱动" class="headerlink" title="documentDidBecomeActive 驱动"></a>documentDidBecomeActive 驱动</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Document::documentDidBecomeActive() &#123;</div><div class="line">  HashSet&lt;Element*&gt;::iterator end = m_documentActivationCallbackElements.end();</div><div class="line">  <span class="keyword">for</span> (HashSet&lt;Element*&gt;::iterator i = m_documentActivationCallbackElements.begin(); i != end; ++i)</div><div class="line">    (*i)-&gt;documentDidBecomeActive();</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class="line">  <span class="keyword">if</span> (renderer())</div><div class="line">    renderView()-&gt;didMoveOnscreen();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">  ASSERT(m_frame);</div><div class="line">  m_frame-&gt;loader()-&gt;client()-&gt;dispatchDidBecomeFrameset(isFrameSet());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebCore/rendering/RenderLayerCompositor.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> RenderLayerCompositor::didMoveOnscreen() &#123;</div><div class="line">  RootLayerAttachment attachment = shouldPropagateCompositingToEnclosingFrame() ? RootLayerAttachedViaEnclosingFrame</div><div class="line">                                                                                : RootLayerAttachedViaChromeClient;</div><div class="line">  attachRootPlatformLayer(attachment);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> RenderLayerCompositor::attachRootPlatformLayer(RootLayerAttachment attachment) &#123;</div><div class="line">  <span class="keyword">switch</span> (attachment) &#123;</div><div class="line">    <span class="keyword">case</span> RootLayerAttachedViaChromeClient: &#123;</div><div class="line">      page-&gt;chrome()-&gt;client()-&gt;attachRootGraphicsLayer(frame, rootPlatformLayer());</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> RootLayerAttachedViaEnclosingFrame: &#123;</div><div class="line">      <span class="comment">// The layer will get hooked up via RenderLayerBacking::updateGraphicsLayerConfiguration()</span></div><div class="line">      <span class="comment">// for the frame's renderer in the parent document.</span></div><div class="line">      scheduleNeedsStyleRecalc(m_renderView-&gt;document()-&gt;ownerElement());</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> ChromeClientAndroid::attachRootGraphicsLayer(WebCore::Frame*, WebCore::GraphicsLayer* layer) &#123;</div><div class="line">  scheduleCompositingLayerSync();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebKit/gaia/WebCoreSupport/ChromeClientAndroid.cpp</span></div><div class="line"><span class="keyword">void</span> ChromeClientAndroid::scheduleCompositingLayerSync() &#123;</div><div class="line">  <span class="keyword">if</span> (m_needsLayerSync)</div><div class="line">    <span class="keyword">return</span>;</div><div class="line"></div><div class="line">  m_needsLayerSync = <span class="literal">true</span>;</div><div class="line">  WebViewCore* webViewCore = WebViewCore::getWebViewCore(m_webFrame-&gt;page()-&gt;mainFrame()-&gt;view());</div><div class="line">  <span class="keyword">if</span> (webViewCore)</div><div class="line">    webViewCore-&gt;layersDraw();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebKit/gaia/frameworks/webkit/WebViewCore.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> WebViewCore::layersDraw() &#123;</div><div class="line">  mEventHub-&gt;sendMessage(gaia::Message::obtain(<span class="literal">NULL</span>, EventHub::WEBKIT_DRAW_LAYERS));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebKit/gaia/frameworks/webkit/inner/EventHub.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> EventHub::EventHubHandler::handleMessage(<span class="keyword">const</span> sp&lt;gaia::Message&gt;&amp; msg) &#123;</div><div class="line">  <span class="keyword">case</span> WEBKIT_DRAW:</div><div class="line">    webViewCore-&gt;webkitDraw();</div><div class="line">    <span class="keyword">break</span>;</div><div class="line"></div><div class="line">  <span class="keyword">case</span> WEBKIT_DRAW_LAYERS:</div><div class="line">    webViewCore-&gt;webkitDrawLayers();</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WebKit/gaia/frameworks/webkit/WebViewCore.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> WebViewCore::webkitDrawLayers() &#123;</div><div class="line">  mDrawLayersIsScheduled = <span class="literal">false</span>;</div><div class="line">  <span class="keyword">if</span> (mDrawIsScheduled || mLastDrawData == <span class="literal">NULL</span>) &#123;</div><div class="line">    removeMessages(EventHub::WEBKIT_DRAW);</div><div class="line">    webkitDraw();</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Directly update the layers we last passed to the UI side</span></div><div class="line">  <span class="keyword">if</span> (nativeUpdateLayers(mProxy-&gt;mNativeClass, mLastDrawData-&gt;mBaseLayer)) &#123;</div><div class="line">    <span class="comment">// If anything more complex than position has been touched, let's do a full draw</span></div><div class="line">    webkitDraw();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> WebViewCore::webkitDraw() &#123;</div><div class="line">  mDrawIsScheduled = <span class="literal">false</span>;</div><div class="line">  sp&lt;DrawData&gt; draw = <span class="keyword">new</span> DrawData();</div><div class="line">  draw-&gt;mBaseLayer = nativeRecordContent(draw-&gt;mInvalRegion, draw-&gt;mContentSize);</div><div class="line">  <span class="keyword">if</span> (draw-&gt;mBaseLayer == <span class="number">0</span>) &#123;</div><div class="line">    sp &lt;WebView&gt; spWebView = mWebView.promote();</div><div class="line">    <span class="keyword">if</span> (spWebView != <span class="literal">NULL</span> &amp;&amp; !spWebView-&gt;isPaused()) &#123;</div><div class="line">      LOGV(<span class="string">"webkitDraw abort, resending draw message"</span>);</div><div class="line">      mEventHub-&gt;sendMessage(gaia::Message::obtain(<span class="literal">NULL</span>, EventHub::WEBKIT_DRAW));</div><div class="line">    &#125; <span class="keyword">else</span></div><div class="line">      LOGV(<span class="string">"webkitDraw abort, webview paused"</span>);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mLastDrawData = draw;</div><div class="line">  webkitDraw(draw);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// WebKit/gaia/frameworks/webkit/WebViewCore.cpp</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> WebViewCore::webkitDraw(<span class="keyword">const</span> sp&lt;DrawData&gt;&amp; draw) &#123;</div><div class="line">  sp &lt;WebView&gt; spWebView = mWebView.promote();</div><div class="line">  <span class="keyword">if</span> (spWebView != <span class="literal">NULL</span>) &#123;</div><div class="line">    draw-&gt;mFocusSizeChanged = nativeFocusBoundsChanged();</div><div class="line">    draw-&gt;mViewSize = <span class="keyword">new</span> GPoint(mCurrentViewWidth, mCurrentViewHeight);</div><div class="line">    <span class="keyword">if</span> (mSettings-&gt;getUseWideViewPort()) &#123;</div><div class="line">      draw-&gt;mMinPrefWidth = <span class="built_in">std</span>::max(</div><div class="line">          mViewportWidth == <span class="number">-1</span> ? WebView::DEFAULT_VIEWPORT_WIDTH</div><div class="line">                               : (mViewportWidth == <span class="number">0</span> ? mCurrentViewWidth</div><div class="line">                                                      : mViewportWidth),</div><div class="line">          nativeGetContentMinPrefWidth());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mInitialViewState != <span class="literal">NULL</span>) &#123;</div><div class="line">      draw-&gt;mViewState = mInitialViewState;</div><div class="line">      mInitialViewState = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mFirstLayoutForNonStandardLoad) &#123;</div><div class="line">      draw-&gt;mFirstLayoutForNonStandardLoad = <span class="literal">true</span>;</div><div class="line">      mFirstLayoutForNonStandardLoad = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (DebugFlags::WEB_VIEW_CORE)</div><div class="line">      LOGV(<span class="string">"webkitDraw NEW_PICTURE_MSG_ID"</span>);</div><div class="line"></div><div class="line">    sp&lt;gaia::Message&gt; message = gaia::Message::obtain(spWebView-&gt;mPrivateHandler,</div><div class="line">                                                                WebView::NEW_PICTURE_MSG_ID, draw);</div><div class="line">    SAFETY_ON_NULL_RETURN(message);</div><div class="line">    message-&gt;sendToTarget();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> PrivateHandler::handleMessage(<span class="keyword">const</span> sp&lt;gaia::Message&gt;&amp; msg) &#123;</div><div class="line">  <span class="keyword">case</span> WebView::NEW_PICTURE_MSG_ID: &#123;</div><div class="line">    <span class="comment">// called for new content</span></div><div class="line">    sp&lt;DrawData&gt; draw = safe_cast&lt;DrawData*&gt;(msg-&gt;obj);</div><div class="line">    webView-&gt;setNewPicture(draw, <span class="literal">true</span>);</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">BaseLayerAndroid* WebViewCore::recordContent(SkRegion* region, SkIPoint* point) &#123;</div><div class="line">  <span class="keyword">float</span> progress = (<span class="keyword">float</span>) m_mainFrame-&gt;page()-&gt;progress()-&gt;estimatedProgress();</div><div class="line">  m_progressDone = progress &lt;= <span class="number">0.0f</span> || progress &gt;= <span class="number">1.0f</span>;</div><div class="line">  recordPictureSet(&amp;m_content);</div><div class="line">  <span class="keyword">return</span> createBaseLayer(region);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> WebViewCore::recordPictureSet(PictureSet* content) &#123;</div><div class="line">  <span class="comment">// Rebuild the pictureset (webkit repaint)</span></div><div class="line">  rebuildPictureSet(content);</div><div class="line"></div><div class="line">  updateFrameCache();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> WebViewCore::rebuildPictureSet(PictureSet* pictureSet) &#123;</div><div class="line">  WebCore::FrameView* view = m_mainFrame-&gt;view();</div><div class="line">  <span class="keyword">size_t</span> size = pictureSet-&gt;size();</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> index = <span class="number">0</span>; index &lt; size; index++) &#123;</div><div class="line">    <span class="keyword">if</span> (pictureSet-&gt;upToDate(index))</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> SkIRect&amp; inval = pictureSet-&gt;bounds(index);</div><div class="line">    pictureSet-&gt;setPicture(index, rebuildPicture(inval));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  pictureSet-&gt;validate(__FUNCTION__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">SkPicture* WebViewCore::rebuildPicture(<span class="keyword">const</span> SkIRect&amp; inval) &#123;</div><div class="line">  WebCore::FrameView* view = m_mainFrame-&gt;view();</div><div class="line">  <span class="keyword">int</span> width = view-&gt;contentsWidth();</div><div class="line">  <span class="keyword">int</span> height = view-&gt;contentsHeight();</div><div class="line">  SkPicture* picture = <span class="keyword">new</span> SkPicture();</div><div class="line">  <span class="function">SkAutoPictureRecord <span class="title">arp</span><span class="params">(picture, width, height, PICT_RECORD_FLAGS)</span></span>;</div><div class="line">  <span class="function">SkAutoMemoryUsageProbe <span class="title">mup</span><span class="params">(__FUNCTION__)</span></span>;</div><div class="line">  SkCanvas* recordingCanvas = arp.getRecordingCanvas();</div><div class="line"></div><div class="line">  WebCore::<span class="function">PlatformGraphicsContext <span class="title">pgc</span><span class="params">(recordingCanvas)</span></span>;</div><div class="line">  WebCore::<span class="function">GraphicsContext <span class="title">gc</span><span class="params">(&amp;pgc)</span></span>;</div><div class="line">  IntPoint origin = view-&gt;minimumScrollPosition();</div><div class="line">  <span class="comment">// Line commented because of highlight problem</span></div><div class="line">  <span class="comment">// WebCore::IntRect drawArea(inval.fLeft + origin.x(), inval.fTop + origin.y(), inval.width(), inval.height());</span></div><div class="line">  recordingCanvas-&gt;translate(-drawArea.x(), -drawArea.y());</div><div class="line">  recordingCanvas-&gt;save();</div><div class="line">  view-&gt;platformWidget()-&gt;draw(&amp;gc, drawArea);</div><div class="line">  m_rebuildInval.op(inval, SkRegion::kUnion_Op);</div><div class="line">  <span class="keyword">return</span> picture;</div><div class="line">&#125;</div><div class="line"></div><div class="line">BaseLayerAndroid* WebViewCore::createBaseLayer(SkRegion* region) &#123;</div><div class="line">  BaseLayerAndroid* base = <span class="keyword">new</span> BaseLayerAndroid();</div><div class="line">  base-&gt;setContent(m_content);</div><div class="line"></div><div class="line">  m_skipContentDraw = <span class="literal">true</span>;</div><div class="line">  <span class="keyword">bool</span> layoutSucceeded = layoutIfNeededRecursive(m_mainFrame);</div><div class="line">  m_skipContentDraw = <span class="literal">false</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> USE(ACCELERATED_COMPOSITING)</span></div><div class="line">  <span class="comment">// We set the background color</span></div><div class="line">  <span class="keyword">if</span> (m_mainFrame &amp;&amp; m_mainFrame-&gt;document()</div><div class="line">      &amp;&amp; m_mainFrame-&gt;document()-&gt;body()) &#123;</div><div class="line">    Document* document = m_mainFrame-&gt;document();</div><div class="line">    RefPtr&lt;RenderStyle&gt; style = document-&gt;styleForElementIgnoringPendingStylesheets(document-&gt;body());</div><div class="line">    <span class="keyword">if</span> (style-&gt;hasBackground()) &#123;</div><div class="line">      Color color = style-&gt;visitedDependentColor(CSSPropertyBackgroundColor);</div><div class="line">      <span class="keyword">if</span> (color.isValid() &amp;&amp; color.alpha() &gt; <span class="number">0</span>)</div><div class="line">        base-&gt;setBackgroundColor(color);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// We update the layers</span></div><div class="line">  ChromeClientAndroid* chromeC = <span class="keyword">static_cast</span>&lt;ChromeClientAndroid*&gt;(m_mainFrame-&gt;page()-&gt;chrome()-&gt;client());</div><div class="line">  GraphicsLayerAndroid* root = <span class="keyword">static_cast</span>&lt;GraphicsLayerAndroid*&gt;(chromeC-&gt;layersSync());</div><div class="line">  <span class="keyword">if</span> (root) &#123;</div><div class="line">    LayerAndroid* copyLayer = <span class="keyword">new</span> LayerAndroid(*root-&gt;contentLayer());</div><div class="line">    base-&gt;addChild(copyLayer);</div><div class="line">    copyLayer-&gt;unref();</div><div class="line">    root-&gt;contentLayer()-&gt;clearDirtyRegion();</div><div class="line">  &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> base;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.antkit.com/2015/03/09/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Martin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antkit">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/03/09/hello-world/" itemprop="url">Hello Hexo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-03-09T15:54:58+08:00">
                2015-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Install-node-js-and-npm"><a href="#Install-node-js-and-npm" class="headerlink" title="Install node.js and npm"></a>Install node.js and npm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> ~/tools</div><div class="line">$ wget https://nodejs.org/dist/v6.11.1/node-v6.11.1-linux-x64.tar.xz</div><div class="line">$ tar xzvf node-v6.11.1-linux-x64.tar.xz</div><div class="line">$ <span class="built_in">echo</span> <span class="string">"export PATH=<span class="variable">$HOME</span>/tools/node-v6.11.1-linux-x64/bin:<span class="variable">$PATH</span>"</span> &gt;&gt; ~/.bashrc</div><div class="line">$ <span class="built_in">source</span> ~/.bashrc</div></pre></td></tr></table></figure>
<h3 id="Initialize-web-site"><a href="#Initialize-web-site" class="headerlink" title="Initialize web site"></a>Initialize web site</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> https://github.com/antkit/antkit.github.io.git</div><div class="line">$ git checkout -b develop origin/develop</div><div class="line">$ <span class="built_in">cd</span> antkit.github.io.git</div><div class="line">$ npm install --registry=https://registry.npm.taobao.org</div></pre></td></tr></table></figure>
<p>Now hexo is under directory ./node_modules/hexo/bin. You can run server:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./node_modules/hexo/bin/hexo server</div></pre></td></tr></table></figure>
<h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Martin" />
          <p class="site-author-name" itemprop="name">Martin</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Martin</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
